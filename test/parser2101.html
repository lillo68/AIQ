<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser Betmonitor & AIQ Calculator - 3 & 2 Esiti + Backtest</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #ffffff;
            color: #333;
            line-height: 1.5;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* Layout principale */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .tab:hover {
            color: #2563eb;
            background: #f8f9fa;
        }

        .tab.active {
            color: #2563eb;
            font-weight: 600;
            border-color: #eaeaea;
            border-bottom-color: white;
            background: white;
            border-radius: 6px 6px 0 0;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #fff;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .card h2 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #2563eb;
            border-radius: 2px;
        }

        /* CALCOLATORE AIQ STYLES */
        .aiq-calculator {
            background: #ffffff;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .aiq-calculator h2 {
            text-align: center;
            color: #0369a1;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .aiq-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .aiq-table th, .aiq-table td {
            border: 1px solid #e5e7eb;
            padding: 6px;
            text-align: center;
        }

        .aiq-table th { 
            background: #f1f5f9; 
            font-weight: 600;
            color: #475569;
        }

        .aiq-input {
            width: 70px;
            text-align: center;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .aiq-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .aiq-result { 
            font-weight: bold; 
            font-size: 14px;
        }

        .aiq-value {
            background: #dcfce7;
            color: #166534;
        }

        .aiq-novalue {
            background: #fee2e2;
            color: #991b1b;
        }

        .aiq-ok {
            background: #dcfce7;
            color: #166534;
        }

        .aiq-warn {
            background: #fef9c3;
            color: #854d0e;
        }

        /* Parser styles */
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            background: #fafafa;
            color: #333;
        }

        textarea:focus {
            outline: none;
            border-color: #2563eb;
            background: #fff;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            color: #333;
            flex: 1;
            min-width: 120px;
        }

        button:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }

        .btn-parse {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .btn-parse:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .btn-clear {
            background: #fff;
            color: #666;
        }

        .btn-clear:hover {
            background: #f8f9fa;
            color: #333;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-summary-item {
            text-align: center;
        }

        .stat-summary-value {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            display: block;
        }

        .stat-summary-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* Tabella statistiche compatte */
        .stats-table-container {
            margin-top: 20px;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            overflow: hidden;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th {
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eaeaea;
        }

        .stats-table td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .stats-table tr:last-child td {
            border-bottom: none;
        }

        .stats-table tr:hover {
            background: #fafafa;
        }

        /* Stili per le colonne Pinnacle e Betfair */
        .stat-pinnacle .stat-table-value { color: #7c3aed; }
        .stat-betfair .stat-table-value { color: #ea580c; }

        /* Header per Pinnacle e Betfair */
        .esito-header.pinnacle { 
            border-left: 3px solid #7c3aed;
            color: #7c3aed;
        }
        .esito-header.betfair { 
            border-left: 3px solid #ea580c;
            color: #ea580c;
        }
        
        /* Header colonne esiti */
        .esito-header {
            font-weight: 600;
            color: #1a1a1a;
            padding: 10px 12px;
            background: #f8f9fa;
        }

        .esito-header.quote-1 { 
            border-left: 3px solid #2563eb;
            color: #2563eb;
        }
        .esito-header.quote-x { 
            border-left: 3px solid #9333ea;
            color: #9333ea;
        }
        .esito-header.quote-2 { 
            border-left: 3px solid #059669;
            color: #059669;
        }
        .esito-header.quote-yes { 
            border-left: 3px solid #2563eb;
            color: #2563eb;
        }
        .esito-header.quote-no { 
            border-left: 3px solid #dc2626;
            color: #dc2626;
        }

        /* Valori nelle celle */
        .stat-table-value {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            display: block;
        }

        .stat-table-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-top: 2px;
        }

        .stat-table-bookmaker {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Colori per i tipi di statistiche */
        .stat-min .stat-table-value { color: #059669; }
        .stat-max .stat-table-value { color: #dc2626; }
        .stat-sharp .stat-table-value { color: #ea580c; }

        /* Tabella bookmaker */
        .results-container {
            margin-top: 20px;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            overflow: hidden;
        }

        .bookmaker-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bookmaker-table thead {
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }

        .bookmaker-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bookmaker-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #eaeaea;
            font-size: 13px;
        }

        .bookmaker-table tr:last-child td {
            border-bottom: none;
        }

        .bookmaker-table tr:hover {
            background: #f8f9fa;
        }

        /* Stili per l'ordinamento */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
            transition: background-color 0.2s ease;
        }

        .sortable-header:hover {
            background-color: #f0f0f0;
        }

        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            opacity: 0.3;
        }

        .sortable-header.asc::after {
            border-bottom: 6px solid #666;
            border-top: none;
            opacity: 1;
        }

        .sortable-header.desc::after {
            border-top: 6px solid #666;
            border-bottom: none;
            opacity: 1;
        }

        .bookmaker-name {
            font-weight: 500;
            color: #1a1a1a;
        }

        .bookmaker-name.sharp {
            color: #ea580c;
            font-weight: 600;
        }

        .quote-cell {
            text-align: center;
            font-weight: 500;
            border-radius: 4px;
            padding: 4px 8px;
            font-feature-settings: "tnum";
        }

        .quote-1-cell { color: #2563eb; background: #eff6ff; }
        .quote-x-cell { color: #9333ea; background: #faf5ff; }
        .quote-2-cell { color: #059669; background: #f0fdf4; }
        .quote-yes-cell { color: #2563eb; background: #eff6ff; }
        .quote-no-cell { color: #dc2626; background: #fef2f2; }

        .export-options {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }

        .export-btn.csv { color: #059669; border-color: #d1fae5; background: #f0fdf4; }
        .export-btn.json { color: #2563eb; border-color: #dbeafe; background: #eff6ff; }
        .export-btn.txt { color: #ea580c; border-color: #ffedd5; background: #fff7ed; }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #1a1a1a;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }

        .empty-state .icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .example-toggle {
            font-size: 12px;
            color: #2563eb;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            margin-top: 8px;
            text-decoration: underline;
        }

        .example-toggle:hover {
            color: #1d4ed8;
        }
        
        /* Tooltip AIQ */
        .aiq-tooltip {
            position: fixed;
            pointer-events: none;
            background: #020617;
            color: #f8fafc;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 999;
        }

        /* Layout per i tab */
        .tab-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        @media (max-width: 1400px) {
            .tab-layout {
                grid-template-columns: 1fr;
            }
        }

        .tab-left, .tab-right {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Stili per la gestione eventi */
        .evento-current {
            background: #f0f9ff;
            border-left: 4px solid #2563eb;
        }

        .btn-success {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        .btn-success:hover {
            background: #047857;
            border-color: #047857;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .filter-bar button {
            padding: 8px 16px;
            min-width: auto;
        }

        .stats-backtest {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .evento-details {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .evento-details h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .evento-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }

        .evento-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eaeaea;
        }

        .evento-info-label {
            color: #666;
        }

        .evento-info-value {
            font-weight: 500;
            color: #1a1a1a;
        }
      
        /* Layout a larghezza completa per tab eventi */
        .tab-full-width {
            width: 100%;
            grid-column: 1 / -1;
        }

        /* Stili per la modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .btn-dettagli {
            background: #2563eb;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-dettagli:hover {
            background: #1d4ed8;
        }

        .mercato-select {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
            background: white;
        }

        .mercato-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Stili per Setup */
        .mercato-dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }

        tr[draggable="true"] {
            cursor: move;
            transition: background 0.2s;
        }

        tr[draggable="true"]:hover {
            background: #f9fafb;
        }

        tr[draggable="true"]:active {
            cursor: grabbing;
        }

        /* Stili per input mercato */
        input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Stili per bottoni Setup */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stili per la tabella setup */
        .bookmaker-table th {
            user-select: none;
        }
        
        /* Stili per i grafici */
        .chart-container {
            height: 350px;
            width: 100%;
        }

        /* Stili per la tab Guida */
        .guide-section {
            display: none;
        }

        .guide-section.active {
            display: block;
        }

        .guide-section h4 {
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }

        .guide-section h5 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        .guide-section ul, .guide-section ol {
            margin-bottom: 15px;
        }

        .guide-section li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .guide-section code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Parser Betmonitor & AIQ Calculator + Backtest Database</h1>
            <p>Estrazione quote bookmaker, calcolo ValueBet AIQ e gestione eventi per backtest</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('tab-3esiti')">3 Esiti (1X2)</div>
            <div class="tab" onclick="switchTab('tab-2esiti')">2 Esiti (S√¨/No)</div>
            <div class="tab" onclick="switchTab('tab-eventi')">üìÖ Gestione Eventi</div>
            <div class="tab" onclick="switchTab('tab-analisi')">üîç Analisi ValueBet</div> 
            <div class="tab" onclick="switchTab('tab-setup')">‚öôÔ∏è Setup</div>
            <div class="tab" onclick="switchTab('tab-guida')">üìò Guida & Tutorial</div>
        </div>

        <!-- Tab 3 Esiti -->
        <div id="tab-3esiti" class="tab-content active">
            <div class="tab-layout">
                <!-- Colonna sinistra: Calcolatore AIQ CALCIO -->
                <div class="tab-left">
                    <!-- Mini Parser Eventi per 3 Esiti -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h2>Mini Parser Eventi - Calcio</h2>
                        <textarea id="inputEvento3" placeholder="Incolla i dati dell'evento nel formato:
                    VfB Stuttgart ‚Äî Eintracht Frankfurt
                    Football ¬∑ Germany ¬∑ Germany Bundesliga
                    Tuesday ¬∑ 13 Jan, 2026 ¬∑ 18:30"></textarea>
                        
                        <button class="example-toggle" onclick="loadEsempioEvento3()">Carica esempio evento</button>
                        
                        <div class="button-group">
                            <button class="btn-parse" onclick="parseEvento3()">Parsa Evento</button>
                            <button class="btn-clear" onclick="clearEvento3()">Pulisci</button>
                            <button class="btn-success" onclick="salvaEventoConQuotes3()">üíæ Salva Evento + Quotes</button>
                        </div>

                        <div class="help-text">
                            Formato: Nome evento (linea 1) ¬∑ Sport ¬∑ Nazione ¬∑ Lega (linea 2) ¬∑ Data/ora (linea 3)
                        </div>

                        <!-- Dettagli Evento Corrente per 3 Esiti -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h2>Dettagli Evento Corrente - Calcio</h2>
                            <div class="evento-details" id="eventoDetails3">
                                <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                    Nessun evento caricato
                                </div>
                            </div>

                            <div class="button-group" style="margin-top: 15px;">
                                <button class="btn-parse" onclick="caricaQuotesInEvento3()">üîÑ Carica Quotes 3 Esiti</button>
                                <button class="export-btn json" onclick="esportaEventoJSON3()">üì§ Esporta Evento</button>
                            </div>
                        </div>

                        <div class="stats-summary" style="margin-top: 20px;">
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="totalEventi3">0</span>
                                <span class="stat-summary-label">Eventi salvati</span>
                            </div>
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="eventiAnalizzati3">0</span>
                                <span class="stat-summary-label">Con risultato</span>
                            </div>
                        </div>
                    </div>

                    <div class="aiq-calculator">
                        <h2>AIQ CALCIO - 3 Esiti</h2>
                        <table class="aiq-table">
                            <tr>
                                <th>Parametro</th>
                                <th>HOME</th>
                                <th>DRAW</th>
                                <th>AWAY</th>
                            </tr>
                            
                            <tr>
                                <td>Quota Sharp</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Sharp_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Sharp_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Sharp_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Media</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Media_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Media_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Media_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Min</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Min_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Min_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Min_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Max</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Max_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Max_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Max_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Sharp / Media</td>
                                <td id="AIQ CALCIO_sm_HOME"></td>
                                <td id="AIQ CALCIO_sm_DRAW"></td>
                                <td id="AIQ CALCIO_sm_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>Max / Min</td>
                                <td id="AIQ CALCIO_mm_HOME"></td>
                                <td id="AIQ CALCIO_mm_DRAW"></td>
                                <td id="AIQ CALCIO_mm_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>Sharp / Soft</td>
                                <td id="AIQ CALCIO_ss_HOME"></td>
                                <td id="AIQ CALCIO_ss_DRAW"></td>
                                <td id="AIQ CALCIO_ss_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>FORZA VALUE</td>
                                <td id="AIQ CALCIO_fv_HOME"></td>
                                <td id="AIQ CALCIO_fv_DRAW"></td>
                                <td id="AIQ CALCIO_fv_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>VERDETTO</td>
                                <td id="AIQ CALCIO_res_HOME" class="aiq-result"></td>
                                <td id="AIQ CALCIO_res_DRAW" class="aiq-result"></td>
                                <td id="AIQ CALCIO_res_AWAY" class="aiq-result"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Colonna destra: Parser 3 Esiti -->
                <div class="tab-right">
                    <div class="card">
                        <h2>Dati Input - 3 Esiti</h2>
                        <textarea id="inputData3" placeholder="Incolla i dati copiati da Betmonitor (formato 3 esiti)..."></textarea>
                        
                        <button class="example-toggle" onclick="loadExample3Esiti()">Carica esempio 3 esiti</button>
                        
                        <div class="button-group">
                            <button class="btn-parse" onclick="parseData3Esiti()">Parsa Dati</button>
                            <button class="btn-clear" onclick="clearData3Esiti()">Pulisci</button>
                        </div>

                        <div class="help-text">
                            Formato atteso: nome bookmaker, dominio, 3 quote (1, X, 2), percentuale
                        </div>

                        <div class="stats-summary">
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="totalBooks3">0</span>
                                <span class="stat-summary-label">Bookmaker totali</span>
                            </div>
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="sharpBooks3">0</span>
                                <span class="stat-summary-label">Sharp</span>
                            </div>
                        </div>

                        <div class="debug-info" id="debugInfo3"></div>
                    </div>

                    <div class="card">
                        <h2>Statistiche Quote - 3 Esiti</h2>
                        
                        <!-- Tabella statistiche compatte -->
                        <div class="stats-table-container">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th style="width: 120px; text-align: left;">Statistica</th>
                                        <th style="width: 25%;" class="esito-header quote-1">1</th>
                                        <th style="width: 25%;" class="esito-header quote-x">X</th>
                                        <th style="width: 25%;" class="esito-header quote-2">2</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Riga Media -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Media</td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuote1">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuoteX">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuote2">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Minima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Minima</td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuote1">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBook1">-</div>
                                        </td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuoteX">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBookX">-</div>
                                        </td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuote2">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBook2">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Massima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Massima</td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuote1">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBook1">-</div>
                                        </td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuoteX">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBookX">-</div>
                                        </td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuote2">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBook2">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Pinnacle -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Pinnacle</td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuote1">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuoteX">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuote2">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>

                                    <!-- Riga Betfair -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Betfair</td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuote1">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuoteX">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuote2">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Tabella bookmaker -->
                        <h2 style="margin-top: 30px;">Dettaglio Bookmaker - 3 Esiti</h2>
                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" onclick="sortTable3('bookmaker')" data-sort="none">Bookmaker</th>
                                        <th class="sortable-header" onclick="sortTable3('quote1')" style="text-align: center;" data-sort="none">1</th>
                                        <th class="sortable-header" onclick="sortTable3('quoteX')" style="text-align: center;" data-sort="none">X</th>
                                        <th class="sortable-header" onclick="sortTable3('quote2')" style="text-align: center;" data-sort="none">2</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable3">
                                    <!-- I dati verranno inseriti qui dinamicamente -->
                                </tbody>
                            </table>
                            <div id="emptyState3" class="empty-state" style="display: none;">
                                <div class="icon">üìä</div>
                                <div>Nessun dato disponibile</div>
                                <div style="font-size: 12px; margin-top: 4px;">Incolla i dati e clicca "Parsa Dati"</div>
                            </div>
                        </div>

                        <div class="export-options">
                            <button class="export-btn csv" onclick="exportToCSV3()">Esporta CSV</button>
                            <button class="export-btn json" onclick="exportToJSON3()">Esporta JSON</button>
                            <button class="export-btn txt" onclick="exportToTXT3()">Esporta TXT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2 Esiti -->
        <div id="tab-2esiti" class="tab-content">
            <div class="tab-layout">
                <!-- Colonna sinistra: Calcolatore AIQ TENNIS -->
                <div class="tab-left">
                        <!-- Mini Parser Eventi per 2 Esiti -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h2>Mini Parser Eventi - Tennis</h2>
                            <textarea id="inputEvento2" placeholder="Incolla i dati dell'evento nel formato:
                        Nadal vs. Djokovic
                        Tennis ¬∑ International ¬∑ Wimbledon
                        Monday ¬∑ 15 Jan, 2026 ¬∑ 15:00"></textarea>
                            
                            <button class="example-toggle" onclick="loadEsempioEvento2()">Carica esempio evento</button>
                            
                            <div class="button-group">
                                <button class="btn-parse" onclick="parseEvento2()">Parsa Evento</button>
                                <button class="btn-clear" onclick="clearEvento2()">Pulisci</button>
                                <button class="btn-success" onclick="salvaEventoConQuotes2()">üíæ Salva Evento + Quotes</button>
                            </div>

                            <div class="help-text">
                                Formato: Nome evento (linea 1) ¬∑ Sport ¬∑ Nazione ¬∑ Lega (linea 2) ¬∑ Data/ora (linea 3)
                            </div>

                            <div class="stats-summary" style="margin-top: 20px;">
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="totalEventi2">0</span>
                                    <span class="stat-summary-label">Eventi salvati</span>
                                </div>
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="eventiAnalizzati2">0</span>
                                    <span class="stat-summary-label">Con risultato</span>
                                </div>
                            </div>
                        </div>

                        <!-- Dettagli Evento Corrente per 2 Esiti -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h2>Dettagli Evento Corrente - Tennis</h2>
                            <div class="evento-details" id="eventoDetails2">
                                <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                    Nessun evento caricato
                                </div>
                            </div>

                            <div class="button-group" style="margin-top: 15px;">
                                <button class="btn-parse" onclick="caricaQuotesInEvento2()">üîÑ Carica Quotes 2 Esiti</button>
                                <button class="export-btn json" onclick="esportaEventoJSON2()">üì§ Esporta Evento</button>
                            </div>
                        </div>
                    <div class="aiq-calculator">
                        <h2>AIQ TENNIS - 2 Esiti</h2>
                        <table class="aiq-table">
                            <tr>
                                <th>Parametro</th>
                                <th>HOME</th>
                                <th>AWAY</th>
                            </tr>
                            
                            <tr>
                                <td>Quota Sharp</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Sharp_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Sharp_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Media</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Media_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Media_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Min</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Min_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Min_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Max</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Max_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Max_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Sharp / Media</td>
                                <td id="AIQ TENNIS_sm_HOME"></td>
                                <td id="AIQ TENNIS_sm_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>Max / Min</td>
                                <td id="AIQ TENNIS_mm_HOME"></td>
                                <td id="AIQ TENNIS_mm_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>Sharp / Soft</td>
                                <td id="AIQ TENNIS_ss_HOME"></td>
                                <td id="AIQ TENNIS_ss_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>FORZA VALUE</td>
                                <td id="AIQ TENNIS_fv_HOME"></td>
                                <td id="AIQ TENNIS_fv_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>VERDETTO</td>
                                <td id="AIQ TENNIS_res_HOME" class="aiq-result"></td>
                                <td id="AIQ TENNIS_res_AWAY" class="aiq-result"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Colonna destra: Parser 2 Esiti -->
                <div class="tab-right">
                    <div class="card">
                        <h2>Dati Input - 2 Esiti</h2>
                        <textarea id="inputData2" placeholder="Incolla i dati copiati da Betmonitor (formato 2 esiti)..."></textarea>
                        
                        <button class="example-toggle" onclick="loadExample2Esiti()">Carica esempio 2 esiti</button>
                        
                        <div class="button-group">
                            <button class="btn-parse" onclick="parseData2Esiti()">Parsa Dati</button>
                            <button class="btn-clear" onclick="clearData2Esiti()">Pulisci</button>
                        </div>

                        <div class="help-text">
                            Formato atteso: nome bookmaker, dominio, 2 quote (S√¨, No), percentuale
                        </div>

                        <div class="stats-summary">
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="totalBooks2">0</span>
                                <span class="stat-summary-label">Bookmaker totali</span>
                            </div>
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="sharpBooks2">0</span>
                                <span class="stat-summary-label">Sharp</span>
                            </div>
                        </div>

                        <div class="debug-info" id="debugInfo2"></div>
                    </div>

                    <div class="card">
                        <h2>Statistiche Quote - 2 Esiti</h2>
                        
                        <!-- Tabella statistiche compatte -->
                        <div class="stats-table-container">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th style="width: 120px; text-align: left;">Statistica</th>
                                        <th style="width: 40%;" class="esito-header quote-yes">S√¨ / Over / Alt</th>
                                        <th style="width: 40%;" class="esito-header quote-no">No / Under / Alt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Riga Media -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Media</td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuoteYes">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuoteNo">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Minima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Minima</td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuoteYes">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBookYes">-</div>
                                        </td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuoteNo">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBookNo">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Massima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Massima</td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuoteYes">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBookYes">-</div>
                                        </td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuoteNo">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBookNo">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Pinnacle -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Pinnacle</td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuoteYes">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuoteNo">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>

                                    <!-- Riga Betfair -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Betfair</td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuoteYes">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuoteNo">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Tabella bookmaker -->
                        <h2 style="margin-top: 30px;">Dettaglio Bookmaker - 2 Esiti</h2>
                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" onclick="sortTable2('bookmaker')" data-sort="none">Bookmaker</th>
                                        <th class="sortable-header" onclick="sortTable2('quoteYes')" style="text-align: center;" data-sort="none">S√¨ / Over / Alt</th>
                                        <th class="sortable-header" onclick="sortTable2('quoteNo')" style="text-align: center;" data-sort="none">No / Under / Alt</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable2">
                                    <!-- I dati verranno inseriti qui dinamicamente -->
                                </tbody>
                            </table>
                            <div id="emptyState2" class="empty-state" style="display: none;">
                                <div class="icon">üìä</div>
                                <div>Nessun dato disponibile</div>
                                <div style="font-size: 12px; margin-top: 4px;">Incolla i dati e clicca "Parsa Dati"</div>
                            </div>
                        </div>

                        <div class="export-options">
                            <button class="export-btn csv" onclick="exportToCSV2()">Esporta CSV</button>
                            <button class="export-btn json" onclick="exportToJSON2()">Esporta JSON</button>
                            <button class="export-btn txt" onclick="exportToTXT2()">Esporta TXT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Gestione Eventi -->
        <div id="tab-eventi" class="tab-content">
            <div class="tab-layout">
                <!-- Colonna unica per database a larghezza completa -->
                <div class="tab-full-width">
                    <div class="card">
                        <h2>Database Eventi Backtest</h2>
                        
                        <div class="filter-bar">
                            <input type="text" id="cercaEvento" placeholder="Cerca evento..." onkeyup="filtraEventi()">
                            <select id="filtroSport" onchange="filtraEventi()">
                                <option value="">Tutti gli sport</option>
                            </select>
                            <button onclick="resetFiltri()" style="background: #6b7280; color: white;">Reset</button>
                        </div>

                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">Evento</th>
                                        <th style="width: 10%;">Sport</th>
                                        <th style="width: 15%;">Lega</th>
                                        <th style="width: 10%;">Data</th>
                                        <th style="width: 15%;">Tipologia</th>
                                        <th style="width: 8%;">Value su</th>
                                        <th style="width: 8%;">Risultato</th>
                                        <th style="width: 10%;">AIQ Value</th>
                                        <th style="width: 10%;">Bookmaker</th>
                                        <th style="width: 10%;">Dettagli</th>
                                    </tr>
                                </thead>
                                <tbody id="tabellaEventi">
                                    <!-- Eventi verranno caricati qui -->
                                </tbody>
                            </table>
                            <div id="emptyEventi" class="empty-state" style="display: block;">
                                <div class="icon">üìÖ</div>
                                <div>Nessun evento salvato</div>
                                <div style="font-size: 12px; margin-top: 4px;">Usa i parser nelle altre tab per aggiungere eventi</div>
                            </div>
                        </div>

                        <div class="export-options" style="margin-top: 20px;">
                            <button class="export-btn csv" onclick="esportaEventiCSV()">Esporta CSV Backtest</button>
                            <button class="export-btn json" onclick="esportaEventiJSONCompleto()">Esporta JSON Completo</button>
                            <button class="export-btn txt" onclick="esportaBacktestTXT()">Esporta Report TXT</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Importa/Esporta Database</h2>
                        <div class="button-group">
                            <button class="export-btn json" onclick="backupDatabase()">üíæ Backup Database</button>
                            <button class="export-btn txt" onclick="restoreDatabase()">üîÑ Ripristina Database</button>
                            <button class="btn-secondary" onclick="clearDatabase()" style="background: #dc2626; border-color: #dc2626;">üóëÔ∏è Cancella Tutto</button>
                        </div>
                        <div class="help-text" style="margin-top: 10px;">
                            Il database viene salvato automaticamente nel browser. Fai backup regolari.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================= -->
        <!-- NUOVA TAB: ANALISI VALUEBET -->
        <!-- ============================= -->
        <div id="tab-analisi" class="tab-content">
            <div class="tab-full-width">
                
                <!-- HEADER ANALISI -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üîç Analisi ValueBet - Pattern Recognition System</h2>
                    <p style="color: #666; margin-top: 10px;">
                        Sistema di backtest per identificare pattern, anomalie e segnali ricorrenti nelle valuebet.
                        <strong>Obiettivo:</strong> Capire QUALI valuebet funzionano, PERCH√â funzionano, e QUALI segnali si ripetono.
                    </p>
                </div>

                <!-- 1Ô∏è‚É£ FILTRI GLOBALI -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üéØ Filtri Globali di Analisi</h2>
                    <div class="filter-bar" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 0;">
                        
                        <!-- Sport -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Sport</label>
                            <select id="filtroSportAnalisi" style="width: 100%;">
                                <option value="">Tutti</option>
                                <option value="Football">Calcio</option>
                                <option value="Tennis">Tennis</option>
                            </select>
                        </div>
                        
                        <!-- Tipo Mercato -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Mercato</label>
                            <select id="filtroMercatoAnalisi" style="width: 100%;">
                                <option value="">Tutti</option>
                                <option value="HOME">HOME/1/S√å</option>
                                <option value="DRAW">DRAW/X</option>
                                <option value="AWAY">AWAY/2/NO</option>
                            </select>
                        </div>
                        
                        <!-- Bookmaker Sharp -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Sharp</label>
                            <select id="filtroSharpAnalisi" style="width: 100%;">
                                <option value="">Tutti</option>
                                <option value="pinnacle">Pinnacle</option>
                                <option value="betfair">Betfair</option>
                            </select>
                        </div>
                        
                        <!-- Bookmaker Soft -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Soft</label>
                            <select id="filtroSoftAnalisi" style="width: 100%;">
                                <option value="">Tutti</option>
                                <!-- Popolato dinamicamente -->
                            </select>
                        </div>
                        
                        <!-- Range Quota -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Range Quota</label>
                            <select id="filtroRangeQuota" style="width: 100%;">
                                <option value="">Tutte</option>
                                <option value="1.5-2.0">1.50 - 2.00</option>
                                <option value="2.0-2.5">2.00 - 2.50</option>
                                <option value="2.5-3.0">2.50 - 3.00</option>
                                <option value="3.0-4.0">3.00 - 4.00</option>
                                <option value="4.0+">4.00+</option>
                            </select>
                        </div>
                        
                        <!-- Forza Value Minima -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">FV Min (%)</label>
                            <input type="number" id="filtroFVMin" min="0" max="50" step="0.5" value="5" style="width: 100%;">
                        </div>
                        
                        <!-- Range Date -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Data da</label>
                            <input type="date" id="filtroDataDa" style="width: 100%;">
                        </div>
                        
                        <!-- Bottoni -->
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="applicaFiltriAnalisi()" style="background: #2563eb; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                Applica Filtri
                            </button>
                            <button onclick="resetFiltriAnalisi()" style="background: #6b7280; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 2Ô∏è‚É£ KPI RIASSUNTIVI -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üìä KPI Analisi - Panoramica</h2>
                    <div class="stats-backtest" style="grid-template-columns: repeat(6, 1fr);">
                        
                        <!-- Totale Value -->
                        <div class="stat-box">
                            <span class="stat-value" id="kpiTotaleValue">0</span>
                            <span class="stat-label">Totale Value</span>
                        </div>
                        
                        <!-- FV Media -->
                        <div class="stat-box">
                            <span class="stat-value" id="kpiFVMedia">0.0%</span>
                            <span class="stat-label">FV Media</span>
                        </div>
                        
                        <!-- Quota Media -->
                        <div class="stat-box">
                            <span class="stat-value" id="kpiQuotaMedia">0.00</span>
                            <span class="stat-label">Quota Media</span>
                        </div>
                        
                        <!-- Sharp pi√π frequente -->
                        <div class="stat-box">
                            <span class="stat-value" id="kpiSharpFrequente">-</span>
                            <span class="stat-label">Sharp Leader</span>
                        </div>
                        
                        <!-- Soft pi√π frequente -->
                        <div class="stat-box">
                            <span class="stat-value" id="kpiSoftFrequente">-</span>
                            <span class="stat-label">Soft Errori</span>
                        </div>
                        
                        <!-- Mercato dominante -->
                        <div class="stat-box">
                            <span class="stat-value" id="kpiMercatoDominante">-</span>
                            <span class="stat-label">Mercato Top</span>
                        </div>
                        
                    </div>
                    
                    <!-- KPI Avanzati -->
                    <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Delta Medio</div>
                            <div style="font-size: 16px; font-weight: bold; color: #2563eb;" id="kpiDeltaMedio">0.00</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Ripetizioni >2</div>
                            <div style="font-size: 16px; font-weight: bold; color: #059669;" id="kpiRipetizioni">0</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Successo Stimato</div>
                            <div style="font-size: 16px; font-weight: bold; color: #ea580c;" id="kpiSuccessoStimato">0%</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Score Affidabilit√†</div>
                            <div style="font-size: 16px; font-weight: bold; color: #9333ea;" id="kpiScoreAffidabilita">0.0</div>
                        </div>
                    </div>
                </div>

                <!-- 3Ô∏è‚É£ TABELLA ANALISI DETTAGLIATA -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üìã Dettaglio ValueBet - Analisi Pattern</h2>
                    
                    <!-- Controlli Tabella -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="esportaAnalisiCSV()" class="export-btn csv">Esporta CSV</button>
                            <button onclick="mostraSoloRipetizioni()" class="export-btn" style="background: #fef9c3; color: #854d0e;">
                                üéØ Solo Ripetizioni
                            </button>
                            <button onclick="calcolaScoreAffidabilita()" class="export-btn" style="background: #dbeafe; color: #1d4ed8;">
                                üìà Calcola Score
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <span id="contatoreRisultati">0</span> valuebet trovate
                        </div>
                    </div>
                    
                    <!-- Tabella -->
                    <div class="results-container">
                        <table class="bookmaker-table">
                            <thead>
                                <tr>
                                    <th style="width: 8%;" class="sortable-header" onclick="sortAnalisi('data')">Data/Ora</th>
                                    <th style="width: 15%;" class="sortable-header" onclick="sortAnalisi('match')">Match</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('sport')">Sport</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('mercato')">Mercato</th>
                                    <th style="width: 8%;" class="sortable-header" onclick="sortAnalisi('sharp')">Sharp</th>
                                    <th style="width: 8%;" class="sortable-header" onclick="sortAnalisi('soft')">Soft</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('quotaSharp')">Q Sharp</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('quotaSoft')">Q Soft</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('delta')">Œî</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('sm')">SM%</th>
                                    <th style="width: 6%;" class="sortable-header" onclick="sortAnalisi('fv')">FV%</th>
                                    <th style="width: 8%;" class="sortable-header" onclick="sortAnalisi('range')">Range</th>
                                    <th style="width: 7%;" class="sortable-header" onclick="sortAnalisi('ripetizione')">Rip.</th>
                                    <th style="width: 10%;" class="sortable-header" onclick="sortAnalisi('score')">Score</th>
                                </tr>
                            </thead>
                            <tbody id="tabellaAnalisi">
                                <!-- Popolato dinamicamente -->
                            </tbody>
                        </table>
                        <div id="emptyAnalisi" class="empty-state" style="display: block;">
                            <div class="icon">üìä</div>
                            <div>Nessuna valuebet trovata</div>
                            <div style="font-size: 12px; margin-top: 4px;">Usa i filtri per analizzare i dati</div>
                        </div>
                    </div>
                </div>

                <!-- 4Ô∏è‚É£ GRAFICI DI ANALISI -->
                <div class="card">
                    <h2>üìà Visualizzazione Pattern</h2>
                    
                    <!-- Selezione Grafici -->
                    <div class="tabs" style="margin-bottom: 20px; border-bottom: none;">
                        <div class="tab active" onclick="switchGrafico('grafico1')">üìä Soft pi√π Errori</div>
                        <div class="tab" onclick="switchGrafico('grafico2')">üìà Delta nel Tempo</div>
                        <div class="tab" onclick="switchGrafico('grafico3')">üß© Heatmap Mercato/Quota</div>
                        <div class="tab" onclick="switchGrafico('grafico4')">üéØ Performance per Range</div>
                    </div>
                    
                    <!-- Contenitore Grafici -->
                    <div id="grafico1" class="tab-content active" style="padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 400px;">
                        <div id="chartSoftErrori" class="chart-container"></div>
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                            Bookmaker Soft che commettono pi√π errori sistematici
                        </div>
                    </div>
                    
                    <div id="grafico2" class="tab-content" style="padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 400px;">
                        <div id="chartDeltaTempo" class="chart-container"></div>
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                            Evoluzione dello scarto Sharp-Soft nel tempo
                        </div>
                    </div>
                    
                    <div id="grafico3" class="tab-content" style="padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 400px;">
                        <div id="chartHeatmap" class="chart-container"></div>
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                            Distribuzione valuebet per mercato e range quota
                        </div>
                    </div>
                    
                    <div id="grafico4" class="tab-content" style="padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 400px;">
                        <div id="chartPerformanceRange" class="chart-container"></div>
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                            Performance stimata per range di quota
                        </div>
                    </div>
                    
                    <!-- Legenda -->
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 6px;">
                        <h4 style="margin-bottom: 10px;">üí° Come leggere i pattern:</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                            <div>
                                <strong>Pattern 1:</strong> Soft ricorrenti ‚Üí bookmaker con pricing debole
                            </div>
                            <div>
                                <strong>Pattern 2:</strong> Delta crescenti ‚Üí mercato che "scappa"
                            </div>
                            <div>
                                <strong>Pattern 3:</strong> Concentrazione in range ‚Üí zone di efficacia
                            </div>
                            <div>
                                <strong>Pattern 4:</strong> Ripetizioni temporali ‚Üí finestre di opportunit√†
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5Ô∏è‚É£ SISTEMA DI SCORE E PREDIZIONE -->
                <div class="card">
                    <h2>üéØ Score di Affidabilit√† - Sistema Predittivo</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="color: #666; margin-bottom: 15px;">
                            Assegna un punteggio a ogni valuebet in base a fattori statistici dimostrati.
                            <strong>Non predice il risultato, ma la QUALIT√Ä del segnale.</strong>
                        </p>
                        
                        <!-- Calcolatore Score -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">üìä Calcolo Score Affidabilit√†</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                            <input type="checkbox" id="scoreSharpPinnacle" checked> Sharp = Pinnacle (+2)
                                        </label>
                                        <small style="color: #888;">Il bookmaker pi√π accurato</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                            <input type="checkbox" id="scoreFV8" checked> FV > 8% (+1)
                                        </label>
                                        <small style="color: #888;">Forza Value significativa</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                            <input type="checkbox" id="scoreQuotaRange" checked> Quota 2.00-2.50 (+1)
                                        </label>
                                        <small style="color: #888;">Range ottimale per value</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                            <input type="checkbox" id="scoreSoftBet365" checked> Soft = Bet365 (+1)
                                        </label>
                                        <small style="color: #888;">Bookmaker con pricing conservativo</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                            <input type="checkbox" id="scoreDelta5" checked> Œî > 5% (+1)
                                        </label>
                                        <small style="color: #888;">Scarto significativo</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px;">
                                            <input type="checkbox" id="scorePenaltyDRAW" checked> DRAW = (-1)
                                        </label>
                                        <small style="color: #888;">Mercato tradizionalmente problematico</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="applicaScoreConfig()" style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                    Applica Configurazione
                                </button>
                                <button onclick="mostraValueTopScore()" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üèÜ Top Value (Score > 3)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Risultati Score -->
                        <div id="risultatiScore" style="display: none;">
                            <h4 style="margin-bottom: 15px;">üèÖ ValueBet con Score pi√π Alto</h4>
                            <div class="results-container" style="max-height: 300px; overflow-y: auto;">
                                <table class="bookmaker-table">
                                    <thead>
                                        <tr>
                                            <th>Score</th>
                                            <th>Match</th>
                                            <th>Sharp</th>
                                            <th>Soft</th>
                                            <th>FV%</th>
                                            <th>Range</th>
                                            <th>Affidabilit√†</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabellaTopScore">
                                        <!-- Popolato dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6Ô∏è‚É£ ESPORTAZIONE E REPORT -->
                <div class="card">
                    <h2>üì§ Esportazione Dati Analisi</h2>
                    <div class="button-group">
                        <button class="export-btn csv" onclick="esportaReportCompletoCSV()">üìä Report Completo CSV</button>
                        <button class="export-btn json" onclick="esportaPatternJSON()">üîç Pattern Analisi JSON</button>
                        <button class="export-btn txt" onclick="generaReportInsight()">üìà Report Insight TXT</button>
                        <button class="btn-success" onclick="salvaConfigAnalisi()">üíæ Salva Configurazione</button>
                    </div>
                    
                    <div class="help-text" style="margin-top: 15px;">
                        <strong>üí° Suggerimenti per l'analisi:</strong><br>
                        1. Cerca soft bookmaker che si ripetono frequentemente<br>
                        2. Identifica range di quota con maggior concentrazione di value<br>
                        3. Analizza pattern temporali (orari/giorni con pi√π value)<br>
                        4. Usa lo score per filtrare le value pi√π affidabili<br>
                        5. Esporta e analizza i dati in Excel per approfondimenti statistici
                    </div>
                </div>

            </div>
        </div>
        <!-- Tab Setup -->
        <div id="tab-setup" class="tab-content">
            <div class="tab-layout">
                <div class="tab-full-width">
                    <div class="card">
                        <h2>‚öôÔ∏è Setup Mercati</h2>
                        <p style="margin-bottom: 20px; color: #666;">
                            Configura qui i tipi di mercato disponibili per la selezione negli eventi.
                            Puoi aggiungere, modificare, eliminare e riordinare i mercati.
                        </p>
                        
                        <!-- Form per aggiungere nuovo mercato -->
                        <div class="card" style="margin-bottom: 30px; background: #f8f9fa;">
                            <h3 style="margin-bottom: 15px;">‚ûï Aggiungi Nuovo Mercato</h3>
                            <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                        Codice
                                    </label>
                                    <input type="text" id="nuovoCodice" placeholder="es: hcap" 
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                        Nome Mercato
                                    </label>
                                    <input type="text" id="nuovoNome" placeholder="es: Handicap Asiatico" 
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <button onclick="aggiungiMercato()" 
                                            style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                        Aggiungi
                                    </button>
                                </div>
                            </div>
                            <div class="help-text" style="margin-top: 10px;">
                                Il codice √® usato internamente, il nome √® quello visualizzato nella selezione.
                            </div>
                        </div>
                        
                        <!-- Lista mercati configurati -->
                        <div class="card">
                            <h3 style="margin-bottom: 15px;">üìã Mercati Configurati</h3>
                            <div class="results-container">
                                <table class="bookmaker-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Ordine</th>
                                            <th style="width: 20%;">Codice</th>
                                            <th style="width: 40%;">Nome Mercato</th>
                                            <th style="width: 15%;">Utilizzi</th>
                                            <th style="width: 15%;">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaMercati">
                                        <!-- Mercati verranno caricati qui -->
                                    </tbody>
                                </table>
                                <div id="emptyMercati" class="empty-state" style="display: block;">
                                    <div class="icon">‚öôÔ∏è</div>
                                    <div>Nessun mercato configurato</div>
                                    <div style="font-size: 12px; margin-top: 4px;">Usa il form sopra per aggiungere il primo mercato</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="salvaMercati()" 
                                        style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üíæ Salva Configurazione
                                </button>
                                <button onclick="resetMercatiDefault()" 
                                        style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üîÑ Reset a Default
                                </button>
                                <button onclick="esportaConfigurazione()" 
                                        style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üì§ Esporta Config
                                </button>
                                <button onclick="importaConfigurazione()" 
                                        style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üì• Importa Config
                                </button>
                            </div>
                            
                            <div class="help-text" style="margin-top: 20px;">
                                <strong>üí° Suggerimenti:</strong><br>
                                - Trascina le righe per riordinare i mercati<br>
                                - Clicca sul nome per modificarlo<br>
                                - I mercati sono salvati automaticamente nel browser
                            </div>
                        </div>
                        
                        <!-- Configurazione avanzata -->
                        <div class="card">
                            <h3 style="margin-bottom: 15px;">‚ö° Configurazione Avanzata</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                                <div>
                                    <h4 style="margin-bottom: 10px; font-size: 14px; color: #666;">Impostazioni Globali</h4>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 14px;">
                                            <input type="checkbox" id="autoSalva" onchange="aggiornaAutoSalva()">
                                            Auto-salva modifiche
                                        </label>
                                        <small style="color: #888;">Salva automaticamente le modifiche ai mercati</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 14px;">
                                            <input type="checkbox" id="mostraCodici" onchange="aggiornaMostraCodici()">
                                            Mostra codici nei dropdown
                                        </label>
                                        <small style="color: #888;">Mostra anche i codici accanto ai nomi nei menu a tendina</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 style="margin-bottom: 10px; font-size: 14px; color: #666;">Statistiche</h4>
                                    
                                    <div class="stats-summary" style="margin: 0;">
                                        <div class="stat-summary-item">
                                            <span class="stat-summary-value" id="totaleMercati">0</span>
                                            <span class="stat-summary-label">Mercati configurati</span>
                                        </div>
                                        <div class="stat-summary-item">
                                            <span class="stat-summary-value" id="mercatiUtilizzati">0</span>
                                            <span class="stat-summary-label">Mercati utilizzati</span>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 15px; font-size: 13px; color: #666;">
                                        <div>üîÑ Ultimo salvataggio: <span id="ultimoSalvataggio">Mai</span></div>
                                        <div>üìä Versione config: <span id="versioneConfig">1.0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tab Guida -->
<div id="tab-guida" class="tab-content">
    <div class="tab-full-width">
        
        <!-- INTRODUZIONE -->
        <div class="card">
            <h2>üìò Guida Completa - Parser Betmonitor & AIQ Calculator</h2>
            
            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                <h3 style="color: white; margin-bottom: 10px;">üéØ Scopo dello Script</h3>
                <p style="font-size: 16px; line-height: 1.6;">
                    Questo strumento nasce per <strong>automatizzare, analizzare e ottimizzare</strong> il processo di identificazione delle valuebet. 
                    Unisce in un'unica piattaforma:
                </p>
                <ul style="margin-left: 20px; margin-top: 10px; font-size: 15px;">
                    <li><strong>üîç Parsing automatico</strong> dei dati da Betmonitor</li>
                    <li><strong>üßÆ Calcolo AIQ</strong> (Algoritmo di Identificazione Quality) per valuebet</li>
                    <li><strong>üóÉÔ∏è Database</strong> per backtest e analisi storiche</li>
                    <li><strong>üìà Sistema di pattern recognition</strong> per identificare segnali ricorrenti</li>
                    <li><strong>‚öôÔ∏è Configurazione personalizzata</strong> dei mercati</li>
                </ul>
            </div>
            
            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb;">
                    <h4 style="color: #2563eb; margin-bottom: 10px;">üë• Per chi √® pensato?</h4>
                    <ul style="margin-left: 20px; color: #666;">
                        <li><strong>Scommettitori sportivi</strong> che cercano valuebet</li>
                        <li><strong>Analisti sportivi</strong> che studiano i mercati</li>
                        <li><strong>Sviluppatori</strong> che vogliono automatizzare analisi</li>
                        <li><strong>Backtester</strong> che testano strategie</li>
                    </ul>
                </div>
                
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #059669;">
                    <h4 style="color: #059669; margin-bottom: 10px;">‚ú® Vantaggi Chiave</h4>
                    <ul style="margin-left: 20px; color: #666;">
                        <li><strong>Risparmio tempo</strong>: parsing automatico</li>
                        <li><strong>Decisioni data-driven</strong>: analisi statistiche</li>
                        <li><strong>Backtest strutturato</strong>: database eventi</li>
                        <li><strong>Pattern recognition</strong>: identificazione segnali ricorrenti</li>
                        <li><strong>Export multipli</strong>: CSV, JSON, TXT</li>
                    </ul>
                </div>
            </div>
        </div>

            <!-- TABS GUIDA -->
            <div class="card">
                <h2>üß≠ Navigazione tra i Tabs</h2>
                
                <div class="tabs" style="margin-bottom: 30px;">
                    <div class="tab active" onclick="switchGuideSection('guide-3esiti')">‚öΩ 3 Esiti</div>
                    <div class="tab" onclick="switchGuideSection('guide-2esiti')">üéæ 2 Esiti</div>
                    <div class="tab" onclick="switchGuideSection('guide-eventi')">üìÖ Gestione Eventi</div>
                    <div class="tab" onclick="switchGuideSection('guide-analisi')">üîç Analisi ValueBet</div>
                    <div class="tab" onclick="switchGuideSection('guide-setup')">‚öôÔ∏è Setup</div>
                    <div class="tab" onclick="switchGuideSection('guide-tips')">üí° Tips & Tricks</div>
                </div>
                
                <!-- Sezione 3 Esiti -->
                <div id="guide-3esiti" class="guide-section active">
                    <h3 style="margin-bottom: 20px; color: #2563eb;">‚öΩ Tab 3 Esiti (Calcio - 1X2)</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>üìã Funzionalit√† Principali</h4>
                            <ul style="margin-left: 20px; color: #666;">
                                <li><strong>Mini Parser Eventi</strong>: Estrae nome evento, sport, lega, data</li>
                                <li><strong>Parser Betmonitor</strong>: Legge dati copiati (nome bookmaker + 3 quote)</li>
                                <li><strong>AIQ Calculator</strong>: Calcola se c'√® valuebet su 1, X, o 2</li>
                                <li><strong>Statistiche Automatiche</strong>: Media, min, max, sharp bookmaker</li>
                                <li><strong>Export Dati</strong>: Salva tutto in CSV/JSON/TXT</li>
                            </ul>
                            
                            <h4 style="margin-top: 20px;">üéØ Algoritmo AIQ 3 Esiti</h4>
                            <p style="color: #666; margin-bottom: 10px;">
                                L'AIQ (Algoritmo di Identificazione Quality) usa <strong>3 metriche</strong>:
                            </p>
                            <ol style="margin-left: 20px; color: #666;">
                                <li><strong>Sharp/Media (SM%)</strong>: Differenza % tra quota sharp e media</li>
                                <li><strong>Max/Min (MM%)</strong>: Differenza % tra quota max e min</li>
                                <li><strong>Sharp/Soft (SS%)</strong>: Differenza % tra quota sharp e soft</li>
                            </ol>
                            <p style="color: #666; margin-top: 10px;">
                                <strong>Condizione VALUE:</strong> SM ‚â• 5% E MM ‚â• 8% E SS ‚â• 7%
                            </p>
                        </div>
                        
                        <div>
                            <h4>üìù Formato Dati Betmonitor</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; color: #333;">
                                efbet<br>
                                efbet.net<br>
                                3.69<br>
                                3.41<br>
                                2.28<br>
                                99.7%<br>
                                1xbet<br>
                                1xbet<br>
                                3.61<br>
                                3.46<br>
                                2.23<br>
                                98.6%
                            </div>
                            <p style="color: #666; margin-top: 10px; font-size: 14px;">
                                <strong>Struttura:</strong> Nome bookmaker, Dominio, Quote (1,X,2), Percentuale
                            </p>
                            
                            <h4 style="margin-top: 20px;">‚ö° Funzionalit√† Smart</h4>
                            <ul style="margin-left: 20px; color: #666;">
                                <li><strong>Auto-Parsing</strong>: Rileva automaticamente i dati incollati</li>
                                <li><strong>Ordina colonne</strong>: Clicca intestazioni per ordinare</li>
                                <li><strong>Sharp detection</strong>: Identifica automaticamente Pinnacle/Betfair</li>
                                <li><strong>Carica esempio</strong>: Pulsante per testare</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px;">
                        <h4>üöÄ Workflow Consigliato</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="background: #2563eb; color: white; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; margin: 0 auto 10px;">1</div>
                                <strong>Copia da Betmonitor</strong><br>
                                <small style="color: #666;">Seleziona e copia i dati</small>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #2563eb; color: white; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; margin: 0 auto 10px;">2</div>
                                <strong>Incolla nell'app</strong><br>
                                <small style="color: #666;">Parsing automatico</small>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #2563eb; color: white; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; margin: 0 auto 10px;">3</div>
                                <strong>Analizza AIQ</strong><br>
                                <small style="color: #666;">Verifica valuebet</small>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #2563eb; color: white; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; margin: 0 auto 10px;">4</div>
                                <strong>Salva evento</strong><br>
                                <small style="color: #666;">Per backtest futuro</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione 2 Esiti -->
                <div id="guide-2esiti" class="guide-section">
                    <h3 style="margin-bottom: 20px; color: #dc2626;">üéæ Tab 2 Esiti (Tennis - S√¨/No)</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>üìã Funzionalit√† Specifiche</h4>
                            <ul style="margin-left: 20px; color: #666;">
                                <li><strong>Adattato per tennis</strong>: S√¨/No, Over/Under, handicap</li>
                                <li><strong>Parser ottimizzato</strong>: Riconosce formati 2 quote</li>
                                <li><strong>AIQ Tennis</strong>: Soglie calibrate per mercati binari</li>
                                <li><strong>Mercati supportati</strong>: Vincitore set, game, handicap</li>
                            </ul>
                            
                            <h4 style="margin-top: 20px;">üéØ Algoritmo AIQ 2 Esiti</h4>
                            <p style="color: #666; margin-bottom: 10px;">
                                Stesse 3 metriche del calcio, ma con <strong>interpretazione diversa</strong>:
                            </p>
                            <ul style="margin-left: 20px; color: #666;">
                                <li><strong>S√¨</strong>: Rappresenta Home/Over/Favorite</li>
                                <li><strong>No</strong>: Rappresenta Away/Under/Underdog</li>
                                <li><strong>Sharp</strong>: Pinnacle o Betfair come riferimento</li>
                                <li><strong>Soft</strong>: Bookmaker con pricing conservativo</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4>üìù Formato Dati 2 Esiti</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; color: #333;">
                                betfair<br>
                                betfair<br>
                                1.80<br>
                                2.10<br>
                                98.6%<br>
                                bet365<br>
                                bet365<br>
                                1.75<br>
                                2.15<br>
                                96.8%
                            </div>
                            <p style="color: #666; margin-top: 10px; font-size: 14px;">
                                <strong>Struttura:</strong> Nome bookmaker, Dominio, Quote (S√¨, No), Percentuale
                            </p>
                            
                            <h4 style="margin-top: 20px;">üéæ Mercati Tennis Supportati</h4>
                            <ul style="margin-left: 20px; color: #666;">
                                <li><strong>Vincitore match</strong>: Giocatore A vs Giocatore B</li>
                                <li><strong>Set betting</strong>: Punteggio esatto set</li>
                                <li><strong>Over/Under games</strong>: Totale games nel match</li>
                                <li><strong>Handicap games</strong>: Handicap sui games</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Gestione Eventi - DETTAGLIATA -->
                <div id="guide-eventi" class="guide-section">
                    <h3 style="margin-bottom: 20px; color: #059669;">üìÖ Tab Gestione Eventi - Database Backtest</h3>
                    
                    <div style="margin-bottom: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #2563eb;">
                        <h4 style="color: #2563eb;">üéØ Scopo Principale</h4>
                        <p style="color: #666;">
                            Creare un <strong>database strutturato</strong> di eventi con tutte le informazioni necessarie per:
                        </p>
                        <ul style="margin-left: 20px; color: #666;">
                            <li><strong>Backtest statistico</strong>: Verificare performance strategie</li>
                            <li><strong>Analisi pattern</strong>: Identificare segnali ricorrenti</li>
                            <li><strong>Ottimizzazione</strong>: Migliorare parametri AIQ</li>
                            <li><strong>Reportistica</strong>: Generare statistiche di performance</li>
                        </ul>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h4>üìä Struttura Database</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Ogni evento salvato contiene:
                            </p>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #333;">üìã Informazioni Base</h5>
                                <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                    <li><strong>ID univoco</strong>: Generato automaticamente</li>
                                    <li><strong>Nome evento</strong>: Es. "Juventus vs Milan"</li>
                                    <li><strong>Sport & Lega</strong>: Categoria e competizione</li>
                                    <li><strong>Data/Ora</strong>: Timestamp preciso</li>
                                    <li><strong>Tipo quotes</strong>: 3 esiti o 2 esiti</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #333;">üéØ Dati Valuebet</h5>
                                <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                    <li><strong>Tipo scommessa</strong>: Mercato selezionato</li>
                                    <li><strong>Value su</strong>: Esito identificato come value</li>
                                    <li><strong>Risultato reale</strong>: Esito verificato</li>
                                    <li><strong>Profitto/ROI</strong>: Calcolato automaticamente</li>
                                    <li><strong>Quote & bookmaker</strong>: Dati precisi della scommessa</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div>
                            <h4>üîß Funzionalit√† Avanzate</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333;">üìà Calcolo Automatico Performance</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Quando inserisci <strong>"Value su"</strong> e <strong>"Risultato reale"</strong>, il sistema calcola automaticamente:
                                </p>
                                <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                    <li><strong>Ha vinto?</strong>: Confronto value vs risultato</li>
                                    <li><strong>Profitto</strong>: Basato su quota e stake (default: 10‚Ç¨)</li>
                                    <li><strong>ROI</strong>: Return on Investment in percentuale</li>
                                    <li><strong>Successo/fallimento</strong>: Per analisi statistiche</li>
                                </ul>
                            </div>
                            
                            <div>
                                <h5 style="color: #333;">üîç Filtri e Ricerca</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Trova velocemente gli eventi che ti interessano:
                                </p>
                                <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                    <li><strong>Ricerca testo</strong>: Cerca per nome evento o ID</li>
                                    <li><strong>Filtro sport</strong>: Solo calcio, solo tennis, ecc.</li>
                                    <li><strong>Visualizzazione</strong>: Ordinamento per data</li>
                                    <li><strong>Export selettivo</strong>: Esporta solo eventi filtrati</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #059669;">üíæ Sistema di Salvataggio</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üìÅ Local Storage</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Tutti i dati sono salvati nel <strong>browser</strong>. Non serve login o server.
                                </p>
                            </div>
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üíæ Backup/Ripristino</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Esporta tutto in JSON e ripristina quando vuoi. <strong>Fai backup regolari!</strong>
                                </p>
                            </div>
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üîÑ Sincronizzazione</h5>
                                <p style="color: #666; font-size: 14px;">
                                    I dati sono disponibili solo su <strong>questo browser</strong>. Per sincronizzare tra dispositivi, esporta e importa.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #92400e;">üìä Workflow Backtest Completo</h4>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="background: #92400e; color: white; width: 25px; height: 25px; line-height: 25px; border-radius: 50%; margin: 0 auto 5px; font-size: 12px;">1</div>
                                <div style="font-size: 12px;"><strong>Parsa</strong> evento e quotes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #92400e; color: white; width: 25px; height: 25px; line-height: 25px; border-radius: 50%; margin: 0 auto 5px; font-size: 12px;">2</div>
                                <div style="font-size: 12px;"><strong>Salva</strong> nel database</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #92400e; color: white; width: 25px; height: 25px; line-height: 25px; border-radius: 50%; margin: 0 auto 5px; font-size: 12px;">3</div>
                                <div style="font-size: 12px;"><strong>Segna</strong> value su</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #92400e; color: white; width: 25px; height: 25px; line-height: 25px; border-radius: 50%; margin: 0 auto 5px; font-size: 12px;">4</div>
                                <div style="font-size: 12px;"><strong>Inserisci</strong> risultato</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #92400e; color: white; width: 25px; height: 25px; line-height: 25px; border-radius: 50%; margin: 0 auto 5px; font-size: 12px;">5</div>
                                <div style="font-size: 12px;"><strong>Analizza</strong> performance</div>
                            </div>
                        </div>
                        <p style="color: #92400e; margin-top: 15px; font-size: 14px; text-align: center;">
                            ‚ö° <strong>Pro Tip:</strong> Completa almeno 50-100 eventi prima di trarre conclusioni statistiche significative.
                        </p>
                    </div>
                </div>
                
                <!-- Sezione Analisi ValueBet - DETTAGLIATA -->
                <div id="guide-analisi" class="guide-section">
                    <h3 style="margin-bottom: 20px; color: #7c3aed;">üîç Tab Analisi ValueBet - Pattern Recognition System</h3>
                    
                    <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 8px;">
                        <h4 style="color: white;">üéØ Filosofia del Sistema</h4>
                        <p style="font-size: 16px; line-height: 1.6;">
                            Non si tratta di <strong>predire il futuro</strong>, ma di <strong>identificare pattern statistici</strong> che si ripetono.
                            Il sistema analizza il database per rispondere a:
                        </p>
                        <ul style="margin-left: 20px; font-size: 15px;">
                            <li><strong>QUALI</strong> valuebet funzionano realmente?</li>
                            <li><strong>PERCH√â</strong> alcune valuebet sono pi√π affidabili?</li>
                            <li><strong>QUANDO</strong> si verificano certe condizioni favorevoli?</li>
                            <li><strong>CHI</strong> (quali bookmaker) commette errori sistematici?</li>
                        </ul>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h4>üß© Sistema di Pattern Recognition</h4>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h5 style="margin-top: 0; color: #7c3aed;">Pattern 1: Soft Ricorrenti</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Identifica bookmaker "soft" che commettono <strong>errori sistematici</strong> su specifici mercati o range di quota.
                                </p>
                                <ul style="margin-left: 20px; color: #666; font-size: 13px;">
                                    <li><strong>Esempio:</strong> "Bet365 sbaglia spesso su HOME in range 2.0-2.5"</li>
                                    <li><strong>Segnale:</strong> Ripetizione > 2 volte dello stesso pattern</li>
                                    <li><strong>Azione:</strong> Monitorare quel bookmaker su quel mercato</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h5 style="margin-top: 0; color: #7c3aed;">Pattern 2: Delta Crescenti</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Rileva quando lo <strong>scarto Sharp-Soft</strong> aumenta nel tempo per certi mercati.
                                </p>
                                <ul style="margin-left: 20px; color: #666; font-size: 13px;">
                                    <li><strong>Esempio:</strong> "Delta su OVER in tennis aumenta nei weekend"</li>
                                    <li><strong>Segnale:</strong> Trend positivo del delta %</li>
                                    <li><strong>Azione:</strong> Sfruttare finestre temporali favorevoli</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #7c3aed;">Pattern 3: Concentrazione Range</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Identifica <strong>range di quota</strong> dove si concentrano le valuebet pi√π profittevoli.
                                </p>
                                <ul style="margin-left: 20px; color: #666; font-size: 13px;">
                                    <li><strong>Esempio:</strong> "70% delle valuebet vincenti sono in range 2.0-2.5"</li>
                                    <li><strong>Segnale:</strong> Alta densit√† di valuebet in un range</li>
                                    <li><strong>Azione:</strong> Focus su quel range, filtra gli altri</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div>
                            <h4>üéØ Sistema di Score Affidabilit√†</h4>
                            
                            <div style="background: #faf5ff; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                                <h5 style="margin-top: 0; color: #7c3aed;">Come funziona lo Score?</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Ogni valuebet riceve un <strong>punteggio da 0 a 5+</strong> basato su fattori statistici dimostrati:
                                </p>
                                
                                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                    <div style="background: #f3f4f6; padding: 8px; border-radius: 4px;">
                                        <strong>Sharp = Pinnacle</strong><br>
                                        <small>+2 punti (pi√π accurato)</small>
                                    </div>
                                    <div style="background: #f3f4f6; padding: 8px; border-radius: 4px;">
                                        <strong>FV > 8%</strong><br>
                                        <small>+1 punto (value forte)</small>
                                    </div>
                                    <div style="background: #f3f4f6; padding: 8px; border-radius: 4px;">
                                        <strong>Range 2.0-2.5</strong><br>
                                        <small>+1 punto (range ottimale)</small>
                                    </div>
                                    <div style="background: #f3f4f6; padding: 8px; border-radius: 4px;">
                                        <strong>Soft = Bet365</strong><br>
                                        <small>+1 punto (pricing conservativo)</small>
                                    </div>
                                    <div style="background: #f3f4f6; padding: 8px; border-radius: 4px;">
                                        <strong>Œî > 5%</strong><br>
                                        <small>+1 punto (scarto significativo)</small>
                                    </div>
                                    <div style="background: #fee2e2; padding: 8px; border-radius: 4px;">
                                        <strong>Mercato = DRAW</strong><br>
                                        <small>-1 punto (problematico)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #2563eb;">üìä Interpretazione Score</h5>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 12px;">
                                    <div style="text-align: center; background: #fee2e2; padding: 10px; border-radius: 4px;">
                                        <strong>0-1.9</strong><br>
                                        <small>Bassa affidabilit√†</small>
                                    </div>
                                    <div style="text-align: center; background: #fef9c3; padding: 10px; border-radius: 4px;">
                                        <strong>2-2.9</strong><br>
                                        <small>Affidabilit√† media</small>
                                    </div>
                                    <div style="text-align: center; background: #dcfce7; padding: 10px; border-radius: 4px;">
                                        <strong>3+</strong><br>
                                        <small>Alta affidabilit√†</small>
                                    </div>
                                </div>
                                <p style="color: #666; margin-top: 10px; font-size: 13px;">
                                    <strong>Pro Tip:</strong> Filtra per score ‚â• 3 per aumentare le probabilit√† di successo.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #92400e;">üìà Grafici di Analisi</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px;">
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üìä Soft pi√π Errori</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Bar chart che mostra quali bookmaker soft commettono pi√π errori. <strong>Identifica i candidati ideali</strong> per valuebet.
                                </p>
                            </div>
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üìà Delta nel Tempo</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Line chart che mostra l'evoluzione dello scarto Sharp-Soft. <strong>Identifica trend</strong> e finestre temporali favorevoli.
                                </p>
                            </div>
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üß© Heatmap Mercato/Quota</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Mappa di calore che mostra dove si concentrano le valuebet. <strong>Identifica zone calde</strong> per profitto.
                                </p>
                            </div>
                            <div>
                                <h5 style="color: #333; margin-bottom: 10px;">üéØ Performance per Range</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Doppio asse che mostra numero di valuebet e successo stimato per range. <strong>Ottimizza la selezione</strong> delle quote.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #059669;">üöÄ Strategia di Utilizzo Avanzato</h4>
                        
                        <div style="margin-top: 15px;">
                            <h5 style="color: #333;">Fase 1: Raccolta Dati (Minimo 50 eventi)</h5>
                            <p style="color: #666; font-size: 14px;">
                                Usa i parser per accumulare eventi nel database. <strong>Non saltare questa fase</strong> - pi√π dati, pi√π accurata l'analisi.
                            </p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h5 style="color: #333;">Fase 2: Analisi Pattern</h5>
                            <p style="color: #666; font-size: 14px;">
                                Usa i filtri per identificare:
                            </p>
                            <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                <li>Quali soft bookmaker si ripetono</li>
                                <li>Quali range di quota sono pi√π frequenti</li>
                                <li>Quali mercati hanno delta pi√π alti</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h5 style="color: #333;">Fase 3: Ottimizzazione Parametri</h5>
                            <p style="color: #666; font-size: 14px;">
                                Basandoti sui dati, modifica:
                            </p>
                            <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                <li>Soglie AIQ (SM, MM, SS)</li>
                                <li>Configurazione score</li>
                                <li>Filtri di analisi</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h5 style="color: #333;">Fase 4: Implementazione e Monitoraggio</h5>
                            <p style="color: #666; font-size: 14px;">
                                Applica i pattern identificati e <strong>continua a raccogliere dati</strong> per validare/ottimizzare.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Setup -->
                <div id="guide-setup" class="guide-section">
                    <h3 style="margin-bottom: 20px; color: #ea580c;">‚öôÔ∏è Tab Setup - Configurazione Personalizzata</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>üéØ Configurazione Mercati</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Personalizza i tipi di mercato disponibili nella selezione eventi:
                            </p>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h5 style="margin-top: 0; color: #ea580c;">‚ûï Aggiungi Nuovo Mercato</h5>
                                <p style="color: #666; font-size: 14px;">
                                    <strong>Codice</strong>: Usato internamente (es: "hcap")<br>
                                    <strong>Nome</strong>: Visualizzato nei dropdown (es: "Handicap Asiatico")
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #ea580c;">üîÑ Drag & Drop</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Trascina le righe per <strong>riordinare i mercati</strong> nell'elenco. L'ordine si riflette nei dropdown.
                                </p>
                            </div>
                        </div>
                        
                        <div>
                            <h4>‚ö° Impostazioni Globali</h4>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #ea580c;">üíæ Auto-Salvataggio</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Quando attivo, le modifiche ai mercati sono salvate automaticamente. <strong>Consigliato: ON</strong>
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #ea580c;">üëÅÔ∏è Mostra Codici</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Mostra i codici accanto ai nomi nei dropdown. <strong>Utile per sviluppatori</strong>.
                                </p>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <h5 style="color: #333;">üîÑ Operazioni Disponibili</h5>
                                <ul style="margin-left: 20px; color: #666; font-size: 14px;">
                                    <li><strong>Reset a default</strong>: Torna ai mercati predefiniti</li>
                                    <li><strong>Esporta config</strong>: Salva configurazione in JSON</li>
                                    <li><strong>Importa config</strong>: Carica configurazione da file</li>
                                    <li><strong>Backup/ripristino</strong>: Gestisci versioni diverse</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Tips & Tricks -->
                <div id="guide-tips" class="guide-section">
                    <h3 style="margin-bottom: 20px; color: #9333ea;">üí° Tips & Tricks - Utilizzo Avanzato</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px;">
                        <div>
                            <h4>üöÄ Performance & Ottimizzazione</h4>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #9333ea;">‚ö° Parsing Automatico</h5>
                                <p style="color: #666; font-size: 14px;">
                                    <strong>Non serve pi√π cliccare "Parsa Dati"!</strong> Basta incollare i dati da Betmonitor e il sistema li elabora automaticamente.
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #9333ea;">üìä Dati di Qualit√†</h5>
                                <p style="color: #666; font-size: 14px;">
                                    <strong>Pi√π dati = analisi migliore</strong>. Accumula almeno 100 eventi prima di prendere decisioni basate sui pattern.
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #9333ea;">üîÑ Aggiornamento Regolare</h5>
                                <p style="color: #666; font-size: 14px;">
                                    I bookmaker cambiano algoritmi. <strong>Aggiorna regolarmente</strong> il database per mantenere l'analisi valida.
                                </p>
                            </div>
                        </div>
                        
                        <div>
                            <h4>üéØ Strategie di Utilizzo</h4>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #9333ea;">üîç Focus su Pattern Ripetuti</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Cerca soft bookmaker che si ripetono frequentemente. <strong>Un pattern ripetuto 3+ volte √® un segnale forte</strong>.
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #9333ea;">üìà Utilizza lo Score</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Filtra per <strong>score ‚â• 3</strong> per aumentare significativamente le probabilit√† di successo.
                                </p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <h5 style="margin-top: 0; color: #9333ea;">üíæ Backup Regolari</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Il database √® salvato nel browser. <strong>Fai backup settimanali</strong> per non perdere dati.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="color: #2563eb;">‚ö†Ô∏è Avvertenze Importanti</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px;">
                            <div>
                                <h5 style="color: #333;">üìâ Gestione del Rischio</h5>
                                <p style="color: #666; font-size: 14px;">
                                    Questo √® uno <strong>strumento di analisi</strong>, non un sistema infallibile. Usa sempre una corretta gestione del bankroll.
                                </p>
                            </div>
                            
                            <div>
                                <h5 style="color: #333;">üîç Validazione Continua</h5>
                                <p style="color: #666; font-size: 14px;">
                                    I pattern del passato non garantiscono risultati futuri. <strong>Continua a testare e validare</strong> le tue strategie.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ -->
            <div class="card">
                <h2>‚ùì FAQ - Domande Frequenti</h2>
                
                <div style="margin-top: 20px;">
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eaeaea;">
                        <h4 style="color: #333;">Q: I dati sono salvati su server?</h4>
                        <p style="color: #666;">
                            <strong>A:</strong> No, tutto √® salvato <strong>localmente nel tuo browser</strong> (Local Storage). Per backup tra dispositivi, usa l'export/import.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eaeaea;">
                        <h4 style="color: #333;">Q: Quanti eventi servono per analisi significative?</h4>
                        <p style="color: #666;">
                            <strong>A:</strong> Minimo <strong>50 eventi</strong> per analisi base, <strong>100+</strong> per pattern affidabili, <strong>200+</strong> per statistiche solide.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eaeaea;">
                        <h4 style="color: #333;">Q: L'AIQ garantisce valuebet vincenti?</h4>
                        <p style="color: #666;">
                            <strong>A:</strong> No, identifica <strong>discrepanze di prezzo</strong> tra bookmaker. √à uno strumento di analisi, non di predizione.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eaeaea;">
                        <h4 style="color: #333;">Q: Posso modificare le soglie AIQ?</h4>
                        <p style="color: #666;">
                            <strong>A:</strong> S√¨, modifica le costanti <code>THRESHOLDS</code> nel codice (SM: 5, MM: 8, SS: 7).
                        </p>
                    </div>
                    
                    <div>
                        <h4 style="color: #333;">Q: Come sincronizzo tra pi√π dispositivi?</h4>
                        <p style="color: #666;">
                            <strong>A:</strong> Usa <strong>Backup Database</strong> per esportare e <strong>Ripristina Database</strong> per importare su altri dispositivi.
                        </p>
                    </div>
                </div>
            </div>

            <!-- CONTATTI & SUPPORTO -->
            <div class="card">
                <h2>üìû Supporto & Contributi</h2>
                
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üêõ</div>
                            <h5 style="margin-bottom: 10px;">Segnala Bug</h5>
                            <p style="color: #666; font-size: 14px;">
                                Problemi di parsing? Errori nei calcoli? Segnalali per migliorare lo strumento.
                            </p>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üí°</div>
                            <h5 style="margin-bottom: 10px;">Suggerimenti</h5>
                            <p style="color: #666; font-size: 14px;">
                                Nuove funzionalit√†? Miglioramenti? Condividi le tue idee.
                            </p>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üöÄ</div>
                            <h5 style="margin-bottom: 10px;">Contributi</h5>
                            <p style="color: #666; font-size: 14px;">
                                Sviluppatore? Aiuta a migliorare il codice su GitHub.
                            </p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 14px;">
                        <p>
                            <strong>Versione:</strong> 2.0 | <strong>Ultimo aggiornamento:</strong> Gennaio 2024<br>
                            <strong>Licenza:</strong> Open Source per uso personale
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>

    <div class="notification" id="notification"></div>
    <div class="aiq-tooltip" id="aiqTooltip"></div>

    <!-- Modal per dettagli evento -->
    <div id="eventoModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìä Dettagli Evento</h2>
                <button onclick="chiudiModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div id="modalEventoInfo" style="margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <!-- Info evento verranno inserite qui -->
            </div>
            
            <div id="modalAIQInfo" style="margin-bottom: 30px; padding: 15px; background: #f0f9ff; border-radius: 6px;">
                <!-- Info AIQ verranno inserite qui -->
            </div>
            
            <div id="modalQuotesContainer">
                <!-- Tabella quotes verr√† inserita qui -->
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="chiudiModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Chiudi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Includiamo Chart.js per i grafici -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ==============================
        // VARIABILI GLOBALI
        // ==============================
        let parsedData3 = [];  // Dati per 3 esiti
        let parsedData2 = [];  // Dati per 2 esiti
        let eventoCorrente3 = null;  // Per tab 3 esiti
        let eventoCorrente2 = null;  // Per tab 2 esiti
        const sharpBookmakers = ['pinnacle', 'betfair'];
        
        // AIQ Calculator Constants
        const THRESHOLDS = { sm: 5, mm: 8, ss: 7 };
        const NEAR_THRESHOLD = 0.5;
        const aiqTooltip = document.getElementById("aiqTooltip");
        
        // Variabili per la gestione eventi
        let eventoCorrente = null;
        let databaseEventi = JSON.parse(localStorage.getItem('databaseEventi') || '[]');
        let eventoCorrenteId = null;
        
        // Ordinamento per 3 esiti
        let currentSort3 = {
            column: null,
            direction: 'asc'
        };
        
        // Ordinamento per 2 esiti
        let currentSort2 = {
            column: null,
            direction: 'asc'
        };

        // ==============================
        // VARIABILI PER ANALISI VALUEBET
        // ==============================
        let datiAnalisi = [];
        let filtriAttivi = {};
        let currentSortAnalisi = { column: null, direction: 'asc' };
        let configScore = {
            sharpPinnacle: true,
            softBet365: true,
            fv8: true,
            quotaRange: true,
            delta5: true,
            penaltyDRAW: true
        };
        
        // Variabili per i grafici
        let chartSoftErrori = null;
        let chartDeltaTempo = null;
        let chartHeatmap = null;
        let chartPerformanceRange = null;

        /*****************************
         * STORICO VALUEBET
         *****************************/
        const STORAGE_KEY = 'aiq_valuebet_history';

        function loadHistory() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        function saveHistory(history) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        // ==============================
        // FUNZIONI TAB
        // ==============================
        function switchTab(tabId) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra il tab selezionato
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // Azioni specifiche per ogni tab
            if (tabId === 'tab-analisi') {
                initTabAnalisi();
            } else if (tabId === 'tab-eventi') {
                mostraTabellaEventi();
                aggiornaFiltriSport();
            } else if (tabId === 'tab-setup') {
                initMercati();
            } else if (tabId === 'tab-guida') { 
            initTabGuida();
            }
        }

        // ==============================
        // FUNZIONI AIQ CALCULATOR
        // ==============================
        function showAiqTooltip(text, e) {
            aiqTooltip.innerText = text;
            aiqTooltip.style.left = e.clientX + 12 + "px";
            aiqTooltip.style.top  = e.clientY + 12 + "px";
            aiqTooltip.style.opacity = 1;
        }
        
        function hideAiqTooltip() {
            aiqTooltip.style.opacity = 0;
        }

        function applyAiqTooltip(el, text) {
            el.onmousemove = e => showAiqTooltip(text, e);
            el.onmouseleave = hideAiqTooltip;
        }

        function styleAiqCell(el, value, th) {
            el.className = "";
            if (value >= th) {
                el.classList.add("aiq-ok");
                applyAiqTooltip(el, "üü¢ Condizione OK");
            } else if (value >= th - NEAR_THRESHOLD) {
                el.classList.add("aiq-warn");
                applyAiqTooltip(el, "üü° Vicino alla soglia");
            } else {
                applyAiqTooltip(el, "üî¥ Condizione NON OK");
            }
        }

        function saveValueBet(entry) {
            const history = loadHistory();

            // evita duplicati (match + outcome)
            const exists = history.some(v =>
                v.match === entry.match &&
                v.outcome === entry.outcome &&
                v.sport === entry.sport
            );

            if (!exists) {
                history.push(entry);
                saveHistory(history);
            }
        }

        function calculateAiq(title, outcome) {
            const g = k => parseFloat(document.getElementById(`${title}_${k}_${outcome}`).value);
            const sharp = g("Sharp"), media = g("Media"), min = g("Min"), max = g("Max");
            if([sharp, media, min, max].some(isNaN)) return;

            const sm = ((sharp - media) / media) * 100;
            const mm = ((max - min) / min) * 100;
            const ss = ((sharp - min) / min) * 100;
            const fv = (sm + mm + ss) / 3;

            const smEl = document.getElementById(`${title}_sm_${outcome}`);
            const mmEl = document.getElementById(`${title}_mm_${outcome}`);
            const ssEl = document.getElementById(`${title}_ss_${outcome}`);
            const fvEl = document.getElementById(`${title}_fv_${outcome}`);
            const resEl = document.getElementById(`${title}_res_${outcome}`);

            smEl.innerText = sm.toFixed(2) + "%";
            mmEl.innerText = mm.toFixed(2) + "%";
            ssEl.innerText = ss.toFixed(2) + "%";
            fvEl.innerText = fv.toFixed(2) + "%";

            styleAiqCell(smEl, sm, THRESHOLDS.sm);
            styleAiqCell(mmEl, mm, THRESHOLDS.mm);
            styleAiqCell(ssEl, ss, THRESHOLDS.ss);

            const smOK = sm >= THRESHOLDS.sm;
            const mmOK = mm >= THRESHOLDS.mm;
            const ssOK = ss >= THRESHOLDS.ss;
            const value = smOK && mmOK && ssOK;

            fvEl.className = value ? "aiq-ok" : "";
            applyAiqTooltip(fvEl, value ? "‚≠ê ValueBet confermata" : "‚Ñπ Media delle metriche");

            resEl.innerText = value ? "VALUE" : "NO VALUE";
            resEl.className = value ? "aiq-result aiq-value" : "aiq-result aiq-novalue";

            if (value) {
                saveValueBet({
                    sport: title.includes('CALCIO') ? 'CALCIO' : 'TENNIS',
                    match: document.getElementById('matchName')?.value || 'N/D',
                    outcome: outcome,
                    sharp: sharp,
                    media: media,
                    min: min,
                    max: max,
                    sm: sm,
                    mm: mm,
                    ss: ss,
                    forza: fv,
                    timestamp: new Date().toLocaleString()
                });
            }
        }

        // ==============================
        // FUNZIONI 3 ESITI
        // ==============================
        function loadExample3Esiti() {
            const example = `efbet
efbet.net
3.69
3.41
2.28
99.7%
1xbet
1xbet
3.61
3.46
2.23
98.6%
tipico
tipico
3.60
3.30
2.10
94.3%
betfair
betfair
3.60
3.40
2.32
99.7%
betsensation
betsensation
3.56
3.30
2.22
96.6%
pinnacle
pinnacle
3.52
3.27
2.28
97.2%`;
            
            document.getElementById('inputData3').value = example;
            showNotification('Esempio 3 esiti caricato', 'info');
        }

        function parseData3Esiti() {
            const input = document.getElementById('inputData3').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati da Betmonitor', 'error');
                return;
            }

            parsedData3 = [];
            const debugInfo = [];
            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');

            let i = 0;
            while (i < lines.length) {
                // Pattern: nome, dominio, 3 quote, percentuale
                if (i + 5 < lines.length) {
                    const bookmakerName = lines[i].toLowerCase();
                    const quote1 = parseFloat(lines[i + 2]);
                    const quoteX = parseFloat(lines[i + 3]);
                    const quote2 = parseFloat(lines[i + 4]);

                    if (!isNaN(quote1) && !isNaN(quoteX) && !isNaN(quote2)) {
                        parsedData3.push({
                            bookmaker: bookmakerName,
                            quote1: quote1,
                            quoteX: quoteX,
                            quote2: quote2,
                            isSharp: sharpBookmakers.includes(bookmakerName)
                        });
                        i += 6; // Salta al prossimo bookmaker
                        continue;
                    }
                }
                i++;
            }

            if (parsedData3.length === 0) {
                showNotification('Nessun dato valido trovato', 'error');
                document.getElementById('debugInfo3').innerHTML = debugInfo.join('<br>');
                document.getElementById('debugInfo3').style.display = 'block';
            } else {
                document.getElementById('debugInfo3').style.display = 'none';
                displayResults3();
                updateStats3();
                updateAiqCalculatorFromParser3();
                resetSort3();
                showNotification(`Trovati ${parsedData3.length} bookmaker (3 esiti)`, 'success');
            }
        }

        function calculateStatistics3() {
            if (parsedData3.length === 0) {
                return {
                    avg1: 0, avgX: 0, avg2: 0,
                    min1: 0, minX: 0, min2: 0,
                    max1: 0, maxX: 0, max2: 0,
                    minBook1: '', minBookX: '', minBook2: '',
                    maxBook1: '', maxBookX: '', maxBook2: '',
                    pinnacle1: null, pinnacleX: null, pinnacle2: null,
                    betfair1: null, betfairX: null, betfair2: null,
                    sharpCount: 0
                };
            }

            let min1 = parsedData3[0].quote1, minX = parsedData3[0].quoteX, min2 = parsedData3[0].quote2;
            let max1 = parsedData3[0].quote1, maxX = parsedData3[0].quoteX, max2 = parsedData3[0].quote2;
            let minBook1 = parsedData3[0].bookmaker, minBookX = parsedData3[0].bookmaker, minBook2 = parsedData3[0].bookmaker;
            let maxBook1 = parsedData3[0].bookmaker, maxBookX = parsedData3[0].bookmaker, maxBook2 = parsedData3[0].bookmaker;
            let total1 = 0, totalX = 0, total2 = 0;
            let sharpCount = 0;

            let pinnacle1 = null, pinnacleX = null, pinnacle2 = null;
            let betfair1 = null, betfairX = null, betfair2 = null;

            parsedData3.forEach(item => {
                total1 += item.quote1;
                totalX += item.quoteX;
                total2 += item.quote2;

                if (item.quote1 < min1) { min1 = item.quote1; minBook1 = item.bookmaker; }
                if (item.quote1 > max1) { max1 = item.quote1; maxBook1 = item.bookmaker; }
                if (item.quoteX < minX) { minX = item.quoteX; minBookX = item.bookmaker; }
                if (item.quoteX > maxX) { maxX = item.quoteX; maxBookX = item.bookmaker; }
                if (item.quote2 < min2) { min2 = item.quote2; minBook2 = item.bookmaker; }
                if (item.quote2 > max2) { max2 = item.quote2; maxBook2 = item.bookmaker; }
                
                if (item.bookmaker === 'pinnacle') {
                    pinnacle1 = item.quote1;
                    pinnacleX = item.quoteX;
                    pinnacle2 = item.quote2;
                    sharpCount++;
                }
                if (item.bookmaker === 'betfair') {
                    betfair1 = item.quote1;
                    betfairX = item.quoteX;
                    betfair2 = item.quote2;
                    sharpCount++;
                }
            });

            return {
                avg1: total1 / parsedData3.length,
                avgX: totalX / parsedData3.length,
                avg2: total2 / parsedData3.length,
                min1, minX, min2,
                max1, maxX, max2,
                minBook1, minBookX, minBook2,
                maxBook1, maxBookX, maxBook2,
                pinnacle1, pinnacleX, pinnacle2,
                betfair1, betfairX, betfair2,
                sharpCount
            };
        }

        function updateStats3() {
            const stats = calculateStatistics3();
            
            document.getElementById('totalBooks3').textContent = parsedData3.length;
            document.getElementById('sharpBooks3').textContent = stats.sharpCount;

            document.getElementById('avgQuote1').textContent = stats.avg1.toFixed(2);
            document.getElementById('minQuote1').textContent = stats.min1.toFixed(2);
            document.getElementById('maxQuote1').textContent = stats.max1.toFixed(2);
            document.getElementById('minBook1').textContent = formatBookmakerName(stats.minBook1);
            document.getElementById('maxBook1').textContent = formatBookmakerName(stats.maxBook1);
            
            document.getElementById('pinnacleQuote1').textContent = stats.pinnacle1 !== null ? stats.pinnacle1.toFixed(2) : '-';
            document.getElementById('betfairQuote1').textContent = stats.betfair1 !== null ? stats.betfair1.toFixed(2) : '-';

            document.getElementById('avgQuoteX').textContent = stats.avgX.toFixed(2);
            document.getElementById('minQuoteX').textContent = stats.minX.toFixed(2);
            document.getElementById('maxQuoteX').textContent = stats.maxX.toFixed(2);
            document.getElementById('minBookX').textContent = formatBookmakerName(stats.minBookX);
            document.getElementById('maxBookX').textContent = formatBookmakerName(stats.maxBookX);
            
            document.getElementById('pinnacleQuoteX').textContent = stats.pinnacleX !== null ? stats.pinnacleX.toFixed(2) : '-';
            document.getElementById('betfairQuoteX').textContent = stats.betfairX !== null ? stats.betfairX.toFixed(2) : '-';

            document.getElementById('avgQuote2').textContent = stats.avg2.toFixed(2);
            document.getElementById('minQuote2').textContent = stats.min2.toFixed(2);
            document.getElementById('maxQuote2').textContent = stats.max2.toFixed(2);
            document.getElementById('minBook2').textContent = formatBookmakerName(stats.minBook2);
            document.getElementById('maxBook2').textContent = formatBookmakerName(stats.maxBook2);
            
            document.getElementById('pinnacleQuote2').textContent = stats.pinnacle2 !== null ? stats.pinnacle2.toFixed(2) : '-';
            document.getElementById('betfairQuote2').textContent = stats.betfair2 !== null ? stats.betfair2.toFixed(2) : '-';
        }

        function updateAiqCalculatorFromParser3() {
            const stats = calculateStatistics3();
            
            // Aggiorna il calcolatore AIQ CALCIO con i dati del parser
            // Pulisci prima tutti i campi
            document.getElementById('AIQ CALCIO_Sharp_HOME').value = '';
            document.getElementById('AIQ CALCIO_Sharp_DRAW').value = '';
            document.getElementById('AIQ CALCIO_Sharp_AWAY').value = '';
            
            document.getElementById('AIQ CALCIO_Media_HOME').value = '';
            document.getElementById('AIQ CALCIO_Media_DRAW').value = '';
            document.getElementById('AIQ CALCIO_Media_AWAY').value = '';
            
            document.getElementById('AIQ CALCIO_Min_HOME').value = '';
            document.getElementById('AIQ CALCIO_Max_HOME').value = '';
            
            document.getElementById('AIQ CALCIO_Min_DRAW').value = '';
            document.getElementById('AIQ CALCIO_Max_DRAW').value = '';
            
            document.getElementById('AIQ CALCIO_Min_AWAY').value = '';
            document.getElementById('AIQ CALCIO_Max_AWAY').value = '';
            
            // Solo se ci sono dati validi, inseriscili
            if (stats.pinnacle1 !== null) {
                document.getElementById('AIQ CALCIO_Sharp_HOME').value = stats.pinnacle1.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_DRAW').value = stats.pinnacleX.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_AWAY').value = stats.pinnacle2.toFixed(2);
            } else if (stats.betfair1 !== null) {
                document.getElementById('AIQ CALCIO_Sharp_HOME').value = stats.betfair1.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_DRAW').value = stats.betfairX.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_AWAY').value = stats.betfair2.toFixed(2);
            }
            
            if (parsedData3.length > 0) {
                document.getElementById('AIQ CALCIO_Media_HOME').value = stats.avg1.toFixed(2);
                document.getElementById('AIQ CALCIO_Media_DRAW').value = stats.avgX.toFixed(2);
                document.getElementById('AIQ CALCIO_Media_AWAY').value = stats.avg2.toFixed(2);
                
                document.getElementById('AIQ CALCIO_Min_HOME').value = stats.min1.toFixed(2);
                document.getElementById('AIQ CALCIO_Max_HOME').value = stats.max1.toFixed(2);
                
                document.getElementById('AIQ CALCIO_Min_DRAW').value = stats.minX.toFixed(2);
                document.getElementById('AIQ CALCIO_Max_DRAW').value = stats.maxX.toFixed(2);
                
                document.getElementById('AIQ CALCIO_Min_AWAY').value = stats.min2.toFixed(2);
                document.getElementById('AIQ CALCIO_Max_AWAY').value = stats.max2.toFixed(2);
            }
            
            // Ricalcola AIQ
            calculateAiq('AIQ CALCIO', 'HOME');
            calculateAiq('AIQ CALCIO', 'DRAW');
            calculateAiq('AIQ CALCIO', 'AWAY');
        }

        function displayResults3() {
            const tableBody = document.getElementById('resultsTable3');
            const emptyState = document.getElementById('emptyState3');
            
            if (parsedData3.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tableBody.innerHTML = parsedData3.map(item => `
                <tr>
                    <td>
                        <span class="bookmaker-name ${item.isSharp ? 'sharp' : ''}">
                            ${formatBookmakerName(item.bookmaker)}
                            ${item.isSharp ? ' ‚ö°' : ''}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-1-cell">${item.quote1.toFixed(2)}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-x-cell">${item.quoteX.toFixed(2)}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-2-cell">${item.quote2.toFixed(2)}</span>
                    </td>
                </tr>
            `).join('');
        }

        function clearData3Esiti() {
            document.getElementById('inputData3').value = '';
            parsedData3 = [];
            displayResults3();
            updateStats3();
            resetSort3();
            showNotification('Dati 3 esiti puliti', 'info');
        }

        // ==============================
        // FUNZIONI 2 ESITI
        // ==============================
        function loadExample2Esiti() {
            const example = `efbet
efbet.net
8.40
1.11
98.0 %
betfair
betfair
8.24
1.12
98.6 %
dafabet
dafabet
7.10
1.10
95.0 %
ggbet
ggbet
6.99
1.09
94.0 %
bet365
bet365
6.60
1.11
94.8 %
pmbet
pmbet
6.40
1.11
94.3 %
casapariurilor
casapariurilor
6.40
1.12
95.1 %
wwin
wwin
5.90
1.10
92.1 %
tippmix_hu
tippmix_hu
5.25
1.09
89.2 %`;
            
            document.getElementById('inputData2').value = example;
            showNotification('Esempio 2 esiti caricato', 'info');
        }

        function parseData2Esiti() {
            const input = document.getElementById('inputData2').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati da Betmonitor', 'error');
                return;
            }

            parsedData2 = [];
            const debugInfo = [];
            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');

            let i = 0;
            while (i < lines.length) {
                if (i + 4 < lines.length) {
                    const bookmakerName = lines[i].toLowerCase();
                    const quoteYes = parseFloat(lines[i + 2]);
                    const quoteNo = parseFloat(lines[i + 3]);

                    if (!isNaN(quoteYes) && !isNaN(quoteNo)) {
                        parsedData2.push({
                            bookmaker: bookmakerName,
                            quoteYes: quoteYes,
                            quoteNo: quoteNo,
                            isSharp: sharpBookmakers.includes(bookmakerName)
                        });
                        i += 5;
                        continue;
                    }
                }
                i++;
            }

            if (parsedData2.length === 0) {
                showNotification('Nessun dato valido trovato', 'error');
                document.getElementById('debugInfo2').innerHTML = debugInfo.join('<br>');
                document.getElementById('debugInfo2').style.display = 'block';
            } else {
                document.getElementById('debugInfo2').style.display = 'none';
                displayResults2();
                updateStats2();
                updateAiqCalculatorFromParser2();
                resetSort2();
                showNotification(`Trovati ${parsedData2.length} bookmaker (2 esiti)`, 'success');
            }
        }

        function calculateStatistics2() {
            if (parsedData2.length === 0) {
                return {
                    avgYes: 0, avgNo: 0,
                    minYes: 0, minNo: 0,
                    maxYes: 0, maxNo: 0,
                    minBookYes: '', minBookNo: '',
                    maxBookYes: '', maxBookNo: '',
                    pinnacleYes: null, pinnacleNo: null,
                    betfairYes: null, betfairNo: null,
                    sharpCount: 0
                };
            }

            let minYes = parsedData2[0].quoteYes, minNo = parsedData2[0].quoteNo;
            let maxYes = parsedData2[0].quoteYes, maxNo = parsedData2[0].quoteNo;
            let minBookYes = parsedData2[0].bookmaker, minBookNo = parsedData2[0].bookmaker;
            let maxBookYes = parsedData2[0].bookmaker, maxBookNo = parsedData2[0].bookmaker;
            let totalYes = 0, totalNo = 0;
            let sharpCount = 0;

            let pinnacleYes = null, pinnacleNo = null;
            let betfairYes = null, betfairNo = null;

            parsedData2.forEach(item => {
                totalYes += item.quoteYes;
                totalNo += item.quoteNo;

                if (item.quoteYes < minYes) { minYes = item.quoteYes; minBookYes = item.bookmaker; }
                if (item.quoteYes > maxYes) { maxYes = item.quoteYes; maxBookYes = item.bookmaker; }
                if (item.quoteNo < minNo) { minNo = item.quoteNo; minBookNo = item.bookmaker; }
                if (item.quoteNo > maxNo) { maxNo = item.quoteNo; maxBookNo = item.bookmaker; }
                
                if (item.bookmaker === 'pinnacle') {
                    pinnacleYes = item.quoteYes;
                    pinnacleNo = item.quoteNo;
                    sharpCount++;
                }
                if (item.bookmaker === 'betfair') {
                    betfairYes = item.quoteYes;
                    betfairNo = item.quoteNo;
                    sharpCount++;
                }
            });

            return {
                avgYes: totalYes / parsedData2.length,
                avgNo: totalNo / parsedData2.length,
                minYes, minNo,
                maxYes, maxNo,
                minBookYes, minBookNo,
                maxBookYes, maxBookNo,
                pinnacleYes, pinnacleNo,
                betfairYes, betfairNo,
                sharpCount
            };
        }

        function updateStats2() {
            const stats = calculateStatistics2();
            
            document.getElementById('totalBooks2').textContent = parsedData2.length;
            document.getElementById('sharpBooks2').textContent = stats.sharpCount;

            document.getElementById('avgQuoteYes').textContent = stats.avgYes.toFixed(2);
            document.getElementById('minQuoteYes').textContent = stats.minYes.toFixed(2);
            document.getElementById('maxQuoteYes').textContent = stats.maxYes.toFixed(2);
            document.getElementById('minBookYes').textContent = formatBookmakerName(stats.minBookYes);
            document.getElementById('maxBookYes').textContent = formatBookmakerName(stats.maxBookYes);
            
            document.getElementById('pinnacleQuoteYes').textContent = stats.pinnacleYes !== null ? stats.pinnacleYes.toFixed(2) : '-';
            document.getElementById('betfairQuoteYes').textContent = stats.betfairYes !== null ? stats.betfairYes.toFixed(2) : '-';

            document.getElementById('avgQuoteNo').textContent = stats.avgNo.toFixed(2);
            document.getElementById('minQuoteNo').textContent = stats.minNo.toFixed(2);
            document.getElementById('maxQuoteNo').textContent = stats.maxNo.toFixed(2);
            document.getElementById('minBookNo').textContent = formatBookmakerName(stats.minBookNo);
            document.getElementById('maxBookNo').textContent = formatBookmakerName(stats.maxBookNo);
            
            document.getElementById('pinnacleQuoteNo').textContent = stats.pinnacleNo !== null ? stats.pinnacleNo.toFixed(2) : '-';
            document.getElementById('betfairQuoteNo').textContent = stats.betfairNo !== null ? stats.betfairNo.toFixed(2) : '-';
        }

        function updateAiqCalculatorFromParser2() {
            const stats = calculateStatistics2();
            
            // Aggiorna il calcolatore AIQ TENNIS con i dati del parser
            // Pulisci prima tutti i campi
            document.getElementById('AIQ TENNIS_Sharp_HOME').value = '';
            document.getElementById('AIQ TENNIS_Sharp_AWAY').value = '';
            
            document.getElementById('AIQ TENNIS_Media_HOME').value = '';
            document.getElementById('AIQ TENNIS_Media_AWAY').value = '';
            
            document.getElementById('AIQ TENNIS_Min_HOME').value = '';
            document.getElementById('AIQ TENNIS_Max_HOME').value = '';
            
            document.getElementById('AIQ TENNIS_Min_AWAY').value = '';
            document.getElementById('AIQ TENNIS_Max_AWAY').value = '';
            
            // Solo se ci sono dati validi, inseriscili
            if (stats.pinnacleYes !== null) {
                document.getElementById('AIQ TENNIS_Sharp_HOME').value = stats.pinnacleYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Sharp_AWAY').value = stats.pinnacleNo.toFixed(2);
            } else if (stats.betfairYes !== null) {
                document.getElementById('AIQ TENNIS_Sharp_HOME').value = stats.betfairYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Sharp_AWAY').value = stats.betfairNo.toFixed(2);
            }
            
            if (parsedData2.length > 0) {
                document.getElementById('AIQ TENNIS_Media_HOME').value = stats.avgYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Media_AWAY').value = stats.avgNo.toFixed(2);
                
                document.getElementById('AIQ TENNIS_Min_HOME').value = stats.minYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Max_HOME').value = stats.maxYes.toFixed(2);
                
                document.getElementById('AIQ TENNIS_Min_AWAY').value = stats.minNo.toFixed(2);
                document.getElementById('AIQ TENNIS_Max_AWAY').value = stats.maxNo.toFixed(2);
            }
            
            // Ricalcola AIQ
            calculateAiq('AIQ TENNIS', 'HOME');
            calculateAiq('AIQ TENNIS', 'AWAY');
        }

        function displayResults2() {
            const tableBody = document.getElementById('resultsTable2');
            const emptyState = document.getElementById('emptyState2');
            
            if (parsedData2.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tableBody.innerHTML = parsedData2.map(item => `
                <tr>
                    <td>
                        <span class="bookmaker-name ${item.isSharp ? 'sharp' : ''}">
                            ${formatBookmakerName(item.bookmaker)}
                            ${item.isSharp ? ' ‚ö°' : ''}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-yes-cell">${item.quoteYes.toFixed(2)}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-no-cell">${item.quoteNo.toFixed(2)}</span>
                    </td>
                </tr>
            `).join('');
        }

        function clearData2Esiti() {
            document.getElementById('inputData2').value = '';
            parsedData2 = [];
            displayResults2();
            updateStats2();
            resetSort2();
            showNotification('Dati 2 esiti puliti', 'info');
        }

        // ==============================
        // Funzioni per parser 3 esiti
        // ==============================
        function loadEsempioEvento3() {
            const esempio = `VfB Stuttgart ‚Äî Eintracht Frankfurt
        Football ¬∑ Germany ¬∑ Germany Bundesliga
        Tuesday ¬∑ 13 Jan, 2026 ¬∑ 18:30`;
            
            document.getElementById('inputEvento3').value = esempio;
            showNotification('Esempio evento caricato (Calcio)', 'info');
        }

        function parseEvento3() {
            const input = document.getElementById('inputEvento3').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati dell\'evento', 'error');
                return;
            }

            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');
            
            if (lines.length < 3) {
                showNotification('Formato non valido. Servono 3 linee di dati', 'error');
                return;
            }

            // Parsing
            const nomeEvento = lines[0];
            const partsLinea2 = lines[1].split('¬∑').map(part => part.trim());
            const partsLinea3 = lines[2].split('¬∑').map(part => part.trim());
            
            if (partsLinea2.length < 3 || partsLinea3.length < 3) {
                showNotification('Formato non valido', 'error');
                return;
            }
            
            const dataCompleta = partsLinea3[1] + ' ' + partsLinea3[2];
            const dataOra = parseDate(dataCompleta);
            
            if (!dataOra) {
                showNotification('Data non valida', 'error');
                return;
            }

            const dataFormattata = dataOra.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Salva in variabile globale
            eventoCorrente3 = {
                nome: nomeEvento,
                sport: partsLinea2[0],
                nazione: partsLinea2[1],
                lega: partsLinea2[2],
                dataOra: dataOra.toISOString(),
                dataFormattata: dataFormattata,
                timestamp: new Date().toISOString(),
                quotes: null,
                aiqData: null
            };

            // Mostra dettagli
            mostraDettagliEvento3(eventoCorrente3);
            showNotification('Evento parsato con successo (Calcio)', 'success');
        }

        function clearEvento3() {
            document.getElementById('inputEvento3').value = '';
            eventoCorrente3 = null;
            mostraDettagliEvento3(null);
            showNotification('Evento pulito (Calcio)', 'info');
        }

        function salvaEventoConQuotes3() {
            if (!eventoCorrente3) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData3.length === 0) {
                showNotification('Prima parsare quotes 3 esiti', 'error');
                return;
            }

            eventoCorrente3.quotes = parsedData3;
            eventoCorrente3.tipoQuotes = '3_esiti';
            eventoCorrente3.mercato = ''; 
            eventoCorrente3.aiqData = {
                timestamp: new Date().toISOString(),
                stats: calculateStatistics3()
            };
            
            // Salva nel database
            eventoCorrente3.id = 'evento_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            databaseEventi.push({...eventoCorrente3});
            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
            
            // Aggiorna contatori
            document.getElementById('totalEventi3').textContent = databaseEventi.length;
            document.getElementById('eventiAnalizzati3').textContent = databaseEventi.filter(e => e.quotes && e.tipoQuotes === '3_esiti').length;
            
            // MOSTRA SEMPRE la tabella eventi
            mostraTabellaEventi();
            
            showNotification(`Evento ${eventoCorrente3.sport} salvato! ID: ${eventoCorrente3.id.slice(0, 8)}...`, 'success');
            
            // Resetta evento corrente
            eventoCorrente3 = null;
            document.getElementById('inputEvento3').value = '';
            mostraDettagliEvento3(null);
        }

        // Funzioni per parser 2 esiti
        function loadEsempioEvento2() {
            const esempio = `Nadal vs. Djokovic
        Tennis ¬∑ International ¬∑ Wimbledon
        Monday ¬∑ 15 Jan, 2026 ¬∑ 15:00`;
            
            document.getElementById('inputEvento2').value = esempio;
            showNotification('Esempio evento caricato (Tennis)', 'info');
        }

        function parseEvento2() {
            const input = document.getElementById('inputEvento2').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati dell\'evento', 'error');
                return;
            }

            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');
            
            if (lines.length < 3) {
                showNotification('Formato non valido. Servono 3 linee di dati', 'error');
                return;
            }

            // Parsing
            const nomeEvento = lines[0];
            const partsLinea2 = lines[1].split('¬∑').map(part => part.trim());
            const partsLinea3 = lines[2].split('¬∑').map(part => part.trim());
            
            if (partsLinea2.length < 3 || partsLinea3.length < 3) {
                showNotification('Formato non valido', 'error');
                return;
            }
            
            const dataCompleta = partsLinea3[1] + ' ' + partsLinea3[2];
            const dataOra = parseDate(dataCompleta);
            
            if (!dataOra) {
                showNotification('Data non valida', 'error');
                return;
            }

            const dataFormattata = dataOra.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Salva in variabile globale
            eventoCorrente2 = {
                nome: nomeEvento,
                sport: partsLinea2[0],
                nazione: partsLinea2[1],
                lega: partsLinea2[2],
                dataOra: dataOra.toISOString(),
                dataFormattata: dataFormattata,
                timestamp: new Date().toISOString(),
                quotes: null,
                aiqData: null
            };

            // Mostra dettagli
            mostraDettagliEvento2(eventoCorrente2);
            showNotification('Evento parsato con successo (Tennis)', 'success');
        }

        function clearEvento2() {
            document.getElementById('inputEvento2').value = '';
            eventoCorrente2 = null;
            mostraDettagliEvento2(null);
            showNotification('Evento pulito (Tennis)', 'info');
        }

        function salvaEventoConQuotes2() {
            if (!eventoCorrente2) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData2.length === 0) {
                showNotification('Prima parsare quotes 2 esiti', 'error');
                return;
            }

            eventoCorrente2.quotes = parsedData2;
            eventoCorrente2.tipoQuotes = '2_esiti';
            eventoCorrente2.mercato = ''; 
            eventoCorrente2.aiqData = {
                timestamp: new Date().toISOString(),
                stats: calculateStatistics2()
            };
            
            // Salva nel database
            eventoCorrente2.id = 'evento_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            databaseEventi.push({...eventoCorrente2});
            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
            
            // Aggiorna contatori
            document.getElementById('totalEventi2').textContent = databaseEventi.length;
            document.getElementById('eventiAnalizzati2').textContent = databaseEventi.filter(e => e.quotes && e.tipoQuotes === '2_esiti').length;
            
            // MOSTRA SEMPRE la tabella eventi
            mostraTabellaEventi();
            
            showNotification(`Evento ${eventoCorrente2.sport} salvato! ID: ${eventoCorrente2.id.slice(0, 8)}...`, 'success');
            
            // Resetta evento corrente
            eventoCorrente2 = null;
            document.getElementById('inputEvento2').value = '';
            mostraDettagliEvento2(null);
        }

        // Mostra dettagli evento per 3 esiti
        function mostraDettagliEvento3(evento) {
            const container = document.getElementById('eventoDetails3');
            mostraDettagliEventoGenerico(container, evento, '3_esiti');
        }

        // Mostra dettagli evento per 2 esiti
        function mostraDettagliEvento2(evento) {
            const container = document.getElementById('eventoDetails2');
            mostraDettagliEventoGenerico(container, evento, '2_esiti');
        }

        // Funzione generica per mostrare dettagli
        function mostraDettagliEventoGenerico(container, evento, tipo) {
            if (!evento) {
                container.innerHTML = `
                    <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                        Nessun evento caricato
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3>${evento.nome}</h3>
                <div class="evento-info-grid">
                    <div class="evento-info-item">
                        <span class="evento-info-label">Sport:</span>
                        <span class="evento-info-value">${evento.sport}</span>
                    </div>
                    <div class="evento-info-item">
                        <span class="evento-info-label">Nazione:</span>
                        <span class="evento-info-value">${evento.nazione}</span>
                    </div>
                    <div class="evento-info-item">
                        <span class="evento-info-label">Lega:</span>
                        <span class="evento-info-value">${evento.lega}</span>
                    </div>
                    <div class="evento-info-item">
                        <span class="evento-info-label">Data:</span>
                        <span class="evento-info-value">${evento.dataFormattata}</span>
                    </div>
                </div>
                ${evento.quotes ? `
                <div style="margin-top: 15px; padding: 10px; background: #dcfce7; border-radius: 4px; font-size: 13px;">
                    <strong>‚úÖ Quotes associate</strong><br>
                    <small>Tipo: ${evento.tipoQuotes || 'N/D'} | Count: ${evento.quotes.length}</small>
                </div>` : `
                <div style="margin-top: 15px; padding: 10px; background: #fef9c3; border-radius: 4px; font-size: 13px;">
                    <strong>‚ö† Nessuna quote associata</strong><br>
                    <small>Clicca "Carica Quotes" per aggiungerle</small>
                </div>`}
                ${evento.aiqData ? `
                <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 4px; font-size: 13px;">
                    <strong>üìä Dati AIQ salvati</strong><br>
                    <small>${new Date(evento.aiqData.timestamp).toLocaleString()}</small>
                </div>` : ''}
            `;
        }

        // Carica quotes nell'evento per 3 esiti
        function caricaQuotesInEvento3() {
            if (!eventoCorrente3) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData3.length === 0) {
                showNotification('Prima parsare quotes 3 esiti', 'error');
                return;
            }

            eventoCorrente3.quotes = parsedData3;
            eventoCorrente3.tipoQuotes = '3_esiti';
            eventoCorrente3.aiqData = {
                timestamp: new Date().toISOString(),
                stats: calculateStatistics3()
            };
            
            mostraDettagliEvento3(eventoCorrente3);
            showNotification('Quote 3 esiti caricate nell\'evento', 'success');
        }

        // Carica quotes nell'evento per 2 esiti
        function caricaQuotesInEvento2() {
            if (!eventoCorrente2) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData2.length === 0) {
                showNotification('Prima parsare quotes 2 esiti', 'error');
                return;
            }

            eventoCorrente2.quotes = parsedData2;
            eventoCorrente2.tipoQuotes = '2_esiti';
            eventoCorrente2.aiqData = {
                timestamp: new Date().toISOString(),
                stats: calculateStatistics2()
            };
            
            mostraDettagliEvento2(eventoCorrente2);
            showNotification('Quote 2 esiti caricate nell\'evento', 'success');
        }

        // Funzioni esporta evento
        function esportaEventoJSON3() {
            if (!eventoCorrente3) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            const exportData = {
                evento: eventoCorrente3,
                timestamp: new Date().toISOString(),
                versione: '1.0'
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const nomeFile = `evento_${eventoCorrente3.nome.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_calcio.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Evento calcio esportato', 'success');
        }

        function esportaEventoJSON2() {
            if (!eventoCorrente2) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            const exportData = {
                evento: eventoCorrente2,
                timestamp: new Date().toISOString(),
                versione: '1.0'
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const nomeFile = `evento_${eventoCorrente2.nome.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_tennis.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Evento tennis esportato', 'success');
        }
        
        // ==============================
        // FUNZIONI COMUNI
        // ==============================
        function formatBookmakerName(name) {
            if (!name) return '-';
            const cleanName = name.replace(/\.[a-z]+$/, '');
            return cleanName.charAt(0).toUpperCase() + cleanName.slice(1);
        }

        // ==============================
        // FUNZIONI ORDINAMENTO 3 ESITI
        // ==============================
        function sortTable3(column) {
            const header = document.querySelector(`#tab-3esiti th[onclick="sortTable3('${column}')"]`);
            
            if (currentSort3.column === column) {
                currentSort3.direction = currentSort3.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort3.column = column;
                currentSort3.direction = 'asc';
            }
            
            document.querySelectorAll('#tab-3esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
            
            header.classList.add(currentSort3.direction);
            header.setAttribute('data-sort', currentSort3.direction);
            
            sortData3(column, currentSort3.direction);
            displayResults3();
        }

        function sortData3(column, direction) {
            if (parsedData3.length === 0) return;
            
            parsedData3.sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'bookmaker':
                        valueA = a.bookmaker.toLowerCase();
                        valueB = b.bookmaker.toLowerCase();
                        break;
                    case 'quote1':
                        valueA = a.quote1;
                        valueB = b.quote1;
                        break;
                    case 'quoteX':
                        valueA = a.quoteX;
                        valueB = b.quoteX;
                        break;
                    case 'quote2':
                        valueA = a.quote2;
                        valueB = b.quote2;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    if (valueA < valueB) return -1;
                    if (valueA > valueB) return 1;
                    return 0;
                } else {
                    if (valueA > valueB) return -1;
                    if (valueA < valueB) return 1;
                    return 0;
                }
            });
        }

        function resetSort3() {
            currentSort3.column = null;
            currentSort3.direction = 'asc';
            document.querySelectorAll('#tab-3esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
        }

        // ==============================
        // FUNZIONI ORDINAMENTO 2 ESITI
        // ==============================
        function sortTable2(column) {
            const header = document.querySelector(`#tab-2esiti th[onclick="sortTable2('${column}')"]`);
            
            if (currentSort2.column === column) {
                currentSort2.direction = currentSort2.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort2.column = column;
                currentSort2.direction = 'asc';
            }
            
            document.querySelectorAll('#tab-2esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
            
            header.classList.add(currentSort2.direction);
            header.setAttribute('data-sort', currentSort2.direction);
            
            sortData2(column, currentSort2.direction);
            displayResults2();
        }

        function sortData2(column, direction) {
            if (parsedData2.length === 0) return;
            
            parsedData2.sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'bookmaker':
                        valueA = a.bookmaker.toLowerCase();
                        valueB = b.bookmaker.toLowerCase();
                        break;
                    case 'quoteYes':
                        valueA = a.quoteYes;
                        valueB = b.quoteYes;
                        break;
                    case 'quoteNo':
                        valueA = a.quoteNo;
                        valueB = b.quoteNo;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    if (valueA < valueB) return -1;
                    if (valueA > valueB) return 1;
                    return 0;
                } else {
                    if (valueA > valueB) return -1;
                    if (valueA < valueB) return 1;
                    return 0;
                }
            });
        }

        function resetSort2() {
            currentSort2.column = null;
            currentSort2.direction = 'asc';
            document.querySelectorAll('#tab-2esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
        }

        // ==============================
        // FUNZIONI ESPORTAZIONE
        // ==============================
        function exportToCSV3() {
            if (parsedData3.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics3();
            
            let csvContent = "BOOKMAKER 3 ESITI\n";
            csvContent += `Esportato il: ${new Date().toLocaleString()}\n`;
            csvContent += `Bookmaker totali: ${parsedData3.length}\n`;
            csvContent += `Bookmaker Sharp trovati: ${stats.sharpCount}\n\n`;
            
            csvContent += "DETTAGLIO BOOKMAKER\n";
            csvContent += "Bookmaker,Quote 1,Quote X,Quote 2,Sharp\n";
            
            parsedData3.forEach(item => {
                csvContent += `${formatBookmakerName(item.bookmaker)},${item.quote1},${item.quoteX},${item.quote2},${item.isSharp ? 'SI' : 'NO'}\n`;
            });
            
            csvContent += "\n\nSTATISTICHE\n";
            csvContent += "Statistica,Quote 1,Quote X,Quote 2\n";
            csvContent += `Media,${stats.avg1.toFixed(2)},${stats.avgX.toFixed(2)},${stats.avg2.toFixed(2)}\n`;
            csvContent += `Minima,${stats.min1.toFixed(2)},${stats.minX.toFixed(2)},${stats.min2.toFixed(2)}\n`;
            csvContent += `Massima,${stats.max1.toFixed(2)},${stats.maxX.toFixed(2)},${stats.max2.toFixed(2)}\n`;
            
            csvContent += `Pinnacle,${stats.pinnacle1 !== null ? stats.pinnacle1.toFixed(2) : '-'},${stats.pinnacleX !== null ? stats.pinnacleX.toFixed(2) : '-'},${stats.pinnacle2 !== null ? stats.pinnacle2.toFixed(2) : '-'}\n`;
            csvContent += `Betfair,${stats.betfair1 !== null ? stats.betfair1.toFixed(2) : '-'},${stats.betfairX !== null ? stats.betfairX.toFixed(2) : '-'},${stats.betfair2 !== null ? stats.betfair2.toFixed(2) : '-'}\n`;

            downloadFile(csvContent, 'bookmaker_3esiti.csv', 'text/csv');
            showNotification('CSV 3 esiti esportato', 'success');
        }

        function exportToJSON3() {
            if (parsedData3.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics3();
            const exportData = {
                bookmakers: parsedData3,
                statistics: {
                    total: parsedData3.length,
                    sharpCount: stats.sharpCount,
                    percentageSharp: parsedData3.length > 0 ? (stats.sharpCount / parsedData3.length) * 100 : 0,
                    quotes1: {
                        average: stats.avg1,
                        minimum: stats.min1,
                        maximum: stats.max1,
                        pinnacle: stats.pinnacle1,
                        betfair: stats.betfair1
                    },
                    quotesX: {
                        average: stats.avgX,
                        minimum: stats.minX,
                        maximum: stats.maxX,
                        pinnacle: stats.pinnacleX,
                        betfair: stats.betfairX
                    },
                    quotes2: {
                        average: stats.avg2,
                        minimum: stats.min2,
                        maximum: stats.max2,
                        pinnacle: stats.pinnacle2,
                        betfair: stats.betfair2
                    }
                },
                timestamp: new Date().toISOString()
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'bookmaker_3esiti.json', 'application/json');
            showNotification('JSON 3 esiti esportato', 'success');
        }

        function exportToTXT3() {
            if (parsedData3.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            let txtContent = `Bookmaker 3 Esiti - ${new Date().toLocaleString()}\n`;
            txtContent += '='.repeat(40) + '\n\n';
            txtContent += `Bookmaker totali: ${parsedData3.length}\n\n`;
            
            parsedData3.forEach(item => {
                txtContent += `${formatBookmakerName(item.bookmaker).padEnd(20)} ${item.quote1.toFixed(2).padStart(6)} ${item.quoteX.toFixed(2).padStart(6)} ${item.quote2.toFixed(2).padStart(6)} ${item.isSharp ? '‚ö°' : ''}\n`;
            });

            downloadFile(txtContent, 'bookmaker_3esiti.txt', 'text/plain');
            showNotification('TXT 3 esiti esportato', 'success');
        }

        function exportToCSV2() {
            if (parsedData2.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics2();
            
            let csvContent = "BOOKMAKER 2 ESITI\n";
            csvContent += `Esportato il: ${new Date().toLocaleString()}\n`;
            csvContent += `Bookmaker totali: ${parsedData2.length}\n\n`;
            
            csvContent += "DETTAGLIO BOOKMAKER\n";
            csvContent += "Bookmaker,Quote S√¨,Quote No,Sharp\n";
            
            parsedData2.forEach(item => {
                csvContent += `${formatBookmakerName(item.bookmaker)},${item.quoteYes},${item.quoteNo},${item.isSharp ? 'SI' : 'NO'}\n`;
            });
            
            csvContent += "\n\nSTATISTICHE\n";
            csvContent += "Statistica,Quote S√¨,Quote No\n";
            csvContent += `Media,${stats.avgYes.toFixed(2)},${stats.avgNo.toFixed(2)}\n`;
            csvContent += `Minima,${stats.minYes.toFixed(2)},${stats.minNo.toFixed(2)}\n`;
            csvContent += `Massima,${stats.maxYes.toFixed(2)},${stats.maxNo.toFixed(2)}\n`;
            
            csvContent += `Pinnacle,${stats.pinnacleYes !== null ? stats.pinnacleYes.toFixed(2) : '-'},${stats.pinnacleNo !== null ? stats.pinnacleNo.toFixed(2) : '-'}\n`;
            csvContent += `Betfair,${stats.betfairYes !== null ? stats.betfairYes.toFixed(2) : '-'},${stats.betfairNo !== null ? stats.betfairNo.toFixed(2) : '-'}\n`;

            downloadFile(csvContent, 'bookmaker_2esiti.csv', 'text/csv');
            showNotification('CSV 2 esiti esportato', 'success');
        }

        function exportToJSON2() {
            if (parsedData2.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics2();
            const exportData = {
                bookmakers: parsedData2,
                statistics: {
                    total: parsedData2.length,
                    sharpCount: stats.sharpCount,
                    percentageSharp: parsedData2.length > 0 ? (stats.sharpCount / parsedData2.length) * 100 : 0,
                    quotesYes: {
                        average: stats.avgYes,
                        minimum: stats.minYes,
                        maximum: stats.maxYes,
                        pinnacle: stats.pinnacleYes,
                        betfair: stats.betfairYes
                    },
                    quotesNo: {
                        average: stats.avgNo,
                        minimum: stats.minNo,
                        maximum: stats.maxNo,
                        pinnacle: stats.pinnacleNo,
                        betfair: stats.betfairNo
                    }
                },
                timestamp: new Date().toISOString()
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'bookmaker_2esiti.json', 'application/json');
            showNotification('JSON 2 esiti esportato', 'success');
        }

        function exportToTXT2() {
            if (parsedData2.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            let txtContent = `Bookmaker 2 Esiti - ${new Date().toLocaleString()}\n`;
            txtContent += '='.repeat(40) + '\n\n';
            txtContent += `Bookmaker totali: ${parsedData2.length}\n\n`;
            
            parsedData2.forEach(item => {
                txtContent += `${formatBookmakerName(item.bookmaker).padEnd(20)} ${item.quoteYes.toFixed(2).padStart(6)} ${item.quoteNo.toFixed(2).padStart(6)} ${item.isSharp ? '‚ö°' : ''}\n`;
            });

            downloadFile(txtContent, 'bookmaker_2esiti.txt', 'text/plain');
            showNotification('TXT 2 esiti esportato', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#dc2626' : 
                                           type === 'success' ? '#059669' : '#1a1a1a';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==============================
        // FUNZIONI PER PARSING AUTOMATICO
        // ==============================

        // Rileva quando l'utente incolla nei textarea e avvia parsing automatico
        function setupAutoParse() {
            // Textarea per 3 esiti
            const textarea3 = document.getElementById('inputData3');
            if (textarea3) {
                textarea3.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        autoParseData(textarea3.value, '3esiti');
                    }, 50); // Piccolo delay per permettere alla clipboard di essere incollata
                });
            }
            
            // Textarea per 2 esiti
            const textarea2 = document.getElementById('inputData2');
            if (textarea2) {
                textarea2.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        autoParseData(textarea2.value, '2esiti');
                    }, 50);
                });
            }
            
            // Textarea evento 3 esiti
            const textareaEvento3 = document.getElementById('inputEvento3');
            if (textareaEvento3) {
                textareaEvento3.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        autoParseEvento(textareaEvento3.value, '3esiti');
                    }, 50);
                });
            }
            
            // Textarea evento 2 esiti
            const textareaEvento2 = document.getElementById('inputEvento2');
            if (textareaEvento2) {
                textareaEvento2.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        autoParseEvento(textareaEvento2.value, '2esiti');
                    }, 50);
                });
            }
        }

        // Funzione per auto-parsing dati bookmaker
        function autoParseData(inputText, tipo) {
            if (!inputText || inputText.trim().length < 10) {
                return false; // Testo troppo corto, non fare nulla
            }
            
            // Controlla se il testo sembra dati di bookmaker
            const lines = inputText.split('\n').filter(line => line.trim().length > 0);
            const looksLikeBookmakerData = lines.some(line => 
                line.includes('.') && // Probabile dominio o numero decimale
                (line.includes('bet') || line.includes('Bet') || line.includes('BET') ||
                /^\d+\.\d+$/.test(line.trim())) // O √® una quota decimale
            );
            
            if (looksLikeBookmakerData) {
                // Mostra notifica di parsing automatico
                showNotification(`üîç Auto-parsing ${tipo}...`, 'info');
                
                // Chiama la funzione di parsing appropriata dopo un breve delay
                setTimeout(() => {
                    if (tipo === '3esiti') {
                        parseData3Esiti();
                    } else if (tipo === '2esiti') {
                        parseData2Esiti();
                    }
                }, 300); // Piccolo delay per feedback visivo
                return true;
            }
            return false;
        }

        // Funzione per auto-parsing evento
        function autoParseEvento(inputText, tipo) {
            if (!inputText || inputText.trim().length < 20) {
                return false;
            }
            
            // Controlla se sembra un formato evento (con ‚Äî o vs e data)
            const looksLikeEvento = inputText.includes(' ‚Äî ') || 
                                inputText.includes(' vs ') || 
                                inputText.includes(' vs. ') ||
                                (inputText.includes('Football') || inputText.includes('Tennis')) ||
                                /(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/i.test(inputText);
            
            if (looksLikeEvento) {
                showNotification(`üìÖ Auto-parsing evento ${tipo}...`, 'info');
                
                setTimeout(() => {
                    if (tipo === '3esiti') {
                        parseEvento3();
                    } else if (tipo === '2esiti') {
                        parseEvento2();
                    }
                }, 300);
                return true;
            }
            return false;
        }

        // Funzione per rilevare input manuale (tastiera) e avviare parsing dopo un delay
        function setupKeyboardAutoParse() {
            const textareas = [
                'inputData3', 'inputData2', 'inputEvento3', 'inputEvento2'
            ];
            
            textareas.forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    let timeout;
                    
                    textarea.addEventListener('input', function(e) {
                        // Cancella timeout precedente
                        clearTimeout(timeout);
                        
                        // Se il testo √® abbastanza lungo, programma un parsing automatico
                        if (this.value.trim().length > 50) {
                            timeout = setTimeout(() => {
                                if (id.includes('Data')) {
                                    const tipo = id.includes('3') ? '3esiti' : '2esiti';
                                    autoParseData(this.value, tipo);
                                } else if (id.includes('Evento')) {
                                    const tipo = id.includes('3') ? '3esiti' : '2esiti';
                                    autoParseEvento(this.value, tipo);
                                }
                            }, 2000); // 2 secondi dopo l'ultimo input
                        }
                    });
                    
                    // Pulizia quando si cambia tab
                    textarea.addEventListener('blur', function() {
                        clearTimeout(timeout);
                    });
                }
            });
        }

        // Controlla se ci sono gi√† dati nei textarea al caricamento e li parsa
        function checkExistingContent() {
            setTimeout(() => {
                // Controlla textarea 3 esiti
                const textarea3 = document.getElementById('inputData3');
                if (textarea3 && textarea3.value.trim().length > 20) {
                    autoParseData(textarea3.value, '3esiti');
                }
                
                // Controlla textarea 2 esiti
                const textarea2 = document.getElementById('inputData2');
                if (textarea2 && textarea2.value.trim().length > 20) {
                    autoParseData(textarea2.value, '2esiti');
                }
                
                // Controlla textarea evento 3 esiti
                const textareaEvento3 = document.getElementById('inputEvento3');
                if (textareaEvento3 && textareaEvento3.value.trim().length > 20) {
                    autoParseEvento(textareaEvento3.value, '3esiti');
                }
                
                // Controlla textarea evento 2 esiti
                const textareaEvento2 = document.getElementById('inputEvento2');
                if (textareaEvento2 && textareaEvento2.value.trim().length > 20) {
                    autoParseEvento(textareaEvento2.value, '2esiti');
                }
            }, 1000); // 1 secondo dopo il caricamento
        }
        
        // ==============================
        // FUNZIONI GESTIONE EVENTI
        // ==============================
        function parseDate(dateString) {
            // Supporta formati: "13 Jan, 2026 18:30" o "13 Jan 2026 18:30"
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            // Prova formato alternativo
            const parts = dateString.split(' ');
            if (parts.length >= 3) {
                const day = parts[0];
                const month = getMonthNumber(parts[1].replace(',', ''));
                const year = parts[2];
                const time = parts[3] || '00:00';
                
                if (month && day && year) {
                    return new Date(`${year}-${month}-${day.padStart(2, '0')}T${time}`);
                }
            }
            
            return null;
        }

        function getMonthNumber(monthStr) {
            const months = {
                'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
                'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
                'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
            };
            return months[monthStr.toLowerCase()];
        }

        // ==============================
        // FUNZIONI DATABASE EVENTI
        // ==============================
        function mostraTabellaEventi() {
            const container = document.getElementById('tabellaEventi');
            const emptyState = document.getElementById('emptyEventi');
            
            if (databaseEventi.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            // Ordina per data (pi√π recente prima)
            const eventiOrdinati = [...databaseEventi].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            container.innerHTML = eventiOrdinati.map((evento, index) => {
                // Estrai dati AIQ se presenti
                const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                
                // Calcola se c'√® VALUE in qualche esito
                let hasValue = false;
                let valueOutcome = '';
                
                if (aiqStats && evento.tipoQuotes === '3_esiti') {
                    // Logica per 3 esiti - semplificata: verifica se ci sono differenze significative
                    const hasPinnacle = aiqStats.pinnacle1 || aiqStats.pinnacleX || aiqStats.pinnacle2;
                    const hasBetfair = aiqStats.betfair1 || aiqStats.betfairX || aiqStats.betfair2;
                    hasValue = hasPinnacle || hasBetfair;
                    if (hasValue) {
                        // Determina quale esito ha la quota pi√π alta rispetto alla media
                        const diff1 = aiqStats.pinnacle1 ? aiqStats.pinnacle1 - aiqStats.avg1 : 0;
                        const diffX = aiqStats.pinnacleX ? aiqStats.pinnacleX - aiqStats.avgX : 0;
                        const diff2 = aiqStats.pinnacle2 ? aiqStats.pinnacle2 - aiqStats.avg2 : 0;
                        const maxDiff = Math.max(diff1, diffX, diff2);
                        if (maxDiff > 0) {
                            if (maxDiff === diff1) valueOutcome = '1';
                            else if (maxDiff === diffX) valueOutcome = 'X';
                            else valueOutcome = '2';
                        }
                    }
                } else if (aiqStats && evento.tipoQuotes === '2_esiti') {
                    // Logica per 2 esiti
                    const hasPinnacle = aiqStats.pinnacleYes || aiqStats.pinnacleNo;
                    const hasBetfair = aiqStats.betfairYes || aiqStats.betfairNo;
                    hasValue = hasPinnacle || hasBetfair;
                    if (hasValue) {
                        const diffYes = aiqStats.pinnacleYes ? aiqStats.pinnacleYes - aiqStats.avgYes : 0;
                        const diffNo = aiqStats.pinnacleNo ? aiqStats.pinnacleNo - aiqStats.avgNo : 0;
                        const maxDiff = Math.max(diffYes, diffNo);
                        if (maxDiff > 0) {
                            valueOutcome = maxDiff === diffYes ? 'SI' : 'NO';
                        }
                    }
                }
                
                return `
                    <tr data-event-id="${evento.id || ''}">
                        <td>
                            <strong>${evento.nome}</strong><br>
                            <small style="color: #666; font-size: 11px;">ID: ${evento.id ? evento.id.substring(0, 8) : 'N/D'}</small>
                        </td>
                        <td>${evento.sport}</td>
                        <td>
                            ${evento.lega}<br>
                            <small style="color: #666; font-size: 11px;">
                                ${evento.tipoQuotes || 'N/D'}
                            </small>
                        </td>
                        <td>${evento.dataFormattata}</td>
                        <td>
                            <select class="mercato-select" data-event-id="${evento.id || ''}" 
                                    style="font-size: 12px; padding: 3px 6px; border-radius: 4px; border: 1px solid #ddd; width: 100%;"
                                    onchange="aggiornaTipoScommessa('${evento.id || ''}', this.value)">
                                <option value="">Seleziona...</option>
                                ${mercatiConfigurati.sort((a, b) => a.ordine - b.ordine).map(mercato => `
                                    <option value="${mercato.codice}" ${evento.tipoScommessa === mercato.codice ? 'selected' : ''}>
                                        ${configurazioneSetup.mostraCodici ? `${mercato.codice} - ` : ''}${mercato.nome}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <!-- NUOVA COLONNA: VALUE SU (esito della valuebet) -->
                            <select class="value-su-select" data-event-id="${evento.id || ''}"
                                    style="font-size: 12px; padding: 3px 6px; border-radius: 4px; border: 1px solid #ddd; width: 100%;"
                                    onchange="aggiornaValueSu('${evento.id || ''}', this.value)">
                                <option value="">N/D</option>
                                ${evento.tipoQuotes === '3_esiti' ? `
                                    <option value="1" ${evento.valueSu === '1' ? 'selected' : ''}>1</option>
                                    <option value="X" ${evento.valueSu === 'X' ? 'selected' : ''}>X</option>
                                    <option value="2" ${evento.valueSu === '2' ? 'selected' : ''}>2</option>
                                ` : `
                                    <option value="SI" ${evento.valueSu === 'SI' ? 'selected' : ''}>S√¨</option>
                                    <option value="NO" ${evento.valueSu === 'NO' ? 'selected' : ''}>No</option>
                                `}
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <!-- NUOVA COLONNA: RISULTATO REALE -->
                            <select class="risultato-select" data-event-id="${evento.id || ''}"
                                    style="font-size: 12px; padding: 3px 6px; border-radius: 4px; border: 1px solid #ddd; width: 100%;"
                                    onchange="aggiornaRisultatoReale('${evento.id || ''}', this.value)">
                                <option value="">N/D</option>
                                ${evento.tipoQuotes === '3_esiti' ? `
                                    <option value="1" ${evento.risultatoReale === '1' ? 'selected' : ''}>1</option>
                                    <option value="X" ${evento.risultatoReale === 'X' ? 'selected' : ''}>X</option>
                                    <option value="2" ${evento.risultatoReale === '2' ? 'selected' : ''}>2</option>
                                ` : `
                                    <option value="SI" ${evento.risultatoReale === 'SI' ? 'selected' : ''}>S√¨</option>
                                    <option value="NO" ${evento.risultatoReale === 'NO' ? 'selected' : ''}>No</option>
                                `}
                                <option value="ANNULLATO" ${evento.risultatoReale === 'ANNULLATO' ? 'selected' : ''}>‚ùå</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            ${hasValue ? 
                                `<span style="background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                    VALUE ${valueOutcome}
                                </span>` : 
                                `<span style="background: #fef9c3; color: #854d0e; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                    NO VALUE
                                </span>`}
                        </td>
                        <td style="text-align: center;">
                            ${evento.quotes ? 
                                `<span style="background: #dbeafe; color: #1d4ed8; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                    ${evento.quotes.length} book
                                </span>` : 
                                `<span style="background: #f1f5f9; color: #64748b; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                    0 book
                                </span>`}
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-dettagli" onclick="mostraDettagliEventoModal('${evento.id || ''}')" 
                                    style="background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                Dettagli
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Aggiorna filtri sport
            aggiornaFiltriSport();
        }

        function aggiornaFiltriSport() {
            const sportUnici = [...new Set(databaseEventi.map(e => e.sport))].sort();
            const filtroSport = document.getElementById('filtroSport');
            const opzioniEsistenti = Array.from(filtroSport.options).map(o => o.value);
            
            // Aggiungi solo sport nuovi
            sportUnici.forEach(sport => {
                if (!opzioniEsistenti.includes(sport)) {
                    const option = document.createElement('option');
                    option.value = sport;
                    option.textContent = sport;
                    filtroSport.appendChild(option);
                }
            });
        }

        function filtraEventi() {
            const searchTerm = document.getElementById('cercaEvento').value.toLowerCase();
            const filtroSport = document.getElementById('filtroSport').value;            
            let filtrati = databaseEventi;
            
            if (searchTerm) {
                filtrati = filtrati.filter(e => 
                    e.nome.toLowerCase().includes(searchTerm) || 
                    e.lega.toLowerCase().includes(searchTerm) ||
                    (e.id && e.id.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filtroSport) {
                filtrati = filtrati.filter(e => e.sport === filtroSport);
            }
            
            // Mostra risultati filtrati
            const container = document.getElementById('tabellaEventi');
            const emptyState = document.getElementById('emptyEventi');
            
            if (filtrati.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                container.innerHTML = filtrati.map(evento => `
                    <tr>
                        <td>${evento.nome}</td>
                        <td>${evento.sport}</td>
                        <td>${evento.lega}</td>
                        <td>${evento.dataFormattata}</td>
                    </tr>
                `).join('');
            }
        }

        function resetFiltri() {
            document.getElementById('cercaEvento').value = '';
            document.getElementById('filtroSport').value = '';
            mostraTabellaEventi();
        }

        // ==============================
        // FUNZIONI ESPORTAZIONE EVENTI
        // ==============================
        function esportaEventiCSV() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            let csvContent = "ID;Evento;Sport;Nazione;Lega;Data;Tipo Quotes;Quotes Count;Data Creazione\n";
            
            databaseEventi.forEach(evento => {
                csvContent += `${evento.id || 'N/D'};"${evento.nome}";${evento.sport};${evento.nazione};${evento.lega};${evento.dataFormattata};${evento.tipoQuotes || 'N/D'};${evento.quotes ? evento.quotes.length : 0};${new Date(evento.timestamp).toLocaleString()}\n`;
            });

            downloadFile(csvContent, 'backtest_eventi.csv', 'text/csv');
            showNotification('CSV backtest esportato', 'success');
        }

        function esportaEventiJSONCompleto() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            const exportData = {
                databaseEventi: databaseEventi,
                statistiche: {
                    totale: databaseEventi.length
                },
                timestamp: new Date().toISOString(),
                versione: '1.0'
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'database_backtest_completo.json', 'application/json');
            showNotification('Database completo esportato', 'success');
        }

        function esportaBacktestTXT() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            let txtContent = `DATABASE EVENTI - ${new Date().toLocaleString()}\n`;
            txtContent += '='.repeat(60) + '\n\n';
            
            txtContent += `STATISTICHE:\n`;
            txtContent += `- Eventi totali: ${databaseEventi.length}\n\n`;
            
            txtContent += `DETTAGLIO EVENTI:\n`;
            txtContent += '='.repeat(60) + '\n\n';
            
            databaseEventi.forEach((evento, index) => {
                txtContent += `${index + 1}. ${evento.nome}\n`;
                txtContent += `   Sport: ${evento.sport} | Lega: ${evento.lega} | Data: ${evento.dataFormattata}\n`;
                txtContent += `   Quotes: ${evento.quotes ? evento.quotes.length : 0} | Tipo: ${evento.tipoQuotes || 'N/D'}\n`;
                txtContent += `   ID: ${evento.id || 'N/D'}\n\n`;
            });

            downloadFile(txtContent, 'database_eventi.txt', 'text/plain');
            showNotification('Report eventi esportato', 'success');
        }

        function backupDatabase() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const backupData = {
                databaseEventi: databaseEventi,
                timestamp: new Date().toISOString(),
                totaleEventi: databaseEventi.length,
                descrizione: 'Backup database eventi backtest'
            };

            const jsonContent = JSON.stringify(backupData, null, 2);
            const nomeFile = `backup_eventi_${new Date().toISOString().slice(0, 10)}.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Backup eseguito', 'success');
        }

        function restoreDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        if (!backupData.databaseEventi || !Array.isArray(backupData.databaseEventi)) {
                            throw new Error('Formato file non valido');
                        }
                        
                        if (confirm(`Vuoi ripristinare il backup con ${backupData.databaseEventi.length} eventi? I dati attuali verranno sovrascritti.`)) {
                            databaseEventi = backupData.databaseEventi;
                            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                            
                            mostraTabellaEventi();                            
                            showNotification(`Database ripristinato con ${databaseEventi.length} eventi`, 'success');
                        }
                    } catch (error) {
                        showNotification('Errore nel ripristino: file non valido', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearDatabase() {
            if (confirm('Sei sicuro di voler cancellare TUTTI gli eventi? Questa azione √® irreversibile.')) {
                databaseEventi = [];
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                
                mostraTabellaEventi();
                showNotification('Database cancellato', 'success');
                
                // Aggiorna anche i contatori nelle altre tab
                document.getElementById('totalEventi3').textContent = '0';
                document.getElementById('eventiAnalizzati3').textContent = '0';
                document.getElementById('totalEventi2').textContent = '0';
                document.getElementById('eventiAnalizzati2').textContent = '0';
            }
        }

        // ==============================
        // FUNZIONI PER LA MODAL E GESTIONE CAMPI
        // ==============================
        function aggiornaMercatoEvento(eventId, mercato) {
            const evento = databaseEventi.find(e => e.id === eventId);
            if (evento) {
                evento.mercato = mercato;
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                showNotification(`Mercato aggiornato: ${mercato}`, 'success');
            }
        }

        function mostraDettagliEventoModal(eventId) {
            const evento = databaseEventi.find(e => e.id === eventId);
            if (!evento) {
                showNotification('Evento non trovato', 'error');
                return;
            }
            
            // Apri la modal
            const modal = document.getElementById('eventoModal');
            modal.style.display = 'block';
            
            // Popola info evento
            const modalInfo = document.getElementById('modalEventoInfo');
            modalInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                        <strong>Evento:</strong> ${evento.nome}
                    </div>
                    <div>
                        <strong>Sport:</strong> ${evento.sport}
                    </div>
                    <div>
                        <strong>Lega:</strong> ${evento.lega}
                    </div>
                    <div>
                        <strong>Nazione:</strong> ${evento.nazione}
                    </div>
                    <div>
                        <strong>Data:</strong> ${evento.dataFormattata}
                    </div>
                    <div>
                        <strong>Tipo Quotes:</strong> ${evento.tipoQuotes || 'N/D'}
                    </div>
                    <div>
                        <strong>Mercato:</strong> ${evento.mercato || 'Non specificato'}
                    </div>
                    <div>
                        <strong>Data creazione:</strong> ${new Date(evento.timestamp).toLocaleString()}
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eaeaea;">
                    <h4 style="margin-bottom: 15px;">üéØ Dati Valuebet & Risultato</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <strong>Tipo Scommessa:</strong><br>
                            <select id="modalTipoScommessa" style="width: 100%; margin-top: 5px; padding: 5px;"
                                    onchange="aggiornaTipoScommessa('${evento.id}', this.value)">
                                <option value="">Seleziona...</option>
                                ${mercatiConfigurati.sort((a, b) => a.ordine - b.ordine).map(mercato => `
                                    <option value="${mercato.codice}" ${evento.tipoScommessa === mercato.codice ? 'selected' : ''}>
                                        ${mercato.nome}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <strong>Value su:</strong><br>
                            <select id="modalValueSu" style="width: 100%; margin-top: 5px; padding: 5px;"
                                    onchange="aggiornaValueSu('${evento.id}', this.value)">
                                <option value="">N/D</option>
                                ${evento.tipoQuotes === '3_esiti' ? `
                                    <option value="1" ${evento.valueSu === '1' ? 'selected' : ''}>1 - Home</option>
                                    <option value="X" ${evento.valueSu === 'X' ? 'selected' : ''}>X - Draw</option>
                                    <option value="2" ${evento.valueSu === '2' ? 'selected' : ''}>2 - Away</option>
                                ` : `
                                    <option value="SI" ${evento.valueSu === 'SI' ? 'selected' : ''}>S√¨</option>
                                    <option value="NO" ${evento.valueSu === 'NO' ? 'selected' : ''}>No</option>
                                `}
                            </select>
                        </div>
                        
                        <div>
                            <strong>Risultato Reale:</strong><br>
                            <select id="modalRisultato" style="width: 100%; margin-top: 5px; padding: 5px;"
                                    onchange="aggiornaRisultatoReale('${evento.id}', this.value)">
                                <option value="">N/D</option>
                                ${evento.tipoQuotes === '3_esiti' ? `
                                    <option value="1" ${evento.risultatoReale === '1' ? 'selected' : ''}>1 - Home</option>
                                    <option value="X" ${evento.risultatoReale === 'X' ? 'selected' : ''}>X - Draw</option>
                                    <option value="2" ${evento.risultatoReale === '2' ? 'selected' : ''}>2 - Away</option>
                                ` : `
                                    <option value="SI" ${evento.risultatoReale === 'SI' ? 'selected' : ''}>S√¨</option>
                                    <option value="NO" ${evento.risultatoReale === 'NO' ? 'selected' : ''}>No</option>
                                `}
                                <option value="ANNULLATO" ${evento.risultatoReale === 'ANNULLATO' ? 'selected' : ''}>‚ùå Annullato</option>
                            </select>
                        </div>
                    </div>
                    
                    ${evento.haVinto !== undefined ? `
                    <div style="margin-top: 15px; padding: 10px; background: ${evento.haVinto ? '#dcfce7' : '#fee2e2'}; border-radius: 6px;">
                        <strong>${evento.haVinto ? '‚úÖ VINTA' : '‚ùå PERSA'}</strong>
                        ${evento.profitto ? ` | Profitto: ${evento.profitto > 0 ? '+' : ''}${evento.profitto.toFixed(2)}‚Ç¨` : ''}
                        ${evento.roi ? ` | ROI: ${evento.roi > 0 ? '+' : ''}${evento.roi.toFixed(1)}%` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Popola info AIQ se presenti
            const modalAIQ = document.getElementById('modalAIQInfo');
            if (evento.aiqData && evento.aiqData.stats) {
                const stats = evento.aiqData.stats;
                
                if (evento.tipoQuotes === '3_esiti') {
                    modalAIQ.innerHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìä Statistiche AIQ - 3 Esiti</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div style="background: #eff6ff; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #2563eb; margin-bottom: 5px;">ESITO 1</div>
                                <div><strong>Media:</strong> ${stats.avg1 ? stats.avg1.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.min1 ? stats.min1.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.max1 ? stats.max1.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacle1 ? stats.pinnacle1.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfair1 ? stats.betfair1.toFixed(2) : '-'}</div>
                            </div>
                            <div style="background: #faf5ff; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #9333ea; margin-bottom: 5px;">ESITO X</div>
                                <div><strong>Media:</strong> ${stats.avgX ? stats.avgX.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.minX ? stats.minX.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.maxX ? stats.maxX.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacleX ? stats.pinnacleX.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfairX ? stats.betfairX.toFixed(2) : '-'}</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #059669; margin-bottom: 5px;">ESITO 2</div>
                                <div><strong>Media:</strong> ${stats.avg2 ? stats.avg2.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.min2 ? stats.min2.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.max2 ? stats.max2.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacle2 ? stats.pinnacle2.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfair2 ? stats.betfair2.toFixed(2) : '-'}</div>
                            </div>
                        </div>
                    `;
                } else if (evento.tipoQuotes === '2_esiti') {
                    modalAIQ.innerHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìä Statistiche AIQ - 2 Esiti</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; text-align: center;">
                            <div style="background: #eff6ff; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #2563eb; margin-bottom: 5px;">ESITO S√å</div>
                                <div><strong>Media:</strong> ${stats.avgYes ? stats.avgYes.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.minYes ? stats.minYes.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.maxYes ? stats.maxYes.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacleYes ? stats.pinnacleYes.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfairYes ? stats.betfairYes.toFixed(2) : '-'}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #dc2626; margin-bottom: 5px;">ESITO NO</div>
                                <div><strong>Media:</strong> ${stats.avgNo ? stats.avgNo.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.minNo ? stats.minNo.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.maxNo ? stats.maxNo.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacleNo ? stats.pinnacleNo.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfairNo ? stats.betfairNo.toFixed(2) : '-'}</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                modalAIQ.innerHTML = '<p style="color: #666; text-align: center;">‚ö† Nessun dato AIQ disponibile</p>';
            }
            
            // Popola tabella quotes
            const modalQuotes = document.getElementById('modalQuotesContainer');
            if (evento.quotes && evento.quotes.length > 0) {
                let tableHTML = '';
                
                if (evento.tipoQuotes === '3_esiti') {
                    tableHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìã Dettaglio Bookmaker (${evento.quotes.length} totali)</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #eaeaea;">Bookmaker</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #2563eb;">1</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #9333ea;">X</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #059669;">2</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea;">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${evento.quotes.map(book => `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 10px;">
                                                <span style="font-weight: ${book.isSharp ? 'bold' : 'normal'}; color: ${book.isSharp ? '#ea580c' : '#1a1a1a'}">
                                                    ${formatBookmakerName(book.bookmaker)}${book.isSharp ? ' ‚ö°' : ''}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #eff6ff; color: #2563eb;">
                                                ${book.quote1.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #faf5ff; color: #9333ea;">
                                                ${book.quoteX.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #f0fdf4; color: #059669;">
                                                ${book.quote2.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center;">
                                                ${book.isSharp ? '<span style="color: #ea580c; font-weight: bold;">SHARP</span>' : '<span style="color: #666;">SOFT</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (evento.tipoQuotes === '2_esiti') {
                    tableHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìã Dettaglio Bookmaker (${evento.quotes.length} totali)</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #eaeaea;">Bookmaker</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #2563eb;">S√å</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #dc2626;">NO</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea;">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${evento.quotes.map(book => `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 10px;">
                                                <span style="font-weight: ${book.isSharp ? 'bold' : 'normal'}; color: ${book.isSharp ? '#ea580c' : '#1a1a1a'}">
                                                    ${formatBookmakerName(book.bookmaker)}${book.isSharp ? ' ‚ö°' : ''}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #eff6ff; color: #2563eb;">
                                                ${book.quoteYes.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #fef2f2; color: #dc2626;">
                                                ${book.quoteNo.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center;">
                                                ${book.isSharp ? '<span style="color: #ea580c; font-weight: bold;">SHARP</span>' : '<span style="color: #666;">SOFT</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                modalQuotes.innerHTML = tableHTML;
            } else {
                modalQuotes.innerHTML = '<p style="color: #666; text-align: center;">‚ö† Nessuna quote disponibile</p>';
            }
        }

        function chiudiModal() {
            const modal = document.getElementById('eventoModal');
            modal.style.display = 'none';
        }

        // Chiudi la modal cliccando fuori
        window.onclick = function(event) {
            const modal = document.getElementById('eventoModal');
            if (event.target === modal) {
                chiudiModal();
            }
        };

        // ==============================
        // FUNZIONI PER SETUP MERCATI
        // ==============================
        let mercatiConfigurati = JSON.parse(localStorage.getItem('mercatiConfigurati') || '[]');
        let configurazioneSetup = JSON.parse(localStorage.getItem('configurazioneSetup') || JSON.stringify({
            autoSalva: true,
            mostraCodici: false,
            ultimoSalvataggio: null,
            versione: '1.0'
        }));

        // Mercati di default se nessuno configurato
        const MERCATI_DEFAULT = [
            { codice: 'hcap', nome: 'Handicap Asiatico', ordine: 1, usato: 0 },
            { codice: 'overunder', nome: 'Over/Under', ordine: 2, usato: 0 },
            { codice: '1x2', nome: '1X2', ordine: 3, usato: 0 },
            { codice: 'btts', nome: 'Both Teams to Score', ordine: 4, usato: 0 },
            { codice: 'dc', nome: 'Doppia Chance', ordine: 5, usato: 0 },
            { codice: 'multigoal', nome: 'Multigoal', ordine: 6, usato: 0 },
            { codice: 'corners', nome: 'Corners', ordine: 7, usato: 0 },
            { codice: 'cards', nome: 'Cartellini', ordine: 8, usato: 0 },
            { codice: 'exact_score', nome: 'Risultato Esatto', ordine: 9, usato: 0 },
            { codice: 'htft', nome: 'Primo/Secondo Tempo', ordine: 10, usato: 0 }
        ];

        function initMercati() {
            if (mercatiConfigurati.length === 0) {
                mercatiConfigurati = [...MERCATI_DEFAULT];
                salvaMercati();
            }
            mostraListaMercati();
            aggiornaStatisticheMercati();
            caricaImpostazioniSetup();
        }

        function mostraListaMercati() {
            const container = document.getElementById('listaMercati');
            const emptyState = document.getElementById('emptyMercati');
            
            if (mercatiConfigurati.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Ordina per ordine
            const mercatiOrdinati = [...mercatiConfigurati].sort((a, b) => a.ordine - b.ordine);
            
            container.innerHTML = mercatiOrdinati.map((mercato, index) => {
                // Conta utilizzi negli eventi
                const utilizzi = databaseEventi.filter(e => e.mercato === mercato.codice).length;
                mercato.usato = utilizzi; // Aggiorna conteggio
                
                return `
                    <tr data-mercato-id="${mercato.codice}" draggable="true" 
                        ondragstart="dragStart(event)" 
                        ondragover="dragOver(event)" 
                        ondrop="drop(event)">
                        <td style="text-align: center;">
                            <span style="background: #e5e7eb; color: #4b5563; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ${mercato.ordine}
                            </span>
                        </td>
                        <td>
                            <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${mercato.codice}
                            </code>
                        </td>
                        <td>
                            <input type="text" value="${mercato.nome}" 
                                data-codice="${mercato.codice}"
                                onchange="aggiornaNomeMercato('${mercato.codice}', this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </td>
                        <td style="text-align: center;">
                            <span style="background: ${utilizzi > 0 ? '#dbeafe' : '#f3f4f6'}; 
                                color: ${utilizzi > 0 ? '#1d4ed8' : '#6b7280'}; 
                                padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: ${utilizzi > 0 ? 'bold' : 'normal'};">
                                ${utilizzi} eventi
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <button onclick="spostaMercato('${mercato.codice}', 'up')" 
                                    style="background: none; border: 1px solid #ddd; padding: 4px 8px; margin-right: 5px; border-radius: 4px; cursor: pointer;"
                                    ${mercato.ordine === 1 ? 'disabled' : ''}>
                                ‚¨ÜÔ∏è
                            </button>
                            <button onclick="spostaMercato('${mercato.codice}', 'down')" 
                                    style="background: none; border: 1px solid #ddd; padding: 4px 8px; margin-right: 5px; border-radius: 4px; cursor: pointer;"
                                    ${mercato.ordine === mercatiConfigurati.length ? 'disabled' : ''}>
                                ‚¨áÔ∏è
                            </button>
                            <button onclick="eliminaMercato('${mercato.codice}')" 
                                    style="background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; padding: 4px 8px; border-radius: 4px; cursor: pointer;"
                                    ${utilizzi > 0 ? 'title="Non eliminabile: utilizzato in eventi"' : ''}
                                    ${utilizzi > 0 ? 'disabled' : ''}>
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Aggiorna anche il dropdown nella tab eventi
            aggiornaDropdownMercati();
        }

        function aggiungiMercato() {
            const codiceInput = document.getElementById('nuovoCodice');
            const nomeInput = document.getElementById('nuovoNome');
            
            const codice = codiceInput.value.trim().toLowerCase();
            const nome = nomeInput.value.trim();
            
            if (!codice || !nome) {
                showNotification('Inserisci sia codice che nome del mercato', 'error');
                return;
            }
            
            // Verifica se il codice esiste gi√†
            if (mercatiConfigurati.some(m => m.codice === codice)) {
                showNotification(`Il codice "${codice}" esiste gi√†`, 'error');
                return;
            }
            
            // Trova il prossimo ordine disponibile
            const maxOrdine = mercatiConfigurati.length > 0 
                ? Math.max(...mercatiConfigurati.map(m => m.ordine)) 
                : 0;
            
            const nuovoMercato = {
                codice: codice,
                nome: nome,
                ordine: maxOrdine + 1,
                usato: 0
            };
            
            mercatiConfigurati.push(nuovoMercato);
            
            if (configurazioneSetup.autoSalva) {
                salvaMercati();
            } else {
                mostraListaMercati();
                aggiornaStatisticheMercati();
            }
            
            // Pulisci i campi input
            codiceInput.value = '';
            nomeInput.value = '';
            
            showNotification(`Mercato "${nome}" aggiunto`, 'success');
        }

        function aggiornaNomeMercato(codice, nuovoNome) {
            const mercato = mercatiConfigurati.find(m => m.codice === codice);
            if (mercato) {
                mercato.nome = nuovoNome.trim();
                if (configurazioneSetup.autoSalva) {
                    salvaMercati();
                }
            }
        }

        function spostaMercato(codice, direzione) {
            const mercato = mercatiConfigurati.find(m => m.codice === codice);
            if (!mercato) return;
            
            const vecchioOrdine = mercato.ordine;
            let nuovoOrdine = direzione === 'up' ? vecchioOrdine - 1 : vecchioOrdine + 1;
            
            // Trova il mercato che ha l'ordine che voglio scambiare
            const mercatoDaScambiare = mercatiConfigurati.find(m => m.ordine === nuovoOrdine);
            
            if (mercatoDaScambiare) {
                // Scambia gli ordini
                mercato.ordine = nuovoOrdine;
                mercatoDaScambiare.ordine = vecchioOrdine;
                
                if (configurazioneSetup.autoSalva) {
                    salvaMercati();
                } else {
                    mostraListaMercati();
                }
                
                showNotification(`Mercato spostato`, 'success');
            }
        }

        function eliminaMercato(codice) {
            const mercato = mercatiConfigurati.find(m => m.codice === codice);
            if (!mercato) return;
            
            // Verifica se √® utilizzato
            const utilizzi = databaseEventi.filter(e => e.mercato === codice).length;
            if (utilizzi > 0) {
                showNotification(`Non puoi eliminare un mercato utilizzato in ${utilizzi} eventi`, 'error');
                return;
            }
            
            if (confirm(`Sei sicuro di voler eliminare il mercato "${mercato.nome}"?`)) {
                mercatiConfigurati = mercatiConfigurati.filter(m => m.codice !== codice);
                
                // Riordina i restanti mercati
                mercatiConfigurati.sort((a, b) => a.ordine - b.ordine);
                mercatiConfigurati.forEach((m, index) => {
                    m.ordine = index + 1;
                });
                
                if (configurazioneSetup.autoSalva) {
                    salvaMercati();
                } else {
                    mostraListaMercati();
                    aggiornaStatisticheMercati();
                }
                
                showNotification(`Mercato eliminato`, 'success');
            }
        }

        function salvaMercati() {
            localStorage.setItem('mercatiConfigurati', JSON.stringify(mercatiConfigurati));
            
            // Aggiorna data ultimo salvataggio
            configurazioneSetup.ultimoSalvataggio = new Date().toISOString();
            localStorage.setItem('configurazioneSetup', JSON.stringify(configurazioneSetup));
            
            mostraListaMercati();
            aggiornaStatisticheMercati();
            aggiornaUltimoSalvataggio();
            
            showNotification('Configurazione mercati salvata', 'success');
        }

        function resetMercatiDefault() {
            if (confirm('Tornare ai mercati di default? La configurazione attuale verr√† persa.')) {
                mercatiConfigurati = [...MERCATI_DEFAULT];
                salvaMercati();
                showNotification('Configurazione resettata ai valori di default', 'success');
            }
        }

        function esportaConfigurazione() {
            const exportData = {
                mercati: mercatiConfigurati,
                configurazione: configurazioneSetup,
                dataEsportazione: new Date().toISOString(),
                totaleEventi: databaseEventi.length
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            const nomeFile = `setup_mercati_${new Date().toISOString().slice(0, 10)}.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Configurazione esportata', 'success');
        }

        function importaConfigurazione() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importData = JSON.parse(event.target.result);
                        
                        if (!importData.mercati || !Array.isArray(importData.mercati)) {
                            throw new Error('Formato file non valido');
                        }
                        
                        if (confirm(`Importare ${importData.mercati.length} mercati? La configurazione attuale verr√† sovrascritta.`)) {
                            mercatiConfigurati = importData.mercati;
                            
                            if (importData.configurazione) {
                                configurazioneSetup = importData.configurazione;
                                localStorage.setItem('configurazioneSetup', JSON.stringify(configurazioneSetup));
                            }
                            
                            salvaMercati();
                            caricaImpostazioniSetup();
                            showNotification(`Configurazione importata con ${mercatiConfigurati.length} mercati`, 'success');
                        }
                    } catch (error) {
                        showNotification('Errore nell\'importazione: file non valido', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function aggiornaDropdownMercati() {
            // Questa funzione sar√† chiamata da mostraTabellaEventi per aggiornare le opzioni
            // Non √® necessario implementarla qui, verr√† gestita dinamicamente
        }

        function aggiornaStatisticheMercati() {
            document.getElementById('totaleMercati').textContent = mercatiConfigurati.length;
            
            // Conta mercati utilizzati
            const mercatiUtilizzati = new Set(databaseEventi.map(e => e.mercato).filter(Boolean));
            document.getElementById('mercatiUtilizzati').textContent = mercatiUtilizzati.size;
        }

        function aggiornaUltimoSalvataggio() {
            if (configurazioneSetup.ultimoSalvataggio) {
                const data = new Date(configurazioneSetup.ultimoSalvataggio);
                document.getElementById('ultimoSalvataggio').textContent = data.toLocaleString();
            } else {
                document.getElementById('ultimoSalvataggio').textContent = 'Mai';
            }
        }

        function caricaImpostazioniSetup() {
            // Carica checkbox
            document.getElementById('autoSalva').checked = configurazioneSetup.autoSalva;
            document.getElementById('mostraCodici').checked = configurazioneSetup.mostraCodici;
            
            // Aggiorna versione
            document.getElementById('versioneConfig').textContent = configurazioneSetup.versione || '1.0';
            
            // Aggiorna data ultimo salvataggio
            aggiornaUltimoSalvataggio();
        }

        function aggiornaAutoSalva() {
            configurazioneSetup.autoSalva = document.getElementById('autoSalva').checked;
            localStorage.setItem('configurazioneSetup', JSON.stringify(configurazioneSetup));
            showNotification('Impostazioni salvate', 'success');
        }

        function aggiornaMostraCodici() {
            configurazioneSetup.mostraCodici = document.getElementById('mostraCodici').checked;
            localStorage.setItem('configurazioneSetup', JSON.stringify(configurazioneSetup));
            showNotification('Impostazioni salvate', 'success');
        }

        // Funzioni per drag & drop
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = e.target.closest('tr');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedItem.innerHTML);
            setTimeout(() => draggedItem.style.opacity = '0.4', 0);
        }

        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function drop(e) {
            e.preventDefault();
            if (draggedItem !== e.target.closest('tr')) {
                const targetRow = e.target.closest('tr');
                const container = draggedItem.parentNode;
                
                if (targetRow) {
                    // Scambia le righe
                    const draggedIndex = Array.from(container.children).indexOf(draggedItem);
                    const targetIndex = Array.from(container.children).indexOf(targetRow);
                    
                    if (draggedIndex < targetIndex) {
                        container.insertBefore(draggedItem, targetRow.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, targetRow);
                    }
                    
                    // Aggiorna ordini
                    const rows = container.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        const codice = row.getAttribute('data-mercato-id');
                        const mercato = mercatiConfigurati.find(m => m.codice === codice);
                        if (mercato) {
                            mercato.ordine = index + 1;
                        }
                    });
                    
                    if (configurazioneSetup.autoSalva) {
                        salvaMercati();
                    } else {
                        mostraListaMercati();
                    }
                }
            }
            draggedItem.style.opacity = '';
        }

        // ==============================
        // FUNZIONI PER I NUOVI CAMPI
        // ==============================

        function aggiornaTipoScommessa(eventId, tipo) {
            const evento = databaseEventi.find(e => e.id === eventId);
            if (evento) {
                evento.tipoScommessa = tipo; // Rinominato da "mercato"
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                showNotification('Tipo scommessa aggiornato', 'success');
            }
        }

        function aggiornaValueSu(eventId, valueSu) {
            const evento = databaseEventi.find(e => e.id === eventId);
            if (evento) {
                evento.valueSu = valueSu;
                
                // Calcola automaticamente se era una valuebet
                if (valueSu && evento.aiqData) {
                    evento.haValuebet = true;
                    evento.dataValuebet = new Date().toISOString();
                    
                    // Salva anche quota e bookmaker della valuebet
                    const stats = evento.aiqData.stats;
                    if (evento.tipoQuotes === '3_esiti') {
                        evento.quotaValue = valueSu === '1' ? stats.min1 : 
                                        valueSu === 'X' ? stats.minX : stats.min2;
                        evento.bookmakerValue = valueSu === '1' ? stats.minBook1 : 
                                            valueSu === 'X' ? stats.minBookX : stats.minBook2;
                    } else {
                        evento.quotaValue = valueSu === 'SI' ? stats.minYes : stats.minNo;
                        evento.bookmakerValue = valueSu === 'SI' ? stats.minBookYes : stats.minBookNo;
                    }
                }
                
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                showNotification(`Valuebet su ${valueSu} registrata`, 'success');
            }
        }

        function aggiornaRisultatoReale(eventId, risultato) {
            const evento = databaseEventi.find(e => e.id === eventId);
            if (evento) {
                evento.risultatoReale = risultato;
                evento.dataRisultato = new Date().toISOString();
                
                // Calcola automaticamente se ha vinto
                if (evento.valueSu && risultato && risultato !== 'ANNULLATO') {
                    evento.haVinto = evento.valueSu === risultato;
                    
                    // Calcola profitto se era una valuebet
                    if (evento.haValuebet && evento.quotaValue) {
                        const stake = 10; // Esempio: 10‚Ç¨ per bet
                        if (evento.haVinto) {
                            evento.profitto = (evento.quotaValue * stake) - stake;
                        } else {
                            evento.profitto = -stake;
                        }
                        evento.roi = (evento.profitto / stake) * 100;
                    }
                }
                
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                showNotification(`Risultato ${risultato} salvato`, 'success');
                
                // Se siamo nella tab Analisi, aggiorna le statistiche
                if (document.getElementById('tab-analisi')?.classList.contains('active')) {
                    applicaFiltriAnalisi();
                }
            }
        }

        // ==============================
        // FUNZIONI PER LA NUOVA TAB ANALISI (COMPLETATE)
        // ==============================

        function initTabAnalisi() {
            caricaDatiAnalisi();
            popolaFiltroSoft();
            applicaFiltriAnalisi();
            caricaConfigAnalisi();
        }

        function caricaDatiAnalisi() {
            datiAnalisi = [];
            
            // Processa tutti gli eventi con valuebet
            databaseEventi.forEach(evento => {
                if (evento.quotes && evento.aiqData) {
                    const stats = evento.aiqData.stats;
                    const tipoQuotes = evento.tipoQuotes;
                    
                    if (tipoQuotes === '3_esiti') {
                        // Analisi per 3 esiti
                        processaEsiti3(evento, stats);
                    } else if (tipoQuotes === '2_esiti') {
                        // Analisi per 2 esiti
                        processaEsiti2(evento, stats);
                    }
                }
            });
            
            // Calcola ripetizioni
            calcolaRipetizioni();
            // Calcola score iniziali
            calcolaScorePerTutti();
            
            console.log(`Analisi: caricate ${datiAnalisi.length} valuebet`);
        }

        function processaEsiti3(evento, stats) {
            const esiti = [
                { mercato: 'HOME', quotaSharp: stats.pinnacle1 || stats.betfair1, 
                  quotaMedia: stats.avg1, quotaMin: stats.min1, minBook: stats.minBook1 },
                { mercato: 'DRAW', quotaSharp: stats.pinnacleX || stats.betfairX, 
                  quotaMedia: stats.avgX, quotaMin: stats.minX, minBook: stats.minBookX },
                { mercato: 'AWAY', quotaSharp: stats.pinnacle2 || stats.betfair2, 
                  quotaMedia: stats.avg2, quotaMin: stats.min2, minBook: stats.minBook2 }
            ];
            
            esiti.forEach((esito, index) => {
                if (esito.quotaSharp && esito.quotaMedia && esito.quotaMin) {
                    const sm = ((esito.quotaSharp - esito.quotaMedia) / esito.quotaMedia) * 100;
                    const mm = esito.mercato === 'HOME' ? ((stats.max1 - esito.quotaMin) / esito.quotaMin) * 100 :
                              esito.mercato === 'DRAW' ? ((stats.maxX - esito.quotaMin) / esito.quotaMin) * 100 :
                              ((stats.max2 - esito.quotaMin) / esito.quotaMin) * 100;
                    const ss = ((esito.quotaSharp - esito.quotaMin) / esito.quotaMin) * 100;
                    const fv = (sm + mm + ss) / 3;
                    
                    if (fv >= 5) {
                        const sharpBook = (stats.pinnacle1 || stats.pinnacleX || stats.pinnacle2) ? 'pinnacle' : 'betfair';
                        
                        datiAnalisi.push({
                            id: evento.id + '_' + esito.mercato,
                            data: new Date(evento.timestamp),
                            match: evento.nome,
                            sport: evento.sport,
                            mercato: esito.mercato,
                            sharpBook: sharpBook,
                            softBook: esito.minBook || 'unknown',
                            quotaSharp: esito.quotaSharp,
                            quotaSoft: esito.quotaMin,
                            delta: ((esito.quotaSharp - esito.quotaMin) / esito.quotaMin) * 100,
                            sm: sm,
                            mm: mm,
                            ss: ss,
                            fv: fv,
                            range: getRangeQuota(esito.quotaSharp),
                            ripetizione: 0,
                            score: 0,
                            eventoId: evento.id
                        });
                    }
                }
            });
        }

        function processaEsiti2(evento, stats) {
            const esiti = [
                { mercato: 'SI', quotaSharp: stats.pinnacleYes || stats.betfairYes, 
                  quotaMedia: stats.avgYes, quotaMin: stats.minYes, minBook: stats.minBookYes },
                { mercato: 'NO', quotaSharp: stats.pinnacleNo || stats.betfairNo, 
                  quotaMedia: stats.avgNo, quotaMin: stats.minNo, minBook: stats.minBookNo }
            ];
            
            esiti.forEach(esito => {
                if (esito.quotaSharp && esito.quotaMedia && esito.quotaMin) {
                    const sm = ((esito.quotaSharp - esito.quotaMedia) / esito.quotaMedia) * 100;
                    const mm = esito.mercato === 'SI' ? ((stats.maxYes - esito.quotaMin) / esito.quotaMin) * 100 :
                              ((stats.maxNo - esito.quotaMin) / esito.quotaMin) * 100;
                    const ss = ((esito.quotaSharp - esito.quotaMin) / esito.quotaMin) * 100;
                    const fv = (sm + mm + ss) / 3;
                    
                    if (fv >= 5) {
                        const sharpBook = (stats.pinnacleYes || stats.pinnacleNo) ? 'pinnacle' : 'betfair';
                        
                        datiAnalisi.push({
                            id: evento.id + '_' + esito.mercato,
                            data: new Date(evento.timestamp),
                            match: evento.nome,
                            sport: evento.sport,
                            mercato: esito.mercato,
                            sharpBook: sharpBook,
                            softBook: esito.minBook || 'unknown',
                            quotaSharp: esito.quotaSharp,
                            quotaSoft: esito.quotaMin,
                            delta: ((esito.quotaSharp - esito.quotaMin) / esito.quotaMin) * 100,
                            sm: sm,
                            mm: mm,
                            ss: ss,
                            fv: fv,
                            range: getRangeQuota(esito.quotaSharp),
                            ripetizione: 0,
                            score: 0,
                            eventoId: evento.id
                        });
                    }
                }
            });
        }

        function getRangeQuota(quota) {
            if (quota < 1.5) return '1.0-1.5';
            if (quota < 2.0) return '1.5-2.0';
            if (quota < 2.5) return '2.0-2.5';
            if (quota < 3.0) return '2.5-3.0';
            if (quota < 4.0) return '3.0-4.0';
            return '4.0+';
        }

        function popolaFiltroSoft() {
            const softUnici = [...new Set(datiAnalisi.map(d => d.softBook))].sort();
            const select = document.getElementById('filtroSoftAnalisi');
            
            if (!select) return;
            
            const valoreCorrente = select.value;
            select.innerHTML = '<option value="">Tutti</option>';
            
            softUnici.forEach(soft => {
                if (soft && soft !== 'unknown') {
                    const option = document.createElement('option');
                    option.value = soft;
                    option.textContent = formatBookmakerName(soft);
                    select.appendChild(option);
                }
            });
            
            if (valoreCorrente && softUnici.includes(valoreCorrente)) {
                select.value = valoreCorrente;
            }
        }

        function calcolaRipetizioni() {
            // Conta ripetizioni per soft bookmaker
            const conteggiSoft = {};
            datiAnalisi.forEach(d => {
                const key = `${d.softBook}_${d.mercato}_${d.range}`;
                conteggiSoft[key] = (conteggiSoft[key] || 0) + 1;
            });
            
            // Assegna conteggi ai dati
            datiAnalisi.forEach(d => {
                const key = `${d.softBook}_${d.mercato}_${d.range}`;
                d.ripetizione = conteggiSoft[key] || 0;
            });
        }

        function calcolaScorePerTutti() {
            datiAnalisi.forEach(d => {
                d.score = calcolaScoreSingolo(d);
            });
        }

        function calcolaScoreSingolo(dato) {
            let score = 0;
            
            if (configScore.sharpPinnacle && dato.sharpBook === 'pinnacle') score += 2;
            if (configScore.softBet365 && dato.softBook === 'bet365') score += 1;
            if (configScore.fv8 && dato.fv >= 8) score += 1;
            if (configScore.quotaRange && dato.range === '2.0-2.5') score += 1;
            if (configScore.delta5 && dato.delta >= 5) score += 1;
            if (configScore.penaltyDRAW && dato.mercato === 'DRAW') score -= 1;
            
            return Math.max(0, score);
        }

        function applicaFiltriAnalisi() {
            if (!document.getElementById('filtroSportAnalisi')) return;
            
            // Raccogli filtri
            filtriAttivi = {
                sport: document.getElementById('filtroSportAnalisi').value,
                mercato: document.getElementById('filtroMercatoAnalisi').value,
                sharp: document.getElementById('filtroSharpAnalisi').value,
                soft: document.getElementById('filtroSoftAnalisi').value,
                range: document.getElementById('filtroRangeQuota').value,
                fvMin: parseFloat(document.getElementById('filtroFVMin').value) || 5,
                dataDa: document.getElementById('filtroDataDa').value
            };
            
            // Applica filtri
            let filtrati = [...datiAnalisi];
            
            if (filtriAttivi.sport) {
                filtrati = filtrati.filter(d => d.sport.toLowerCase().includes(filtriAttivi.sport.toLowerCase()));
            }
            
            if (filtriAttivi.mercato) {
                filtrati = filtrati.filter(d => d.mercato === filtriAttivi.mercato);
            }
            
            if (filtriAttivi.sharp) {
                filtrati = filtrati.filter(d => d.sharpBook === filtriAttivi.sharp);
            }
            
            if (filtriAttivi.soft) {
                filtrati = filtrati.filter(d => d.softBook === filtriAttivi.soft);
            }
            
            if (filtriAttivi.range) {
                const rangeMap = {
                    '1.5-2.0': '1.5-2.0',
                    '2.0-2.5': '2.0-2.5',
                    '2.5-3.0': '2.5-3.0',
                    '3.0-4.0': '3.0-4.0',
                    '4.0+': '4.0+'
                };
                
                if (rangeMap[filtriAttivi.range]) {
                    filtrati = filtrati.filter(d => d.range === rangeMap[filtriAttivi.range]);
                }
            }
            
            if (filtriAttivi.fvMin) {
                filtrati = filtrati.filter(d => d.fv >= filtriAttivi.fvMin);
            }
            
            if (filtriAttivi.dataDa) {
                const dataDa = new Date(filtriAttivi.dataDa);
                filtrati = filtrati.filter(d => d.data >= dataDa);
            }
            
            // Aggiorna KPI
            aggiornaKPI(filtrati);
            
            // Mostra tabella
            mostraTabellaAnalisi(filtrati);
            
            // Aggiorna grafici semplificati
            aggiornaGraficiSemplificati(filtrati);
            
            // Contatore
            const contatore = document.getElementById('contatoreRisultati');
            if (contatore) {
                contatore.textContent = filtrati.length;
            }
        }

        function resetFiltriAnalisi() {
            if (!document.getElementById('filtroSportAnalisi')) return;
            
            document.getElementById('filtroSportAnalisi').value = '';
            document.getElementById('filtroMercatoAnalisi').value = '';
            document.getElementById('filtroSharpAnalisi').value = '';
            document.getElementById('filtroSoftAnalisi').value = '';
            document.getElementById('filtroRangeQuota').value = '';
            document.getElementById('filtroFVMin').value = '5';
            document.getElementById('filtroDataDa').value = '';
            
            applicaFiltriAnalisi();
        }

        function aggiornaKPI(dati) {
            if (dati.length === 0) {
                resetKPI();
                return;
            }
            
            // KPI base
            document.getElementById('kpiTotaleValue').textContent = dati.length;
            document.getElementById('kpiFVMedia').textContent = 
                (dati.reduce((sum, d) => sum + d.fv, 0) / dati.length).toFixed(1) + '%';
            document.getElementById('kpiQuotaMedia').textContent = 
                (dati.reduce((sum, d) => sum + d.quotaSharp, 0) / dati.length).toFixed(2);
            
            // Sharp pi√π frequente
            const sharpCounts = {};
            dati.forEach(d => {
                sharpCounts[d.sharpBook] = (sharpCounts[d.sharpBook] || 0) + 1;
            });
            const sharpTop = Object.entries(sharpCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('kpiSharpFrequente').textContent = 
                sharpTop ? formatBookmakerName(sharpTop[0]) + ` (${sharpTop[1]})` : '-';
            
            // Soft pi√π frequente
            const softCounts = {};
            dati.forEach(d => {
                softCounts[d.softBook] = (softCounts[d.softBook] || 0) + 1;
            });
            const softTop = Object.entries(softCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('kpiSoftFrequente').textContent = 
                softTop ? formatBookmakerName(softTop[0]) + ` (${softTop[1]})` : '-';
            
            // Mercato dominante
            const mercatoCounts = {};
            dati.forEach(d => {
                mercatoCounts[d.mercato] = (mercatoCounts[d.mercato] || 0) + 1;
            });
            const mercatoTop = Object.entries(mercatoCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('kpiMercatoDominante').textContent = 
                mercatoTop ? `${mercatoTop[0]} (${mercatoTop[1]})` : '-';
            
            // KPI avanzati
            document.getElementById('kpiDeltaMedio').textContent = 
                (dati.reduce((sum, d) => sum + d.delta, 0) / dati.length).toFixed(2) + '%';
            
            const ripetizioni = dati.filter(d => d.ripetizione >= 2).length;
            document.getElementById('kpiRipetizioni').textContent = ripetizioni;
            
            // Successo stimato (semplificato)
            const successoStimato = Math.min(100, Math.max(0, 
                (dati.reduce((sum, d) => sum + d.fv, 0) / dati.length) * 2
            ));
            document.getElementById('kpiSuccessoStimato').textContent = 
                successoStimato.toFixed(1) + '%';
            
            // Score medio
            const scoreMedio = dati.length > 0 ? 
                dati.reduce((sum, d) => sum + d.score, 0) / dati.length : 0;
            document.getElementById('kpiScoreAffidabilita').textContent = scoreMedio.toFixed(1);
        }

        // Funzioni mancanti per la tab Analisi

        function resetKPI() {
            document.getElementById('kpiTotaleValue').textContent = '0';
            document.getElementById('kpiFVMedia').textContent = '0.0%';
            document.getElementById('kpiQuotaMedia').textContent = '0.00';
            document.getElementById('kpiSharpFrequente').textContent = '-';
            document.getElementById('kpiSoftFrequente').textContent = '-';
            document.getElementById('kpiMercatoDominante').textContent = '-';
            document.getElementById('kpiDeltaMedio').textContent = '0.00';
            document.getElementById('kpiRipetizioni').textContent = '0';
            document.getElementById('kpiSuccessoStimato').textContent = '0%';
            document.getElementById('kpiScoreAffidabilita').textContent = '0.0';
        }

        function mostraTabellaAnalisi(dati) {
            const container = document.getElementById('tabellaAnalisi');
            const emptyState = document.getElementById('emptyAnalisi');
            
            if (dati.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Applica ordinamento se necessario
            if (currentSortAnalisi.column) {
                dati.sort((a, b) => {
                    let valueA = a[currentSortAnalisi.column];
                    let valueB = b[currentSortAnalisi.column];
                    
                    if (currentSortAnalisi.column === 'data') {
                        valueA = new Date(valueA);
                        valueB = new Date(valueB);
                    }
                    
                    if (currentSortAnalisi.direction === 'asc') {
                        return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                    } else {
                        return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                    }
                });
            }
            
            container.innerHTML = dati.map((dato, index) => {
                // Recupera dati risultato dall'evento originale
                const evento = databaseEventi.find(e => e.id === dato.eventoId);
                const haVinto = evento && evento.haVinto !== undefined ? evento.haVinto : null;
                
                return `
                    <tr>
                        <td style="font-size: 11px;">
                            ${dato.data.toLocaleDateString('it-IT')}<br>
                            ${dato.data.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}
                        </td>
                        <td>
                            <strong>${dato.match.substring(0, 25)}${dato.match.length > 25 ? '...' : ''}</strong><br>
                            <small style="color: #666;">${dato.sport}</small>
                        </td>
                        <td style="text-align: center;">
                            <span style="background: ${dato.mercato === 'HOME' ? '#eff6ff' : 
                                                dato.mercato === 'DRAW' ? '#faf5ff' : 
                                                dato.mercato === 'AWAY' ? '#f0fdf4' :
                                                dato.mercato === 'SI' ? '#eff6ff' : '#fef2f2'}; 
                                        color: ${dato.mercato === 'HOME' ? '#2563eb' : 
                                                dato.mercato === 'DRAW' ? '#9333ea' : 
                                                dato.mercato === 'AWAY' ? '#059669' :
                                                dato.mercato === 'SI' ? '#2563eb' : '#dc2626'}; 
                                        padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${dato.mercato}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-weight: bold; color: #ea580c;">${formatBookmakerName(dato.sharpBook)}</span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-weight: ${dato.ripetizione > 1 ? 'bold' : 'normal'}; 
                                color: ${dato.ripetizione > 1 ? '#dc2626' : '#666'};">
                                ${formatBookmakerName(dato.softBook)}
                            </span>
                        </td>
                        <td style="text-align: center; font-weight: bold;">${dato.quotaSharp.toFixed(2)}</td>
                        <td style="text-align: center; font-weight: bold;">${dato.quotaSoft.toFixed(2)}</td>
                        <td style="text-align: center;">
                            <span style="background: ${dato.delta >= 5 ? '#dcfce7' : '#fef9c3'}; 
                                        color: ${dato.delta >= 5 ? '#166534' : '#854d0e'}; 
                                        padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${dato.delta.toFixed(1)}%
                            </span>
                        </td>
                        <td style="text-align: center;">${dato.sm.toFixed(1)}%</td>
                        <td style="text-align: center;">
                            <span style="background: ${dato.fv >= 8 ? '#dcfce7' : 
                                                    dato.fv >= 5 ? '#fef9c3' : '#fee2e2'}; 
                                        color: ${dato.fv >= 8 ? '#166534' : 
                                                dato.fv >= 5 ? '#854d0e' : '#dc2626'}; 
                                        padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${dato.fv.toFixed(1)}%
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span style="background: #f3f4f6; color: #4b5563; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                ${dato.range}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            ${dato.ripetizione > 1 ? 
                                `<span style="background: #fef9c3; color: #854d0e; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                    ${dato.ripetizione}x
                                </span>` : 
                                '<span style="color: #888;">1x</span>'}
                        </td>
                        <td style="text-align: center;">
                            <span style="background: ${dato.score >= 3 ? '#dcfce7' : 
                                                    dato.score >= 2 ? '#fef9c3' : '#fee2e2'}; 
                                        color: ${dato.score >= 3 ? '#166534' : 
                                                dato.score >= 2 ? '#854d0e' : '#dc2626'}; 
                                        padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${dato.score.toFixed(1)}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function sortAnalisi(column) {
            const header = document.querySelector(`#tab-analisi th[onclick="sortAnalisi('${column}')"]`);
            
            if (!header) return;
            
            if (currentSortAnalisi.column === column) {
                currentSortAnalisi.direction = currentSortAnalisi.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortAnalisi.column = column;
                currentSortAnalisi.direction = 'asc';
            }
            
            document.querySelectorAll('#tab-analisi .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            
            header.classList.add(currentSortAnalisi.direction);
            
            applicaFiltriAnalisi();
        }

        function aggiornaGraficiSemplificati(dati) {
            if (dati.length === 0) {
                rimuoviGrafici();
                return;
            }
            
            // Grafico 1: Soft pi√π Errori
            aggiornaGraficoSoftErrori(dati);
            
            // Grafico 2: Delta nel Tempo
            aggiornaGraficoDeltaTempo(dati);
            
            // Grafico 3: Heatmap Mercato/Quota
            aggiornaHeatmapMercatoQuota(dati);
            
            // Grafico 4: Performance per Range
            aggiornaGraficoPerformanceRange(dati);
        }

        function rimuoviGrafici() {
            const containers = ['chartSoftErrori', 'chartDeltaTempo', 'chartHeatmap', 'chartPerformanceRange'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = '<div style="padding: 50px; text-align: center; color: #666;">Nessun dato disponibile</div>';
                }
            });
        }

        function aggiornaGraficoSoftErrori(dati) {
            const container = document.getElementById('chartSoftErrori');
            if (!container) return;
            
            // Conta errori per soft bookmaker
            const softCounts = {};
            dati.forEach(d => {
                softCounts[d.softBook] = (softCounts[d.softBook] || 0) + 1;
            });
            
            const labels = Object.keys(softCounts).map(name => formatBookmakerName(name));
            const values = Object.values(softCounts);
            
            // Ordina per numero di errori
            const combined = labels.map((label, index) => ({ label, value: values[index] }));
            combined.sort((a, b) => b.value - a.value);
            const sortedLabels = combined.map(item => item.label);
            const sortedValues = combined.map(item => item.value);
            
            // Colori
            const backgroundColors = sortedValues.map((value, index) => 
                `hsl(${index * 30}, 70%, 60%)`
            );
            
            const ctx = document.createElement('canvas');
            container.innerHTML = '';
            container.appendChild(ctx);
            
            if (chartSoftErrori) chartSoftErrori.destroy();
            
            chartSoftErrori = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedLabels.slice(0, 10), // Top 10
                    datasets: [{
                        label: 'Numero di Valuebet',
                        data: sortedValues.slice(0, 10),
                        backgroundColor: backgroundColors.slice(0, 10),
                        borderColor: backgroundColors.slice(0, 10).map(color => color.replace('60%)', '40%)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Soft Bookmaker con pi√π Errori Sistematici',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Numero di Valuebet' }
                        },
                        x: {
                            ticks: { maxRotation: 45 }
                        }
                    }
                }
            });
        }

        function aggiornaGraficoDeltaTempo(dati) {
            const container = document.getElementById('chartDeltaTempo');
            if (!container) return;
            
            // Raggruppa per data e calcola delta medio
            const dataMap = {};
            dati.forEach(d => {
                const dateStr = d.data.toISOString().split('T')[0];
                if (!dataMap[dateStr]) {
                    dataMap[dateStr] = { sum: 0, count: 0 };
                }
                dataMap[dateStr].sum += d.delta;
                dataMap[dateStr].count += 1;
            });
            
            const labels = Object.keys(dataMap).sort();
            const avgDeltas = labels.map(date => (dataMap[date].sum / dataMap[date].count).toFixed(1));
            
            const ctx = document.createElement('canvas');
            container.innerHTML = '';
            container.appendChild(ctx);
            
            if (chartDeltaTempo) chartDeltaTempo.destroy();
            
            chartDeltaTempo = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Delta Medio (%)',
                        data: avgDeltas,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evoluzione Delta Sharp-Soft nel Tempo',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Delta (%)' }
                        },
                        x: {
                            title: { display: true, text: 'Data' }
                        }
                    }
                }
            });
        }

        function aggiornaHeatmapMercatoQuota(dati) {
            const container = document.getElementById('chartHeatmap');
            if (!container) return;
            
            // Raggruppa per mercato e range
            const mercati = [...new Set(dati.map(d => d.mercato))].sort();
            const ranges = [...new Set(dati.map(d => d.range))].sort((a, b) => {
                const getMin = range => parseFloat(range.split('-')[0]) || parseFloat(range);
                return getMin(a) - getMin(b);
            });
            
            // Crea matrice di dati
            const matrix = mercati.map(mercato => {
                return ranges.map(range => {
                    return dati.filter(d => d.mercato === mercato && d.range === range).length;
                });
            });
            
            const ctx = document.createElement('canvas');
            container.innerHTML = '';
            container.appendChild(ctx);
            
            if (chartHeatmap) chartHeatmap.destroy();
            
            chartHeatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges,
                    datasets: mercati.map((mercato, index) => ({
                        label: mercato,
                        data: matrix[index],
                        backgroundColor: `hsla(${index * 60}, 70%, 60%, 0.7)`,
                        borderColor: `hsla(${index * 60}, 70%, 40%, 1)`,
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuzione Valuebet per Mercato e Range Quota',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Range Quota' }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { display: true, text: 'Numero di Valuebet' }
                        }
                    }
                }
            });
        }

        function aggiornaGraficoPerformanceRange(dati) {
            const container = document.getElementById('chartPerformanceRange');
            if (!container) return;
            
            // Raggruppa per range
            const ranges = [...new Set(dati.map(d => d.range))].sort((a, b) => {
                const getMin = range => parseFloat(range.split('-')[0]) || parseFloat(range);
                return getMin(a) - getMin(b);
            });
            
            // Conta per range
            const counts = ranges.map(range => dati.filter(d => d.range === range).length);
            
            // Calcola successo stimato (simulato)
            const successRates = ranges.map(range => {
                const rangeDati = dati.filter(d => d.range === range);
                if (rangeDati.length === 0) return 0;
                
                // Simula successo basato su score
                const avgScore = rangeDati.reduce((sum, d) => sum + d.score, 0) / rangeDati.length;
                return Math.min(100, Math.max(0, 40 + avgScore * 15)); // Formula di esempio
            });
            
            const ctx = document.createElement('canvas');
            container.innerHTML = '';
            container.appendChild(ctx);
            
            if (chartPerformanceRange) chartPerformanceRange.destroy();
            
            chartPerformanceRange = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges,
                    datasets: [
                        {
                            label: 'Numero Valuebet',
                            data: counts,
                            backgroundColor: 'rgba(37, 99, 235, 0.6)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Successo Stimato (%)',
                            data: successRates,
                            backgroundColor: 'rgba(5, 150, 105, 0.6)',
                            borderColor: 'rgba(5, 150, 105, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance per Range di Quota',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Range Quota' } },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Numero Valuebet' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Successo Stimato (%)' },
                            beginAtZero: true,
                            max: 100,
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Funzioni per switch grafici
        function switchGrafico(graficoId) {
            // Nascondi tutti i grafici
            document.querySelectorAll('#tab-analisi .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#tab-analisi .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra il grafico selezionato
            document.getElementById(graficoId).classList.add('active');
            document.querySelector(`#tab-analisi .tab[onclick="switchGrafico('${graficoId}')"]`).classList.add('active');
            
            // Ricalcola i grafici se necessario
            setTimeout(() => {
                if (graficoId === 'grafico1') {
                    if (chartSoftErrori) chartSoftErrori.resize();
                } else if (graficoId === 'grafico2') {
                    if (chartDeltaTempo) chartDeltaTempo.resize();
                } else if (graficoId === 'grafico3') {
                    if (chartHeatmap) chartHeatmap.resize();
                } else if (graficoId === 'grafico4') {
                    if (chartPerformanceRange) chartPerformanceRange.resize();
                }
            }, 100);
        }

        // Funzioni per Score e Configurazione
        function caricaConfigAnalisi() {
            const saved = localStorage.getItem('configScoreAnalisi');
            if (saved) {
                configScore = JSON.parse(saved);
                
                // Aggiorna checkbox
                document.getElementById('scoreSharpPinnacle').checked = configScore.sharpPinnacle;
                document.getElementById('scoreSoftBet365').checked = configScore.softBet365;
                document.getElementById('scoreFV8').checked = configScore.fv8;
                document.getElementById('scoreQuotaRange').checked = configScore.quotaRange;
                document.getElementById('scoreDelta5').checked = configScore.delta5;
                document.getElementById('scorePenaltyDRAW').checked = configScore.penaltyDRAW;
            }
        }

        function applicaScoreConfig() {
            configScore = {
                sharpPinnacle: document.getElementById('scoreSharpPinnacle').checked,
                softBet365: document.getElementById('scoreSoftBet365').checked,
                fv8: document.getElementById('scoreFV8').checked,
                quotaRange: document.getElementById('scoreQuotaRange').checked,
                delta5: document.getElementById('scoreDelta5').checked,
                penaltyDRAW: document.getElementById('scorePenaltyDRAW').checked
            };
            
            localStorage.setItem('configScoreAnalisi', JSON.stringify(configScore));
            
            // Ricalcola score per tutti
            calcolaScorePerTutti();
            
            // Riapplica filtri per aggiornare tabella
            applicaFiltriAnalisi();
            
            showNotification('Configurazione score applicata', 'success');
        }

        function calcolaScoreAffidabilita() {
            calcolaScorePerTutti();
            applicaFiltriAnalisi();
            showNotification('Score affidabilit√† ricalcolati', 'success');
        }

        function mostraSoloRipetizioni() {
            // Applica filtro per ripetizioni > 1
            const filtroRipetizioni = document.createElement('input');
            filtroRipetizioni.type = 'hidden';
            filtroRipetizioni.id = 'filtroRipetizioniTmp';
            
            // Filtra dati gi√† filtrati
            let datiFiltrati = [...datiAnalisi];
            
            // Applica filtri attuali
            if (filtriAttivi.sport) {
                datiFiltrati = datiFiltrati.filter(d => d.sport.toLowerCase().includes(filtriAttivi.sport.toLowerCase()));
            }
            
            // Filtra per ripetizioni > 1
            datiFiltrati = datiFiltrati.filter(d => d.ripetizione > 1);
            
            // Mostra risultati
            mostraTabellaAnalisi(datiFiltrati);
            document.getElementById('contatoreRisultati').textContent = datiFiltrati.length;
            
            showNotification(`Mostrate ${datiFiltrati.length} valuebet con pattern ripetuti`, 'success');
        }

        function mostraValueTopScore() {
            const datiFiltrati = datiAnalisi.filter(d => d.score >= 3);
            
            // Popola tabella top score
            const container = document.getElementById('tabellaTopScore');
            if (!container) return;
            
            container.innerHTML = datiFiltrati
                .sort((a, b) => b.score - a.score)
                .slice(0, 10)
                .map((d, index) => `
                    <tr>
                        <td style="text-align: center;">
                            <span style="background: #9333ea; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${d.score.toFixed(1)}
                            </span>
                        </td>
                        <td>${d.match.substring(0, 20)}...</td>
                        <td style="text-align: center;">${formatBookmakerName(d.sharpBook)}</td>
                        <td style="text-align: center;">
                            <span style="color: #dc2626; font-weight: ${d.ripetizione > 1 ? 'bold' : 'normal'}">
                                ${formatBookmakerName(d.softBook)}
                            </span>
                        </td>
                        <td style="text-align: center;">${d.fv.toFixed(1)}%</td>
                        <td style="text-align: center;">${d.range}</td>
                        <td style="text-align: center;">
                            <span style="background: ${d.score >= 4 ? '#dcfce7' : '#fef9c3'}; 
                                        color: ${d.score >= 4 ? '#166534' : '#854d0e'}; 
                                        padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                ${d.score >= 4 ? 'Alta' : d.score >= 3 ? 'Media' : 'Bassa'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            
            // Mostra risultati
            document.getElementById('risultatiScore').style.display = 'block';
            
            showNotification(`Trovate ${datiFiltrati.length} valuebet con score ‚â• 3`, 'success');
        }

        // Funzioni di esportazione
        function esportaAnalisiCSV() {
            if (datiAnalisi.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }
            
            let csvContent = "ANALISI VALUEBET - PATTERN RECOGNITION\n";
            csvContent += `Esportato il: ${new Date().toLocaleString()}\n`;
            csvContent += `Filtri attivi: ${JSON.stringify(filtriAttivi)}\n\n`;
            
            csvContent += "ID;Data;Match;Sport;Mercato;SharpBook;SoftBook;QuotaSharp;QuotaSoft;Delta%;SM%;MM%;SS%;FV%;Range;Ripetizioni;Score\n";
            
            datiAnalisi.forEach(d => {
                csvContent += `${d.id};${d.data.toISOString()};"${d.match}";${d.sport};${d.mercato};`;
                csvContent += `${d.sharpBook};${d.softBook};${d.quotaSharp.toFixed(2)};${d.quotaSoft.toFixed(2)};`;
                csvContent += `${d.delta.toFixed(1)};${d.sm.toFixed(1)};${d.mm.toFixed(1)};${d.ss.toFixed(1)};`;
                csvContent += `${d.fv.toFixed(1)};${d.range};${d.ripetizione};${d.score.toFixed(1)}\n`;
            });
            
            downloadFile(csvContent, `analisi_valuebet_${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv');
            showNotification('Analisi esportata in CSV', 'success');
        }

        function esportaReportCompletoCSV() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }
            
            let csvContent = "REPORT COMPLETO BACKTEST - VALUEBET ANALISI\n";
            csvContent += `Generato il: ${new Date().toLocaleString()}\n`;
            csvContent += `Eventi totali: ${databaseEventi.length}\n`;
            csvContent += `Valuebet identificate: ${datiAnalisi.length}\n\n`;
            
            // Sezione eventi con risultati
            csvContent += "SEZIONE EVENTI COMPLETI\n";
            csvContent += "ID;Evento;Sport;Data;Tipo;Mercato;ValueSu;Risultato;HaVinto;Profitto;ROI%;QuotaValue;BookmakerValue\n";
            
            databaseEventi.forEach(evento => {
                csvContent += `${evento.id || 'N/D'};"${evento.nome}";${evento.sport};${evento.dataFormattata};`;
                csvContent += `${evento.tipoQuotes || 'N/D'};${evento.tipoScommessa || 'N/D'};${evento.valueSu || 'N/D'};`;
                csvContent += `${evento.risultatoReale || 'N/D'};${evento.haVinto !== undefined ? (evento.haVinto ? 'SI' : 'NO') : 'N/D'};`;
                csvContent += `${evento.profitto !== undefined ? evento.profitto.toFixed(2) : 'N/D'};`;
                csvContent += `${evento.roi !== undefined ? evento.roi.toFixed(1) : 'N/D'};`;
                csvContent += `${evento.quotaValue !== undefined ? evento.quotaValue.toFixed(2) : 'N/D'};`;
                csvContent += `${evento.bookmakerValue || 'N/D'}\n`;
            });
            
            // Sezione pattern
            if (datiAnalisi.length > 0) {
                csvContent += "\n\nSEZIONE PATTERN VALUEBET\n";
                csvContent += "SoftBook;Mercato;Range;Conteggio;DeltaMedio;FVMedio;ScoreMedio\n";
                
                // Raggruppa pattern
                const patternMap = {};
                datiAnalisi.forEach(d => {
                    const key = `${d.softBook}_${d.mercato}_${d.range}`;
                    if (!patternMap[key]) {
                        patternMap[key] = { count: 0, deltaSum: 0, fvSum: 0, scoreSum: 0 };
                    }
                    patternMap[key].count++;
                    patternMap[key].deltaSum += d.delta;
                    patternMap[key].fvSum += d.fv;
                    patternMap[key].scoreSum += d.score;
                });
                
                Object.entries(patternMap)
                    .sort((a, b) => b[1].count - a[1].count)
                    .forEach(([key, stats]) => {
                        const [softBook, mercato, range] = key.split('_');
                        csvContent += `${softBook};${mercato};${range};${stats.count};`;
                        csvContent += `${(stats.deltaSum / stats.count).toFixed(1)};`;
                        csvContent += `${(stats.fvSum / stats.count).toFixed(1)};`;
                        csvContent += `${(stats.scoreSum / stats.count).toFixed(1)}\n`;
                    });
            }
            
            downloadFile(csvContent, `report_completo_backtest_${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv');
            showNotification('Report completo esportato', 'success');
        }

        function esportaPatternJSON() {
            if (datiAnalisi.length === 0) {
                showNotification('Nessun pattern da esportare', 'error');
                return;
            }
            
            // Estrai pattern pi√π significativi
            const patternMap = {};
            datiAnalisi.forEach(d => {
                const key = `${d.softBook}_${d.mercato}_${d.range}`;
                if (!patternMap[key]) {
                    patternMap[key] = {
                        softBook: d.softBook,
                        mercato: d.mercato,
                        range: d.range,
                        count: 0,
                        esempi: [],
                        statistiche: {
                            deltaMedio: 0,
                            fvMedio: 0,
                            scoreMedio: 0,
                            quotaSharpMedio: 0,
                            quotaSoftMedio: 0
                        }
                    };
                }
                patternMap[key].count++;
                patternMap[key].statistiche.deltaMedio += d.delta;
                patternMap[key].statistiche.fvMedio += d.fv;
                patternMap[key].statistiche.scoreMedio += d.score;
                patternMap[key].statistiche.quotaSharpMedio += d.quotaSharp;
                patternMap[key].statistiche.quotaSoftMedio += d.quotaSoft;
                
                // Aggiungi esempio (max 5)
                if (patternMap[key].esempi.length < 5) {
                    patternMap[key].esempi.push({
                        match: d.match,
                        data: d.data.toISOString(),
                        quotaSharp: d.quotaSharp,
                        quotaSoft: d.quotaSoft,
                        delta: d.delta,
                        fv: d.fv,
                        score: d.score
                    });
                }
            });
            
            // Calcola medie
            Object.values(patternMap).forEach(p => {
                p.statistiche.deltaMedio /= p.count;
                p.statistiche.fvMedio /= p.count;
                p.statistiche.scoreMedio /= p.count;
                p.statistiche.quotaSharpMedio /= p.count;
                p.statistiche.quotaSoftMedio /= p.count;
                
                // Arrotonda
                Object.keys(p.statistiche).forEach(key => {
                    p.statistiche[key] = parseFloat(p.statistiche[key].toFixed(2));
                });
            });
            
            const patternArray = Object.values(patternMap)
                .sort((a, b) => b.count - a.count)
                .slice(0, 20); // Top 20 pattern
            
            const exportData = {
                pattern: patternArray,
                metadata: {
                    totalePattern: patternArray.length,
                    dataEsportazione: new Date().toISOString(),
                    totaleValuebetAnalizzate: datiAnalisi.length,
                    filtriApplicati: filtriAttivi
                }
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, `pattern_valuebet_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
            showNotification('Pattern analisi esportati in JSON', 'success');
        }

        function generaReportInsight() {
            if (datiAnalisi.length === 0) {
                showNotification('Nessun dato per generare insight', 'error');
                return;
            }
            
            let txtContent = `üìä REPORT INSIGHT VALUEBET ANALISI\n`;
            txtContent += `=======================================\n\n`;
            txtContent += `Data generazione: ${new Date().toLocaleString()}\n`;
            txtContent += `Eventi analizzati: ${databaseEventi.length}\n`;
            txtContent += `Valuebet identificate: ${datiAnalisi.length}\n\n`;
            
            // 1. TOP SOFT BOOKMAKER CHE COMMETTONO ERRORI
            const softCounts = {};
            datiAnalisi.forEach(d => {
                softCounts[d.softBook] = (softCounts[d.softBook] || 0) + 1;
            });
            
            const topSoft = Object.entries(softCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            txtContent += `üî• TOP 5 SOFT BOOKMAKER CON PI√ô ERRORI:\n`;
            txtContent += `---------------------------------------\n`;
            topSoft.forEach(([soft, count], index) => {
                txtContent += `${index + 1}. ${formatBookmakerName(soft)}: ${count} valuebet\n`;
            });
            txtContent += `\n`;
            
            // 2. MERCATI PI√ô PROFITABILI
            const mercatoStats = {};
            datiAnalisi.forEach(d => {
                if (!mercatoStats[d.mercato]) {
                    mercatoStats[d.mercato] = { count: 0, fvSum: 0, deltaSum: 0 };
                }
                mercatoStats[d.mercato].count++;
                mercatoStats[d.mercato].fvSum += d.fv;
                mercatoStats[d.mercato].deltaSum += d.delta;
            });
            
            txtContent += `üéØ MERCATI PI√ô FREQUENTI:\n`;
            txtContent += `----------------------------\n`;
            Object.entries(mercatoStats)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([mercato, stats]) => {
                    txtContent += `${mercato}: ${stats.count} valuebet (FV medio: ${(stats.fvSum / stats.count).toFixed(1)}%, Œî medio: ${(stats.deltaSum / stats.count).toFixed(1)}%)\n`;
                });
            txtContent += `\n`;
            
            // 3. RANGE QUOTA PI√ô FREQUENTI
            const rangeStats = {};
            datiAnalisi.forEach(d => {
                rangeStats[d.range] = (rangeStats[d.range] || 0) + 1;
            });
            
            txtContent += `üìà DISTRIBUZIONE PER RANGE QUOTA:\n`;
            txtContent += `----------------------------------\n`;
            Object.entries(rangeStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([range, count]) => {
                    const percentuale = (count / datiAnalisi.length * 100).toFixed(1);
                    txtContent += `${range}: ${count} valuebet (${percentuale}%)\n`;
                });
            txtContent += `\n`;
            
            // 4. PATTERN RIPETUTI
            const patternMap = {};
            datiAnalisi.forEach(d => {
                if (d.ripetizione > 1) {
                    const key = `${d.softBook} su ${d.mercato} (${d.range})`;
                    patternMap[key] = (patternMap[key] || 0) + 1;
                }
            });
            
            if (Object.keys(patternMap).length > 0) {
                txtContent += `üîÑ PATTERN RIPETUTI (Ripetizioni > 1):\n`;
                txtContent += `-------------------------------------\n`;
                Object.entries(patternMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .forEach(([pattern, count]) => {
                        txtContent += `‚Ä¢ ${pattern}: ${count} occorrenze\n`;
                    });
                txtContent += `\n`;
            }
            
            // 5. CONSIGLI E INSIGHT
            txtContent += `üí° INSIGHT E CONSIGLI:\n`;
            txtContent += `----------------------\n`;
            
            // Analisi sharp vs soft
            const sharpCounts = {};
            datiAnalisi.forEach(d => {
                sharpCounts[d.sharpBook] = (sharpCounts[d.sharpBook] || 0) + 1;
            });
            
            const sharpTop = Object.entries(sharpCounts).sort((a, b) => b[1] - a[1])[0];
            const softTop = topSoft[0];
            
            if (sharpTop && softTop) {
                txtContent += `‚Ä¢ Sharp leader: ${formatBookmakerName(sharpTop[0])} (${sharpTop[1]} valuebet)\n`;
                txtContent += `‚Ä¢ Soft pi√π debole: ${formatBookmakerName(softTop[0])} (${softTop[1]} errori)\n`;
            }
            
            // FV medio
            const fvMedio = datiAnalisi.reduce((sum, d) => sum + d.fv, 0) / datiAnalisi.length;
            txtContent += `‚Ä¢ FV medio: ${fvMedio.toFixed(1)}%\n`;
            
            // Delta medio
            const deltaMedio = datiAnalisi.reduce((sum, d) => sum + d.delta, 0) / datiAnalisi.length;
            txtContent += `‚Ä¢ Œî medio Sharp-Soft: ${deltaMedio.toFixed(1)}%\n`;
            
            // Score medio
            const scoreMedio = datiAnalisi.reduce((sum, d) => sum + d.score, 0) / datiAnalisi.length;
            txtContent += `‚Ä¢ Score affidabilit√† medio: ${scoreMedio.toFixed(1)}/5\n\n`;
            
            // 6. SUGGERIMENTI OPERATIVI
            txtContent += `üöÄ SUGGERIMENTI OPERATIVI:\n`;
            txtContent += `--------------------------\n`;
            txtContent += `1. Monitora ${formatBookmakerName(softTop?.[0] || 'soft bookmaker')} per errori sistematici\n`;
            txtContent += `2. Focus su range quota ${Object.entries(rangeStats).sort((a, b) => b[1] - a[1])[0]?.[0] || '2.0-2.5'}\n`;
            txtContent += `3. Verifica pattern ripetuti prima di scommettere\n`;
            txtContent += `4. Filtra per score > 3 per maggiore affidabilit√†\n`;
            txtContent += `5. Analizza trend delta nel tempo\n`;
            
            downloadFile(txtContent, `insight_valuebet_${new Date().toISOString().slice(0, 10)}.txt`, 'text/plain');
            showNotification('Report insight generato', 'success');
        }

        function salvaConfigAnalisi() {
            const config = {
                score: configScore,
                filtriAttivi: filtriAttivi,
                dataSalvataggio: new Date().toISOString()
            };
            
            localStorage.setItem('configAnalisiValuebet', JSON.stringify(config));
            showNotification('Configurazione analisi salvata', 'success');
        }

        // ==============================
        // FUNZIONI PER LA TAB GUIDA
        // ==============================

        function switchGuideSection(sectionId) {
            // Nascondi tutte le sezioni
            document.querySelectorAll('.guide-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Disattiva tutti i tab
            document.querySelectorAll('#tab-guida .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra la sezione selezionata
            document.getElementById(sectionId).classList.add('active');
            
            // Attiva il tab corrispondente
            document.querySelector(`#tab-guida .tab[onclick="switchGuideSection('${sectionId}')"]`).classList.add('active');
        }

        // Quando si apre la tab Guida, mostra la prima sezione
        function initTabGuida() {
            switchGuideSection('guide-3esiti');
        }

        // ==============================
        // INIZIALIZZAZIONE
        // ==============================

        // Al caricamento della pagina, inizializza tutto
        document.addEventListener('DOMContentLoaded', function() {
            // Carica database eventi
            databaseEventi = JSON.parse(localStorage.getItem('databaseEventi') || '[]');
            
            // Inizializza tab analisi se attiva
            if (document.getElementById('tab-analisi')?.classList.contains('active')) {
                initTabAnalisi();
            }
            
            // Inizializza setup mercati se attivo
            if (document.getElementById('tab-setup')?.classList.contains('active')) {
                initMercati();
            }
            
            // Mostra tabella eventi se attiva
            if (document.getElementById('tab-eventi')?.classList.contains('active')) {
                mostraTabellaEventi();
            }
            
            // Aggiorna contatori
            document.getElementById('totalEventi3').textContent = databaseEventi.length;
            document.getElementById('eventiAnalizzati3').textContent = databaseEventi.filter(e => e.quotes && e.tipoQuotes === '3_esiti').length;
            document.getElementById('totalEventi2').textContent = databaseEventi.length;
            document.getElementById('eventiAnalizzati2').textContent = databaseEventi.filter(e => e.quotes && e.tipoQuotes === '2_esiti').length;

            // Funzione Parser Automatico
            setupAutoParse();        // Per parsing automatico al paste
            setupKeyboardAutoParse(); // Per parsing automatico con input tastiera
            
            // Abilita anche parsing automatico per input esistenti
            checkExistingContent();
        });
    </script>
</body>
</html>