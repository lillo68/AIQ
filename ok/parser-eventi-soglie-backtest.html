<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser Betmonitor & AIQ Calculator - 3 & 2 Esiti + Backtest</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #ffffff;
            color: #333;
            line-height: 1.5;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* Layout principale */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .tab:hover {
            color: #2563eb;
            background: #f8f9fa;
        }

        .tab.active {
            color: #2563eb;
            font-weight: 600;
            border-color: #eaeaea;
            border-bottom-color: white;
            background: white;
            border-radius: 6px 6px 0 0;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #fff;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .card h2 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #2563eb;
            border-radius: 2px;
        }

        /* CALCOLATORE AIQ STYLES */
        .aiq-calculator {
            background: #ffffff;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .aiq-calculator h2 {
            text-align: center;
            color: #0369a1;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .aiq-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .aiq-table th, .aiq-table td {
            border: 1px solid #e5e7eb;
            padding: 6px;
            text-align: center;
        }

        .aiq-table th { 
            background: #f1f5f9; 
            font-weight: 600;
            color: #475569;
        }

        .aiq-input {
            width: 70px;
            text-align: center;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .aiq-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .aiq-result { 
            font-weight: bold; 
            font-size: 14px;
        }

        .aiq-value {
            background: #dcfce7;
            color: #166534;
        }

        .aiq-novalue {
            background: #fee2e2;
            color: #991b1b;
        }

        .aiq-ok {
            background: #dcfce7;
            color: #166534;
        }

        .aiq-warn {
            background: #fef9c3;
            color: #854d0e;
        }

        /* Parser styles */
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            background: #fafafa;
            color: #333;
        }

        textarea:focus {
            outline: none;
            border-color: #2563eb;
            background: #fff;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            color: #333;
            flex: 1;
            min-width: 120px;
        }

        button:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }

        .btn-parse {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .btn-parse:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .btn-clear {
            background: #fff;
            color: #666;
        }

        .btn-clear:hover {
            background: #f8f9fa;
            color: #333;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-summary-item {
            text-align: center;
        }

        .stat-summary-value {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            display: block;
        }

        .stat-summary-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* Tabella statistiche compatte */
        .stats-table-container {
            margin-top: 20px;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            overflow: hidden;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th {
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eaeaea;
        }

        .stats-table td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .stats-table tr:last-child td {
            border-bottom: none;
        }

        .stats-table tr:hover {
            background: #fafafa;
        }

        /* Stili per le colonne Pinnacle e Betfair */
        .stat-pinnacle .stat-table-value { color: #7c3aed; }
        .stat-betfair .stat-table-value { color: #ea580c; }

        /* Header per Pinnacle e Betfair */
        .esito-header.pinnacle { 
            border-left: 3px solid #7c3aed;
            color: #7c3aed;
        }
        .esito-header.betfair { 
            border-left: 3px solid #ea580c;
            color: #ea580c;
        }
        
        /* Header colonne esiti */
        .esito-header {
            font-weight: 600;
            color: #1a1a1a;
            padding: 10px 12px;
            background: #f8f9fa;
        }

        .esito-header.quote-1 { 
            border-left: 3px solid #2563eb;
            color: #2563eb;
        }
        .esito-header.quote-x { 
            border-left: 3px solid #9333ea;
            color: #9333ea;
        }
        .esito-header.quote-2 { 
            border-left: 3px solid #059669;
            color: #059669;
        }
        .esito-header.quote-yes { 
            border-left: 3px solid #2563eb;
            color: #2563eb;
        }
        .esito-header.quote-no { 
            border-left: 3px solid #dc2626;
            color: #dc2626;
        }

        /* Valori nelle celle */
        .stat-table-value {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            display: block;
        }

        .stat-table-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-top: 2px;
        }

        .stat-table-bookmaker {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Colori per i tipi di statistiche */
        .stat-min .stat-table-value { color: #059669; }
        .stat-max .stat-table-value { color: #dc2626; }
        .stat-sharp .stat-table-value { color: #ea580c; }

        /* Tabella bookmaker */
        .results-container {
            margin-top: 20px;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            overflow: hidden;
        }

        .bookmaker-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bookmaker-table thead {
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }

        .bookmaker-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bookmaker-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #eaeaea;
            font-size: 13px;
        }

        .bookmaker-table tr:last-child td {
            border-bottom: none;
        }

        .bookmaker-table tr:hover {
            background: #f8f9fa;
        }

        /* Stili per l'ordinamento */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
            transition: background-color 0.2s ease;
        }

        .sortable-header:hover {
            background-color: #f0f0f0;
        }

        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            opacity: 0.3;
        }

        .sortable-header.asc::after {
            border-bottom: 6px solid #666;
            border-top: none;
            opacity: 1;
        }

        .sortable-header.desc::after {
            border-top: 6px solid #666;
            border-bottom: none;
            opacity: 1;
        }

        .bookmaker-name {
            font-weight: 500;
            color: #1a1a1a;
        }

        .bookmaker-name.sharp {
            color: #ea580c;
            font-weight: 600;
        }

        .quote-cell {
            text-align: center;
            font-weight: 500;
            border-radius: 4px;
            padding: 4px 8px;
            font-feature-settings: "tnum";
        }

        .quote-1-cell { color: #2563eb; background: #eff6ff; }
        .quote-x-cell { color: #9333ea; background: #faf5ff; }
        .quote-2-cell { color: #059669; background: #f0fdf4; }
        .quote-yes-cell { color: #2563eb; background: #eff6ff; }
        .quote-no-cell { color: #dc2626; background: #fef2f2; }

        .export-options {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }

        .export-btn.csv { color: #059669; border-color: #d1fae5; background: #f0fdf4; }
        .export-btn.json { color: #2563eb; border-color: #dbeafe; background: #eff6ff; }
        .export-btn.txt { color: #ea580c; border-color: #ffedd5; background: #fff7ed; }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #1a1a1a;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }

        .empty-state .icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .example-toggle {
            font-size: 12px;
            color: #2563eb;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            margin-top: 8px;
            text-decoration: underline;
        }

        .example-toggle:hover {
            color: #1d4ed8;
        }
        
        /* Tooltip AIQ */
        .aiq-tooltip {
            position: fixed;
            pointer-events: none;
            background: #020617;
            color: #f8fafc;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 999;
        }

        /* Layout per i tab */
        .tab-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        @media (max-width: 1400px) {
            .tab-layout {
                grid-template-columns: 1fr;
            }
        }

        .tab-left, .tab-right {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Stili per la gestione eventi */
        .evento-current {
            background: #f0f9ff;
            border-left: 4px solid #2563eb;
        }

        .btn-success {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        .btn-success:hover {
            background: #047857;
            border-color: #047857;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .filter-bar button {
            padding: 8px 16px;
            min-width: auto;
        }

        .stats-backtest {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .evento-details {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .evento-details h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .evento-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }

        .evento-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eaeaea;
        }

        .evento-info-label {
            color: #666;
        }

        .evento-info-value {
            font-weight: 500;
            color: #1a1a1a;
        }
      
        /* Layout a larghezza completa per tab eventi */
        .tab-full-width {
            width: 100%;
            grid-column: 1 / -1;
        }

        /* Stili per la modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .btn-dettagli {
            background: #2563eb;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-dettagli:hover {
            background: #1d4ed8;
        }

        tr[draggable="true"] {
            cursor: move;
            transition: background 0.2s;
        }

        tr[draggable="true"]:hover {
            background: #f9fafb;
        }

        tr[draggable="true"]:active {
            cursor: grabbing;
        }

        .stat-card {
            transition: all 0.3s ease;
            cursor: default;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Stili per i bottoni di eliminazione */
        .btn-elimina {
            transition: all 0.2s ease;
        }

        .btn-elimina:hover {
            background: #b91c1c !important;
            transform: scale(1.05);
        }

        .btn-elimina:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #6b7280 !important;
            color: white !important;
            border-color: #6b7280 !important;
        }

        .btn-secondary:hover {
            background: #4b5563 !important;
            border-color: #4b5563 !important;
        }

        /* Animazione per riga eliminata */
        @keyframes fadeOut {
            from { opacity: 1; background: #fee2e2; }
            to { opacity: 0; transform: translateX(-20px); }
        }

        .tr-eliminata {
            animation: fadeOut 0.3s ease forwards;
        }
        
        /* Stili per ordinamento tabella eventi */
        .sortable-header-eventi {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
            padding-right: 24px !important;
        }

        .sortable-header-eventi:hover {
            background-color: #f0f0f0 !important;
        }

        .sortable-header-eventi .sort-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .sortable-header-eventi:hover .sort-arrow {
            opacity: 0.6;
        }

        .sortable-header-eventi.asc .sort-arrow::before {
            content: '‚ñ≤';
            color: #2563eb;
            opacity: 1;
            font-size: 10px;
        }

        .sortable-header-eventi.desc .sort-arrow::before {
            content: '‚ñº';
            color: #2563eb;
            opacity: 1;
            font-size: 10px;
        }

        /* Stili per le soglie AIQ nella tabella */
        .soglie-aiq-badge {
            font-size: 9px;
            color: #666;
            background: #f8f9fa;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid #e5e7eb;
            margin-top: 2px;
            display: inline-block;
            transition: all 0.2s;
        }

        .soglie-aiq-badge:hover {
            background: #e5e7eb;
            color: #4b5563;
        }

        /* Tooltip per soglie personalizzate */
        .soglie-personalizzata {
            background: #fef3c7 !important;
            border: 1px dashed #f59e0b !important;
            color: #92400e !important;
            font-weight: bold !important;
        }

        /* Stili per ricerca avanzata */
        #filtriAvanzatiContainer {
            animation: fadeIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stili per input range personalizzato */
        input[type="range"] {
            appearance: none;
            -webkit-appearance: none;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #059669;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #059669;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Stili per preset */
        #presetList button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Responsive design per filtri avanzati */
        @media (max-width: 1200px) {
            #filtriAvanzatiContainer > div {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 768px) {
            #filtriAvanzatiContainer > div {
                grid-template-columns: 1fr !important;
            }
            
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-bar input, 
            .filter-bar button {
                width: 100%;
                margin-bottom: 8px;
            }
        }
            </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Parser Betmonitor & AIQ Calculator + Backtest Database</h1>
            <p>Estrazione quote bookmaker, calcolo ValueBet AIQ e gestione eventi per backtest</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('tab-3esiti')">3 Esiti (1X2)</div>
            <div class="tab" onclick="switchTab('tab-2esiti')">2 Esiti (S√¨/No)</div>
            <div class="tab" onclick="switchTab('tab-eventi')">üìÖ Gestione Eventi</div>
            <div class="tab" onclick="switchTab('tab-setup')">‚öôÔ∏è Setup AIQ</div>
            <div class="tab" onclick="switchTab('tab-backtest')">üìà Backtest</div>
        </div>

        <!-- Tab 3 Esiti -->
        <div id="tab-3esiti" class="tab-content active">
            <div class="tab-layout">
                <!-- Colonna sinistra: Calcolatore AIQ CALCIO -->
                <div class="tab-left">
                    <!-- Mini Parser Eventi per 3 Esiti -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h2>Mini Parser Eventi - Calcio</h2>
                        <textarea id="inputEvento3" placeholder="Incolla i dati dell'evento nel formato:
                    VfB Stuttgart ‚Äî Eintracht Frankfurt
                    Football ¬∑ Germany ¬∑ Germany Bundesliga
                    Tuesday ¬∑ 13 Jan, 2026 ¬∑ 18:30"></textarea>
                        
                        <button class="example-toggle" onclick="loadEsempioEvento3()">Carica esempio evento</button>
                        
                        <div class="button-group">
                            <button class="btn-parse" onclick="parseEvento3()">Parsa Evento</button>
                            <button class="btn-clear" onclick="clearEvento3()">Pulisci</button>
                            <button class="btn-success" onclick="salvaEventoConQuotes3()">üíæ Salva Evento + Quotes</button>
                        </div>

                        <div class="help-text">
                            Formato: Nome evento (linea 1) ¬∑ Sport ¬∑ Nazione ¬∑ Lega (linea 2) ¬∑ Data/ora (linea 3)
                        </div>

                        <!-- Dettagli Evento Corrente per 3 Esiti -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h2>Dettagli Evento Corrente - Calcio</h2>
                            <div class="evento-details" id="eventoDetails3">
                                <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                    Nessun evento caricato
                                </div>
                            </div>

                            <div class="button-group" style="margin-top: 15px;">
                                <button class="btn-parse" onclick="caricaQuotesInEvento3()">üîÑ Carica Quotes 3 Esiti</button>
                                <button class="export-btn json" onclick="esportaEventoJSON3()">üì§ Esporta Evento</button>
                            </div>
                        </div>

                        <div class="stats-summary" style="margin-top: 20px;">
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="totalEventi3">0</span>
                                <span class="stat-summary-label">Eventi salvati</span>
                            </div>
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="eventiAnalizzati3">0</span>
                                <span class="stat-summary-label">Con risultato</span>
                            </div>
                        </div>
                    </div>

                    <div class="aiq-calculator">
                        <h2>AIQ CALCIO - 3 Esiti 
                            <span id="soglieAttiveCalcio" style="display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 12px; margin-left: 10px; cursor: help;" 
                                title="Clicca per modificare le soglie" onclick="switchTab('tab-setup')">
                                Soglie: <span id="valoreSM">5</span>-<span id="valoreMM">8</span>-<span id="valoreSS">7</span>%
                            </span>
                        </h2>
                        <table class="aiq-table">
                            <tr>
                                <th>Parametro</th>
                                <th>HOME</th>
                                <th>DRAW</th>
                                <th>AWAY</th>
                            </tr>
                            
                            <tr>
                                <td>Quota Sharp</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Sharp_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Sharp_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Sharp_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Media</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Media_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Media_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Media_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Min</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Min_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Min_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Min_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Quota Max</td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'HOME')" id="AIQ CALCIO_Max_HOME" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'DRAW')" id="AIQ CALCIO_Max_DRAW" class="aiq-input"></td>
                                <td><input type="number" step="0.01" oninput="calculateAiq('AIQ CALCIO', 'AWAY')" id="AIQ CALCIO_Max_AWAY" class="aiq-input"></td>
                            </tr>
                            
                            <tr>
                                <td>Sharp / Media</td>
                                <td id="AIQ CALCIO_sm_HOME"></td>
                                <td id="AIQ CALCIO_sm_DRAW"></td>
                                <td id="AIQ CALCIO_sm_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>Max / Min</td>
                                <td id="AIQ CALCIO_mm_HOME"></td>
                                <td id="AIQ CALCIO_mm_DRAW"></td>
                                <td id="AIQ CALCIO_mm_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>Sharp / Soft</td>
                                <td id="AIQ CALCIO_ss_HOME"></td>
                                <td id="AIQ CALCIO_ss_DRAW"></td>
                                <td id="AIQ CALCIO_ss_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>FORZA VALUE</td>
                                <td id="AIQ CALCIO_fv_HOME"></td>
                                <td id="AIQ CALCIO_fv_DRAW"></td>
                                <td id="AIQ CALCIO_fv_AWAY"></td>
                            </tr>
                            
                            <tr>
                                <td>VERDETTO</td>
                                <td id="AIQ CALCIO_res_HOME" class="aiq-result"></td>
                                <td id="AIQ CALCIO_res_DRAW" class="aiq-result"></td>
                                <td id="AIQ CALCIO_res_AWAY" class="aiq-result"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Colonna destra: Parser 3 Esiti -->
                <div class="tab-right">
                    <div class="card">
                        <h2>Dati Input - 3 Esiti</h2>
                        <textarea id="inputData3" placeholder="Incolla i dati copiati da Betmonitor (formato 3 esiti)..."></textarea>
                        
                        <button class="example-toggle" onclick="loadExample3Esiti()">Carica esempio 3 esiti</button>
                        
                        <div class="button-group">
                            <button class="btn-parse" onclick="parseData3Esiti()">Parsa Dati</button>
                            <button class="btn-clear" onclick="clearData3Esiti()">Pulisci</button>
                        </div>

                        <div class="help-text">
                            Formato atteso: nome bookmaker, dominio, 3 quote (1, X, 2), percentuale
                        </div>

                        <div class="stats-summary">
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="totalBooks3">0</span>
                                <span class="stat-summary-label">Bookmaker totali</span>
                            </div>
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="sharpBooks3">0</span>
                                <span class="stat-summary-label">Sharp</span>
                            </div>
                        </div>

                        <div class="debug-info" id="debugInfo3"></div>
                    </div>

                    <div class="card">
                        <h2>Statistiche Quote - 3 Esiti</h2>
                        
                        <!-- Tabella statistiche compatte -->
                        <div class="stats-table-container">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th style="width: 120px; text-align: left;">Statistica</th>
                                        <th style="width: 25%;" class="esito-header quote-1">1</th>
                                        <th style="width: 25%;" class="esito-header quote-x">X</th>
                                        <th style="width: 25%;" class="esito-header quote-2">2</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Riga Media -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Media</td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuote1">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuoteX">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuote2">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Minima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Minima</td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuote1">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBook1">-</div>
                                        </td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuoteX">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBookX">-</div>
                                        </td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuote2">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBook2">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Massima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Massima</td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuote1">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBook1">-</div>
                                        </td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuoteX">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBookX">-</div>
                                        </td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuote2">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBook2">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Pinnacle -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Pinnacle</td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuote1">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuoteX">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuote2">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>

                                    <!-- Riga Betfair -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Betfair</td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuote1">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuoteX">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuote2">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Tabella bookmaker -->
                        <h2 style="margin-top: 30px;">Dettaglio Bookmaker - 3 Esiti</h2>
                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" onclick="sortTable3('bookmaker')" data-sort="none">Bookmaker</th>
                                        <th class="sortable-header" onclick="sortTable3('quote1')" style="text-align: center;" data-sort="none">1</th>
                                        <th class="sortable-header" onclick="sortTable3('quoteX')" style="text-align: center;" data-sort="none">X</th>
                                        <th class="sortable-header" onclick="sortTable3('quote2')" style="text-align: center;" data-sort="none">2</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable3">
                                    <!-- I dati verranno inseriti qui dinamicamente -->
                                </tbody>
                            </table>
                            <div id="emptyState3" class="empty-state" style="display: none;">
                                <div class="icon">üìä</div>
                                <div>Nessun dato disponibile</div>
                                <div style="font-size: 12px; margin-top: 4px;">Incolla i dati e clicca "Parsa Dati"</div>
                            </div>
                        </div>

                        <div class="export-options">
                            <button class="export-btn csv" onclick="exportToCSV3()">Esporta CSV</button>
                            <button class="export-btn json" onclick="exportToJSON3()">Esporta JSON</button>
                            <button class="export-btn txt" onclick="exportToTXT3()">Esporta TXT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2 Esiti -->
        <div id="tab-2esiti" class="tab-content">
            <div class="tab-layout">
                <!-- Colonna sinistra: Calcolatore AIQ TENNIS -->
                <div class="tab-left">
                        <!-- Mini Parser Eventi per 2 Esiti -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h2>Mini Parser Eventi - Tennis</h2>
                            <textarea id="inputEvento2" placeholder="Incolla i dati dell'evento nel formato:
                        Nadal vs. Djokovic
                        Tennis ¬∑ International ¬∑ Wimbledon
                        Monday ¬∑ 15 Jan, 2026 ¬∑ 15:00"></textarea>
                            
                            <button class="example-toggle" onclick="loadEsempioEvento2()">Carica esempio evento</button>
                            
                            <div class="button-group">
                                <button class="btn-parse" onclick="parseEvento2()">Parsa Evento</button>
                                <button class="btn-clear" onclick="clearEvento2()">Pulisci</button>
                                <button class="btn-success" onclick="salvaEventoConQuotes2()">üíæ Salva Evento + Quotes</button>
                            </div>

                            <div class="help-text">
                                Formato: Nome evento (linea 1) ¬∑ Sport ¬∑ Nazione ¬∑ Lega (linea 2) ¬∑ Data/ora (linea 3)
                            </div>

                            <div class="stats-summary" style="margin-top: 20px;">
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="totalEventi2">0</span>
                                    <span class="stat-summary-label">Eventi salvati</span>
                                </div>
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="eventiAnalizzati2">0</span>
                                    <span class="stat-summary-label">Con risultato</span>
                                </div>
                            </div>
                        </div>

                        <!-- Dettagli Evento Corrente per 2 Esiti -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h2>Dettagli Evento Corrente - Tennis</h2>
                            <div class="evento-details" id="eventoDetails2">
                                <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                    Nessun evento caricato
                                </div>
                            </div>

                            <div class="button-group" style="margin-top: 15px;">
                                <button class="btn-parse" onclick="caricaQuotesInEvento2()">üîÑ Carica Quotes 2 Esiti</button>
                                <button class="export-btn json" onclick="esportaEventoJSON2()">üì§ Esporta Evento</button>
                            </div>
                        </div>

                        <div class="aiq-calculator">
                            <h2>AIQ TENNIS - 2 Esiti 
                                <span id="soglieAttiveTennis" style="display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 12px; margin-left: 10px; cursor: help;" 
                                    title="Clicca per modificare le soglie" onclick="switchTab('tab-setup')">
                                    Soglie: <span id="valoreSM_T">5</span>-<span id="valoreMM_T">8</span>-<span id="valoreSS_T">7</span>%
                                </span>
                            </h2>
                            <table class="aiq-table">
                                <tr>
                                    <th>Parametro</th>
                                    <th>HOME</th>
                                    <th>AWAY</th>
                                </tr>
                                
                                <tr>
                                    <td>Quota Sharp</td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Sharp_HOME" class="aiq-input"></td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Sharp_AWAY" class="aiq-input"></td>
                                </tr>
                                
                                <tr>
                                    <td>Quota Media</td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Media_HOME" class="aiq-input"></td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Media_AWAY" class="aiq-input"></td>
                                </tr>
                                
                                <tr>
                                    <td>Quota Min</td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Min_HOME" class="aiq-input"></td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Min_AWAY" class="aiq-input"></td>
                                </tr>
                                
                                <tr>
                                    <td>Quota Max</td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'HOME')" id="AIQ TENNIS_Max_HOME" class="aiq-input"></td>
                                    <td><input type="number" step="0.01" oninput="calculateAiq('AIQ TENNIS', 'AWAY')" id="AIQ TENNIS_Max_AWAY" class="aiq-input"></td>
                                </tr>
                                
                                <tr>
                                    <td>Sharp / Media</td>
                                    <td id="AIQ TENNIS_sm_HOME"></td>
                                    <td id="AIQ TENNIS_sm_AWAY"></td>
                                </tr>
                                
                                <tr>
                                    <td>Max / Min</td>
                                    <td id="AIQ TENNIS_mm_HOME"></td>
                                    <td id="AIQ TENNIS_mm_AWAY"></td>
                                </tr>
                                
                                <tr>
                                    <td>Sharp / Soft</td>
                                    <td id="AIQ TENNIS_ss_HOME"></td>
                                    <td id="AIQ TENNIS_ss_AWAY"></td>
                                </tr>
                                
                                <tr>
                                    <td>FORZA VALUE</td>
                                    <td id="AIQ TENNIS_fv_HOME"></td>
                                    <td id="AIQ TENNIS_fv_AWAY"></td>
                                </tr>
                                
                                <tr>
                                    <td>VERDETTO</td>
                                    <td id="AIQ TENNIS_res_HOME" class="aiq-result"></td>
                                    <td id="AIQ TENNIS_res_AWAY" class="aiq-result"></td>
                                </tr>
                            </table>
                        </div>
                </div>
                
                <!-- Colonna destra: Parser 2 Esiti -->
                <div class="tab-right">
                    <div class="card">
                        <h2>Dati Input - 2 Esiti</h2>
                        <textarea id="inputData2" placeholder="Incolla i dati copiati da Betmonitor (formato 2 esiti)..."></textarea>
                        
                        <button class="example-toggle" onclick="loadExample2Esiti()">Carica esempio 2 esiti</button>
                        
                        <div class="button-group">
                            <button class="btn-parse" onclick="parseData2Esiti()">Parsa Dati</button>
                            <button class="btn-clear" onclick="clearData2Esiti()">Pulisci</button>
                        </div>

                        <div class="help-text">
                            Formato atteso: nome bookmaker, dominio, 2 quote (S√¨, No), percentuale
                        </div>

                        <div class="stats-summary">
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="totalBooks2">0</span>
                                <span class="stat-summary-label">Bookmaker totali</span>
                            </div>
                            <div class="stat-summary-item">
                                <span class="stat-summary-value" id="sharpBooks2">0</span>
                                <span class="stat-summary-label">Sharp</span>
                            </div>
                        </div>

                        <div class="debug-info" id="debugInfo2"></div>
                    </div>

                    <div class="card">
                        <h2>Statistiche Quote - 2 Esiti</h2>
                        
                        <!-- Tabella statistiche compatte -->
                        <div class="stats-table-container">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th style="width: 120px; text-align: left;">Statistica</th>
                                        <th style="width: 40%;" class="esito-header quote-yes">S√¨ / Over / Alt</th>
                                        <th style="width: 40%;" class="esito-header quote-no">No / Under / Alt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Riga Media -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Media</td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuoteYes">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                        <td>
                                            <span class="stat-table-value" id="avgQuoteNo">0.00</span>
                                            <span class="stat-table-label">tutti i book</span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Minima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Minima</td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuoteYes">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBookYes">-</div>
                                        </td>
                                        <td class="stat-min">
                                            <span class="stat-table-value" id="minQuoteNo">0.00</span>
                                            <span class="stat-table-label">migliore offerta</span>
                                            <div class="stat-table-bookmaker" id="minBookNo">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Massima -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Massima</td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuoteYes">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBookYes">-</div>
                                        </td>
                                        <td class="stat-max">
                                            <span class="stat-table-value" id="maxQuoteNo">0.00</span>
                                            <span class="stat-table-label">peggiore offerta</span>
                                            <div class="stat-table-bookmaker" id="maxBookNo">-</div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Riga Pinnacle -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Pinnacle</td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuoteYes">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-pinnacle">
                                            <span class="stat-table-value" id="pinnacleQuoteNo">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>

                                    <!-- Riga Betfair -->
                                    <tr>
                                        <td style="text-align: left; font-size: 13px; font-weight: 500; color: #333;">Betfair</td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuoteYes">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                        <td class="stat-betfair">
                                            <span class="stat-table-value" id="betfairQuoteNo">-</span>
                                            <span class="stat-table-label">quote esatta</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Tabella bookmaker -->
                        <h2 style="margin-top: 30px;">Dettaglio Bookmaker - 2 Esiti</h2>
                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" onclick="sortTable2('bookmaker')" data-sort="none">Bookmaker</th>
                                        <th class="sortable-header" onclick="sortTable2('quoteYes')" style="text-align: center;" data-sort="none">S√¨ / Over / Alt</th>
                                        <th class="sortable-header" onclick="sortTable2('quoteNo')" style="text-align: center;" data-sort="none">No / Under / Alt</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable2">
                                    <!-- I dati verranno inseriti qui dinamicamente -->
                                </tbody>
                            </table>
                            <div id="emptyState2" class="empty-state" style="display: none;">
                                <div class="icon">üìä</div>
                                <div>Nessun dato disponibile</div>
                                <div style="font-size: 12px; margin-top: 4px;">Incolla i dati e clicca "Parsa Dati"</div>
                            </div>
                        </div>

                        <div class="export-options">
                            <button class="export-btn csv" onclick="exportToCSV2()">Esporta CSV</button>
                            <button class="export-btn json" onclick="exportToJSON2()">Esporta JSON</button>
                            <button class="export-btn txt" onclick="exportToTXT2()">Esporta TXT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Gestione Eventi -->
        <div id="tab-eventi" class="tab-content">
            <div class="tab-layout">
                <!-- Colonna unica per database a larghezza completa -->
                <div class="tab-full-width">
                    <div class="card" style="margin-bottom: 20px;">
                        <h2>üìä Statistiche Database</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                            <!-- Card 1: Eventi totali -->
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2563eb;">
                                <div style="font-size: 24px; font-weight: bold; color: #2563eb;" id="statEventiTotali">0</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Eventi totali</div>
                            </div>
                            
                            <!-- Card 2: Eventi con Value -->
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #059669;">
                                <div style="font-size: 24px; font-weight: bold; color: #059669;" id="statEventiValue">0</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Eventi con Value</div>
                            </div>
                            
                            <!-- Card 3: Esiti pi√π frequenti -->
                            <div style="background: #faf5ff; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #9333ea;">
                                <div style="font-size: 24px; font-weight: bold; color: #9333ea;" id="statEsitiFrequenti">-</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Esito Value pi√π frequente</div>
                            </div>
                            
                            <!-- Card 4: Value media -->
                            <div style="background: #fefce8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #ca8a04;">
                                <div style="font-size: 24px; font-weight: bold; color: #ca8a04;" id="statValueMedia">0%</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Forza Value media</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Database Eventi Backtest</h2>
                        
                    <div class="filter-bar">
                        <!-- RICERCA BASE -->
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="text" id="cercaEvento" placeholder="Cerca evento..." 
                                onkeyup="filtraEventi()" 
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                            <button onclick="clearSearch()" 
                                    style="background: #6b7280; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    ‚ùå
                            </button>
                        </div>
                        
                        <!-- FILTRI AVANZATI (TOGGLE) -->
                        <button id="toggleFiltriAvanzati" 
                                onclick="toggleFiltriAvanzati()"
                                style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                            üîç Filtri Avanzati
                        </button>
                        
                        <!-- PULSANTE REFRESH -->
                        <button onclick="refreshDatabaseEventi()" 
                                style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-left: auto;">
                            üîÑ Refresh
                        </button>
                    </div>

                    <!-- FILTRI AVANZATI ESPANSI (inizialmente nascosti) -->
                    <div id="filtriAvanzatiContainer" style="display: none; margin-top: 15px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                            
                            <!-- COLONNA 1: FILTRI BASE -->
                            <div>
                                <h4 style="margin-top: 0; margin-bottom: 15px; color: #4b5563; font-size: 14px;">üìã Filtri Base</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Sport</label>
                                    <select id="filtroSport" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Tutti gli sport</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Tipo Evento</label>
                                    <select id="filtroTipoEvento" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Tutti i tipi</option>
                                        <option value="3_esiti">3 Esiti (Calcio)</option>
                                        <option value="2_esiti">2 Esiti (Tennis/Altro)</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Range Date</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="date" id="filtroDataDa" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                        <input type="date" id="filtroDataA" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <small style="color: #6b7280; font-size: 11px;">Da - A (lasciare vuoto per ignorare)</small>
                                </div>
                            </div>
                            
                            <!-- COLONNA 2: FILTRI AIQ -->
                            <div>
                                <h4 style="margin-top: 0; margin-bottom: 15px; color: #4b5563; font-size: 14px;">üéØ Filtri AIQ</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" id="filtroSoloValue" onchange="filtraEventi()">
                                        Solo eventi con Value
                                    </label>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Esito Value</label>
                                    <select id="filtroEsitoValue" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Tutti gli esiti</option>
                                        <option value="1">VALUE 1</option>
                                        <option value="X">VALUE X</option>
                                        <option value="2">VALUE 2</option>
                                        <option value="SI">VALUE SI</option>
                                        <option value="NO">VALUE NO</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Forza Value Minima</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" id="filtroForzaValueRange" min="0" max="30" step="0.5" value="0" 
                                            oninput="updateForzaValueDisplay(this.value)" 
                                            style="width: 100%; cursor: pointer;">
                                            <input type="hidden" id="filtroForzaValue" value="0">
                                        <span id="forzaValueDisplay" style="min-width: 40px; text-align: center; font-weight: bold; color: #059669;">0%</span>
                                    </div>
                                    <small style="color: #6b7280; font-size: 11px;">‚â• <span id="forzaValueMin">0</span>%</small>
                                </div>
                            </div>
                            
                            <!-- COLONNA 3: FILTRI BOOKMAKER -->
                            <div>
                                <h4 style="margin-top: 0; margin-bottom: 15px; color: #4b5563; font-size: 14px;">üè¶ Filtri Bookmaker</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Min. Bookmaker</label>
                                    <select id="filtroMinBookmaker" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="0">Qualsiasi numero</option>
                                        <option value="5">Almeno 5 bookmaker</option>
                                        <option value="10">Almeno 10 bookmaker</option>
                                        <option value="15">Almeno 15 bookmaker</option>
                                        <option value="20">Almeno 20 bookmaker</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Presenza Sharp</label>
                                    <select id="filtroSharpBookmaker" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Non importa</option>
                                        <option value="si">Deve avere sharp</option>
                                        <option value="no">Senza sharp</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">Soglie AIQ Usate</label>
                                    <select id="filtroSoglieAIQ" onchange="filtraEventi()"
                                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Tutte le soglie</option>
                                        <option value="default">Solo default (5-8-7)</option>
                                        <option value="personalizzate">Solo personalizzate</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- COLONNA 4: AZIONI RICERCA -->
                            <div>
                                <h4 style="margin-top: 0; margin-bottom: 15px; color: #4b5563; font-size: 14px;">‚ö° Azioni</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <button onclick="filtraEventi()" 
                                            style="width: 100%; background: #059669; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 10px;">
                                        üîç Applica Filtri
                                    </button>
                                    
                                    <button onclick="resetFiltriAvanzati()" 
                                            style="width: 100%; background: #f59e0b; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 10px;">
                                        üîÑ Reset Filtri
                                    </button>
                                    
                                    <button onclick="salvaPresetFiltri()" 
                                            style="width: 100%; background: #7c3aed; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                        üíæ Salva Preset
                                    </button>
                                </div>
                                
                                <!-- INFO RISULTATI -->
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Filtri attivi:</div>
                                    <div id="filtriAttiviInfo" style="font-size: 11px; color: #374151; line-height: 1.4;">
                                        Nessun filtro attivo
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RICERCA SAVE/LOAD PRESET -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 15px; display: none;" id="presetContainer">
                            <h4 style="margin-top: 0; margin-bottom: 10px; color: #4b5563; font-size: 14px;">üìÅ Preset Salvati</h4>
                            <div id="presetList" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <!-- I preset verranno caricati qui -->
                            </div>
                        </div>
                    </div>

                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px; text-align: center;">#</th>
                                        <th style="width: 23%;" class="sortable-header-eventi" onclick="ordinaEventi('nome')" data-sort="none">
                                            Evento <span class="sort-arrow"></span>
                                        </th>
                                        <th style="width: 10%;" class="sortable-header-eventi" onclick="ordinaEventi('sport')" data-sort="none">
                                            Sport <span class="sort-arrow"></span>
                                        </th>
                                        <th style="width: 18%;" class="sortable-header-eventi" onclick="ordinaEventi('lega')" data-sort="none">
                                            Lega <span class="sort-arrow"></span>
                                        </th>
                                        <th style="width: 12%;" class="sortable-header-eventi" onclick="ordinaEventi('data')" data-sort="none">
                                            Data <span class="sort-arrow"></span>
                                        </th>
                                        <th style="width: 13%;" class="sortable-header-eventi" onclick="ordinaEventi('forzaValue')" data-sort="none">
                                            AIQ Value <span class="sort-arrow"></span>
                                        </th>
                                        <th style="width: 9%;" class="sortable-header-eventi" onclick="ordinaEventi('bookCount')" data-sort="none">
                                            Bookmaker <span class="sort-arrow"></span>
                                        </th>
                                        <th style="width: 10%;">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="tabellaEventi">
                                    <!-- Eventi verranno caricati qui -->
                                </tbody>
                            </table>
                            <div id="emptyEventi" class="empty-state" style="display: block;">
                                <div class="icon">üìÖ</div>
                                <div>Nessun evento salvato</div>
                                <div style="font-size: 12px; margin-top: 4px;">Usa i parser nelle altre tab per aggiungere eventi</div>
                            </div>
                        </div>

                        <!-- PAGINAZIONE -->
                        <div id="paginazioneContainer" class="card" style="margin-top: 20px; display: none;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div id="infoPaginazione" style="color: #666; font-size: 14px; margin-bottom: 10px;"></div>
                                
                                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <!-- Precedente -->
                                    <button id="btnPrec" onclick="paginaPrecedente()" 
                                            style="padding: 8px 15px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        ‚óÄÔ∏è Precedente
                                    </button>
                                    
                                    <!-- Numeri pagina -->
                                    <div id="numeriPagine" style="display: flex; gap: 5px;"></div>
                                    
                                    <!-- Successiva -->
                                    <button id="btnSucc" onclick="paginaSuccessiva()" 
                                            style="padding: 8px 15px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        Successiva ‚ñ∂Ô∏è
                                    </button>
                                </div>
                                
                                <!-- Selettore eventi per pagina -->
                                <div style="margin-top: 15px;">
                                    <select onchange="cambiaEventiPerPagina(this.value)" 
                                            style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                                        <option value="10">10 eventi per pagina</option>
                                        <option value="20" selected>20 eventi per pagina</option>
                                        <option value="50">50 eventi per pagina</option>
                                        <option value="100">100 eventi per pagina</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="export-options" style="margin-top: 20px;">
                            <button class="export-btn csv" onclick="esportaEventiCSV()">Esporta CSV Backtest</button>
                            <button class="export-btn json" onclick="esportaEventiJSONCompleto()">Esporta JSON Completo</button>
                            <button class="export-btn txt" onclick="esportaBacktestTXT()">Esporta Report TXT</button>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>üóëÔ∏è Gestione Eliminazione</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                            <button onclick="eliminaEventiFiltrati()" 
                                    style="background: #f59e0b; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                üóëÔ∏è Elimina eventi visualizzati (filtrati)
                            </button>
                            <button onclick="eliminaEventiSenzaValue()" 
                                    style="background: #d97706; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                üóëÔ∏è Elimina eventi SENZA Value
                            </button>
                            <button onclick="clearDatabase()" 
                                    style="background: #dc2626; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                üí£ Elimina TUTTI gli eventi
                            </button>
                        </div>
                        <div class="help-text" style="margin-top: 10px;">
                            <strong>‚ö† Attenzione:</strong> Le eliminazioni sono definitive. Fai backup prima.
                        </div>
                    </div>
                    <div class="card">
                        <h2>Importa/Esporta Database</h2>
                        <div class="button-group">
                            <button class="export-btn json" onclick="backupDatabase()">üíæ Backup Database</button>
                            <button class="export-btn txt" onclick="restoreDatabase()">üîÑ Ripristina Database</button>
                            <button class="btn-secondary" onclick="clearDatabase()" style="background: #dc2626; border-color: #dc2626;">üóëÔ∏è Cancella Tutto</button>
                        </div>
                        <div class="help-text" style="margin-top: 10px;">
                            Il database viene salvato automaticamente nel browser. Fai backup regolari.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Setup -->
        <div id="tab-setup" class="tab-content">
            <div class="tab-layout">
                <div class="tab-full-width">
                    <div class="card">
                        <h2>‚öôÔ∏è Configurazione Sistema</h2>
                        <p style="margin-bottom: 20px; color: #666;">
                            Configura qui le impostazioni globali del sistema. Le modifiche si applicano a tutti i calcolatori e analisi.
                        </p>
                        
                        <!-- CONFIGURAZIONE SOGLIE AIQ -->
                        <div class="card" style="margin-bottom: 30px;">
                            <h3>üéØ Soglie AIQ ValueBet</h3>
                            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                                Modifica le soglie per l'identificazione delle valuebet. Le nuove soglie si applicheranno immediatamente a tutto il sistema.
                            </p>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <!-- Colonna sinistra: Soglie -->
                                <div>
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                            Sharp/Media (%)
                                            <span style="color: #666; font-weight: normal; font-size: 13px;">
                                                - Differenza % tra quota sharp e media
                                            </span>
                                        </label>
                                        <input type="number" id="sogliaSM" step="0.1" min="0" max="50"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                            Max/Min (%)
                                            <span style="color: #666; font-weight: normal; font-size: 13px;">
                                                - Differenza % tra quota max e min
                                            </span>
                                        </label>
                                        <input type="number" id="sogliaMM" step="0.1" min="0" max="50"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                            Sharp/Soft (%)
                                            <span style="color: #666; font-weight: normal; font-size: 13px;">
                                                - Differenza % tra quota sharp e minima
                                            </span>
                                        </label>
                                        <input type="number" id="sogliaSS" step="0.1" min="0" max="50"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                            Soglia "Vicino" (%)
                                            <span style="color: #666; font-weight: normal; font-size: 13px;">
                                                - Considera "vicino" se manca meno di X% alla soglia
                                            </span>
                                        </label>
                                        <input type="number" id="sogliaNEAR" step="0.1" min="0" max="5"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                                
                                <!-- Colonna destra: Info e preview -->
                                <div>
                                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #2563eb;">
                                        <h4 style="margin-top: 0; color: #2563eb;">‚ÑπÔ∏è Come funziona</h4>
                                        <p style="font-size: 13px; color: #666; line-height: 1.5;">
                                            Una valuebet √® identificata quando <strong>TUTTE E TRE</strong> le condizioni sono soddisfatte:<br><br>
                                            1. <strong>Sharp/Media ‚â• X%</strong> - La quota sharp √® superiore alla media<br>
                                            2. <strong>Max/Min ‚â• Y%</strong> - C'√® variabilit√† nel mercato<br>
                                            3. <strong>Sharp/Soft ‚â• Z%</strong> - La quota sharp batte la migliore offerta
                                        </p>
                                        
                                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px;">
                                            <h5 style="margin-top: 0; color: #333;">Soglie attuali:</h5>
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                                <div>
                                                    <span style="font-size: 12px; color: #666;">Sharp/Media:</span><br>
                                                    <strong id="currentSM">5%</strong>
                                                </div>
                                                <div>
                                                    <span style="font-size: 12px; color: #666;">Max/Min:</span><br>
                                                    <strong id="currentMM">8%</strong>
                                                </div>
                                                <div>
                                                    <span style="font-size: 12px; color: #666;">Sharp/Soft:</span><br>
                                                    <strong id="currentSS">7%</strong>
                                                </div>
                                                <div>
                                                    <span style="font-size: 12px; color: #666;">Vicino:</span><br>
                                                    <strong id="currentNEAR">0.5%</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 20px;">
                                        <button onclick="salvaSoglieAIQ()" 
                                                style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; width: 100%;">
                                            üíæ Salva Configurazione AIQ
                                        </button>
                                        <button onclick="resetSoglieDefault()" 
                                                style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; width: 100%; margin-top: 10px;">
                                            üîÑ Reset a Default
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE SISTEMA -->
                        <div class="card" style="margin-bottom: 30px;">
                            <h3>‚ö° Impostazioni Sistema</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 20px;">
                                <div>
                                    <h4 style="margin-bottom: 15px; font-size: 14px; color: #666;">Calcolatori AIQ</h4>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <input type="checkbox" id="autoCalcolaAIQ" onchange="aggiornaImpostazioniSistema()">
                                            Auto-calcola AIQ dopo parsing
                                        </label>
                                        <small style="color: #888; display: block; margin-top: 4px;">
                                            Calcola automaticamente l'AIQ dopo aver parsato le quote
                                        </small>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <input type="checkbox" id="mostraTooltipAIQ" onchange="aggiornaImpostazioniSistema()">
                                            Mostra tooltip AIQ
                                        </label>
                                        <small style="color: #888; display: block; margin-top: 4px;">
                                            Mostra suggerimenti al passaggio del mouse
                                        </small>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 style="margin-bottom: 15px; font-size: 14px; color: #666;">Database Eventi</h4>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <input type="checkbox" id="autoBackup" onchange="aggiornaImpostazioniSistema()">
                                            Auto-backup giornaliero
                                        </label>
                                        <small style="color: #888; display: block; margin-top: 4px;">
                                            Crea backup automatico ogni giorno
                                        </small>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <input type="checkbox" id="notificheValue" onchange="aggiornaImpostazioniSistema()">
                                            Notifiche per valuebet forti
                                        </label>
                                        <small style="color: #888; display: block; margin-top: 4px;">
                                            Avvisa per valuebet con forza ‚â• 15%
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- STATISTICHE CONFIGURAZIONE -->
                        <div class="card">
                            <h3>üìä Statistiche Configurazione</h3>
                            
                            <div class="stats-summary" style="margin-top: 15px;">
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="statEventiTotaliSetup">0</span>
                                    <span class="stat-summary-label">Eventi nel DB</span>
                                </div>
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="statValuebetTrovate">0</span>
                                    <span class="stat-summary-label">Valuebet trovate</span>
                                </div>
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="statSoglieAttive">AIQ 5-8-7</span>
                                    <span class="stat-summary-label">Soglie attive</span>
                                </div>
                                <div class="stat-summary-item">
                                    <span class="stat-summary-value" id="statUltimaModifica">Oggi</span>
                                    <span class="stat-summary-label">Ultima modifica</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="esportaConfigurazioneCompleta()" 
                                        style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üì§ Esporta Config Completa
                                </button>
                                <button onclick="importaConfigurazioneCompleta()" 
                                        style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üì• Importa Config
                                </button>
                                <button onclick="riapplicaSoglieATutto()" 
                                        style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    üîÑ Riapplica a tutto il DB
                                </button>
                            </div>
                            
                            <div class="help-text" style="margin-top: 20px;">
                                <strong>üí° Suggerimento:</strong> Dopo aver cambiato le soglie AIQ, usa "Riapplica a tutto il DB" per rivalutare tutti gli eventi storici con le nuove soglie.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Backtest -->
        <div id="tab-backtest" class="tab-content">
            <div class="tab-layout">
                <div class="tab-full-width">
                    
                    <!-- INTRODUZIONE BACKTEST -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h2>üìà Backtest Automatico - Strategie Avanzate</h2>
                        <p style="margin-bottom: 20px; color: #666;">
                            Testa le performance delle tue valuebet con 4 strategie di stake management.
                            Imposta i risultati reali degli eventi e calcola ROI, drawdown e altre metriche avanzate.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2563eb;">
                                <div style="font-size: 24px; font-weight: bold; color: #2563eb;" id="statEventiConRisultato">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Eventi con risultato</div>
                            </div>
                            
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #059669;">
                                <div style="font-size: 24px; font-weight: bold; color: #059669;" id="statValuebetConRisultato">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Valuebet testabili</div>
                            </div>
                            
                            <div style="background: #fefce8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #ca8a04;">
                                <div style="font-size: 24px; font-weight: bold; color: #ca8a04;" id="statBacktestPronti">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Pronti per backtest</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PARAMETRI BACKTEST (AGGIORNATO CON STRATEGIE STAKE) -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3>‚öôÔ∏è Parametri Backtest - Strategie Stake</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                            <!-- STRATEGIA STAKE -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                    Strategia Stake
                                    <span style="color: #666; font-weight: normal; font-size: 13px;">
                                        - Scegli come gestire le puntate
                                    </span>
                                </label>
                                <select id="strategiaStake" onchange="cambiaStrategiaStake()"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="fisso">üí∞ Fisso (importo costante)</option>
                                    <option value="percentuale">üìä % Bankroll (percentuale variabile)</option>
                                    <option value="kelly">üéØ Kelly Criterion (ottimizzazione matematica)</option>
                                    <option value="fibonacci">üî¢ Fibonacci (progressione)</option>
                                </select>
                            </div>
                            
                            <!-- PARAMETRO STAKE (dinamico in base alla strategia) -->
                            <div id="parametroStakeContainer">
                                <!-- Questo div verr√† popolato dinamicamente in base alla strategia selezionata -->
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                        Stake Fisso (‚Ç¨)
                                        <span style="color: #666; font-weight: normal; font-size: 13px;">
                                            - Importo fisso da scommettere
                                        </span>
                                    </label>
                                    <input type="number" id="stakeBacktest" value="100" min="1" step="10"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                            
                            <!-- BANKROLL INIZIALE -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                    Bankroll iniziale (‚Ç¨)
                                    <span style="color: #666; font-weight: normal; font-size: 13px;">
                                        - Capitale di partenza
                                    </span>
                                </label>
                                <input type="number" id="bankrollIniziale" value="1000" min="100" step="100"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- PARAMETRI SPECIFICI STRATEGIA -->
                        <div id="parametriStrategiaContainer" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                <!-- PARAMETRI PER % BANKROLL -->
                                <div id="parametriPercentuale" style="display: none;">
                                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #4b5563; font-size: 14px;">üìä % Bankroll</h4>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Percentuale Bankroll (%)
                                        </label>
                                        <input type="number" id="percentualeBankroll" value="5" min="0.1" max="100" step="0.5"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Stake Minimo (‚Ç¨)
                                        </label>
                                        <input type="number" id="stakeMinimoPercentuale" value="10" min="1" step="1"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Stake Massimo (‚Ç¨)
                                        </label>
                                        <input type="number" id="stakeMassimoPercentuale" value="500" min="10" step="10"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                </div>
                                
                                <!-- PARAMETRI PER KELLY -->
                                <div id="parametriKelly" style="display: none;">
                                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #4b5563; font-size: 14px;">üéØ Kelly Criterion</h4>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Kelly Fraction (%)
                                        </label>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="range" id="kellyFraction" min="5" max="100" value="25" step="5" 
                                                style="width: 100%;" oninput="updateKellyDisplay(this.value)">
                                            <span id="kellyFractionDisplay" style="min-width: 40px; text-align: center; font-weight: bold; color: #059669;">25%</span>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Stake Massimo Kelly (‚Ç¨)
                                        </label>
                                        <input type="number" id="stakeMassimoKelly" value="200" min="10" step="10"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                </div>
                                
                                <!-- PARAMETRI PER FIBONACCI -->
                                <div id="parametriFibonacci" style="display: none;">
                                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #4b5563; font-size: 14px;">üî¢ Fibonacci</h4>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Stake Base (‚Ç¨)
                                        </label>
                                        <input type="number" id="stakeBaseFibonacci" value="10" min="1" step="1"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Sequenza Max (livelli)
                                        </label>
                                        <select id="sequenzaFibonacci" 
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                            <option value="7">7 livelli (1,1,2,3,5,8,13)</option>
                                            <option value="10">10 livelli (1,1,2,3,5,8,13,21,34,55)</option>
                                        </select>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                            Reset dopo vittoria
                                        </label>
                                        <select id="resetFibonacci" 
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                            <option value="si">SI - Torna a livello 1</option>
                                            <option value="no">NO - Continua sequenza</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- FILTRI AVANZATI -->
                        <div style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; border: 1px solid #93c5fd;">
                            <h4 style="margin-top: 0; margin-bottom: 15px; color: #1d4ed8;">üîç Filtri Avanzati Backtest</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                <!-- FILTRO FORZA VALUE -->
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                        Forza Value Minima (%)
                                    </label>
                                    <input type="number" id="filtroForzaValueBacktest" value="0" min="0" max="50" step="0.5"
                                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                </div>
                                
                                <!-- FILTRO SPORT -->
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                        Sport
                                    </label>
                                    <select id="filtroSportBacktest"
                                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Tutti gli sport</option>
                                    </select>
                                </div>
                                
                                <!-- FILTRO TIPO EVENTO -->
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                        Tipo Evento
                                    </label>
                                    <select id="filtroTipoEventoBacktest"
                                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Tutti i tipi</option>
                                        <option value="3_esiti">3 Esiti (Calcio)</option>
                                        <option value="2_esiti">2 Esiti (Tennis/Altro)</option>
                                    </select>
                                </div>
                                
                                <!-- FILTRO SHARP -->
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                        Bookmaker Sharp
                                    </label>
                                    <select id="filtroSharpBacktest"
                                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                        <option value="">Non importa</option>
                                        <option value="si">Deve avere sharp</option>
                                        <option value="no">Senza sharp</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- FILTRO PERIODO -->
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #374151;">
                                    Periodo Date
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #6b7280;">Da:</label>
                                        <input type="date" id="filtroDataDaBacktest"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #6b7280;">A:</label>
                                        <input type="date" id="filtroDataABacktest"
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BOOKMAKER E COMMISSIONI -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                    Bookmaker da usare
                                </label>
                                <select id="tipoBookmakerBacktest" 
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="migliore">Migliore quota disponibile</option>
                                    <option value="sharp">Migliore quota sharp</option>
                                    <option value="media">Media delle quote</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                    Commissioni Exchange (%)
                                </label>
                                <input type="number" id="commissioniExchange" value="0" min="0" max="10" step="0.1"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- BOTTONI AZIONE -->
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="eseguiBacktestCompleto()" 
                                    style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 15px; width: 200px;">
                                üöÄ Esegui Backtest
                            </button>
                            
                            <button onclick="impostaRisultatiMultipli()" 
                                    style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 15px; width: 200px; margin-left: 10px;">
                                üéØ Imposta Risultati
                            </button>
                        </div>
                    </div>
                    
                    <!-- RISULTATI BACKTEST -->
                    <div class="card" id="risultatiBacktestContainer" style="display: none;">
                        <h3>üìä Risultati Backtest</h3>
                        
                        <!-- STATISTICHE PRINCIPALI -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                            <div style="text-align: center; padding: 20px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #2563eb;">
                                <div style="font-size: 28px; font-weight: bold; color: #2563eb;" id="statROI">0%</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ROI</div>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #059669;">
                                <div style="font-size: 28px; font-weight: bold; color: #059669;" id="statWinRate">0%</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Win Rate</div>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: #fefce8; border-radius: 8px; border-left: 4px solid #ca8a04;">
                                <div style="font-size: 28px; font-weight: bold; color: #ca8a04;" id="statProfittoNetto">0‚Ç¨</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Profitto Netto</div>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626;">
                                <div style="font-size: 28px; font-weight: bold; color: #dc2626;" id="statProfitFactor">0.00</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Profit Factor</div>
                            </div>
                        </div>
                        
                        <!-- METRICHE SECONDARIE -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <div style="font-size: 20px; font-weight: bold; color: #4b5563;" id="statTotaleScommesse">0</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Scommesse totali</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <div style="font-size: 20px; font-weight: bold; color: #059669;" id="statScommesseVinte">0</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Scommesse vinte</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <div style="font-size: 20px; font-weight: bold; color: #dc2626;" id="statScommessePerse">0</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Scommesse perse</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <div style="font-size: 20px; font-weight: bold; color: #7c3aed;" id="statBankrollFinale">0‚Ç¨</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Bankroll finale</div>
                            </div>
                        </div>
                        
                        <!-- METRICHE AVANZATE -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="text-align: center; padding: 15px; background: #fffbeb; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                <div style="font-size: 20px; font-weight: bold; color: #d97706;" id="statMaxDrawdown">0%</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Max Drawdown</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9;">
                                <div style="font-size: 20px; font-weight: bold; color: #0284c7;" id="statSharpeRatio">0.00</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Sharpe Ratio</div>
                            </div>
                            
                            <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">
                                <div style="font-size: 20px; font-weight: bold; color: #059669;" id="statExpectancy">0.00</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">Expectancy (‚Ç¨)</div>
                            </div>
                        </div>
                        
                        <!-- EVOLUZIONE BANKROLL -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-top: 0; margin-bottom: 15px;">üìà Evoluzione Bankroll</h4>
                            <div id="bankrollChartSimple" style="height: 200px; background: white; border-radius: 6px; padding: 10px; overflow-x: auto;">
                                <canvas id="bankrollCanvas" width="800" height="150"></canvas>
                            </div>
                        </div>
                        
                        <!-- DETTAGLIO SMESSE -->
                        <div style="margin-top: 30px;">
                            <h4>üìã Dettaglio Scommesse</h4>
                            <div class="results-container">
                                <table class="bookmaker-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;">#</th>
                                            <th style="width: 25%;">Evento</th>
                                            <th style="width: 10%;">Esito</th>
                                            <th style="width: 10%;">Quota</th>
                                            <th style="width: 10%;">Stake</th>
                                            <th style="width: 10%;">Risultato</th>
                                            <th style="width: 15%;">Profitto</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabellaDettaglioBacktest">
                                        <!-- Dettagli verranno inseriti qui -->
                                    </tbody>
                                </table>
                                <div id="emptyBacktest" class="empty-state" style="display: block;">
                                    <div class="icon">üìä</div>
                                    <div>Nessun dato backtest disponibile</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ESPORTA RISULTATI -->
                        <div style="margin-top: 20px;">
                            <div class="export-options">
                                <button class="export-btn csv" onclick="esportaBacktestCSV()">üì• Esporta CSV</button>
                                <button class="export-btn json" onclick="esportaBacktestJSON()">üì• Esporta JSON</button>
                                <button class="export-btn txt" onclick="esportaBacktestReport()">üìÑ Report Completo</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
    <div class="aiq-tooltip" id="aiqTooltip"></div>

    <!-- Modal per dettagli evento -->
    <div id="eventoModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìä Dettagli Evento</h2>
                <button onclick="chiudiModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div id="modalEventoInfo" style="margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <!-- Info evento verranno inserite qui -->
            </div>
            
            <div id="modalAIQInfo" style="margin-bottom: 30px; padding: 15px; background: #f0f9ff; border-radius: 6px;">
                <!-- Info AIQ verranno inserite qui -->
            </div>
            
            <div id="modalQuotesContainer">
                <!-- Tabella quotes verr√† inserita qui -->
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="chiudiModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Chiudi
                </button>
            </div>
        </div>
    </div>
    <script>
        // ==============================
        // VARIABILI GLOBALI
        // ==============================
        let parsedData3 = [];  // Dati per 3 esiti
        let parsedData2 = [];  // Dati per 2 esiti
        let eventoCorrente3 = null;  // Per tab 3 esiti
        let eventoCorrente2 = null;  // Per tab 2 esiti
        const sharpBookmakers = ['pinnacle', 'betfair'];
        
        // ==============================
        // VARIABILI AIQ GLOBALI (CONFIGURABILI)
        // ==============================
        let soglieAIQ = JSON.parse(localStorage.getItem('soglieAIQ') || JSON.stringify({
            sm: 5,    // Sharp/Media %
            mm: 8,    // Max/Min %
            ss: 7,    // Sharp/Soft %
            near: 0.5 // Soglia "vicino"
        }));
        const aiqTooltip = document.getElementById("aiqTooltip");
        
        // Variabili per la gestione eventi
        let eventoCorrente = null;
        let databaseEventi = JSON.parse(localStorage.getItem('databaseEventi') || '[]');
        let eventoCorrenteId = null;
        
        // ==============================
        // VARIABILI GLOBALI PAGINAZIONE
        // ==============================
        let paginaCorrente = 1;
        let eventiPerPagina = 20;
        let eventiFiltrati = [];

        // Ordinamento per 3 esiti
        let currentSort3 = {
            column: null,
            direction: 'asc'
        };
        
        // Ordinamento per 2 esiti
        let currentSort2 = {
            column: null,
            direction: 'asc'
        };

        // ==============================
        // VARIABILI ORDINAMENTO EVENTI
        // ==============================
        let ordinamentoEventi = {
            campo: 'data',      // Campo di default: data
            direzione: 'desc'   // Default: pi√π recenti prima
        };

        // ==============================
        // FUNZIONE PER GENERARE ID UNIVOCI
        // ==============================
        function generaIdEvento() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 15) + 
                        Math.random().toString(36).substring(2, 15); // Pi√π lungo
            const microtime = performance.now().toString().replace('.', '').slice(-6);
            return `ev_${timestamp}_${microtime}_${random.substring(0, 8)}`;
        }

        // Esempi di ID generati:
        // ev_1706371200000_123456_a1b2c3d4
        // ev_1706371200123_654321_f5g6h7i8

        // ==============================
        // FUNZIONI TAB
        // ==============================
        function switchTab(tabId) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra il tab selezionato
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // Azioni specifiche per ogni tab
            if (tabId === 'tab-eventi') {
                // AGGIORNA SEMPRE eventiFiltrati con tutti gli eventi
                eventiFiltrati = [...databaseEventi];
                paginaCorrente = 1; // Reset paginazione
                
                mostraTabellaEventi();
                aggiornaFiltriSport();
                calcolaStatisticheDatabase();
                
                // Forza un refresh visivo
                setTimeout(() => {
                    document.getElementById('tabellaEventi').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }

            if (tabId === 'tab-setup') {
            inizializzaTabSetup(); 
            }

            if (tabId === 'tab-backtest') {
                aggiornaStatisticheBacktest();
                inizializzaStrategieStake(); // AGGIUNGI QUESTA RIGA!
            }
        }

        // ==============================
        // FUNZIONI AIQ CALCULATOR
        // ==============================
        function showAiqTooltip(text, e) {
            aiqTooltip.innerText = text;
            aiqTooltip.style.left = e.clientX + 12 + "px";
            aiqTooltip.style.top  = e.clientY + 12 + "px";
            aiqTooltip.style.opacity = 1;
        }
        
        function hideAiqTooltip() {
            aiqTooltip.style.opacity = 0;
        }

        function applyAiqTooltip(el, text) {
            el.onmousemove = e => showAiqTooltip(text, e);
            el.onmouseleave = hideAiqTooltip;
        }

        function styleAiqCell(el, value, th) {
            el.className = "";
            if (value >= th) {
                el.classList.add("aiq-ok");
                applyAiqTooltip(el, "üü¢ Condizione OK");
            } else if (value >= th - soglieAIQ.near) {
                el.classList.add("aiq-warn");
                applyAiqTooltip(el, "üü° Vicino alla soglia");
            } else {
                applyAiqTooltip(el, "üî¥ Condizione NON OK");
            }
        }

        function calculateAiq(title, outcome) {
            const g = k => parseFloat(document.getElementById(`${title}_${k}_${outcome}`).value);
            const sharp = g("Sharp"), media = g("Media"), min = g("Min"), max = g("Max");
            
            if([sharp, media, min, max].some(isNaN)) return;

            const sm = ((sharp - media) / media) * 100;
            const mm = ((max - min) / min) * 100;
            const ss = ((sharp - min) / min) * 100;
            const fv = (sm + mm + ss) / 3;

            const smEl = document.getElementById(`${title}_sm_${outcome}`);
            const mmEl = document.getElementById(`${title}_mm_${outcome}`);
            const ssEl = document.getElementById(`${title}_ss_${outcome}`);
            const fvEl = document.getElementById(`${title}_fv_${outcome}`);
            const resEl = document.getElementById(`${title}_res_${outcome}`);

            smEl.innerText = sm.toFixed(2) + "%";
            mmEl.innerText = mm.toFixed(2) + "%";
            ssEl.innerText = ss.toFixed(2) + "%";
            fvEl.innerText = fv.toFixed(2) + "%";

            // USA LE SOGLIE CONFIGURATE
            styleAiqCell(smEl, sm, soglieAIQ.sm);
            styleAiqCell(mmEl, mm, soglieAIQ.mm);
            styleAiqCell(ssEl, ss, soglieAIQ.ss);

            const value = sm >= soglieAIQ.sm && mm >= soglieAIQ.mm && ss >= soglieAIQ.ss;

            fvEl.className = value ? "aiq-ok" : "";
            applyAiqTooltip(fvEl, value ? "‚≠ê ValueBet confermata" : "‚Ñπ Media delle metriche");

            resEl.innerText = value ? "VALUE" : "NO VALUE";
            resEl.className = value ? "aiq-result aiq-value" : "aiq-result aiq-novalue";
        }

        // ==============================
        // FUNZIONI 3 ESITI
        // ==============================
        function loadExample3Esiti() {
            const example = `efbet
efbet.net
3.69
3.41
2.28
99.7%
1xbet
1xbet
3.61
3.46
2.23
98.6%
tipico
tipico
3.60
3.30
2.10
94.3%
betfair
betfair
3.60
3.40
2.32
99.7%
betsensation
betsensation
3.56
3.30
2.22
96.6%
pinnacle
pinnacle
3.52
3.27
2.28
97.2%`;
            
            document.getElementById('inputData3').value = example;
            showNotification('Esempio 3 esiti caricato', 'info');
        }

        function parseData3Esiti() {
            const input = document.getElementById('inputData3').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati da Betmonitor', 'error');
                return;
            }

            parsedData3 = [];
            const debugInfo = [];
            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');

            let i = 0;
            while (i < lines.length) {
                // Pattern: nome, dominio, 3 quote, percentuale
                if (i + 5 < lines.length) {
                    const bookmakerName = lines[i].toLowerCase();
                    const quote1 = parseFloat(lines[i + 2]);
                    const quoteX = parseFloat(lines[i + 3]);
                    const quote2 = parseFloat(lines[i + 4]);

                    if (!isNaN(quote1) && !isNaN(quoteX) && !isNaN(quote2)) {
                        parsedData3.push({
                            bookmaker: bookmakerName,
                            quote1: quote1,
                            quoteX: quoteX,
                            quote2: quote2,
                            isSharp: sharpBookmakers.includes(bookmakerName)
                        });
                        i += 6; // Salta al prossimo bookmaker
                        continue;
                    }
                }
                i++;
            }

            if (parsedData3.length === 0) {
                showNotification('Nessun dato valido trovato', 'error');
                document.getElementById('debugInfo3').innerHTML = debugInfo.join('<br>');
                document.getElementById('debugInfo3').style.display = 'block';
            } else {
                document.getElementById('debugInfo3').style.display = 'none';
                displayResults3();
                updateStats3();
                updateAiqCalculatorFromParser3();
                resetSort3();
                showNotification(`Trovati ${parsedData3.length} bookmaker (3 esiti)`, 'success');
            }
        }

        function calculateStatistics3() {
            if (parsedData3.length === 0) {
                return {
                    avg1: 0, avgX: 0, avg2: 0,
                    min1: 0, minX: 0, min2: 0,
                    max1: 0, maxX: 0, max2: 0,
                    minBook1: '', minBookX: '', minBook2: '',
                    maxBook1: '', maxBookX: '', maxBook2: '',
                    pinnacle1: null, pinnacleX: null, pinnacle2: null,
                    betfair1: null, betfairX: null, betfair2: null,
                    sharpCount: 0
                };
            }

            let min1 = parsedData3[0].quote1, minX = parsedData3[0].quoteX, min2 = parsedData3[0].quote2;
            let max1 = parsedData3[0].quote1, maxX = parsedData3[0].quoteX, max2 = parsedData3[0].quote2;
            let minBook1 = parsedData3[0].bookmaker, minBookX = parsedData3[0].bookmaker, minBook2 = parsedData3[0].bookmaker;
            let maxBook1 = parsedData3[0].bookmaker, maxBookX = parsedData3[0].bookmaker, maxBook2 = parsedData3[0].bookmaker;
            let total1 = 0, totalX = 0, total2 = 0;
            let sharpCount = 0;

            let pinnacle1 = null, pinnacleX = null, pinnacle2 = null;
            let betfair1 = null, betfairX = null, betfair2 = null;

            parsedData3.forEach(item => {
                total1 += item.quote1;
                totalX += item.quoteX;
                total2 += item.quote2;

                if (item.quote1 < min1) { min1 = item.quote1; minBook1 = item.bookmaker; }
                if (item.quote1 > max1) { max1 = item.quote1; maxBook1 = item.bookmaker; }
                if (item.quoteX < minX) { minX = item.quoteX; minBookX = item.bookmaker; }
                if (item.quoteX > maxX) { maxX = item.quoteX; maxBookX = item.bookmaker; }
                if (item.quote2 < min2) { min2 = item.quote2; minBook2 = item.bookmaker; }
                if (item.quote2 > max2) { max2 = item.quote2; maxBook2 = item.bookmaker; }
                
                if (item.bookmaker === 'pinnacle') {
                    pinnacle1 = item.quote1;
                    pinnacleX = item.quoteX;
                    pinnacle2 = item.quote2;
                    sharpCount++;
                }
                if (item.bookmaker === 'betfair') {
                    betfair1 = item.quote1;
                    betfairX = item.quoteX;
                    betfair2 = item.quote2;
                    sharpCount++;
                }
            });

            return {
                avg1: total1 / parsedData3.length,
                avgX: totalX / parsedData3.length,
                avg2: total2 / parsedData3.length,
                min1, minX, min2,
                max1, maxX, max2,
                minBook1, minBookX, minBook2,
                maxBook1, maxBookX, maxBook2,
                pinnacle1, pinnacleX, pinnacle2,
                betfair1, betfairX, betfair2,
                sharpCount
            };
        }

        function updateStats3() {
            const stats = calculateStatistics3();
            
            document.getElementById('totalBooks3').textContent = parsedData3.length;
            document.getElementById('sharpBooks3').textContent = stats.sharpCount;

            document.getElementById('avgQuote1').textContent = stats.avg1.toFixed(2);
            document.getElementById('minQuote1').textContent = stats.min1.toFixed(2);
            document.getElementById('maxQuote1').textContent = stats.max1.toFixed(2);
            document.getElementById('minBook1').textContent = formatBookmakerName(stats.minBook1);
            document.getElementById('maxBook1').textContent = formatBookmakerName(stats.maxBook1);
            
            document.getElementById('pinnacleQuote1').textContent = stats.pinnacle1 !== null ? stats.pinnacle1.toFixed(2) : '-';
            document.getElementById('betfairQuote1').textContent = stats.betfair1 !== null ? stats.betfair1.toFixed(2) : '-';

            document.getElementById('avgQuoteX').textContent = stats.avgX.toFixed(2);
            document.getElementById('minQuoteX').textContent = stats.minX.toFixed(2);
            document.getElementById('maxQuoteX').textContent = stats.maxX.toFixed(2);
            document.getElementById('minBookX').textContent = formatBookmakerName(stats.minBookX);
            document.getElementById('maxBookX').textContent = formatBookmakerName(stats.maxBookX);
            
            document.getElementById('pinnacleQuoteX').textContent = stats.pinnacleX !== null ? stats.pinnacleX.toFixed(2) : '-';
            document.getElementById('betfairQuoteX').textContent = stats.betfairX !== null ? stats.betfairX.toFixed(2) : '-';

            document.getElementById('avgQuote2').textContent = stats.avg2.toFixed(2);
            document.getElementById('minQuote2').textContent = stats.min2.toFixed(2);
            document.getElementById('maxQuote2').textContent = stats.max2.toFixed(2);
            document.getElementById('minBook2').textContent = formatBookmakerName(stats.minBook2);
            document.getElementById('maxBook2').textContent = formatBookmakerName(stats.maxBook2);
            
            document.getElementById('pinnacleQuote2').textContent = stats.pinnacle2 !== null ? stats.pinnacle2.toFixed(2) : '-';
            document.getElementById('betfairQuote2').textContent = stats.betfair2 !== null ? stats.betfair2.toFixed(2) : '-';
        }

        function updateAiqCalculatorFromParser3() {
            const stats = calculateStatistics3();
            
            // Aggiorna il calcolatore AIQ CALCIO con i dati del parser
            // Pulisci prima tutti i campi
            document.getElementById('AIQ CALCIO_Sharp_HOME').value = '';
            document.getElementById('AIQ CALCIO_Sharp_DRAW').value = '';
            document.getElementById('AIQ CALCIO_Sharp_AWAY').value = '';
            
            document.getElementById('AIQ CALCIO_Media_HOME').value = '';
            document.getElementById('AIQ CALCIO_Media_DRAW').value = '';
            document.getElementById('AIQ CALCIO_Media_AWAY').value = '';
            
            document.getElementById('AIQ CALCIO_Min_HOME').value = '';
            document.getElementById('AIQ CALCIO_Max_HOME').value = '';
            
            document.getElementById('AIQ CALCIO_Min_DRAW').value = '';
            document.getElementById('AIQ CALCIO_Max_DRAW').value = '';
            
            document.getElementById('AIQ CALCIO_Min_AWAY').value = '';
            document.getElementById('AIQ CALCIO_Max_AWAY').value = '';
            
            // Solo se ci sono dati validi, inseriscili
            if (stats.pinnacle1 !== null) {
                document.getElementById('AIQ CALCIO_Sharp_HOME').value = stats.pinnacle1.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_DRAW').value = stats.pinnacleX.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_AWAY').value = stats.pinnacle2.toFixed(2);
            } else if (stats.betfair1 !== null) {
                document.getElementById('AIQ CALCIO_Sharp_HOME').value = stats.betfair1.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_DRAW').value = stats.betfairX.toFixed(2);
                document.getElementById('AIQ CALCIO_Sharp_AWAY').value = stats.betfair2.toFixed(2);
            }
            
            if (parsedData3.length > 0) {
                document.getElementById('AIQ CALCIO_Media_HOME').value = stats.avg1.toFixed(2);
                document.getElementById('AIQ CALCIO_Media_DRAW').value = stats.avgX.toFixed(2);
                document.getElementById('AIQ CALCIO_Media_AWAY').value = stats.avg2.toFixed(2);
                
                document.getElementById('AIQ CALCIO_Min_HOME').value = stats.min1.toFixed(2);
                document.getElementById('AIQ CALCIO_Max_HOME').value = stats.max1.toFixed(2);
                
                document.getElementById('AIQ CALCIO_Min_DRAW').value = stats.minX.toFixed(2);
                document.getElementById('AIQ CALCIO_Max_DRAW').value = stats.maxX.toFixed(2);
                
                document.getElementById('AIQ CALCIO_Min_AWAY').value = stats.min2.toFixed(2);
                document.getElementById('AIQ CALCIO_Max_AWAY').value = stats.max2.toFixed(2);
            }
            
            // Ricalcola AIQ
            calculateAiq('AIQ CALCIO', 'HOME');
            calculateAiq('AIQ CALCIO', 'DRAW');
            calculateAiq('AIQ CALCIO', 'AWAY');
        }

        function displayResults3() {
            const tableBody = document.getElementById('resultsTable3');
            const emptyState = document.getElementById('emptyState3');
            
            if (parsedData3.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tableBody.innerHTML = parsedData3.map(item => `
                <tr>
                    <td>
                        <span class="bookmaker-name ${item.isSharp ? 'sharp' : ''}">
                            ${formatBookmakerName(item.bookmaker)}
                            ${item.isSharp ? ' ‚ö°' : ''}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-1-cell">${item.quote1.toFixed(2)}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-x-cell">${item.quoteX.toFixed(2)}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-2-cell">${item.quote2.toFixed(2)}</span>
                    </td>
                </tr>
            `).join('');
        }

        function clearData3Esiti() {
            document.getElementById('inputData3').value = '';
            parsedData3 = [];
            displayResults3();
            updateStats3();
            resetSort3();
            showNotification('Dati 3 esiti puliti', 'info');
        }

        // ==============================
        // FUNZIONI 2 ESITI
        // ==============================
        function loadExample2Esiti() {
            const example = `efbet
efbet.net
8.40
1.11
98.0 %
betfair
betfair
8.24
1.12
98.6 %
dafabet
dafabet
7.10
1.10
95.0 %
ggbet
ggbet
6.99
1.09
94.0 %
bet365
bet365
6.60
1.11
94.8 %
pmbet
pmbet
6.40
1.11
94.3 %
casapariurilor
casapariurilor
6.40
1.12
95.1 %
wwin
wwin
5.90
1.10
92.1 %
tippmix_hu
tippmix_hu
5.25
1.09
89.2 %`;
            
            document.getElementById('inputData2').value = example;
            showNotification('Esempio 2 esiti caricato', 'info');
        }

        function parseData2Esiti() {
            const input = document.getElementById('inputData2').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati da Betmonitor', 'error');
                return;
            }

            parsedData2 = [];
            const debugInfo = [];
            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');

            let i = 0;
            while (i < lines.length) {
                if (i + 4 < lines.length) {
                    const bookmakerName = lines[i].toLowerCase();
                    const quoteYes = parseFloat(lines[i + 2]);
                    const quoteNo = parseFloat(lines[i + 3]);

                    if (!isNaN(quoteYes) && !isNaN(quoteNo)) {
                        parsedData2.push({
                            bookmaker: bookmakerName,
                            quoteYes: quoteYes,
                            quoteNo: quoteNo,
                            isSharp: sharpBookmakers.includes(bookmakerName)
                        });
                        i += 5;
                        continue;
                    }
                }
                i++;
            }

            if (parsedData2.length === 0) {
                showNotification('Nessun dato valido trovato', 'error');
                document.getElementById('debugInfo2').innerHTML = debugInfo.join('<br>');
                document.getElementById('debugInfo2').style.display = 'block';
            } else {
                document.getElementById('debugInfo2').style.display = 'none';
                displayResults2();
                updateStats2();
                updateAiqCalculatorFromParser2();
                resetSort2();
                showNotification(`Trovati ${parsedData2.length} bookmaker (2 esiti)`, 'success');
            }
        }

        function calculateStatistics2() {
            if (parsedData2.length === 0) {
                return {
                    avgYes: 0, avgNo: 0,
                    minYes: 0, minNo: 0,
                    maxYes: 0, maxNo: 0,
                    minBookYes: '', minBookNo: '',
                    maxBookYes: '', maxBookNo: '',
                    pinnacleYes: null, pinnacleNo: null,
                    betfairYes: null, betfairNo: null,
                    sharpCount: 0
                };
            }

            let minYes = parsedData2[0].quoteYes, minNo = parsedData2[0].quoteNo;
            let maxYes = parsedData2[0].quoteYes, maxNo = parsedData2[0].quoteNo;
            let minBookYes = parsedData2[0].bookmaker, minBookNo = parsedData2[0].bookmaker;
            let maxBookYes = parsedData2[0].bookmaker, maxBookNo = parsedData2[0].bookmaker;
            let totalYes = 0, totalNo = 0;
            let sharpCount = 0;

            let pinnacleYes = null, pinnacleNo = null;
            let betfairYes = null, betfairNo = null;

            parsedData2.forEach(item => {
                totalYes += item.quoteYes;
                totalNo += item.quoteNo;

                if (item.quoteYes < minYes) { minYes = item.quoteYes; minBookYes = item.bookmaker; }
                if (item.quoteYes > maxYes) { maxYes = item.quoteYes; maxBookYes = item.bookmaker; }
                if (item.quoteNo < minNo) { minNo = item.quoteNo; minBookNo = item.bookmaker; }
                if (item.quoteNo > maxNo) { maxNo = item.quoteNo; maxBookNo = item.bookmaker; }
                
                if (item.bookmaker === 'pinnacle') {
                    pinnacleYes = item.quoteYes;
                    pinnacleNo = item.quoteNo;
                    sharpCount++;
                }
                if (item.bookmaker === 'betfair') {
                    betfairYes = item.quoteYes;
                    betfairNo = item.quoteNo;
                    sharpCount++;
                }
            });

            return {
                avgYes: totalYes / parsedData2.length,
                avgNo: totalNo / parsedData2.length,
                minYes, minNo,
                maxYes, maxNo,
                minBookYes, minBookNo,
                maxBookYes, maxBookNo,
                pinnacleYes, pinnacleNo,
                betfairYes, betfairNo,
                sharpCount
            };
        }

        // ==============================
        // FUNZIONE VERIFICA VALUEBET AIQ (PER TABELLA)
        // ==============================
        function verificaValueBetAIQ(stats, tipoQuotes) {
            if (!stats || !tipoQuotes) return { hasValue: false, outcome: '', forzaValue: 0 };
            
            if (tipoQuotes === '3_esiti') {
                // Funzione per calcolare metriche per un singolo esito
                const calcolaMetriche = (sharp, media, min, max) => {
                    // CORREZIONE: Controlla esplicitamente per null/undefined, non per falsy (0 √® valido)
                    if (sharp === null || sharp === undefined || 
                        media === null || media === undefined || 
                        min === null || min === undefined || 
                        max === null || max === undefined) return null;
                    
                    const sm = ((sharp - media) / media) * 100;
                    const mm = ((max - min) / min) * 100;
                    const ss = ((sharp - min) / min) * 100;
                    const fv = (sm + mm + ss) / 3;
                    
                    return { sm, mm, ss, fv };
                };
                
                // Usa Pinnacle se disponibile, altrimenti Betfair
                const sharp1 = stats.pinnacle1 !== null && stats.pinnacle1 !== undefined ? stats.pinnacle1 : stats.betfair1;
                const sharpX = stats.pinnacleX !== null && stats.pinnacleX !== undefined ? stats.pinnacleX : stats.betfairX;
                const sharp2 = stats.pinnacle2 !== null && stats.pinnacle2 !== undefined ? stats.pinnacle2 : stats.betfair2;
                
                // Calcola metriche per ogni esito
                const metriche1 = calcolaMetriche(sharp1, stats.avg1, stats.min1, stats.max1);
                const metricheX = calcolaMetriche(sharpX, stats.avgX, stats.minX, stats.maxX);
                const metriche2 = calcolaMetriche(sharp2, stats.avg2, stats.min2, stats.max2);
                
                // Verifica se soddisfa tutte e tre le soglie (CONFIGURABILI)
                const checkSoglie = (m) => m && m.sm >= soglieAIQ.sm && m.mm >= soglieAIQ.mm && m.ss >= soglieAIQ.ss;
                
                const isValue1 = checkSoglie(metriche1);
                const isValueX = checkSoglie(metricheX);
                const isValue2 = checkSoglie(metriche2);
                
                // Determina quale esito ha VALUE
                if (isValue1) return { 
                    hasValue: true, 
                    outcome: '1', 
                    forzaValue: metriche1.fv 
                };
                if (isValueX) return { 
                    hasValue: true, 
                    outcome: 'X', 
                    forzaValue: metricheX.fv 
                };
                if (isValue2) return { 
                    hasValue: true, 
                    outcome: '2', 
                    forzaValue: metriche2.fv 
                };
                
                return { hasValue: false, outcome: '', forzaValue: 0 };
            }
            else if (tipoQuotes === '2_esiti') {
                // Logica per 2 esiti con stessa correzione
                const calcolaMetriche = (sharp, media, min, max) => {
                    if (sharp === null || sharp === undefined || 
                        media === null || media === undefined || 
                        min === null || min === undefined || 
                        max === null || max === undefined) return null;
                    
                    const sm = ((sharp - media) / media) * 100;
                    const mm = ((max - min) / min) * 100;
                    const ss = ((sharp - min) / min) * 100;
                    const fv = (sm + mm + ss) / 3;
                    
                    return { sm, mm, ss, fv };
                };
                
                const sharpYes = stats.pinnacleYes !== null && stats.pinnacleYes !== undefined ? stats.pinnacleYes : stats.betfairYes;
                const sharpNo = stats.pinnacleNo !== null && stats.pinnacleNo !== undefined ? stats.pinnacleNo : stats.betfairNo;
                
                const metricheYes = calcolaMetriche(sharpYes, stats.avgYes, stats.minYes, stats.maxYes);
                const metricheNo = calcolaMetriche(sharpNo, stats.avgNo, stats.minNo, stats.maxNo);
                
                // Verifica se soddisfa tutte e tre le soglie (CONFIGURABILI)
                const checkSoglie = (m) => m && m.sm >= soglieAIQ.sm && m.mm >= soglieAIQ.mm && m.ss >= soglieAIQ.ss;
                
                const isValueYes = checkSoglie(metricheYes);
                const isValueNo = checkSoglie(metricheNo);
                
                if (isValueYes) return { 
                    hasValue: true, 
                    outcome: 'SI', 
                    forzaValue: metricheYes.fv 
                };
                if (isValueNo) return { 
                    hasValue: true, 
                    outcome: 'NO', 
                    forzaValue: metricheNo.fv 
                };
                
                return { hasValue: false, outcome: '', forzaValue: 0 };
            }
            
            return { hasValue: false, outcome: '', forzaValue: 0 };
        }

        function updateStats2() {
            const stats = calculateStatistics2();
            
            document.getElementById('totalBooks2').textContent = parsedData2.length;
            document.getElementById('sharpBooks2').textContent = stats.sharpCount;

            document.getElementById('avgQuoteYes').textContent = stats.avgYes.toFixed(2);
            document.getElementById('minQuoteYes').textContent = stats.minYes.toFixed(2);
            document.getElementById('maxQuoteYes').textContent = stats.maxYes.toFixed(2);
            document.getElementById('minBookYes').textContent = formatBookmakerName(stats.minBookYes);
            document.getElementById('maxBookYes').textContent = formatBookmakerName(stats.maxBookYes);
            
            document.getElementById('pinnacleQuoteYes').textContent = stats.pinnacleYes !== null ? stats.pinnacleYes.toFixed(2) : '-';
            document.getElementById('betfairQuoteYes').textContent = stats.betfairYes !== null ? stats.betfairYes.toFixed(2) : '-';

            document.getElementById('avgQuoteNo').textContent = stats.avgNo.toFixed(2);
            document.getElementById('minQuoteNo').textContent = stats.minNo.toFixed(2);
            document.getElementById('maxQuoteNo').textContent = stats.maxNo.toFixed(2);
            document.getElementById('minBookNo').textContent = formatBookmakerName(stats.minBookNo);
            document.getElementById('maxBookNo').textContent = formatBookmakerName(stats.maxBookNo);
            
            document.getElementById('pinnacleQuoteNo').textContent = stats.pinnacleNo !== null ? stats.pinnacleNo.toFixed(2) : '-';
            document.getElementById('betfairQuoteNo').textContent = stats.betfairNo !== null ? stats.betfairNo.toFixed(2) : '-';
        }

        function updateAiqCalculatorFromParser2() {
            const stats = calculateStatistics2();
            
            // Aggiorna il calcolatore AIQ TENNIS con i dati del parser
            // Pulisci prima tutti i campi
            document.getElementById('AIQ TENNIS_Sharp_HOME').value = '';
            document.getElementById('AIQ TENNIS_Sharp_AWAY').value = '';
            
            document.getElementById('AIQ TENNIS_Media_HOME').value = '';
            document.getElementById('AIQ TENNIS_Media_AWAY').value = '';
            
            document.getElementById('AIQ TENNIS_Min_HOME').value = '';
            document.getElementById('AIQ TENNIS_Max_HOME').value = '';
            
            document.getElementById('AIQ TENNIS_Min_AWAY').value = '';
            document.getElementById('AIQ TENNIS_Max_AWAY').value = '';
            
            // Solo se ci sono dati validi, inseriscili
            if (stats.pinnacleYes !== null) {
                document.getElementById('AIQ TENNIS_Sharp_HOME').value = stats.pinnacleYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Sharp_AWAY').value = stats.pinnacleNo.toFixed(2);
            } else if (stats.betfairYes !== null) {
                document.getElementById('AIQ TENNIS_Sharp_HOME').value = stats.betfairYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Sharp_AWAY').value = stats.betfairNo.toFixed(2);
            }
            
            if (parsedData2.length > 0) {
                document.getElementById('AIQ TENNIS_Media_HOME').value = stats.avgYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Media_AWAY').value = stats.avgNo.toFixed(2);
                
                document.getElementById('AIQ TENNIS_Min_HOME').value = stats.minYes.toFixed(2);
                document.getElementById('AIQ TENNIS_Max_HOME').value = stats.maxYes.toFixed(2);
                
                document.getElementById('AIQ TENNIS_Min_AWAY').value = stats.minNo.toFixed(2);
                document.getElementById('AIQ TENNIS_Max_AWAY').value = stats.maxNo.toFixed(2);
            }
            
            // Ricalcola AIQ
            calculateAiq('AIQ TENNIS', 'HOME');
            calculateAiq('AIQ TENNIS', 'AWAY');
        }

        function displayResults2() {
            const tableBody = document.getElementById('resultsTable2');
            const emptyState = document.getElementById('emptyState2');
            
            if (parsedData2.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tableBody.innerHTML = parsedData2.map(item => `
                <tr>
                    <td>
                        <span class="bookmaker-name ${item.isSharp ? 'sharp' : ''}">
                            ${formatBookmakerName(item.bookmaker)}
                            ${item.isSharp ? ' ‚ö°' : ''}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-yes-cell">${item.quoteYes.toFixed(2)}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="quote-cell quote-no-cell">${item.quoteNo.toFixed(2)}</span>
                    </td>
                </tr>
            `).join('');
        }

        function clearData2Esiti() {
            document.getElementById('inputData2').value = '';
            parsedData2 = [];
            displayResults2();
            updateStats2();
            resetSort2();
            showNotification('Dati 2 esiti puliti', 'info');
        }

        function aggiornaIndicatoriSoglie() {
            console.log("aggiornaIndicatoriSoglie chiamato. Soglie:", soglieAIQ);
            
            // Assicurati che soglieAIQ esista
            if (!soglieAIQ) {
                console.error("soglieAIQ non definita! Usando default...");
                soglieAIQ = {
                    sm: 5,
                    mm: 8,
                    ss: 7,
                    near: 0.5
                };
            }
            
            // Aggiorna nei calcolatori AIQ CALCIO
            const valoreSM = document.getElementById('valoreSM');
            const valoreMM = document.getElementById('valoreMM');
            const valoreSS = document.getElementById('valoreSS');
            
            if (valoreSM && valoreMM && valoreSS) {
                valoreSM.textContent = soglieAIQ.sm;
                valoreMM.textContent = soglieAIQ.mm;
                valoreSS.textContent = soglieAIQ.ss;
                console.log("AIQ Calcio aggiornato:", soglieAIQ.sm, soglieAIQ.mm, soglieAIQ.ss);
            }
            
            // Aggiorna nei calcolatori AIQ TENNIS
            const valoreSM_T = document.getElementById('valoreSM_T');
            const valoreMM_T = document.getElementById('valoreMM_T');
            const valoreSS_T = document.getElementById('valoreSS_T');
            
            if (valoreSM_T && valoreMM_T && valoreSS_T) {
                valoreSM_T.textContent = soglieAIQ.sm;
                valoreMM_T.textContent = soglieAIQ.mm;
                valoreSS_T.textContent = soglieAIQ.ss;
                console.log("AIQ Tennis aggiornato:", soglieAIQ.sm, soglieAIQ.mm, soglieAIQ.ss);
            }
            
            // Cambia colore/stile se le soglie sono personalizzate
            const sonoDefault = soglieAIQ.sm === 5 && soglieAIQ.mm === 8 && soglieAIQ.ss === 7;
            
            // Per AIQ Calcio
            const indicatoreCalcio = document.getElementById('soglieAttiveCalcio');
            if (indicatoreCalcio) {
                if (!sonoDefault) {
                    indicatoreCalcio.style.background = '#fef3c7';
                    indicatoreCalcio.style.color = '#92400e';
                    indicatoreCalcio.style.border = '1px solid #f59e0b';
                    indicatoreCalcio.style.fontWeight = 'bold';
                    indicatoreCalcio.title = `‚ö†Ô∏è Soglie personalizzate (default: 5-8-7%)`;
                } else {
                    indicatoreCalcio.style.background = '#dbeafe';
                    indicatoreCalcio.style.color = '#1d4ed8';
                    indicatoreCalcio.style.border = '1px solid #93c5fd';
                    indicatoreCalcio.style.fontWeight = 'normal';
                    indicatoreCalcio.title = `Soglie di default`;
                }
            }
            
            // Per AIQ Tennis
            const indicatoreTennis = document.getElementById('soglieAttiveTennis');
            if (indicatoreTennis) {
                if (!sonoDefault) {
                    indicatoreTennis.style.background = '#fef3c7';
                    indicatoreTennis.style.color = '#92400e';
                    indicatoreTennis.style.border = '1px solid #f59e0b';
                    indicatoreTennis.style.fontWeight = 'bold';
                    indicatoreTennis.title = `‚ö†Ô∏è Soglie personalizzate (default: 5-8-7%)`;
                } else {
                    indicatoreTennis.style.background = '#dbeafe';
                    indicatoreTennis.style.color = '#1d4ed8';
                    indicatoreTennis.style.border = '1px solid #93c5fd';
                    indicatoreTennis.style.fontWeight = 'normal';
                    indicatoreTennis.title = `Soglie di default`;
                }
            }
        }

        // ==============================
        // Funzioni per parser 3 esiti
        // ==============================
        function loadEsempioEvento3() {
            const esempio = `VfB Stuttgart ‚Äî Eintracht Frankfurt
        Football ¬∑ Germany ¬∑ Germany Bundesliga
        Tuesday ¬∑ 13 Jan, 2026 ¬∑ 18:30`;
            
            document.getElementById('inputEvento3').value = esempio;
            showNotification('Esempio evento caricato (Calcio)', 'info');
        }

        function parseEvento3() {
            const input = document.getElementById('inputEvento3').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati dell\'evento', 'error');
                return;
            }

            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');
            
            if (lines.length < 3) {
                showNotification('Formato non valido. Servono 3 linee di dati', 'error');
                return;
            }

            // Parsing
            const nomeEvento = lines[0];
            const partsLinea2 = lines[1].split('¬∑').map(part => part.trim());
            const partsLinea3 = lines[2].split('¬∑').map(part => part.trim());
            
            if (partsLinea2.length < 3 || partsLinea3.length < 3) {
                showNotification('Formato non valido', 'error');
                return;
            }
            
            const dataCompleta = partsLinea3[1] + ' ' + partsLinea3[2];
            const dataOra = parseDate(dataCompleta);
            
            if (!dataOra) {
                showNotification('Data non valida', 'error');
                return;
            }

            const dataFormattata = dataOra.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Salva in variabile globale
            eventoCorrente3 = {
                nome: nomeEvento,
                sport: partsLinea2[0],
                nazione: partsLinea2[1],
                lega: partsLinea2[2],
                dataOra: dataOra.toISOString(),
                dataFormattata: dataFormattata,
                timestamp: new Date().toISOString(),
                quotes: null,
                aiqData: null
            };

            // Mostra dettagli
            mostraDettagliEvento3(eventoCorrente3);
            showNotification('Evento parsato con successo (Calcio)', 'success');
        }

        function clearEvento3() {
            document.getElementById('inputEvento3').value = '';
            eventoCorrente3 = null;
            mostraDettagliEvento3(null);
            showNotification('Evento pulito (Calcio)', 'info');
        }

        function salvaEventoConQuotes3() {
            if (!eventoCorrente3) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData3.length === 0) {
                showNotification('Prima parsare quotes 3 esiti', 'error');
                return;
            }

            // Crea una COPIA dell'evento corrente per non modificare l'originale
            const eventoDaSalvare = {
                ...eventoCorrente3,
                id: generaIdEvento(), // GENERA NUOVO ID UNIVOCO
                quotes: [...parsedData3], // Copia i dati
                tipoQuotes: '3_esiti',
                aiqData: {
                    timestamp: new Date().toISOString(),
                    stats: calculateStatistics3(),
                    soglieUsate: {
                        sm: soglieAIQ.sm,
                        mm: soglieAIQ.mm,
                        ss: soglieAIQ.ss,
                        near: soglieAIQ.near,
                        timestamp: new Date().toISOString()
                    }
                }
            };
            
            // Salva nel database
            databaseEventi.push(eventoDaSalvare);
            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
            
            // AGGIORNA IMMEDIATAMENTE la tab Eventi se √® visibile
            const tabEventiVisibile = document.getElementById('tab-eventi').classList.contains('active');
            if (tabEventiVisibile) {
                // Aggiorna eventi filtrati e mostra tabella
                eventiFiltrati = [...databaseEventi];
                paginaCorrente = 1; // Torna alla prima pagina per mostrare il nuovo evento
                mostraTabellaEventi();
                calcolaStatisticheDatabase();
                aggiornaFiltriSport();
            }
            // Aggiorna statistiche
            calcolaStatisticheDatabase();
            
            // Aggiorna tutto
            refreshDatabaseEventi();
            
            // MOSTRA SEMPRE la tabella eventi
            mostraTabellaEventi();
            
            showNotification(`‚úÖ Evento ${eventoDaSalvare.sport} salvato! ID: ${eventoDaSalvare.id.slice(0, 8)}...`, 'success');
            
            // Resetta evento corrente MA NON l'input (per permettere modifiche)
            eventoCorrente3 = null;
            mostraDettagliEvento3(null);
        }

        // Funzioni per parser 2 esiti
        function loadEsempioEvento2() {
            const esempio = `Nadal vs. Djokovic
        Tennis ¬∑ International ¬∑ Wimbledon
        Monday ¬∑ 15 Jan, 2026 ¬∑ 15:00`;
            
            document.getElementById('inputEvento2').value = esempio;
            showNotification('Esempio evento caricato (Tennis)', 'info');
        }

        function parseEvento2() {
            const input = document.getElementById('inputEvento2').value.trim();
            if (!input) {
                showNotification('Incolla prima i dati dell\'evento', 'error');
                return;
            }

            const lines = input.split('\n').map(line => line.trim()).filter(line => line !== '');
            
            if (lines.length < 3) {
                showNotification('Formato non valido. Servono 3 linee di dati', 'error');
                return;
            }

            // Parsing
            const nomeEvento = lines[0];
            const partsLinea2 = lines[1].split('¬∑').map(part => part.trim());
            const partsLinea3 = lines[2].split('¬∑').map(part => part.trim());
            
            if (partsLinea2.length < 3 || partsLinea3.length < 3) {
                showNotification('Formato non valido', 'error');
                return;
            }
            
            const dataCompleta = partsLinea3[1] + ' ' + partsLinea3[2];
            const dataOra = parseDate(dataCompleta);
            
            if (!dataOra) {
                showNotification('Data non valida', 'error');
                return;
            }

            const dataFormattata = dataOra.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Salva in variabile globale
            eventoCorrente2 = {
                nome: nomeEvento,
                sport: partsLinea2[0],
                nazione: partsLinea2[1],
                lega: partsLinea2[2],
                dataOra: dataOra.toISOString(),
                dataFormattata: dataFormattata,
                timestamp: new Date().toISOString(),
                quotes: null,
                aiqData: null
            };

            // Mostra dettagli
            mostraDettagliEvento2(eventoCorrente2);
            showNotification('Evento parsato con successo (Tennis)', 'success');
        }

        function clearEvento2() {
            document.getElementById('inputEvento2').value = '';
            eventoCorrente2 = null;
            mostraDettagliEvento2(null);
            showNotification('Evento pulito (Tennis)', 'info');
        }

        function salvaEventoConQuotes2() {
            if (!eventoCorrente2) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData2.length === 0) {
                showNotification('Prima parsare quotes 2 esiti', 'error');
                return;
            }

            // Crea una COPIA dell'evento corrente per non modificare l'originale
            const eventoDaSalvare = {
                ...eventoCorrente2,
                id: generaIdEvento(), // GENERA NUOVO ID UNIVOCO
                quotes: [...parsedData2], // Copia i dati
                tipoQuotes: '2_esiti',
                aiqData: {
                    timestamp: new Date().toISOString(),
                    stats: calculateStatistics2(),
                    soglieUsate: {
                        sm: soglieAIQ.sm,
                        mm: soglieAIQ.mm,
                        ss: soglieAIQ.ss,
                        near: soglieAIQ.near,
                        timestamp: new Date().toISOString()
                    }
}
            };
            
            // Salva nel database
            databaseEventi.push(eventoDaSalvare);
            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));

            // AGGIORNA IMMEDIATAMENTE la tab Eventi se √® visibile
            const tabEventiVisibile = document.getElementById('tab-eventi').classList.contains('active');
            if (tabEventiVisibile) {
                // Aggiorna eventi filtrati e mostra tabella
                eventiFiltrati = [...databaseEventi];
                paginaCorrente = 1; // Torna alla prima pagina per mostrare il nuovo evento
                mostraTabellaEventi();
                calcolaStatisticheDatabase();
                aggiornaFiltriSport();
            }
            calcolaStatisticheDatabase();
            
            // Aggiorna tutto
            refreshDatabaseEventi();
            
            // MOSTRA SEMPRE la tabella eventi
            mostraTabellaEventi();
            
            showNotification(`‚úÖ Evento ${eventoDaSalvare.sport} salvato! ID: ${eventoDaSalvare.id.slice(0, 8)}...`, 'success');
            
            // Resetta evento corrente MA NON l'input
            eventoCorrente2 = null;
            document.getElementById('inputEvento2').value = '';
            mostraDettagliEvento2(null);
        }

        // Mostra dettagli evento per 3 esiti
        function mostraDettagliEvento3(evento) {
            const container = document.getElementById('eventoDetails3');
            mostraDettagliEventoGenerico(container, evento, '3_esiti');
        }

        // Mostra dettagli evento per 2 esiti
        function mostraDettagliEvento2(evento) {
            const container = document.getElementById('eventoDetails2');
            mostraDettagliEventoGenerico(container, evento, '2_esiti');
        }

        // Funzione generica per mostrare dettagli
        function mostraDettagliEventoGenerico(container, evento, tipo) {
            if (!evento) {
                container.innerHTML = `
                    <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                        Nessun evento caricato
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3>${evento.nome}</h3>
                <div class="evento-info-grid">
                    <div class="evento-info-item">
                        <span class="evento-info-label">Sport:</span>
                        <span class="evento-info-value">${evento.sport}</span>
                    </div>
                    <div class="evento-info-item">
                        <span class="evento-info-label">Nazione:</span>
                        <span class="evento-info-value">${evento.nazione}</span>
                    </div>
                    <div class="evento-info-item">
                        <span class="evento-info-label">Lega:</span>
                        <span class="evento-info-value">${evento.lega}</span>
                    </div>
                    <div class="evento-info-item">
                        <span class="evento-info-label">Data:</span>
                        <span class="evento-info-value">${evento.dataFormattata}</span>
                    </div>
                </div>
                ${evento.quotes ? `
                <div style="margin-top: 15px; padding: 10px; background: #dcfce7; border-radius: 4px; font-size: 13px;">
                    <strong>‚úÖ Quotes associate</strong><br>
                    <small>Tipo: ${evento.tipoQuotes || 'N/D'} | Count: ${evento.quotes.length}</small>
                </div>` : `
                <div style="margin-top: 15px; padding: 10px; background: #fef9c3; border-radius: 4px; font-size: 13px;">
                    <strong>‚ö† Nessuna quote associata</strong><br>
                    <small>Clicca "Carica Quotes" per aggiungerle</small>
                </div>`}
                ${evento.aiqData ? `
                <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 4px; font-size: 13px;">
                    <strong>üìä Dati AIQ salvati</strong><br>
                    <small>${new Date(evento.aiqData.timestamp).toLocaleString()}</small>
                </div>` : ''}
            `;
        }

        // Carica quotes nell'evento per 3 esiti
        function caricaQuotesInEvento3() {
            if (!eventoCorrente3) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData3.length === 0) {
                showNotification('Prima parsare quotes 3 esiti', 'error');
                return;
            }

            // Crea una COPIA per non sovrascrivere l'originale
            eventoCorrente3 = {
                ...eventoCorrente3,
                quotes: [...parsedData3],
                tipoQuotes: '3_esiti',
                aiqData: {
                    timestamp: new Date().toISOString(),
                    stats: calculateStatistics3(),
                    soglieUsate: {
                        sm: soglieAIQ.sm,
                        mm: soglieAIQ.mm,
                        ss: soglieAIQ.ss,
                        near: soglieAIQ.near,
                        timestamp: new Date().toISOString()
                    }
                }
            };
            
            mostraDettagliEvento3(eventoCorrente3);
            showNotification('‚úÖ Quote 3 esiti caricate nell\'evento', 'success');
        }

        // Carica quotes nell'evento per 2 esiti
        function caricaQuotesInEvento2() {
            if (!eventoCorrente2) {
                showNotification('Prima parsare un evento', 'error');
                return;
            }

            if (parsedData2.length === 0) {
                showNotification('Prima parsare quotes 2 esiti', 'error');
                return;
            }

            // Crea una COPIA per non sovrascrivere l'originale
            eventoCorrente2 = {
                ...eventoCorrente2,
                quotes: [...parsedData2],
                tipoQuotes: '2_esiti',
                aiqData: {
                    timestamp: new Date().toISOString(),
                    stats: calculateStatistics2(),
                    soglieUsate: {
                        sm: soglieAIQ.sm,
                        mm: soglieAIQ.mm,
                        ss: soglieAIQ.ss,
                        near: soglieAIQ.near,
                        timestamp: new Date().toISOString()
                    }
                }
            };
            
            mostraDettagliEvento2(eventoCorrente2);
            showNotification('‚úÖ Quote 2 esiti caricate nell\'evento', 'success');
        }

        // Funzioni esporta evento
        function esportaEventoJSON3() {
            if (!eventoCorrente3) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            const exportData = {
                evento: eventoCorrente3,
                timestamp: new Date().toISOString(),
                versione: '1.0'
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const nomeFile = `evento_${eventoCorrente3.nome.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_calcio.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Evento calcio esportato', 'success');
        }

        function esportaEventoJSON2() {
            if (!eventoCorrente2) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            const exportData = {
                evento: eventoCorrente2,
                timestamp: new Date().toISOString(),
                versione: '1.0'
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const nomeFile = `evento_${eventoCorrente2.nome.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_tennis.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Evento tennis esportato', 'success');
        }
        // ==============================
        // FUNZIONI COMUNI
        // ==============================
        function formatBookmakerName(name) {
            if (!name) return '-';
            const cleanName = name.replace(/\.[a-z]+$/, '');
            return cleanName.charAt(0).toUpperCase() + cleanName.slice(1);
        }

        // ==============================
        // FUNZIONI ORDINAMENTO 3 ESITI
        // ==============================
        function sortTable3(column) {
            const header = document.querySelector(`#tab-3esiti th[onclick="sortTable3('${column}')"]`);
            
            if (currentSort3.column === column) {
                currentSort3.direction = currentSort3.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort3.column = column;
                currentSort3.direction = 'asc';
            }
            
            document.querySelectorAll('#tab-3esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
            
            header.classList.add(currentSort3.direction);
            header.setAttribute('data-sort', currentSort3.direction);
            
            sortData3(column, currentSort3.direction);
            displayResults3();
        }

        function sortData3(column, direction) {
            if (parsedData3.length === 0) return;
            
            parsedData3.sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'bookmaker':
                        valueA = a.bookmaker.toLowerCase();
                        valueB = b.bookmaker.toLowerCase();
                        break;
                    case 'quote1':
                        valueA = a.quote1;
                        valueB = b.quote1;
                        break;
                    case 'quoteX':
                        valueA = a.quoteX;
                        valueB = b.quoteX;
                        break;
                    case 'quote2':
                        valueA = a.quote2;
                        valueB = b.quote2;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    if (valueA < valueB) return -1;
                    if (valueA > valueB) return 1;
                    return 0;
                } else {
                    if (valueA > valueB) return -1;
                    if (valueA < valueB) return 1;
                    return 0;
                }
            });
        }

        function resetSort3() {
            currentSort3.column = null;
            currentSort3.direction = 'asc';
            document.querySelectorAll('#tab-3esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
        }

        // ==============================
        // FUNZIONI ORDINAMENTO 2 ESITI
        // ==============================
        function sortTable2(column) {
            const header = document.querySelector(`#tab-2esiti th[onclick="sortTable2('${column}')"]`);
            
            if (currentSort2.column === column) {
                currentSort2.direction = currentSort2.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort2.column = column;
                currentSort2.direction = 'asc';
            }
            
            document.querySelectorAll('#tab-2esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
            
            header.classList.add(currentSort2.direction);
            header.setAttribute('data-sort', currentSort2.direction);
            
            sortData2(column, currentSort2.direction);
            displayResults2();
        }

        function sortData2(column, direction) {
            if (parsedData2.length === 0) return;
            
            parsedData2.sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'bookmaker':
                        valueA = a.bookmaker.toLowerCase();
                        valueB = b.bookmaker.toLowerCase();
                        break;
                    case 'quoteYes':
                        valueA = a.quoteYes;
                        valueB = b.quoteYes;
                        break;
                    case 'quoteNo':
                        valueA = a.quoteNo;
                        valueB = b.quoteNo;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    if (valueA < valueB) return -1;
                    if (valueA > valueB) return 1;
                    return 0;
                } else {
                    if (valueA > valueB) return -1;
                    if (valueA < valueB) return 1;
                    return 0;
                }
            });
        }

        function resetSort2() {
            currentSort2.column = null;
            currentSort2.direction = 'asc';
            document.querySelectorAll('#tab-2esiti .sortable-header').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.setAttribute('data-sort', 'none');
            });
        }

        // ==============================
        // FUNZIONE ORDINAMENTO EVENTI
        // ==============================
        function ordinaEventi(campo) {
            console.log(`Ordinamento eventi per: ${campo}`);
            
            // Se gi√† ordinati per questo campo, inverte la direzione
            if (ordinamentoEventi.campo === campo) {
                ordinamentoEventi.direzione = ordinamentoEventi.direzione === 'asc' ? 'desc' : 'asc';
            } else {
                // Nuovo campo, ordine ascendente di default
                ordinamentoEventi.campo = campo;
                ordinamentoEventi.direzione = 'asc';
            }
            
            // Aggiorna indicatori visivi
            aggiornaIndicatoriOrdinamentoEventi(campo, ordinamentoEventi.direzione);
            
            // Ordina gli eventi filtrati
            ordinaEventiFiltrati();
            
            // Riparti dalla prima pagina
            paginaCorrente = 1;
            
            // Mostra tabella ordinata
            mostraTabellaEventi();
            
            // Notifica
            showNotification(`Eventi ordinati per ${getNomeCampoOrdinamento(campo)} (${ordinamentoEventi.direzione === 'asc' ? 'crescente' : 'decrescente'})`, 'info');
        }

        function getNomeCampoOrdinamento(campo) {
            const mappaNomi = {
                'nome': 'Nome evento',
                'sport': 'Sport',
                'lega': 'Lega',
                'data': 'Data',
                'forzaValue': 'Forza Value',
                'bookCount': 'Numero bookmaker'
            };
            return mappaNomi[campo] || campo;
        }

        function aggiornaIndicatoriOrdinamentoEventi(campoAttivo, direzione) {
            // Rimuovi tutti gli indicatori
            document.querySelectorAll('#tab-eventi .sortable-header-eventi').forEach(header => {
                header.classList.remove('asc', 'desc');
                header.setAttribute('data-sort', 'none');
            });
            
            // Aggiungi indicatori all'header attivo
            const headerAttivo = document.querySelector(`#tab-eventi .sortable-header-eventi[onclick*="${campoAttivo}"]`);
            if (headerAttivo) {
                headerAttivo.classList.add(direzione);
                headerAttivo.setAttribute('data-sort', direzione);
            }
        }

        function ordinaEventiFiltrati() {
            if (eventiFiltrati.length === 0) return;
            
            eventiFiltrati.sort((a, b) => {
                let valoreA, valoreB;
                
                switch (ordinamentoEventi.campo) {
                    case 'nome':
                        valoreA = a.nome.toLowerCase();
                        valoreB = b.nome.toLowerCase();
                        break;
                        
                    case 'sport':
                        valoreA = a.sport.toLowerCase();
                        valoreB = b.sport.toLowerCase();
                        break;
                        
                    case 'lega':
                        valoreA = a.lega.toLowerCase();
                        valoreB = b.lega.toLowerCase();
                        break;
                        
                    case 'data':
                        valoreA = new Date(a.dataOra).getTime();
                        valoreB = new Date(b.dataOra).getTime();
                        break;
                        
                    case 'forzaValue':
                        const statsA = a.aiqData ? a.aiqData.stats : null;
                        const statsB = b.aiqData ? b.aiqData.stats : null;
                        const risultatoA = verificaValueBetAIQ(statsA, a.tipoQuotes);
                        const risultatoB = verificaValueBetAIQ(statsB, b.tipoQuotes);
                        valoreA = risultatoA.forzaValue;
                        valoreB = risultatoB.forzaValue;
                        break;
                        
                    case 'bookCount':
                        valoreA = a.quotes ? a.quotes.length : 0;
                        valoreB = b.quotes ? b.quotes.length : 0;
                        break;
                        
                    default:
                        return 0;
                }
                
                // Gestione valori null/undefined
                if (valoreA == null) valoreA = 0;
                if (valoreB == null) valoreB = 0;
                
                // Ordine ascendente o discendente
                if (ordinamentoEventi.direzione === 'asc') {
                    if (valoreA < valoreB) return -1;
                    if (valoreA > valoreB) return 1;
                    return 0;
                } else {
                    if (valoreA > valoreB) return -1;
                    if (valoreA < valoreB) return 1;
                    return 0;
                }
            });
        }

        // ==============================
        // FUNZIONI ESPORTAZIONE
        // ==============================
        function exportToCSV3() {
            if (parsedData3.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics3();
            
            let csvContent = "BOOKMAKER 3 ESITI\n";
            csvContent += `Esportato il: ${new Date().toLocaleString()}\n`;
            csvContent += `Bookmaker totali: ${parsedData3.length}\n`;
            csvContent += `Bookmaker Sharp trovati: ${stats.sharpCount}\n\n`;
            
            csvContent += "DETTAGLIO BOOKMAKER\n";
            csvContent += "Bookmaker,Quote 1,Quote X,Quote 2,Sharp\n";
            
            parsedData3.forEach(item => {
                csvContent += `${formatBookmakerName(item.bookmaker)},${item.quote1},${item.quoteX},${item.quote2},${item.isSharp ? 'SI' : 'NO'}\n`;
            });
            
            csvContent += "\n\nSTATISTICHE\n";
            csvContent += "Statistica,Quote 1,Quote X,Quote 2\n";
            csvContent += `Media,${stats.avg1.toFixed(2)},${stats.avgX.toFixed(2)},${stats.avg2.toFixed(2)}\n`;
            csvContent += `Minima,${stats.min1.toFixed(2)},${stats.minX.toFixed(2)},${stats.min2.toFixed(2)}\n`;
            csvContent += `Massima,${stats.max1.toFixed(2)},${stats.maxX.toFixed(2)},${stats.max2.toFixed(2)}\n`;
            
            csvContent += `Pinnacle,${stats.pinnacle1 !== null ? stats.pinnacle1.toFixed(2) : '-'},${stats.pinnacleX !== null ? stats.pinnacleX.toFixed(2) : '-'},${stats.pinnacle2 !== null ? stats.pinnacle2.toFixed(2) : '-'}\n`;
            csvContent += `Betfair,${stats.betfair1 !== null ? stats.betfair1.toFixed(2) : '-'},${stats.betfairX !== null ? stats.betfairX.toFixed(2) : '-'},${stats.betfair2 !== null ? stats.betfair2.toFixed(2) : '-'}\n`;

            downloadFile(csvContent, 'bookmaker_3esiti.csv', 'text/csv');
            showNotification('CSV 3 esiti esportato', 'success');
        }

        function exportToJSON3() {
            if (parsedData3.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics3();
            const exportData = {
                bookmakers: parsedData3,
                statistics: {
                    total: parsedData3.length,
                    sharpCount: stats.sharpCount,
                    percentageSharp: parsedData3.length > 0 ? (stats.sharpCount / parsedData3.length) * 100 : 0,
                    quotes1: {
                        average: stats.avg1,
                        minimum: stats.min1,
                        maximum: stats.max1,
                        pinnacle: stats.pinnacle1,
                        betfair: stats.betfair1
                    },
                    quotesX: {
                        average: stats.avgX,
                        minimum: stats.minX,
                        maximum: stats.maxX,
                        pinnacle: stats.pinnacleX,
                        betfair: stats.betfairX
                    },
                    quotes2: {
                        average: stats.avg2,
                        minimum: stats.min2,
                        maximum: stats.max2,
                        pinnacle: stats.pinnacle2,
                        betfair: stats.betfair2
                    }
                },
                timestamp: new Date().toISOString()
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'bookmaker_3esiti.json', 'application/json');
            showNotification('JSON 3 esiti esportato', 'success');
        }

        function exportToTXT3() {
            if (parsedData3.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            let txtContent = `Bookmaker 3 Esiti - ${new Date().toLocaleString()}\n`;
            txtContent += '='.repeat(40) + '\n\n';
            txtContent += `Bookmaker totali: ${parsedData3.length}\n\n`;
            
            parsedData3.forEach(item => {
                txtContent += `${formatBookmakerName(item.bookmaker).padEnd(20)} ${item.quote1.toFixed(2).padStart(6)} ${item.quoteX.toFixed(2).padStart(6)} ${item.quote2.toFixed(2).padStart(6)} ${item.isSharp ? '‚ö°' : ''}\n`;
            });

            downloadFile(txtContent, 'bookmaker_3esiti.txt', 'text/plain');
            showNotification('TXT 3 esiti esportato', 'success');
        }

        function exportToCSV2() {
            if (parsedData2.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics2();
            
            let csvContent = "BOOKMAKER 2 ESITI\n";
            csvContent += `Esportato il: ${new Date().toLocaleString()}\n`;
            csvContent += `Bookmaker totali: ${parsedData2.length}\n\n`;
            
            csvContent += "DETTAGLIO BOOKMAKER\n";
            csvContent += "Bookmaker,Quote S√¨,Quote No,Sharp\n";
            
            parsedData2.forEach(item => {
                csvContent += `${formatBookmakerName(item.bookmaker)},${item.quoteYes},${item.quoteNo},${item.isSharp ? 'SI' : 'NO'}\n`;
            });
            
            csvContent += "\n\nSTATISTICHE\n";
            csvContent += "Statistica,Quote S√¨,Quote No\n";
            csvContent += `Media,${stats.avgYes.toFixed(2)},${stats.avgNo.toFixed(2)}\n`;
            csvContent += `Minima,${stats.minYes.toFixed(2)},${stats.minNo.toFixed(2)}\n`;
            csvContent += `Massima,${stats.maxYes.toFixed(2)},${stats.maxNo.toFixed(2)}\n`;
            
            csvContent += `Pinnacle,${stats.pinnacleYes !== null ? stats.pinnacleYes.toFixed(2) : '-'},${stats.pinnacleNo !== null ? stats.pinnacleNo.toFixed(2) : '-'}\n`;
            csvContent += `Betfair,${stats.betfairYes !== null ? stats.betfairYes.toFixed(2) : '-'},${stats.betfairNo !== null ? stats.betfairNo.toFixed(2) : '-'}\n`;

            downloadFile(csvContent, 'bookmaker_2esiti.csv', 'text/csv');
            showNotification('CSV 2 esiti esportato', 'success');
        }

        function exportToJSON2() {
            if (parsedData2.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const stats = calculateStatistics2();
            const exportData = {
                bookmakers: parsedData2,
                statistics: {
                    total: parsedData2.length,
                    sharpCount: stats.sharpCount,
                    percentageSharp: parsedData2.length > 0 ? (stats.sharpCount / parsedData2.length) * 100 : 0,
                    quotesYes: {
                        average: stats.avgYes,
                        minimum: stats.minYes,
                        maximum: stats.maxYes,
                        pinnacle: stats.pinnacleYes,
                        betfair: stats.betfairYes
                    },
                    quotesNo: {
                        average: stats.avgNo,
                        minimum: stats.minNo,
                        maximum: stats.maxNo,
                        pinnacle: stats.pinnacleNo,
                        betfair: stats.betfairNo
                    }
                },
                timestamp: new Date().toISOString()
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'bookmaker_2esiti.json', 'application/json');
            showNotification('JSON 2 esiti esportato', 'success');
        }

        function exportToTXT2() {
            if (parsedData2.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            let txtContent = `Bookmaker 2 Esiti - ${new Date().toLocaleString()}\n`;
            txtContent += '='.repeat(40) + '\n\n';
            txtContent += `Bookmaker totali: ${parsedData2.length}\n\n`;
            
            parsedData2.forEach(item => {
                txtContent += `${formatBookmakerName(item.bookmaker).padEnd(20)} ${item.quoteYes.toFixed(2).padStart(6)} ${item.quoteNo.toFixed(2).padStart(6)} ${item.isSharp ? '‚ö°' : ''}\n`;
            });

            downloadFile(txtContent, 'bookmaker_2esiti.txt', 'text/plain');
            showNotification('TXT 2 esiti esportato', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#dc2626' : 
                                        type === 'success' ? '#059669' : '#1a1a1a';
            notification.classList.add('show');
            
            // Cancella timer precedente se esiste
            if (notification.timeoutId) {
                clearTimeout(notification.timeoutId);
            }
            
            // Imposta nuovo timer
            notification.timeoutId = setTimeout(() => {
                notification.classList.remove('show');
                notification.timeoutId = null;
            }, duration);
        }

        // ==============================
        // FUNZIONI GESTIONE EVENTI
        // ==============================
        function parseDate(dateString) {
            // Supporta formati: "13 Jan, 2026 18:30" o "13 Jan 2026 18:30"
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            // Prova formato alternativo
            const parts = dateString.split(' ');
            if (parts.length >= 3) {
                const day = parts[0];
                const month = getMonthNumber(parts[1].replace(',', ''));
                const year = parts[2];
                const time = parts[3] || '00:00';
                
                if (month && day && year) {
                    return new Date(`${year}-${month}-${day.padStart(2, '0')}T${time}`);
                }
            }
            
            return null;
        }

        function getMonthNumber(monthStr) {
            const months = {
                'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
                'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
                'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
            };
            return months[monthStr.toLowerCase()];
        }

        // ==============================
        // FUNZIONI DATABASE EVENTI
        // ==============================
        function mostraTabellaEventi(eventiDaMostrare = null) {
            console.log("mostraTabellaEventi chiamata, pagina:", paginaCorrente);
            
            const container = document.getElementById('tabellaEventi');
            const emptyState = document.getElementById('emptyEventi');
            
            // Determina quali eventi mostrare
            if (eventiDaMostrare) {
                eventiFiltrati = eventiDaMostrare;
            } else if (eventiFiltrati.length === 0) {
                // Prima volta: mostra tutti gli eventi
                eventiFiltrati = [...databaseEventi];
            }
            
            // Applica ordinamento agli eventi filtrati
            ordinaEventiFiltrati();

            if (eventiFiltrati.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('paginazioneContainer').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            
            // Calcola paginazione
            const totalePagine = Math.ceil(eventiFiltrati.length / eventiPerPagina);
            if (paginaCorrente > totalePagine) {
                paginaCorrente = totalePagine || 1;
            }
            
            const inizio = (paginaCorrente - 1) * eventiPerPagina;
            const fine = inizio + eventiPerPagina;
            const eventiPagina = eventiFiltrati.slice(inizio, fine);
            
            // Genera HTML per questa pagina
            container.innerHTML = eventiPagina.map((evento, index) => {
                const numero = inizio + index + 1;
                const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                
                return `
                    <tr data-event-id="${evento.id || ''}">
                        <td style="text-align: center; color: #666; width: 40px;">${numero}</td>
                        <td>
                            <strong>${evento.nome}</strong><br>
                            <small style="color: #666; font-size: 11px;">ID: ${evento.id ? evento.id.substring(0, 8) : 'N/D'}</small>
                        </td>
                        <td>${evento.sport}</td>
                        <td>
                            ${evento.lega}<br>
                            <small style="color: #666; font-size: 11px;">
                                ${evento.tipoQuotes || 'N/D'}
                            </small>
                        </td>
                        <td>${evento.dataFormattata}</td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <!-- Risultato AIQ -->
                                ${risultatoAIQ.hasValue ? 
                                    `<span style="background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; width: 100%; text-align: center;">
                                        VALUE ${risultatoAIQ.outcome}
                                        <small style="opacity: 0.8; margin-left: 3px;">${risultatoAIQ.forzaValue.toFixed(1)}%</small>
                                    </span>` : 
                                    `<span style="background: #fef9c3; color: #854d0e; padding: 3px 8px; border-radius: 12px; font-size: 11px; width: 100%; text-align: center;">
                                        NO VALUE
                                    </span>`
                                }
                                
                            <!-- Soglie AIQ usate -->
                            <div style="font-size: 9px; color: #666; background: #f8f9fa; padding: 2px 5px; border-radius: 4px; margin-top: 2px; width: 100%; text-align: center;"
                                class="soglie-aiq-badge"
                                id="soglie-badge-${evento.id || index}">
                                ${evento.aiqData && evento.aiqData.soglieUsate ? 
                                    `Soglie: ${evento.aiqData.soglieUsate.sm}-${evento.aiqData.soglieUsate.mm}-${evento.aiqData.soglieUsate.ss}%` : 
                                    'Default: 5-8-7%'
                                }
                            </div>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            ${evento.quotes ? 
                                `<span style="background: #dbeafe; color: #1d4ed8; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                    ${evento.quotes.length} book
                                </span>` : 
                                `<span style="background: #f1f5f9; color: #64748b; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                    0 book
                                </span>`
                            }
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button onclick="mostraDettagliEventoModal('${evento.id || ''}')" 
                                        style="background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    üëÅÔ∏è
                                </button>
                                <button onclick="eliminaEvento('${evento.id || ''}')" 
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Aggiorna la paginazione
            aggiornaPaginazione(eventiFiltrati.length, totalePagine);
            
            // Aggiorna statistiche
            calcolaStatisticheDatabase();

            // Evidenzia soglie personalizzate
            setTimeout(() => {
                eventiPagina.forEach((evento, index) => {
                    const badge = document.getElementById(`soglie-badge-${evento.id || index}`);
                    if (badge && evento.aiqData && evento.aiqData.soglieUsate) {
                        evidenziaSogliePersonalizzate(badge, evento.aiqData.soglieUsate);
                    }
                });
            }, 100);
        }
                   
        function aggiornaPaginazione(totaleEventi, totalePagine) {
        const container = document.getElementById('paginazioneContainer');
        
        if (totalePagine <= 1) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        // Info pagina
        const da = (paginaCorrente - 1) * eventiPerPagina + 1;
        const a = Math.min(paginaCorrente * eventiPerPagina, totaleEventi);
        
        document.getElementById('infoPaginazione').innerHTML = `
            Pagina <strong>${paginaCorrente}</strong> di <strong>${totalePagine}</strong> 
            | Eventi <strong>${da}-${a}</strong> di <strong>${totaleEventi}</strong>
        `;
        
        // Bottoni precedente/successiva
        document.getElementById('btnPrec').disabled = paginaCorrente === 1;
        document.getElementById('btnSucc').disabled = paginaCorrente === totalePagine;
        
        // Stile bottoni disabilitati
        if (paginaCorrente === 1) {
            document.getElementById('btnPrec').style.opacity = '0.5';
            document.getElementById('btnPrec').style.cursor = 'not-allowed';
        } else {
            document.getElementById('btnPrec').style.opacity = '1';
            document.getElementById('btnPrec').style.cursor = 'pointer';
        }
        
        if (paginaCorrente === totalePagine) {
            document.getElementById('btnSucc').style.opacity = '0.5';
            document.getElementById('btnSucc').style.cursor = 'not-allowed';
        } else {
            document.getElementById('btnSucc').style.opacity = '1';
            document.getElementById('btnSucc').style.cursor = 'pointer';
        }
        
        // Numeri pagina (solo 5 numeri)
        const pagineContainer = document.getElementById('numeriPagine');
        pagineContainer.innerHTML = '';
        
        let start = Math.max(1, paginaCorrente - 2);
        let end = Math.min(totalePagine, start + 4);
        
        // Aggiusta se siamo vicini all'inizio
        if (end - start < 4) {
            start = Math.max(1, end - 4);
        }
        
        for (let i = start; i <= end; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.style.margin = '0 2px';
            btn.style.padding = '6px 10px';
            btn.style.minWidth = '36px';
            btn.style.border = '1px solid #d1d5db';
            btn.style.borderRadius = '4px';
            btn.style.cursor = 'pointer';
            btn.style.fontSize = '13px';
            
            if (i === paginaCorrente) {
                // Pagina corrente
                btn.style.background = '#2563eb';
                btn.style.color = 'white';
                btn.style.borderColor = '#2563eb';
                btn.style.fontWeight = 'bold';
            } else {
                // Altre pagine
                btn.style.background = '#f3f4f6';
                btn.style.color = '#374151';
                btn.onmouseover = function() {
                    this.style.background = '#e5e7eb';
                };
                btn.onmouseout = function() {
                    this.style.background = '#f3f4f6';
                };
            }
            
            btn.onclick = function() {
                vaiAPagina(i);
            };
            
            pagineContainer.appendChild(btn);
        }
        }

            function paginaPrecedente() {
            if (paginaCorrente > 1) {
                paginaCorrente--;
                mostraTabellaEventi();
                scrollaInAlto();
            }
        }

        function paginaSuccessiva() {
            const totalePagine = Math.ceil(eventiFiltrati.length / eventiPerPagina);
            if (paginaCorrente < totalePagine) {
                paginaCorrente++;
                mostraTabellaEventi();
                scrollaInAlto();
            }
        }

        function vaiAPagina(numero) {
            const totalePagine = Math.ceil(eventiFiltrati.length / eventiPerPagina);
            if (numero >= 1 && numero <= totalePagine) {
                paginaCorrente = numero;
                mostraTabellaEventi();
                scrollaInAlto();
            }
        }

        function scrollaInAlto() {
            const tabella = document.getElementById('tabellaEventi');
            if (tabella) {
                tabella.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function cambiaEventiPerPagina(valore) {
            eventiPerPagina = parseInt(valore);
            paginaCorrente = 1; // Torna alla prima pagina
            mostraTabellaEventi();
            showNotification(`Mostrati ${eventiPerPagina} eventi per pagina`, 'info');
        }

        function aggiornaFiltriSport() {
            const sportUnici = [...new Set(databaseEventi.map(e => e.sport))].sort();
            const filtroSport = document.getElementById('filtroSport');
            const opzioniEsistenti = Array.from(filtroSport.options).map(o => o.value);
            
            // Salva selezione corrente
            const selezioneCorrente = filtroSport.value;
            
            // Pulisci e ricrea (mantenendo "Tutti gli sport")
            filtroSport.innerHTML = '<option value="">Tutti gli sport</option>';
            
            // Aggiungi solo sport nuovi
            sportUnici.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport;
                option.textContent = sport;
                filtroSport.appendChild(option);
            });
            
            // Ripristina selezione se esiste ancora
            if (sportUnici.includes(selezioneCorrente)) {
                filtroSport.value = selezioneCorrente;
            }
        }

        function filtraEventi() {
            const searchTerm = document.getElementById('cercaEvento').value.toLowerCase();
            const filtroSport = document.getElementById('filtroSport').value;
            const filtroSoloValue = document.getElementById('filtroSoloValue').checked;
            const filtroEsitoValue = document.getElementById('filtroEsitoValue').value;
            const filtroForzaValue = parseFloat(document.getElementById('filtroForzaValue').value);
            
            let filtrati = databaseEventi;
            
            // Filtro ricerca testo
            if (searchTerm) {
                filtrati = filtrati.filter(e => 
                    e.nome.toLowerCase().includes(searchTerm) || 
                    e.lega.toLowerCase().includes(searchTerm) ||
                    (e.id && e.id.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtro sport
            if (filtroSport) {
                filtrati = filtrati.filter(e => e.sport === filtroSport);
            }
            
            // Filtro AIQ avanzati
            if (filtroSoloValue || filtroEsitoValue || filtroForzaValue > 0) {
                filtrati = filtrati.filter(evento => {
                    const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                    const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                    
                    if (filtroSoloValue && !risultatoAIQ.hasValue) {
                        return false;
                    }
                    
                    if (filtroEsitoValue && risultatoAIQ.outcome !== filtroEsitoValue) {
                        return false;
                    }
                    
                    if (filtroForzaValue > 0 && risultatoAIQ.forzaValue < filtroForzaValue) {
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // *** MODIFICA PER PAGINAZIONE ***
            paginaCorrente = 1; // Torna alla prima pagina
            eventiFiltrati = filtrati; // Salva gli eventi filtrati
            ordinaEventiFiltrati(); // Applica ordinamento
            mostraTabellaEventi(eventiFiltrati); // Mostra con ordinamento
            
            // Notifica
            showNotification(`Trovati ${filtrati.length} eventi`, 'info', 2000);
        }

        function resetFiltri() {
            // Reset tutti i campi filtro
            document.getElementById('cercaEvento').value = '';
            document.getElementById('filtroSport').value = '';
            document.getElementById('filtroSoloValue').checked = false;
            document.getElementById('filtroEsitoValue').value = '';
            document.getElementById('filtroForzaValue').value = '0';
            
            // Mostra tutti gli eventi
            eventiFiltrati = [...databaseEventi];
            ordinaEventiFiltrati();
            paginaCorrente = 1;
            mostraTabellaEventi();
            showNotification('Filtri resettati', 'info');
        }

        // ==============================
        // FUNZIONI ESPORTAZIONE EVENTI
        // ==============================
        function esportaEventiCSV() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            let csvContent = "ID;Evento;Sport;Nazione;Lega;Data;Tipo Quotes;Quotes Count;Data Creazione\n";
            
            databaseEventi.forEach(evento => {
                csvContent += `${evento.id || 'N/D'};"${evento.nome}";${evento.sport};${evento.nazione};${evento.lega};${evento.dataFormattata};${evento.tipoQuotes || 'N/D'};${evento.quotes ? evento.quotes.length : 0};${new Date(evento.timestamp).toLocaleString()}\n`;
            });

            downloadFile(csvContent, 'backtest_eventi.csv', 'text/csv');
            showNotification('CSV backtest esportato', 'success');
        }

        function esportaEventiJSONCompleto() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            const exportData = {
                databaseEventi: databaseEventi,
                statistiche: {
                    totale: databaseEventi.length
                },
                timestamp: new Date().toISOString(),
                versione: '1.0'
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'database_backtest_completo.json', 'application/json');
            showNotification('Database completo esportato', 'success');
        }

        function esportaBacktestTXT() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento da esportare', 'error');
                return;
            }

            let txtContent = `DATABASE EVENTI - ${new Date().toLocaleString()}\n`;
            txtContent += '='.repeat(60) + '\n\n';
            
            txtContent += `STATISTICHE:\n`;
            txtContent += `- Eventi totali: ${databaseEventi.length}\n\n`;
            
            txtContent += `DETTAGLIO EVENTI:\n`;
            txtContent += '='.repeat(60) + '\n\n';
            
            databaseEventi.forEach((evento, index) => {
                txtContent += `${index + 1}. ${evento.nome}\n`;
                txtContent += `   Sport: ${evento.sport} | Lega: ${evento.lega} | Data: ${evento.dataFormattata}\n`;
                txtContent += `   Quotes: ${evento.quotes ? evento.quotes.length : 0} | Tipo: ${evento.tipoQuotes || 'N/D'}\n`;
                txtContent += `   ID: ${evento.id || 'N/D'}\n\n`;
            });

            downloadFile(txtContent, 'database_eventi.txt', 'text/plain');
            showNotification('Report eventi esportato', 'success');
        }

        function backupDatabase() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun dato da esportare', 'error');
                return;
            }

            const backupData = {
                databaseEventi: databaseEventi,
                timestamp: new Date().toISOString(),
                totaleEventi: databaseEventi.length,
                descrizione: 'Backup database eventi backtest'
            };

            const jsonContent = JSON.stringify(backupData, null, 2);
            const nomeFile = `backup_eventi_${new Date().toISOString().slice(0, 10)}.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('Backup eseguito', 'success');
        }

        function clearDatabase() {
            if (confirm('Sei sicuro di voler cancellare TUTTI gli eventi? Questa azione √® irreversibile.')) {
                databaseEventi = [];
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                
                mostraTabellaEventi();
                showNotification('Database cancellato', 'success');
                
                // Aggiorna anche i contatori nelle altre tab
                document.getElementById('totalEventi3').textContent = '0';
                document.getElementById('eventiAnalizzati3').textContent = '0';
                document.getElementById('totalEventi2').textContent = '0';
                document.getElementById('eventiAnalizzati2').textContent = '0';
            }
        }

        // ==============================
        // FUNZIONE PER ELIMINARE EVENTI FILTRATI
        // ==============================
        function eliminaEventiFiltrati() {
            // Ottieni gli eventi attualmente filtrati/visualizzati
            const rows = document.querySelectorAll('#tabellaEventi tr[data-event-id]');
            
            if (rows.length === 0) {
                showNotification('Nessun evento da eliminare', 'info');
                return;
            }
            
            // Raccogli gli ID degli eventi visualizzati
            const eventiDaEliminare = [];
            rows.forEach(row => {
                const eventId = row.getAttribute('data-event-id');
                const evento = databaseEventi.find(e => e.id === eventId);
                if (evento) {
                    eventiDaEliminare.push(evento);
                }
            });
            
            if (eventiDaEliminare.length === 0) return;
            
            // Conferma
            const confermaMessaggio = eventiDaEliminare.length === 1 
                ? `Sei sicuro di voler eliminare l'evento:\n"${eventiDaEliminare[0].nome}"`
                : `Sei sicuro di voler eliminare ${eventiDaEliminare.length} eventi?\n\nQuesta azione √® irreversibile!`;
            
            if (confirm(confermaMessaggio)) {
                // Rimuovi tutti gli eventi
                eventiDaEliminare.forEach(evento => {
                    const index = databaseEventi.findIndex(e => e.id === evento.id);
                    if (index !== -1) {
                        databaseEventi.splice(index, 1);
                    }
                });
                
                // Salva
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                
                // Aggiorna tutto
                refreshDatabaseEventi();

                // Aggiorna
                mostraTabellaEventi();
                calcolaStatisticheDatabase();
                
                // Notifica
                showNotification(`${eventiDaEliminare.length} eventi eliminati`, 'success');
            }
        }

        // ==============================
        // FUNZIONE PER ELIMINARE UN EVENTO (UNIFICATA)
        // ==============================
        function eliminaEvento(eventId) {
            if (!eventId) {
                showNotification('ID evento non valido', 'error');
                return;
            }
            
            const evento = databaseEventi.find(e => e.id === eventId);
            if (!evento) {
                showNotification('Evento non trovato', 'error');
                return;
            }
            
            if (confirm(`Sei sicuro di voler eliminare l'evento:\n"${evento.nome}"\n\nQuesta azione √® irreversibile!`)) {
                // Animazione
                const row = document.querySelector(`tr[data-event-id="${eventId}"]`);
                if (row) {
                    row.classList.add('tr-eliminata');
                }
                
                setTimeout(() => {
                    // 1. Rimuovi dal database
                    const index = databaseEventi.findIndex(e => e.id === eventId);
                    if (index !== -1) {
                        databaseEventi.splice(index, 1);
                        
                        // 2. Salva
                        localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                        
                        // 3. Chiudi modal se aperta
                        const modal = document.getElementById('eventoModal');
                        if (modal.style.display === 'block') {
                            chiudiModal();
                        }
                        
                        // Aggiorna tutto il sistema
                        refreshDatabaseEventi();
                        
                        // 9. Notifica
                        showNotification(`Evento "${evento.nome.substring(0, 30)}..." eliminato`, 'success');
                    }
                }, 300); // Durata animazione
            }
        }

        // ==============================
        // FUNZIONE PER CALCOLARE STATISTICHE
        // ==============================
        function calcolaStatisticheDatabase() {
            const totali = databaseEventi.length;
            
            if (totali === 0) {
                // Se non ci sono eventi, mostra tutto zero
                document.getElementById('statEventiTotali').textContent = '0';
                document.getElementById('statEventiValue').textContent = '0';
                document.getElementById('statEsitiFrequenti').textContent = '-';
                document.getElementById('statValueMedia').textContent = '0%';
                return;
            }
            
            // Contatori per esiti value
            const contatoriEsiti = {
                '1': 0, 'X': 0, '2': 0, 'SI': 0, 'NO': 0
            };
            
            let eventiConValue = 0;
            let sommaForzaValue = 0;
            
            // Analizza tutti gli eventi
            databaseEventi.forEach(evento => {
                const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                
                if (risultatoAIQ.hasValue) {
                    eventiConValue++;
                    sommaForzaValue += risultatoAIQ.forzaValue;
                    
                    // Conta l'esito
                    if (contatoriEsiti.hasOwnProperty(risultatoAIQ.outcome)) {
                        contatoriEsiti[risultatoAIQ.outcome]++;
                    }
                }
            });
            
            // Calcola esito pi√π frequente
            let esitoPiuFrequente = '-';
            let maxCount = 0;
            
            for (const [esito, count] of Object.entries(contatoriEsiti)) {
                if (count > maxCount) {
                    maxCount = count;
                    esitoPiuFrequente = esito;
                }
            }
            
            // Se ci sono parecchi, mostra il pi√π frequente
            const esitoDisplay = esitoPiuFrequente !== '-' ? 
                `VALUE ${esitoPiuFrequente}` : '-';
            
            // Calcola forza media
            const forzaMedia = eventiConValue > 0 ? 
                (sommaForzaValue / eventiConValue) : 0;
            
            // Aggiorna le card
            document.getElementById('statEventiTotali').textContent = totali;
            document.getElementById('statEventiValue').textContent = eventiConValue;
            document.getElementById('statEsitiFrequenti').textContent = esitoDisplay;
            document.getElementById('statValueMedia').textContent = forzaMedia.toFixed(1) + '%';
            
            // Aggiungi tooltip informativi
            document.getElementById('statEventiTotali').title = `${totali} eventi nel database`;
            document.getElementById('statEventiValue').title = `${eventiConValue} eventi con valuebet identificata`;
            document.getElementById('statEsitiFrequenti').title = `Distribuzione: 1:${contatoriEsiti['1']} X:${contatoriEsiti['X']} 2:${contatoriEsiti['2']} SI:${contatoriEsiti['SI']} NO:${contatoriEsiti['NO']}`;
            document.getElementById('statValueMedia').title = `Media calcolata su ${eventiConValue} valuebet`;
        }

        // ==============================
        // FUNZIONI PER LA MODAL E GESTIONE CAMPI
        // ==============================

        function mostraDettagliEventoModal(eventId) {
            const evento = databaseEventi.find(e => e.id === eventId);
            if (!evento) {
                showNotification('Evento non trovato', 'error');
                return;
            }
            
            // Apri la modal
            const modal = document.getElementById('eventoModal');
            modal.style.display = 'block';
            
            // Popola info evento
            const modalInfo = document.getElementById('modalEventoInfo');
            modalInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                        <strong>Evento:</strong> ${evento.nome}
                    </div>
                    <div>
                        <strong>Sport:</strong> ${evento.sport}
                    </div>
                    <div>
                        <strong>Lega:</strong> ${evento.lega}
                    </div>
                    <div>
                        <strong>Nazione:</strong> ${evento.nazione}
                    </div>
                    <div>
                        <strong>Data:</strong> ${evento.dataFormattata}
                    </div>
                    <div>
                        <strong>Tipo Quotes:</strong> ${evento.tipoQuotes || 'N/D'}
                    </div>
                    <div>
                        <strong>Data creazione:</strong> ${new Date(evento.timestamp).toLocaleString()}
                    </div>
                </div>
            `;

            // Popola info AIQ se presenti
            const modalAIQ = document.getElementById('modalAIQInfo');
            if (evento.aiqData && evento.aiqData.stats) {
                const stats = evento.aiqData.stats;
                
                if (evento.tipoQuotes === '3_esiti') {
                    modalAIQ.innerHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìä Statistiche AIQ - 3 Esiti</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div style="background: #eff6ff; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #2563eb; margin-bottom: 5px;">ESITO 1</div>
                                <div><strong>Media:</strong> ${stats.avg1 ? stats.avg1.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.min1 ? stats.min1.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.max1 ? stats.max1.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacle1 ? stats.pinnacle1.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfair1 ? stats.betfair1.toFixed(2) : '-'}</div>
                            </div>
                            <div style="background: #faf5ff; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #9333ea; margin-bottom: 5px;">ESITO X</div>
                                <div><strong>Media:</strong> ${stats.avgX ? stats.avgX.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.minX ? stats.minX.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.maxX ? stats.maxX.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacleX ? stats.pinnacleX.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfairX ? stats.betfairX.toFixed(2) : '-'}</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #059669; margin-bottom: 5px;">ESITO 2</div>
                                <div><strong>Media:</strong> ${stats.avg2 ? stats.avg2.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.min2 ? stats.min2.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.max2 ? stats.max2.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacle2 ? stats.pinnacle2.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfair2 ? stats.betfair2.toFixed(2) : '-'}</div>
                            </div>
                        </div>
                    `;
                } else if (evento.tipoQuotes === '2_esiti') {
                    modalAIQ.innerHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìä Statistiche AIQ - 2 Esiti</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; text-align: center;">
                            <div style="background: #eff6ff; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #2563eb; margin-bottom: 5px;">ESITO S√å</div>
                                <div><strong>Media:</strong> ${stats.avgYes ? stats.avgYes.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.minYes ? stats.minYes.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.maxYes ? stats.maxYes.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacleYes ? stats.pinnacleYes.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfairYes ? stats.betfairYes.toFixed(2) : '-'}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #dc2626; margin-bottom: 5px;">ESITO NO</div>
                                <div><strong>Media:</strong> ${stats.avgNo ? stats.avgNo.toFixed(2) : '0.00'}</div>
                                <div><strong>Min:</strong> ${stats.minNo ? stats.minNo.toFixed(2) : '0.00'}</div>
                                <div><strong>Max:</strong> ${stats.maxNo ? stats.maxNo.toFixed(2) : '0.00'}</div>
                                <div><strong>Pinnacle:</strong> ${stats.pinnacleNo ? stats.pinnacleNo.toFixed(2) : '-'}</div>
                                <div><strong>Betfair:</strong> ${stats.betfairNo ? stats.betfairNo.toFixed(2) : '-'}</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                modalAIQ.innerHTML = '<p style="color: #666; text-align: center;">‚ö† Nessun dato AIQ disponibile</p>';
            }
            
                const risultatoHTML = evento.risultatoReale ? 
                `<div style="margin-top: 15px; padding: 12px; background: #dcfce7; border-radius: 8px; border-left: 4px solid #059669;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>‚úÖ Risultato Reale Impostato</strong><br>
                            <span style="font-size: 24px; font-weight: bold; color: #166534;">${evento.risultatoReale}</span>
                            <small style="color: #666; margin-left: 10px;">
                                ${evento.risultatoTimestamp ? new Date(evento.risultatoTimestamp).toLocaleString() : ''}
                            </small>
                        </div>
                    </div>
                </div>` : 
                `<div style="margin-top: 15px; padding: 12px; background: #fef9c3; border-radius: 8px; border-left: 4px solid #ca8a04;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>‚ö†Ô∏è Nessun Risultato Impostato</strong><br>
                            <small style="color: #666;">Imposta il risultato per includere nel backtest</small>
                        </div>
                        <button onclick="impostaRisultato('${evento.id}')" 
                                style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                            üéØ Imposta Risultato
                        </button>
                    </div>
                </div>`;
            
            // INSERISCI il risultato nella modalAIQ (aggiungilo al contenuto esistente)
            modalAIQ.innerHTML += risultatoHTML;

            // Aggiungi informazioni sulle soglie usate
            if (evento.aiqData && evento.aiqData.soglieUsate) {
                const soglie = evento.aiqData.soglieUsate;
                
                // Se modalAIQ ha gi√† contenuto, aggiungi al fondo
                if (modalAIQ.innerHTML) {
                    modalAIQ.innerHTML += `
                        <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; border-left: 4px solid #7c3aed;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #7c3aed;">üéØ Soglie AIQ utilizzate</strong>
                                ${soglie.aggiornamento === 'riapplicazione' ? 
                                '<span style="background: #fef3c3; color: #92400e; padding: 2px 6px; border-radius: 10px; font-size: 10px;">RIAVVIATA</span>' : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                <div>
                                    <span style="color: #666; font-size: 11px;">Sharp/Media:</span><br>
                                    <strong style="color: #1a1a1a; font-size: 14px;">${soglie.sm}%</strong>
                                    ${soglie.sm !== 5 ? '<span style="color: #f59e0b; font-size: 10px; margin-left: 5px;">(personalizzata)</span>' : ''}
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 11px;">Max/Min:</span><br>
                                    <strong style="color: #1a1a1a; font-size: 14px;">${soglie.mm}%</strong>
                                    ${soglie.mm !== 8 ? '<span style="color: #f59e0b; font-size: 10px; margin-left: 5px;">(personalizzata)</span>' : ''}
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 11px;">Sharp/Soft:</span><br>
                                    <strong style="color: #1a1a1a; font-size: 14px;">${soglie.ss}%</strong>
                                    ${soglie.ss !== 7 ? '<span style="color: #f59e0b; font-size: 10px; margin-left: 5px;">(personalizzata)</span>' : ''}
                                </div>
                                <div>
                                    <span style="color: #666; font-size: 11px;">Vicino:</span><br>
                                    <strong style="color: #1a1a1a; font-size: 14px;">${soglie.near}%</strong>
                                </div>
                            </div>
                            ${soglie.timestamp ? 
                                `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                    <small style="color: #666; font-size: 10px;">
                                        üïí Valutate: ${new Date(soglie.timestamp).toLocaleDateString('it-IT')} 
                                        ${new Date(soglie.timestamp).toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})}
                                    </small>
                                </div>` : 
                                ''
                            }
                        </div>
                    `;
                } else {
                    // Se non c'era contenuto AIQ, mostra solo le soglie
                    modalAIQ.innerHTML = `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                            <h4 style="margin-top: 0; color: #7c3aed;">üéØ Soglie AIQ utilizzate</h4>
                            <div style="display: inline-block; background: white; padding: 10px 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="font-size: 16px; font-weight: bold; color: #1a1a1a;">
                                    ${soglie.sm}-${soglie.mm}-${soglie.ss}%
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    Sharp/Media ‚Ä¢ Max/Min ‚Ä¢ Sharp/Soft
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            // Popola tabella quotes
            const modalQuotes = document.getElementById('modalQuotesContainer');
            if (evento.quotes && evento.quotes.length > 0) {
                let tableHTML = '';
                
                if (evento.tipoQuotes === '3_esiti') {
                    tableHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìã Dettaglio Bookmaker (${evento.quotes.length} totali)</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #eaeaea;">Bookmaker</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #2563eb;">1</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #9333ea;">X</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #059669;">2</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea;">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${evento.quotes.map(book => `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 10px;">
                                                <span style="font-weight: ${book.isSharp ? 'bold' : 'normal'}; color: ${book.isSharp ? '#ea580c' : '#1a1a1a'}">
                                                    ${formatBookmakerName(book.bookmaker)}${book.isSharp ? ' ‚ö°' : ''}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #eff6ff; color: #2563eb;">
                                                ${book.quote1.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #faf5ff; color: #9333ea;">
                                                ${book.quoteX.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #f0fdf4; color: #059669;">
                                                ${book.quote2.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center;">
                                                ${book.isSharp ? '<span style="color: #ea580c; font-weight: bold;">SHARP</span>' : '<span style="color: #666;">SOFT</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (evento.tipoQuotes === '2_esiti') {
                    tableHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìã Dettaglio Bookmaker (${evento.quotes.length} totali)</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #eaeaea;">Bookmaker</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #2563eb;">S√å</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea; color: #dc2626;">NO</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eaeaea;">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${evento.quotes.map(book => `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 10px;">
                                                <span style="font-weight: ${book.isSharp ? 'bold' : 'normal'}; color: ${book.isSharp ? '#ea580c' : '#1a1a1a'}">
                                                    ${formatBookmakerName(book.bookmaker)}${book.isSharp ? ' ‚ö°' : ''}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #eff6ff; color: #2563eb;">
                                                ${book.quoteYes.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center; background: #fef2f2; color: #dc2626;">
                                                ${book.quoteNo.toFixed(2)}
                                            </td>
                                            <td style="padding: 10px; text-align: center;">
                                                ${book.isSharp ? '<span style="color: #ea580c; font-weight: bold;">SHARP</span>' : '<span style="color: #666;">SOFT</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            // Aggiungi dettagli metriche AIQ se presenti
            if (evento.aiqData && evento.aiqData.stats) {
                const aiqResult = verificaValueBetAIQ(evento.aiqData.stats, evento.tipoQuotes);
                
                if (aiqResult.hasValue) {
                    modalAIQ.innerHTML += `
                        <div style="margin-top: 15px; padding: 10px; background: #dcfce7; border-radius: 6px; text-align: center;">
                            <strong>‚úÖ VALUEBET IDENTIFICATA</strong><br>
                            <div style="font-size: 16px; font-weight: bold; color: #166534; margin: 5px 0;">
                                Esito: ${aiqResult.outcome} | Forza: ${aiqResult.forzaValue.toFixed(1)}%
                            </div>
                            <small>Soddisfatte tutte le soglie AIQ</small>
                        </div>
                    `;
                } else {
                    modalAIQ.innerHTML += `
                        <div style="margin-top: 15px; padding: 10px; background: #fef9c3; border-radius: 6px; text-align: center;">
                            <strong>‚ö† NESSUNA VALUEBET</strong><br>
                            <small>Non soddisfatte tutte le soglie AIQ</small>
                        </div>
                    `;
                }
            }

                modalQuotes.innerHTML = tableHTML;
            } else {
                modalQuotes.innerHTML = '<p style="color: #666; text-align: center;">‚ö† Nessuna quote disponibile</p>';
            }
        }

        function chiudiModal() {
            const modal = document.getElementById('eventoModal');
            modal.style.display = 'none';
        }

        // Chiudi la modal cliccando fuori
        window.onclick = function(event) {
            const modal = document.getElementById('eventoModal');
            if (event.target === modal) {
                chiudiModal();
            }
        };

        // ==============================
        // FUNZIONE DI VALIDAZIONE JSON IMPORT
        // ==============================
        function validaJSONImport(jsonData, tipo = 'database') {
            try {
                if (tipo === 'database') {
                    // Validazione per backup database
                    if (!jsonData.databaseEventi || !Array.isArray(jsonData.databaseEventi)) {
                        return { valido: false, errore: 'Formato non valido: databaseEventi mancante o non array' };
                    }
                    
                    // Validazione struttura eventi
                    for (const evento of jsonData.databaseEventi) {
                        if (!evento.id || typeof evento.id !== 'string') {
                            return { valido: false, errore: `Evento senza ID valido: ${evento.nome || 'N/D'}` };
                        }
                        
                        // Controlla che le quote siano arrays se presenti
                        if (evento.quotes && !Array.isArray(evento.quotes)) {
                            return { valido: false, errore: `Quotes non valide per evento: ${evento.id}` };
                        }
                    }
                    
                    return { valido: true, data: jsonData };
                }
                else if (tipo === 'config') {
                    // Validazione per configurazione AIQ
                    if (!jsonData.soglieAIQ || typeof jsonData.soglieAIQ !== 'object') {
                        return { valido: false, errore: 'Formato non valido: soglieAIQ mancante' };
                    }
                    
                    const requiredFields = ['sm', 'mm', 'ss'];
                    for (const field of requiredFields) {
                        if (typeof jsonData.soglieAIQ[field] !== 'number') {
                            return { valido: false, errore: `Campo soglieAIQ.${field} non valido` };
                        }
                    }
                    
                    return { valido: true, data: jsonData };
                }
                
                return { valido: false, errore: 'Tipo di importazione non supportato' };
            } catch (error) {
                return { valido: false, errore: `Errore nella validazione: ${error.message}` };
            }
        }

        // ==============================
        // RESTORE DATABASE CON VALIDAZIONE
        // ==============================
        function restoreDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Controlla dimensione file (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('File troppo grande (max 10MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        
                        // VALIDAZIONE
                        const validazione = validaJSONImport(jsonData, 'database');
                        if (!validazione.valido) {
                            showNotification(`Errore validazione: ${validazione.errore}`, 'error');
                            return;
                        }
                        
                        if (confirm(`Vuoi ripristinare il backup con ${jsonData.databaseEventi.length} eventi?\n\nIMPORTANTE: I dati attuali (${databaseEventi.length} eventi) verranno SOVRASCRITTI.`)) {
                            databaseEventi = jsonData.databaseEventi;
                            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                            
                            // Reset filtri e paginazione
                            eventiFiltrati = [...databaseEventi];
                            paginaCorrente = 1;
                            
                            mostraTabellaEventi();                            
                            showNotification(`‚úÖ Database ripristinato con ${databaseEventi.length} eventi`, 'success');
                        }
                    } catch (error) {
                        showNotification('‚ùå Errore nel ripristino: file JSON non valido', 'error');
                        console.error('Errore importazione:', error);
                    }
                };
                
                reader.onerror = function() {
                    showNotification('‚ùå Errore nella lettura del file', 'error');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==============================
        // IMPORT CONFIGURAZIONE CON VALIDAZIONE
        // ==============================
        function importaConfigurazioneCompleta() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Controlla dimensione file (max 1MB)
                if (file.size > 1024 * 1024) {
                    showNotification('File troppo grande (max 1MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        
                        // VALIDAZIONE
                        const validazione = validaJSONImport(jsonData, 'config');
                        if (!validazione.valido) {
                            showNotification(`‚ùå Errore validazione: ${validazione.errore}`, 'error');
                            return;
                        }
                        
                        if (confirm(`Importare configurazione AIQ?\n\nSoglie: ${jsonData.soglieAIQ.sm}-${jsonData.soglieAIQ.mm}-${jsonData.soglieAIQ.ss}%\nEventi nel backup: ${jsonData.eventiTotali || 0}`)) {
                            // Importa soglie AIQ
                            soglieAIQ = jsonData.soglieAIQ;
                            localStorage.setItem('soglieAIQ', JSON.stringify(soglieAIQ));
                            
                            // Importa impostazioni sistema se presenti (con validazione)
                            if (jsonData.impostazioniSistema) {
                                // Validazione base impostazioni sistema
                                const impostazioniValide = {
                                    autoCalcolaAIQ: typeof jsonData.impostazioniSistema.autoCalcolaAIQ === 'boolean' ? 
                                                jsonData.impostazioniSistema.autoCalcolaAIQ : true,
                                    mostraTooltipAIQ: typeof jsonData.impostazioniSistema.mostraTooltipAIQ === 'boolean' ? 
                                                    jsonData.impostazioniSistema.mostraTooltipAIQ : true,
                                    autoBackup: typeof jsonData.impostazioniSistema.autoBackup === 'boolean' ? 
                                            jsonData.impostazioniSistema.autoBackup : false,
                                    notificheValue: typeof jsonData.impostazioniSistema.notificheValue === 'boolean' ? 
                                                jsonData.impostazioniSistema.notificheValue : false
                                };
                                localStorage.setItem('impostazioniSistema', JSON.stringify(impostazioniValide));
                            }
                            
                            // Aggiorna UI
                            caricaSoglieAIQ();
                            aggiornaIndicatoriSoglie();
                            ricalcolaTuttiAIQ();
                            inizializzaTabSetup();
                            
                            showNotification('‚úÖ Configurazione AIQ importata con successo', 'success');
                        }
                    } catch (error) {
                        console.error("Errore importazione:", error);
                        showNotification('‚ùå Errore nell\'importazione: file JSON non valido', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showNotification('‚ùå Errore nella lettura del file', 'error');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        // ==============================
        // FUNZIONI CONFIGURAZIONE AIQ
        // ==============================

        function caricaSoglieAIQ() {
            console.log("Caricamento soglie AIQ nei campi...");
            
            // Assicurati che soglieAIQ esista
            if (!soglieAIQ) {
                soglieAIQ = JSON.parse(localStorage.getItem('soglieAIQ') || JSON.stringify({
                    sm: 5, mm: 8, ss: 7, near: 0.5
                }));
            }
            
            // Carica nei campi input (se esistono)
            const sogliaSM = document.getElementById('sogliaSM');
            const sogliaMM = document.getElementById('sogliaMM');
            const sogliaSS = document.getElementById('sogliaSS');
            const sogliaNEAR = document.getElementById('sogliaNEAR');
            
            if (sogliaSM) sogliaSM.value = soglieAIQ.sm;
            if (sogliaMM) sogliaMM.value = soglieAIQ.mm;
            if (sogliaSS) sogliaSS.value = soglieAIQ.ss;
            if (sogliaNEAR) sogliaNEAR.value = soglieAIQ.near;
            
            // Aggiorna display informazioni
            const currentSM = document.getElementById('currentSM');
            const currentMM = document.getElementById('currentMM');
            const currentSS = document.getElementById('currentSS');
            const currentNEAR = document.getElementById('currentNEAR');
            
            if (currentSM) currentSM.textContent = soglieAIQ.sm + '%';
            if (currentMM) currentMM.textContent = soglieAIQ.mm + '%';
            if (currentSS) currentSS.textContent = soglieAIQ.ss + '%';
            if (currentNEAR) currentNEAR.textContent = soglieAIQ.near + '%';
            
            // Aggiorna statistiche
            const statSoglieAttive = document.getElementById('statSoglieAttive');
            if (statSoglieAttive) {
                statSoglieAttive.textContent = `AIQ ${soglieAIQ.sm}-${soglieAIQ.mm}-${soglieAIQ.ss}`;
            }
            
            console.log("Soglie caricate:", soglieAIQ);
        }

        function salvaSoglieAIQ() {
            console.log("Salvataggio nuove soglie AIQ...");
            
            // Leggi i valori dai campi input
            const nuoveSoglie = {
                sm: parseFloat(document.getElementById('sogliaSM').value) || 5,
                mm: parseFloat(document.getElementById('sogliaMM').value) || 8,
                ss: parseFloat(document.getElementById('sogliaSS').value) || 7,
                near: parseFloat(document.getElementById('sogliaNEAR').value) || 0.5
            };
            
            // Validazione
            if (nuoveSoglie.sm < 0 || nuoveSoglie.mm < 0 || nuoveSoglie.ss < 0 || nuoveSoglie.near < 0) {
                showNotification('I valori non possono essere negativi', 'error');
                return;
            }
            
            // Controlla se ci sono cambiamenti rispetto alle attuali
            const sonoUguali = 
                soglieAIQ.sm === nuoveSoglie.sm &&
                soglieAIQ.mm === nuoveSoglie.mm &&
                soglieAIQ.ss === nuoveSoglie.ss &&
                soglieAIQ.near === nuoveSoglie.near;
            
            if (sonoUguali) {
                showNotification('Le soglie sono gi√† impostate su questi valori', 'info');
                return;
            }
            
            // Salva le nuove soglie
            soglieAIQ = nuoveSoglie;
            localStorage.setItem('soglieAIQ', JSON.stringify(soglieAIQ));
            
            // Aggiorna indicatori nei calcolatori
            aggiornaIndicatoriSoglie();
            
            // Ricalcola tutti i calcolatori AIQ aperti
            ricalcolaTuttiAIQ();
            
            // Aggiorna display nella tab Setup
            caricaSoglieAIQ();
            
            // Aggiorna data ultima modifica
            const statUltimaModifica = document.getElementById('statUltimaModifica');
            if (statUltimaModifica) {
                statUltimaModifica.textContent = new Date().toLocaleTimeString();
            }
            
            // Mostra notifica dettagliata
            const cambiamenti = [];
            if (soglieAIQ.sm !== 5) cambiamenti.push(`Sharp/Media: ${soglieAIQ.sm}% (default: 5%)`);
            if (soglieAIQ.mm !== 8) cambiamenti.push(`Max/Min: ${soglieAIQ.mm}% (default: 8%)`);
            if (soglieAIQ.ss !== 7) cambiamenti.push(`Sharp/Soft: ${soglieAIQ.ss}% (default: 7%)`);
            
            if (cambiamenti.length > 0) {
                showNotification(`‚úÖ Soglie AIQ aggiornate\n${cambiamenti.join('\n')}`, 'success', 4000);
            } else {
                showNotification(`‚úÖ Soglie AIQ impostate ai valori di default: 5-8-7%`, 'success');
            }
        }

        function resetSoglieDefault() {
            if (confirm('Tornare alle soglie AIQ di default (5-8-7)?\n\nTutti i calcolatori verranno aggiornati immediatamente.')) {
                soglieAIQ = {
                    sm: 5,
                    mm: 8,
                    ss: 7,
                    near: 0.5
                };
                
                localStorage.setItem('soglieAIQ', JSON.stringify(soglieAIQ));
                
                // Aggiorna interfaccia
                caricaSoglieAIQ();
                aggiornaIndicatoriSoglie();
                ricalcolaTuttiAIQ();
                
                showNotification('‚úÖ Soglie AIQ resettate ai valori di default (5-8-7%)', 'success');
            }
        }

        function ricalcolaTuttiAIQ() {
            console.log("Ricalcolo di tutti i calcolatori AIQ con le nuove soglie...");
            
            // Ricalcola AIQ CALCIO se ci sono dati nei campi
            const calcioSharpHome = document.getElementById('AIQ CALCIO_Sharp_HOME');
            if (calcioSharpHome && calcioSharpHome.value) {
                calculateAiq('AIQ CALCIO', 'HOME');
                calculateAiq('AIQ CALCIO', 'DRAW');
                calculateAiq('AIQ CALCIO', 'AWAY');
                console.log("AIQ Calcio ricalcolato");
            }
            
            // Ricalcola AIQ TENNIS se ci sono dati nei campi
            const tennisSharpHome = document.getElementById('AIQ TENNIS_Sharp_HOME');
            if (tennisSharpHome && tennisSharpHome.value) {
                calculateAiq('AIQ TENNIS', 'HOME');
                calculateAiq('AIQ TENNIS', 'AWAY');
                console.log("AIQ Tennis ricalcolato");
            }
            
            // Ricalcola tutti gli eventi nel database
            if (databaseEventi.length > 0) {
                console.log(`Rivalutazione di ${databaseEventi.length} eventi con le nuove soglie...`);
                // La prossima volta che viene mostrata la tabella eventi, user√† le nuove soglie
            }
        }

        function riapplicaSoglieATutto() {
            if (databaseEventi.length === 0) {
                showNotification('Nessun evento nel database', 'info');
                return;
            }
            
            if (confirm(`Rivalutare ${databaseEventi.length} eventi con le attuali soglie AIQ (${soglieAIQ.sm}-${soglieAIQ.mm}-${soglieAIQ.ss}%)?\n\nQuesta operazione aggiorner√† tutte le valuebet identificate.`)) {
                let valuebetAggiornate = 0;
                
                databaseEventi.forEach(evento => {
                    if (evento.aiqData && evento.aiqData.stats) {
                        // Ricalcola con le nuove soglie
                        const risultatoAIQ = verificaValueBetAIQ(evento.aiqData.stats, evento.tipoQuotes);
                        
                        // Salva il risultato nei dati dell'evento
                        if (!evento.aiqData.risultatoAIQ) {
                            evento.aiqData.risultatoAIQ = {};
                        }
                        evento.aiqData.risultatoAIQ = risultatoAIQ;
                        
                        // Aggiorna anche le soglie usate
                        evento.aiqData.soglieUsate = {
                            sm: soglieAIQ.sm,
                            mm: soglieAIQ.mm,
                            ss: soglieAIQ.ss,
                            near: soglieAIQ.near,
                            timestamp: new Date().toISOString(),
                            aggiornamento: 'riapplicazione'
                        };

                        if (risultatoAIQ.hasValue) {
                            valuebetAggiornate++;
                        }
                    }
                });
                
                // Salva il database aggiornato
                localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
                
                // Aggiorna la vista
                mostraTabellaEventi();
                calcolaStatisticheDatabase();
                
                showNotification(`‚úÖ ${valuebetAggiornate} valuebet rivalutate con le nuove soglie`, 'success');
            }
        }

        function inizializzaTabSetup() {
            console.log("Inizializzazione tab Setup...");
            caricaSoglieAIQ();
            
            // Carica altre impostazioni di sistema se presenti
            try {
                const impostazioniSistema = JSON.parse(localStorage.getItem('impostazioniSistema') || '{}');
                const autoCalcolaAIQ = document.getElementById('autoCalcolaAIQ');
                const mostraTooltipAIQ = document.getElementById('mostraTooltipAIQ');
                const autoBackup = document.getElementById('autoBackup');
                const notificheValue = document.getElementById('notificheValue');
                
                if (autoCalcolaAIQ) autoCalcolaAIQ.checked = impostazioniSistema.autoCalcolaAIQ !== false;
                if (mostraTooltipAIQ) mostraTooltipAIQ.checked = impostazioniSistema.mostraTooltipAIQ !== false;
                if (autoBackup) autoBackup.checked = impostazioniSistema.autoBackup || false;
                if (notificheValue) notificheValue.checked = impostazioniSistema.notificheValue || false;
            } catch (e) {
                console.error("Errore nel caricamento impostazioni sistema:", e);
            }
            
            // Aggiorna statistiche
            aggiornaStatisticheSetup();
        }

        function aggiornaStatisticheSetup() {
            const statEventiTotaliSetup = document.getElementById('statEventiTotaliSetup');
            const statValuebetTrovate = document.getElementById('statValuebetTrovate');
            
            if (statEventiTotaliSetup) {
                statEventiTotaliSetup.textContent = databaseEventi.length;
            }
            
            if (statValuebetTrovate && databaseEventi.length > 0) {
                // Conta valuebet trovate
                let valuebetTrovate = 0;
                databaseEventi.forEach(evento => {
                    if (evento.aiqData && evento.aiqData.stats) {
                        const risultatoAIQ = verificaValueBetAIQ(evento.aiqData.stats, evento.tipoQuotes);
                        if (risultatoAIQ.hasValue) {
                            valuebetTrovate++;
                        }
                    }
                });
                
                statValuebetTrovate.textContent = valuebetTrovate;
            }
            
            // Aggiorna ultima modifica
            const statUltimaModifica = document.getElementById('statUltimaModifica');
            if (statUltimaModifica && !statUltimaModifica.textContent.includes(':')) {
                statUltimaModifica.textContent = new Date().toLocaleTimeString();
            }
        }

        function aggiornaImpostazioniSistema() {
            const impostazioni = {
                autoCalcolaAIQ: document.getElementById('autoCalcolaAIQ').checked,
                mostraTooltipAIQ: document.getElementById('mostraTooltipAIQ').checked,
                autoBackup: document.getElementById('autoBackup').checked,
                notificheValue: document.getElementById('notificheValue').checked,
                ultimaModifica: new Date().toISOString()
            };
            
            localStorage.setItem('impostazioniSistema', JSON.stringify(impostazioni));
            showNotification('Impostazioni sistema salvate', 'success');
        }

        function esportaConfigurazioneCompleta() {
            const config = {
                soglieAIQ: soglieAIQ,
                impostazioniSistema: JSON.parse(localStorage.getItem('impostazioniSistema') || '{}'),
                dataEsportazione: new Date().toISOString(),
                versione: '1.0',
                eventiTotali: databaseEventi.length,
                note: 'Configurazione AIQ Parser Betmonitor'
            };
            
            const jsonContent = JSON.stringify(config, null, 2);
            const nomeFile = `config_aiq_${new Date().toISOString().slice(0, 10)}.json`;
            
            downloadFile(jsonContent, nomeFile, 'application/json');
            showNotification('‚úÖ Configurazione AIQ esportata', 'success');
        }

        // Funzione di utilit√† per aggiornare gli indicatori nelle altre tab
        function aggiornaIndicatoriSoglie() {
            console.log("Aggiornamento indicatori soglie AIQ:", soglieAIQ);
            
            // Assicurati che soglieAIQ esista
            if (!soglieAIQ) {
                console.error("soglieAIQ non definita!");
                return;
            }
            
            // Aggiorna indicatori nei calcolatori AIQ CALCIO
            const valoreSM = document.getElementById('valoreSM');
            const valoreMM = document.getElementById('valoreMM');
            const valoreSS = document.getElementById('valoreSS');
            
            if (valoreSM && valoreMM && valoreSS) {
                valoreSM.textContent = soglieAIQ.sm;
                valoreMM.textContent = soglieAIQ.mm;
                valoreSS.textContent = soglieAIQ.ss;
            }
            
            // Aggiorna indicatori nei calcolatori AIQ TENNIS
            const valoreSM_T = document.getElementById('valoreSM_T');
            const valoreMM_T = document.getElementById('valoreMM_T');
            const valoreSS_T = document.getElementById('valoreSS_T');
            
            if (valoreSM_T && valoreMM_T && valoreSS_T) {
                valoreSM_T.textContent = soglieAIQ.sm;
                valoreMM_T.textContent = soglieAIQ.mm;
                valoreSS_T.textContent = soglieAIQ.ss;
            }
            
            // Cambia stile se le soglie sono personalizzate
            const sonoDefault = soglieAIQ.sm === 5 && soglieAIQ.mm === 8 && soglieAIQ.ss === 7;
            
            // Per AIQ Calcio
            const indicatoreCalcio = document.getElementById('soglieAttiveCalcio');
            if (indicatoreCalcio) {
                if (!sonoDefault) {
                    indicatoreCalcio.style.background = '#fef3c7';
                    indicatoreCalcio.style.color = '#92400e';
                    indicatoreCalcio.style.border = '1px solid #f59e0b';
                    indicatoreCalcio.style.fontWeight = 'bold';
                    indicatoreCalcio.title = `‚ö†Ô∏è Soglie personalizzate (default: 5-8-7%)`;
                } else {
                    indicatoreCalcio.style.background = '#dbeafe';
                    indicatoreCalcio.style.color = '#1d4ed8';
                    indicatoreCalcio.style.border = '1px solid #93c5fd';
                    indicatoreCalcio.style.fontWeight = 'normal';
                    indicatoreCalcio.title = `Soglie di default`;
                }
            }
            
            // Per AIQ Tennis
            const indicatoreTennis = document.getElementById('soglieAttiveTennis');
            if (indicatoreTennis) {
                if (!sonoDefault) {
                    indicatoreTennis.style.background = '#fef3c7';
                    indicatoreTennis.style.color = '#92400e';
                    indicatoreTennis.style.border = '1px solid #f59e0b';
                    indicatoreTennis.style.fontWeight = 'bold';
                    indicatoreTennis.title = `‚ö†Ô∏è Soglie personalizzate (default: 5-8-7%)`;
                } else {
                    indicatoreTennis.style.background = '#dbeafe';
                    indicatoreTennis.style.color = '#1d4ed8';
                    indicatoreTennis.style.border = '1px solid #93c5fd';
                    indicatoreTennis.style.fontWeight = 'normal';
                    indicatoreTennis.title = `Soglie di default`;
                }
            }
        }

        // ==============================
        // FUNZIONE PER EVidenziare SOGLIE PERSONALIZZATE
        // ==============================
        function evidenziaSogliePersonalizzate(element, soglie) {
            if (!soglie || !element) return;
            
            const sonoDefault = soglie.sm === 5 && soglie.mm === 8 && soglie.ss === 7;
            
            if (!sonoDefault) {
                element.classList.add('soglie-personalizzata');
                element.title = `‚ö†Ô∏è Soglie personalizzate (default: 5-8-7%)`;
                
                // Aggiungi icona se necessario
                if (!element.querySelector('.icon-soglie')) {
                    const icon = document.createElement('span');
                    icon.className = 'icon-soglie';
                    icon.innerHTML = ' ‚öôÔ∏è';
                    icon.style.marginLeft = '3px';
                    element.appendChild(icon);
                }
            }
        }

        // ==============================
        // FUNZIONE REFRESH GLOBALE DATABASE
        // ==============================
        function refreshDatabaseEventi() {
            console.log("Refresh database eventi...");
            
            // Ricarica dal localStorage (per sicurezza)
            databaseEventi = JSON.parse(localStorage.getItem('databaseEventi') || '[]');
            
            // Aggiorna contatori in tutte le tab
            document.getElementById('totalEventi3').textContent = databaseEventi.length;
            document.getElementById('eventiAnalizzati3').textContent = databaseEventi.filter(e => e.quotes && e.tipoQuotes === '3_esiti').length;
            
            document.getElementById('totalEventi2').textContent = databaseEventi.length;
            document.getElementById('eventiAnalizzati2').textContent = databaseEventi.filter(e => e.quotes && e.tipoQuotes === '2_esiti').length;
            
            // Se la tab Eventi √® attiva, aggiorna la vista
            const tabEventiAttiva = document.getElementById('tab-eventi').classList.contains('active');
            if (tabEventiAttiva) {
                eventiFiltrati = [...databaseEventi];
                paginaCorrente = 1;
                mostraTabellaEventi();
                calcolaStatisticheDatabase();
                aggiornaFiltriSport();
            }
            
            // Aggiorna statistiche nella tab Setup
            const statEventiTotaliSetup = document.getElementById('statEventiTotaliSetup');
            if (statEventiTotaliSetup) {
                statEventiTotaliSetup.textContent = databaseEventi.length;
            }
        }

        // ==============================
        // FUNZIONI RICERCA AVANZATA
        // ==============================

        let filtriAvanzatiVisibili = false;
        let presetFiltri = JSON.parse(localStorage.getItem('presetFiltri') || '{}');

        function toggleFiltriAvanzati() {
            filtriAvanzatiVisibili = !filtriAvanzatiVisibili;
            const container = document.getElementById('filtriAvanzatiContainer');
            const toggleBtn = document.getElementById('toggleFiltriAvanzati');
            
            if (filtriAvanzatiVisibili) {
                container.style.display = 'block';
                toggleBtn.innerHTML = 'üîç Nascondi Filtri';
                toggleBtn.style.background = '#9f1239';
                
                // Carica preset se esistono
                caricaPresetFiltri();
            } else {
                container.style.display = 'none';
                toggleBtn.innerHTML = 'üîç Filtri Avanzati';
                toggleBtn.style.background = '#7c3aed';
            }
        }

        function updateForzaValueDisplay(value) {
            document.getElementById('forzaValueDisplay').textContent = value + '%';
            document.getElementById('forzaValueMin').textContent = value;
            document.getElementById('filtroForzaValue').value = value;
        }

        function clearSearch() {
            document.getElementById('cercaEvento').value = '';
            filtraEventi();
        }

        function filtraEventi() {
            console.log("Applicazione filtri avanzati...");
            
            // Leggi tutti i valori dei filtri
            const searchTerm = document.getElementById('cercaEvento').value.toLowerCase().trim();
            const filtroSport = document.getElementById('filtroSport').value;
            const filtroTipoEvento = document.getElementById('filtroTipoEvento').value;
            const filtroDataDa = document.getElementById('filtroDataDa').value;
            const filtroDataA = document.getElementById('filtroDataA').value;
            const filtroSoloValue = document.getElementById('filtroSoloValue').checked;
            const filtroEsitoValue = document.getElementById('filtroEsitoValue').value;
            const filtroForzaValue = parseFloat(document.getElementById('filtroForzaValueRange').value) || 0;
            const filtroMinBookmaker = parseInt(document.getElementById('filtroMinBookmaker').value) || 0;
            const filtroSharpBookmaker = document.getElementById('filtroSharpBookmaker').value;
            const filtroSoglieAIQ = document.getElementById('filtroSoglieAIQ').value;
            
            let filtrati = [...databaseEventi];
            
            // 1. Filtro ricerca testo (nome, lega, ID)
            if (searchTerm) {
                filtrati = filtrati.filter(e => 
                    e.nome.toLowerCase().includes(searchTerm) || 
                    e.lega.toLowerCase().includes(searchTerm) ||
                    (e.nazione && e.nazione.toLowerCase().includes(searchTerm)) ||
                    (e.id && e.id.toLowerCase().includes(searchTerm))
                );
            }
            
            // 2. Filtro sport
            if (filtroSport) {
                filtrati = filtrati.filter(e => e.sport === filtroSport);
            }
            
            // 3. Filtro tipo evento
            if (filtroTipoEvento) {
                filtrati = filtrati.filter(e => e.tipoQuotes === filtroTipoEvento);
            }
            
            // 4. Filtro range date
            if (filtroDataDa) {
                const dataDa = new Date(filtroDataDa);
                filtrati = filtrati.filter(e => {
                    const dataEvento = new Date(e.dataOra);
                    return dataEvento >= dataDa;
                });
            }
            
            if (filtroDataA) {
                const dataA = new Date(filtroDataA);
                dataA.setHours(23, 59, 59, 999); // Fine della giornata
                filtrati = filtrati.filter(e => {
                    const dataEvento = new Date(e.dataOra);
                    return dataEvento <= dataA;
                });
            }
            
            // 5. Filtri AIQ
            if (filtroSoloValue || filtroEsitoValue || filtroForzaValue > 0) {
                filtrati = filtrati.filter(evento => {
                    const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                    const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                    
                    // Solo Value
                    if (filtroSoloValue && !risultatoAIQ.hasValue) {
                        return false;
                    }
                    
                    // Esito specifico
                    if (filtroEsitoValue && risultatoAIQ.outcome !== filtroEsitoValue) {
                        return false;
                    }
                    
                    // Forza minima
                    if (filtroForzaValue > 0 && risultatoAIQ.forzaValue < filtroForzaValue) {
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // 6. Filtri Bookmaker
            if (filtroMinBookmaker > 0) {
                filtrati = filtrati.filter(e => e.quotes && e.quotes.length >= filtroMinBookmaker);
            }
            
            if (filtroSharpBookmaker) {
                filtrati = filtrati.filter(e => {
                    if (!e.quotes) return false;
                    
                    const hasSharp = e.quotes.some(q => q.isSharp);
                    
                    if (filtroSharpBookmaker === 'si') {
                        return hasSharp;
                    } else if (filtroSharpBookmaker === 'no') {
                        return !hasSharp;
                    }
                    
                    return true;
                });
            }
            
            // 7. Filtro Soglie AIQ usate
            if (filtroSoglieAIQ) {
                filtrati = filtrati.filter(e => {
                    if (!e.aiqData || !e.aiqData.soglieUsate) {
                        return filtroSoglieAIQ === 'default';
                    }
                    
                    const soglie = e.aiqData.soglieUsate;
                    const isDefault = soglie.sm === 5 && soglie.mm === 8 && soglie.ss === 7;
                    
                    if (filtroSoglieAIQ === 'default') {
                        return isDefault;
                    } else if (filtroSoglieAIQ === 'personalizzate') {
                        return !isDefault;
                    }
                    
                    return true;
                });
            }
            
            // Aggiorna info filtri attivi
            aggiornaInfoFiltriAttivi({
                searchTerm, filtroSport, filtroTipoEvento, filtroDataDa, filtroDataA,
                filtroSoloValue, filtroEsitoValue, filtroForzaValue, filtroMinBookmaker,
                filtroSharpBookmaker, filtroSoglieAIQ
            });
            
            // Aggiorna la vista
            eventiFiltrati = filtrati;
            paginaCorrente = 1;
            mostraTabellaEventi();
            
            showNotification(`Trovati ${filtrati.length} eventi`, 'info', 2000);
        }

        function aggiornaInfoFiltriAttivi(filtri) {
            const infoDiv = document.getElementById('filtriAttiviInfo');
            const attivi = [];
            
            if (filtri.searchTerm) attivi.push(`Testo: "${filtri.searchTerm}"`);
            if (filtri.filtroSport) attivi.push(`Sport: ${filtri.filtroSport}`);
            if (filtri.filtroTipoEvento) attivi.push(`Tipo: ${filtri.filtroTipoEvento}`);
            if (filtri.filtroDataDa || filtri.filtroDataA) {
                const range = [];
                if (filtri.filtroDataDa) range.push(`da ${filtri.filtroDataDa}`);
                if (filtri.filtroDataA) range.push(`a ${filtri.filtroDataA}`);
                attivi.push(`Data: ${range.join(' ')}`);
            }
            if (filtri.filtroSoloValue) attivi.push('Solo Value');
            if (filtri.filtroEsitoValue) attivi.push(`Esito: ${filtri.filtroEsitoValue}`);
            if (filtri.filtroForzaValue > 0) attivi.push(`Forza ‚â• ${filtri.filtroForzaValue}%`);
            if (filtri.filtroMinBookmaker > 0) attivi.push(`Min. book: ${filtri.filtroMinBookmaker}`);
            if (filtri.filtroSharpBookmaker) attivi.push(`Sharp: ${filtri.filtroSharpBookmaker}`);
            if (filtri.filtroSoglieAIQ) attivi.push(`Soglie: ${filtri.filtroSoglieAIQ}`);
            
            if (attivi.length === 0) {
                infoDiv.innerHTML = '<em style="color: #9ca3af;">Nessun filtro attivo</em>';
            } else {
                infoDiv.innerHTML = attivi.map(f => `<div style="margin-bottom: 2px;">‚Ä¢ ${f}</div>`).join('');
            }
        }

        function resetFiltriAvanzati() {
            // Reset tutti i campi filtro
            document.getElementById('cercaEvento').value = '';
            document.getElementById('filtroSport').value = '';
            document.getElementById('filtroTipoEvento').value = '';
            document.getElementById('filtroDataDa').value = '';
            document.getElementById('filtroDataA').value = '';
            document.getElementById('filtroSoloValue').checked = false;
            document.getElementById('filtroEsitoValue').value = '';
            document.getElementById('filtroForzaValueRange').value = 0;
            document.getElementById('forzaValueDisplay').textContent = '0%';
            document.getElementById('forzaValueMin').textContent = '0';
            document.getElementById('filtroMinBookmaker').value = '0';
            document.getElementById('filtroSharpBookmaker').value = '';
            document.getElementById('filtroSoglieAIQ').value = '';
            
            // Aggiorna info
            aggiornaInfoFiltriAttivi({});
            
            // Mostra tutti gli eventi
            eventiFiltrati = [...databaseEventi];
            paginaCorrente = 1;
            mostraTabellaEventi();
            
            showNotification('Filtri resettati', 'info');
        }

        function salvaPresetFiltri() {
            const nomePreset = prompt('Nome per questo preset di filtri:', `Preset_${new Date().toLocaleDateString('it-IT')}`);
            
            if (!nomePreset || nomePreset.trim() === '') return;
            
            // Raccoglie tutti i valori dei filtri
            const preset = {
                nome: nomePreset.trim(),
                timestamp: new Date().toISOString(),
                filtri: {
                    searchTerm: document.getElementById('cercaEvento').value,
                    filtroSport: document.getElementById('filtroSport').value,
                    filtroTipoEvento: document.getElementById('filtroTipoEvento').value,
                    filtroDataDa: document.getElementById('filtroDataDa').value,
                    filtroDataA: document.getElementById('filtroDataA').value,
                    filtroSoloValue: document.getElementById('filtroSoloValue').checked,
                    filtroEsitoValue: document.getElementById('filtroEsitoValue').value,
                    filtroForzaValue: document.getElementById('filtroForzaValueRange').value,
                    filtroMinBookmaker: document.getElementById('filtroMinBookmaker').value,
                    filtroSharpBookmaker: document.getElementById('filtroSharpBookmaker').value,
                    filtroSoglieAIQ: document.getElementById('filtroSoglieAIQ').value
                }
            };
            
            presetFiltri[nomePreset] = preset;
            localStorage.setItem('presetFiltri', JSON.stringify(presetFiltri));
            
            caricaPresetFiltri();
            showNotification(`Preset "${nomePreset}" salvato`, 'success');
        }

        function caricaPresetFiltri() {
            presetFiltri = JSON.parse(localStorage.getItem('presetFiltri') || '{}');
            const presetList = document.getElementById('presetList');
            const presetContainer = document.getElementById('presetContainer');
            
            if (Object.keys(presetFiltri).length === 0) {
                presetContainer.style.display = 'none';
                return;
            }
            
            presetContainer.style.display = 'block';
            presetList.innerHTML = '';
            
            Object.values(presetFiltri).forEach(preset => {
                const btn = document.createElement('button');
                btn.innerHTML = `
                    <div style="text-align: left;">
                        <strong>${preset.nome}</strong><br>
                        <small style="color: #6b7280; font-size: 10px;">
                            ${new Date(preset.timestamp).toLocaleDateString('it-IT')}
                        </small>
                    </div>
                `;
                
                btn.style.cssText = `
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    padding: 10px;
                    cursor: pointer;
                    text-align: left;
                    min-width: 120px;
                    transition: all 0.2s;
                `;
                
                btn.onmouseover = function() { this.style.borderColor = '#2563eb'; this.style.background = '#f0f9ff'; };
                btn.onmouseout = function() { this.style.borderColor = '#e5e7eb'; this.style.background = 'white'; };
                
                btn.onclick = function() {
                    if (confirm(`Caricare il preset "${preset.nome}"?\n\nI filtri attuali verranno sovrascritti.`)) {
                        applicaPresetFiltri(preset.filtri);
                    }
                };
                
                // Bottone elimina preset
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.title = 'Elimina preset';
                deleteBtn.style.cssText = `
                    background: #fee2e2;
                    color: #dc2626;
                    border: none;
                    border-radius: 4px;
                    padding: 2px 6px;
                    cursor: pointer;
                    margin-left: 5px;
                    font-size: 10px;
                `;
                
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    if (confirm(`Eliminare il preset "${preset.nome}"?`)) {
                        delete presetFiltri[preset.nome];
                        localStorage.setItem('presetFiltri', JSON.stringify(presetFiltri));
                        caricaPresetFiltri();
                        showNotification(`Preset "${preset.nome}" eliminato`, 'info');
                    }
                };
                
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.appendChild(btn);
                container.appendChild(deleteBtn);
                
                presetList.appendChild(container);
            });
        }

        function applicaPresetFiltri(filtri) {
            // Applica tutti i valori dal preset
            document.getElementById('cercaEvento').value = filtri.searchTerm || '';
            document.getElementById('filtroSport').value = filtri.filtroSport || '';
            document.getElementById('filtroTipoEvento').value = filtri.filtroTipoEvento || '';
            document.getElementById('filtroDataDa').value = filtri.filtroDataDa || '';
            document.getElementById('filtroDataA').value = filtri.filtroDataA || '';
            document.getElementById('filtroSoloValue').checked = filtri.filtroSoloValue || false;
            document.getElementById('filtroEsitoValue').value = filtri.filtroEsitoValue || '';
            document.getElementById('filtroForzaValueRange').value = filtri.filtroForzaValue || 0;
            document.getElementById('forzaValueDisplay').textContent = (filtri.filtroForzaValue || 0) + '%';
            document.getElementById('forzaValueMin').textContent = filtri.filtroForzaValue || 0;
            document.getElementById('filtroMinBookmaker').value = filtri.filtroMinBookmaker || '0';
            document.getElementById('filtroSharpBookmaker').value = filtri.filtroSharpBookmaker || '';
            document.getElementById('filtroSoglieAIQ').value = filtri.filtroSoglieAIQ || '';
            
            // Applica i filtri
            filtraEventi();
            
            showNotification('Preset applicato', 'success');
        }

        // Aggiorna anche la vecchia funzione resetFiltri
        function resetFiltri() {
            resetFiltriAvanzati();
        }



        // ==============================
        // FUNZIONI BACKTEST FASE 2 - CORE
        // ==============================
        function eseguiBacktestCompleto() {
            console.log("üîÑ Inizio backtest completo...");
            
            try {
                // 1. VERIFICA DATI
                if (!databaseEventi || databaseEventi.length === 0) {
                    showNotification('‚ùå Nessun evento nel database', 'error');
                    return;
                }
                
                console.log(`üìÅ Database eventi: ${databaseEventi.length} eventi`);
                
                // 2. VERIFICA FUNZIONI DISPONIBILI
                if (typeof verificaValueBetAIQ !== 'function') {
                    showNotification('‚ùå Funzione verificaValueBetAIQ non trovata', 'error');
                    return;
                }
                
                // 3. FILTRA EVENTI CON RISULTATO
                const eventiConRisultato = databaseEventi.filter(evento => 
                    evento.risultatoReale && 
                    evento.risultatoReale !== 'NON_IMPOSTATO'
                );
                
                console.log(`üéØ Eventi con risultato: ${eventiConRisultato.length}`);
                
                if (eventiConRisultato.length === 0) {
                    showNotification('‚ö†Ô∏è Imposta prima i risultati reali degli eventi', 'warning');
                    return;
                }
                
                // 4. FILTRA EVENTI CON VALUEBET
                const eventiValuebet = eventiConRisultato.filter(evento => {
                    try {
                        const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                        const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                        return risultatoAIQ.hasValue;
                    } catch (e) {
                        console.error(`Errore verifica valuebet per evento ${evento.id}:`, e);
                        return false;
                    }
                });
                
                console.log(`üí∞ Valuebet con risultato: ${eventiValuebet.length}`);
                
                if (eventiValuebet.length === 0) {
                    showNotification('‚ùå Nessuna valuebet trovata', 'error');
                    return;
                }
                
                // 5. APPLICA FILTRI AVANZATI (se presenti)
                let eventiFiltrati = applicaFiltriBacktest(eventiValuebet);
                
                if (eventiFiltrati.length === 0) {
                    showNotification('‚ö†Ô∏è Nessun evento passa i filtri selezionati', 'warning');
                    return;
                }
                
                console.log(`üé≤ Eventi per backtest: ${eventiFiltrati.length}`);
                
                // 6. ESEGUI SIMULAZIONE
                const risultati = eseguiSimulazioneBacktest(eventiFiltrati);
                
                // 7. VISUALIZZA RISULTATI
                visualizzaRisultatiBacktest(risultati);
                visualizzaDettaglioScommesse(risultati.scommesse);
                
                // 8. MOSTRA SEZIONE RISULTATI
                document.getElementById('risultatiBacktestContainer').style.display = 'block';
                
                showNotification(`‚úÖ Backtest completato! ${risultati.scommesse.length} scommesse analizzate`, 'success');
                
            } catch (error) {
                console.error('‚ùå Errore durante backtest:', error);
                showNotification(`‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Funzione semplificata di simulazione
        function eseguiSimulazioneBacktest(eventi) {
            console.log("üé≤ Inizio simulazione...");
            
            // Parametri base
            const bankrollIniziale = parseFloat(document.getElementById('bankrollIniziale').value) || 1000;
            const strategia = caricaParametriStrategia();
            const tipoBookmaker = document.getElementById('tipoBookmakerBacktest').value;
            const commissioni = parseFloat(document.getElementById('commissioniExchange').value) || 0;
            
            let bankroll = bankrollIniziale;
            let bankrollMassimo = bankrollIniziale;
            let scommesse = [];
            let totaleStake = 0;
            let totaleProfitto = 0;
            let scommesseVinte = 0;
            let scommessePerse = 0;
            
            // Variabili per Fibonacci
            let livelloFibonacci = 0;
            let perditeConsecutive = 0;
            
            // Ordina eventi per data
            const eventiOrdinati = [...eventi].sort((a, b) => 
                new Date(a.dataOra) - new Date(b.dataOra)
            );
            
            // Simula ogni evento
            eventiOrdinati.forEach((evento, index) => {
                try {
                    // 1. DETERMINA ESITO VALUEBET
                    const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                    const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                    
                    if (!risultatoAIQ.hasValue) return; // Salta se non √® valuebet
                    
                    // 2. DETERMINA QUOTA IN BASE AL TIPO BOOKMAKER
                    let quota = 0;
                    const stats = aiqStats;
                    
                if (tipoBookmaker === 'migliore') {
                    // Migliore quota disponibile = QUOTA PI√ô ALTA TRA I SOFT
                    
                    // Lista FISSA di bookmaker sharp da escludere
                    const sharpBookmakers = ['pinnacle', 'betfair', 'matchbook', 'betdaq', 'smarkets'];
                    
                    let quotaMassima = 0;
                    
                    // Cerca tra TUTTI i bookmaker dell'evento
                    evento.quotes.forEach(bookmaker => {
                        // Escludi i bookmaker sharp
                        if (sharpBookmakers.includes(bookmaker.bookmaker.toLowerCase())) {
                            return; // Salta questo bookmaker
                        }
                        
                        let quotaCorrente = 0;
                        
                        // Determina quale quota guardare in base all'esito
                        if (risultatoAIQ.outcome === '1' || risultatoAIQ.outcome === 'SI') {
                            quotaCorrente = evento.tipoQuotes === '3_esiti' ? bookmaker.quote1 : bookmaker.quoteYes;
                        } else if (risultatoAIQ.outcome === 'X') {
                            quotaCorrente = bookmaker.quoteX;
                        } else if (risultatoAIQ.outcome === '2' || risultatoAIQ.outcome === 'NO') {
                            quotaCorrente = evento.tipoQuotes === '3_esiti' ? bookmaker.quote2 : bookmaker.quoteNo;
                        }
                        
                        // Prendi la quota MASSIMA (pi√π alta)
                        if (quotaCorrente > quotaMassima) {
                            quotaMassima = quotaCorrente;
                        }
                    });
                    
                    // Se non ho trovato bookmaker soft, uso la statistica max come fallback
                    if (quotaMassima > 0) {
                        quota = quotaMassima;
                    } else {
                        // Fallback: usa la statistica max
                        if (risultatoAIQ.outcome === '1' || risultatoAIQ.outcome === 'SI') {
                            quota = stats.max1 || stats.maxYes || 0;
                        } else if (risultatoAIQ.outcome === 'X') {
                            quota = stats.maxX || 0;
                        } else if (risultatoAIQ.outcome === '2' || risultatoAIQ.outcome === 'NO') {
                            quota = stats.max2 || stats.maxNo || 0;
                        }
                    }
                    } else if (tipoBookmaker === 'sharp') {
                        // Migliore quota sharp
                        if (risultatoAIQ.outcome === '1' || risultatoAIQ.outcome === 'SI') {
                            quota = stats.pinnacle1 || stats.betfair1 || stats.min1 || stats.minYes || 0;
                        } else if (risultatoAIQ.outcome === 'X') {
                            quota = stats.pinnacleX || stats.betfairX || stats.minX || 0;
                        } else if (risultatoAIQ.outcome === '2' || risultatoAIQ.outcome === 'NO') {
                            quota = stats.pinnacle2 || stats.betfair2 || stats.min2 || stats.minNo || 0;
                        }
                    } else if (tipoBookmaker === 'media') {
                        // Media delle quote
                        if (risultatoAIQ.outcome === '1' || risultatoAIQ.outcome === 'SI') {
                            quota = stats.avg1 || stats.avgYes || 0;
                        } else if (risultatoAIQ.outcome === 'X') {
                            quota = stats.avgX || 0;
                        } else if (risultatoAIQ.outcome === '2' || risultatoAIQ.outcome === 'NO') {
                            quota = stats.avg2 || stats.avgNo || 0;
                        }
                    }
                    
                    // Applica commissioni se > 0
                    if (commissioni > 0 && quota > 0) {
                        quota = quota * (1 - commissioni/100);
                    }
                    
                    if (quota <= 0) return; // Salta se quota non valida
                    
                    // 3. CALCOLA STAKE IN BASE ALLA STRATEGIA
                    let stake = 0;
                    
                    if (strategia.tipo === 'fisso') {
                        stake = strategia.stakeFisso;
                    } else if (strategia.tipo === 'percentuale') {
                        stake = (bankroll * strategia.percentualeBankroll) / 100;
                        stake = Math.max(stake, strategia.stakeMinimoPercentuale);
                        stake = Math.min(stake, strategia.stakeMassimoPercentuale);
                    } else if (strategia.tipo === 'kelly') {
                        // OPZIONE 1: Usa win rate storico invece di probabilit√† implicita
                        const winRateStorico = 50; // O calcolalo dai dati storici
                        const p = winRateStorico / 100;
                        
                        // OPZIONE 2: Usa probabilit√† corretta per il tuo caso specifico
                        // const p = 0.5; // Stima conservativa
                        
                        const b = quota - 1;
                        const q = 1 - p;
                        
                        let kelly = 0;
                        if (b > 0 && p > 0) {
                            kelly = (b * p - q) / b;
                            kelly = Math.max(0, kelly); // Non negativo
                            kelly = Math.min(kelly, 0.5); // Massimo 50% bankroll
                        }
                        
                        // Applica Kelly fraction (25% = Kelly quarter)
                        kelly = kelly * (strategia.kellyFraction / 100);
                        
                        stake = bankroll * kelly;
                        stake = Math.min(stake, strategia.stakeMassimoKelly);
                    } else if (strategia.tipo === 'fibonacci') {
                        // Sequenza Fibonacci: 1,1,2,3,5,8,13,21,34,55
                        const sequenza = [1,1,2,3,5,8,13,21,34,55];
                        const livello = Math.min(livelloFibonacci, sequenza.length - 1);
                        stake = strategia.stakeBaseFibonacci * sequenza[livello];
                    }
                    
                    // Verifica che lo stake non superi il bankroll
                    stake = Math.min(stake, bankroll);
                    if (stake <= 0) return;
                    
                    // 4. DETERMINA SE LA SCEMESSA VINCE O PERDE
                    const esitoValue = risultatoAIQ.outcome;
                    const esitoReale = evento.risultatoReale;
                    
                    let risultato = 'PERSA';
                    let profitto = 0;
                    
                    // Mappa esiti per confronto
                    const mappaEsiti = {
                        '1': 'HOME',
                        'X': 'DRAW', 
                        '2': 'AWAY',
                        'SI': 'YES',
                        'NO': 'NO'
                    };
                    
                    if (mappaEsiti[esitoValue] === esitoReale) {
                        // VINTA
                        risultato = 'VINTA';
                        profitto = (stake * quota) - stake;
                        scommesseVinte++;
                        
                        // Gestione Fibonacci: vittoria
                        if (strategia.tipo === 'fibonacci' && strategia.resetFibonacci === 'si') {
                            livelloFibonacci = 0;
                            perditeConsecutive = 0;
                        }
                    } else {
                        // PERSA
                        profitto = -stake;
                        scommessePerse++;
                        
                        // Gestione Fibonacci: perdita
                        if (strategia.tipo === 'fibonacci') {
                            perditeConsecutive++;
                            livelloFibonacci = Math.min(perditeConsecutive, 9); // Max 10 livelli
                        }
                    }
                    
                    // 5. AGGIORNA BANKROLL E STATISTICHE
                    bankroll += profitto;
                    bankrollMassimo = Math.max(bankrollMassimo, bankroll);
                    totaleStake += stake;
                    totaleProfitto += profitto;
                    
                    // 6. REGISTRA LA SCEMESSA
                    scommesse.push({
                        numero: index + 1,
                        evento: evento.nome,
                        esitoValue: esitoValue,
                        esitoReale: esitoReale,
                        quota: quota.toFixed(2),
                        stake: stake.toFixed(2),
                        risultato: risultato,
                        profitto: profitto.toFixed(2),
                        bankrollDopo: bankroll.toFixed(2),
                        data: evento.dataFormattata
                    });
                    
                } catch (error) {
                    console.error(`Errore durante simulazione evento ${evento.id}:`, error);
                }
            });
            
            // CALCOLA METRICHE FINALI
            const totaleScommesse = scommesse.length;
            const winRate = totaleScommesse > 0 ? (scommesseVinte / totaleScommesse) * 100 : 0;
            const roi = totaleStake > 0 ? (totaleProfitto / totaleStake) * 100 : 0;
            // Calcolo semplificato e corretto
            let profittiTotali = 0;
            let perditeTotali = 0;

            scommesse.forEach(s => {
                const profitto = parseFloat(s.profitto);
                if (profitto > 0) {
                    profittiTotali += profitto;
                } else if (profitto < 0) {
                    perditeTotali += Math.abs(profitto);
                }
            });

            let profitFactor = 0;
            if (perditeTotali > 0) {
                profitFactor = profittiTotali / perditeTotali;
            } else if (profittiTotali > 0) {
                profitFactor = 999.99; // Massimo valore ragionevole
            }

            // Limita il display
            const profitFactorDisplay = profitFactor > 999 ? ">999" : profitFactor.toFixed(2);
            const drawdown = bankrollIniziale > 0 ? ((bankrollMassimo - Math.min(bankroll, bankrollMassimo)) / bankrollMassimo) * 100 : 0;
            
            // Ritorna risultati
            return {
                scommesse: scommesse,
                statistiche: {
                    bankrollIniziale: bankrollIniziale,
                    bankrollFinale: bankroll,
                    totaleScommesse: totaleScommesse,
                    scommesseVinte: scommesseVinte,
                    scommessePerse: scommessePerse,
                    winRate: winRate,
                    totaleStake: totaleStake,
                    totaleProfitto: totaleProfitto,
                    roi: roi,
                    profitFactor: profitFactor,
                    drawdown: drawdown,
                    bankrollMassimo: bankrollMassimo
                },
                strategia: strategia
            };
        }

        // Funzione per applicare filtri avanzati
        function applicaFiltriBacktest(eventi) {
            const forzaMinima = parseFloat(document.getElementById('filtroForzaValueBacktest').value) || 0;
            const sport = document.getElementById('filtroSportBacktest').value;
            const tipoEvento = document.getElementById('filtroTipoEventoBacktest').value;
            const sharp = document.getElementById('filtroSharpBacktest').value;
            const dataDa = document.getElementById('filtroDataDaBacktest').value;
            const dataA = document.getElementById('filtroDataABacktest').value;
            
            let filtrati = [...eventi];
            
            // Filtro forza value
            if (forzaMinima > 0) {
                filtrati = filtrati.filter(evento => {
                    const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                    const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                    return risultatoAIQ.forzaValue >= forzaMinima;
                });
            }
            
            // Filtro sport
            if (sport) {
                filtrati = filtrati.filter(evento => evento.sport === sport);
            }
            
            // Filtro tipo evento
            if (tipoEvento) {
                filtrati = filtrati.filter(evento => evento.tipoQuotes === tipoEvento);
            }
            
            // Filtro sharp
            if (sharp === 'si') {
                filtrati = filtrati.filter(evento => {
                    const stats = evento.aiqData ? evento.aiqData.stats : null;
                    return stats && (stats.pinnacle1 || stats.pinnacleX || stats.pinnacle2 || 
                                    stats.betfair1 || stats.betfairX || stats.betfair2);
                });
            } else if (sharp === 'no') {
                filtrati = filtrati.filter(evento => {
                    const stats = evento.aiqData ? evento.aiqData.stats : null;
                    return !(stats && (stats.pinnacle1 || stats.pinnacleX || stats.pinnacle2 || 
                                    stats.betfair1 || stats.betfairX || stats.betfair2));
                });
            }
            
            // Filtro date
            if (dataDa) {
                const dataDaObj = new Date(dataDa);
                filtrati = filtrati.filter(evento => new Date(evento.dataOra) >= dataDaObj);
            }
            
            if (dataA) {
                const dataAObj = new Date(dataA);
                filtrati = filtrati.filter(evento => new Date(evento.dataOra) <= dataAObj);
            }
            
            return filtrati;
        }

        // Visualizza risultati nella UI
        function visualizzaRisultatiBacktest(risultati) {
            const stats = risultati.statistiche;
            
            // Aggiorna statistiche principali
            document.getElementById('statROI').textContent = stats.roi.toFixed(1) + '%';
            document.getElementById('statWinRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('statProfittoNetto').textContent = stats.totaleProfitto.toFixed(2) + '‚Ç¨';
            document.getElementById('statProfitFactor').textContent = stats.profitFactor.toFixed(2);
            
            // Aggiorna statistiche secondarie
            document.getElementById('statTotaleScommesse').textContent = stats.totaleScommesse;
            document.getElementById('statScommesseVinte').textContent = stats.scommesseVinte;
            document.getElementById('statScommessePerse').textContent = stats.scommessePerse;
            document.getElementById('statBankrollFinale').textContent = stats.bankrollFinale.toFixed(2) + '‚Ç¨';
            
            // Aggiorna metriche avanzate
            document.getElementById('statMaxDrawdown').textContent = stats.drawdown.toFixed(1) + '%';
            document.getElementById('statSharpeRatio').textContent = '0.00'; // Da implementare
            document.getElementById('statExpectancy').textContent = (stats.totaleProfitto / stats.totaleScommesse).toFixed(2) + '‚Ç¨';
            
            // Aggiorna grafico bankroll
            aggiornaGraficoBankroll(risultati.scommesse, stats.bankrollIniziale);
        }

        // Visualizza dettaglio scommesse
        function visualizzaDettaglioScommesse(scommesse) {
            const container = document.getElementById('tabellaDettaglioBacktest');
            const emptyState = document.getElementById('emptyBacktest');
            
            if (scommesse.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Genera HTML per la tabella
            const html = scommesse.map(s => `
                <tr>
                    <td style="text-align: center;">${s.numero}</td>
                    <td>
                        ${s.evento}<br>
                        <small style="color: #666; font-size: 11px;">${s.data}</small>
                    </td>
                    <td style="text-align: center;">
                        <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; 
                            ${s.esitoValue === '1' || s.esitoValue === 'SI' ? 'background: #eff6ff; color: #2563eb;' : 
                            s.esitoValue === 'X' ? 'background: #faf5ff; color: #9333ea;' : 
                            'background: #f0fdf4; color: #059669;'}">
                            ${s.esitoValue}
                        </span>
                    </td>
                    <td style="text-align: center; font-weight: bold;">${s.quota}</td>
                    <td style="text-align: center;">${s.stake}‚Ç¨</td>
                    <td style="text-align: center;">
                        <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; 
                            ${s.risultato === 'VINTA' ? 'background: #dcfce7; color: #166534;' : 'background: #fee2e2; color: #991b1b;'}">
                            ${s.risultato}
                        </span>
                    </td>
                    <td style="text-align: center; font-weight: bold; 
                        ${parseFloat(s.profitto) >= 0 ? 'color: #059669;' : 'color: #dc2626;'}">
                        ${parseFloat(s.profitto) >= 0 ? '+' : ''}${s.profitto}‚Ç¨
                    </td>
                </tr>
            `).join('');
            
            container.innerHTML = html;
        }

        // Aggiorna grafico bankroll semplice
        function aggiornaGraficoBankroll(scommesse, bankrollIniziale) {
            const canvas = document.getElementById('bankrollCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (scommesse.length === 0) return;
            
            // Calcola punti per il grafico
            let bankroll = bankrollIniziale;
            const punti = [{x: 0, y: bankroll}];
            
            scommesse.forEach((s, i) => {
                bankroll += parseFloat(s.profitto);
                punti.push({
                    x: i + 1,
                    y: bankroll
                });
            });
            
            // Trova min e max per scala
            const valoriY = punti.map(p => p.y);
            const minY = Math.min(...valoriY);
            const maxY = Math.max(...valoriY);
            const rangeY = maxY - minY;
            
            // Dimensioni canvas
            const padding = 30;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;
            
            // Disegna asse X
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.strokeStyle = '#ccc';
            ctx.stroke();
            
            // Disegna asse Y
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.strokeStyle = '#ccc';
            ctx.stroke();
            
            // Disegna linea bankroll
            ctx.beginPath();
            punti.forEach((punto, i) => {
                const x = padding + (punto.x / scommesse.length) * width;
                const y = canvas.height - padding - ((punto.y - minY) / rangeY) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Punti del grafico
            punti.forEach((punto, i) => {
                const x = padding + (punto.x / scommesse.length) * width;
                const y = canvas.height - padding - ((punto.y - minY) / rangeY) * height;
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = parseFloat(scommesse[i-1]?.profitto || 0) >= 0 ? '#059669' : '#dc2626';
                ctx.fill();
            });
            
            // Etichette
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Scommesse', canvas.width / 2, canvas.height - 5);
            
            ctx.save();
            ctx.translate(10, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('Bankroll (‚Ç¨)', 0, 0);
            ctx.restore();
        }

        // ==============================
        // FUNZIONI PER STRATEGIE STAKE - MANCANTI
        // ==============================

        // Variabili globali per strategie stake
        let parametriStrategia = {
            tipo: 'fisso',
            stakeFisso: 100,
            percentualeBankroll: 5,
            stakeMinimoPercentuale: 10,
            stakeMassimoPercentuale: 500,
            kellyFraction: 25,
            stakeMassimoKelly: 200,
            stakeBaseFibonacci: 10,
            sequenzaFibonacci: '7',
            resetFibonacci: 'si'
        };

        // Cambia l'interfaccia in base alla strategia selezionata
        function cambiaStrategiaStake() {
            const strategia = document.getElementById('strategiaStake').value;
            const parametriContainer = document.getElementById('parametriStrategiaContainer');
            
            // Nascondi tutti i parametri specifici
            document.getElementById('parametriPercentuale').style.display = 'none';
            document.getElementById('parametriKelly').style.display = 'none';
            document.getElementById('parametriFibonacci').style.display = 'none';
            
            // Aggiorna il parametro stake principale
            const parametroStakeContainer = document.getElementById('parametroStakeContainer');
            
            switch(strategia) {
                case 'fisso':
                    parametroStakeContainer.innerHTML = `
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                Stake Fisso (‚Ç¨)
                                <span style="color: #666; font-weight: normal; font-size: 13px;">
                                    - Importo fisso da scommettere
                                </span>
                            </label>
                            <input type="number" id="stakeBacktest" value="${parametriStrategia.stakeFisso}" min="1" step="10"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    `;
                    parametriContainer.style.display = 'none';
                    break;
                    
                case 'percentuale':
                    parametroStakeContainer.innerHTML = `
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                Stake Base (‚Ç¨)
                                <span style="color: #666; font-weight: normal; font-size: 13px;">
                                    - Valore base per calcolo %
                                </span>
                            </label>
                            <input type="number" id="stakeBacktest" value="${parametriStrategia.stakeFisso}" min="1" step="10"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    `;
                    document.getElementById('parametriPercentuale').style.display = 'block';
                    parametriContainer.style.display = 'block';
                    break;
                    
                case 'kelly':
                    parametroStakeContainer.innerHTML = `
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                Stake Base (‚Ç¨)
                                <span style="color: #666; font-weight: normal; font-size: 13px;">
                                    - Valore base per riferimento
                                </span>
                            </label>
                            <input type="number" id="stakeBacktest" value="${parametriStrategia.stakeFisso}" min="1" step="10"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    `;
                    document.getElementById('parametriKelly').style.display = 'block';
                    parametriContainer.style.display = 'block';
                    break;
                    
                case 'fibonacci':
                    parametroStakeContainer.innerHTML = `
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">
                                Stake Base (‚Ç¨)
                                <span style="color: #666; font-weight: normal; font-size: 13px;">
                                    - Valore base per riferimento
                                </span>
                            </label>
                            <input type="number" id="stakeBacktest" value="${parametriStrategia.stakeFisso}" min="1" step="10"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    `;
                    document.getElementById('parametriFibonacci').style.display = 'block';
                    parametriContainer.style.display = 'block';
                    break;
            }
            
            parametriStrategia.tipo = strategia;
        }

        // Aggiorna display per Kelly fraction
        function updateKellyDisplay(value) {
            document.getElementById('kellyFractionDisplay').textContent = value + '%';
            parametriStrategia.kellyFraction = parseFloat(value);
        }

        // Carica i parametri dalle input - QUESTA √à LA FUNZIONE MANCANTE!
        function caricaParametriStrategia() {
            const strategia = document.getElementById('strategiaStake').value;
            
            parametriStrategia.tipo = strategia;
            parametriStrategia.stakeFisso = parseFloat(document.getElementById('stakeBacktest').value) || 100;
            
            if (strategia === 'percentuale') {
                parametriStrategia.percentualeBankroll = parseFloat(document.getElementById('percentualeBankroll').value) || 5;
                parametriStrategia.stakeMinimoPercentuale = parseFloat(document.getElementById('stakeMinimoPercentuale').value) || 10;
                parametriStrategia.stakeMassimoPercentuale = parseFloat(document.getElementById('stakeMassimoPercentuale').value) || 500;
            }
            
            if (strategia === 'kelly') {
                const kellySlider = document.getElementById('kellyFraction');
                if (kellySlider) {
                    parametriStrategia.kellyFraction = parseFloat(kellySlider.value) || 25;
                }
                parametriStrategia.stakeMassimoKelly = parseFloat(document.getElementById('stakeMassimoKelly').value) || 200;
            }
            
            if (strategia === 'fibonacci') {
                parametriStrategia.stakeBaseFibonacci = parseFloat(document.getElementById('stakeBaseFibonacci').value) || 10;
                parametriStrategia.sequenzaFibonacci = document.getElementById('sequenzaFibonacci').value || '7';
                parametriStrategia.resetFibonacci = document.getElementById('resetFibonacci').value || 'si';
            }
            
            console.log("Parametri strategia caricati:", parametriStrategia);
            return parametriStrategia;
        }

        // Inizializza la strategia stake al caricamento della pagina
        function inizializzaStrategieStake() {
            console.log("Inizializzazione strategie stake...");
            
            // Popola il filtro sport backtest
            const sportUnici = [...new Set(databaseEventi.map(e => e.sport))].sort();
            const filtroSportBacktest = document.getElementById('filtroSportBacktest');
            
            // Pulisci e ricrea
            if (filtroSportBacktest) {
                filtroSportBacktest.innerHTML = '<option value="">Tutti gli sport</option>';
                
                sportUnici.forEach(sport => {
                    const option = document.createElement('option');
                    option.value = sport;
                    option.textContent = sport;
                    filtroSportBacktest.appendChild(option);
                });
            }
            
            // Inizializza la strategia di default
            cambiaStrategiaStake();
        }

        // Aggiorna statistiche backtest
        function aggiornaStatisticheBacktest() {
            if (!databaseEventi) return;
            
            // Eventi con risultato
            const eventiConRisultato = databaseEventi.filter(evento => 
                evento.risultatoReale && 
                evento.risultatoReale !== 'NON_IMPOSTATO'
            );
            
            // Eventi valuebet con risultato
            const eventiValuebet = eventiConRisultato.filter(evento => {
                try {
                    const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                    const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                    return risultatoAIQ.hasValue;
                } catch (e) {
                    return false;
                }
            });
            
            // Aggiorna contatori
            const statEventiConRisultato = document.getElementById('statEventiConRisultato');
            const statValuebetConRisultato = document.getElementById('statValuebetConRisultato');
            const statBacktestPronti = document.getElementById('statBacktestPronti');
            
            if (statEventiConRisultato) {
                statEventiConRisultato.textContent = eventiConRisultato.length;
            }
            
            if (statValuebetConRisultato) {
                statValuebetConRisultato.textContent = eventiValuebet.length;
            }
            
            if (statBacktestPronti) {
                // Eventi che possono essere usati per backtest (con risultato e valuebet)
                statBacktestPronti.textContent = eventiValuebet.length;
            }
        }

        // ==============================
        // FUNZIONI PER IMPOSTAZIONE RISULTATI
        // ==============================

        function impostaRisultatiMultipli() {
            console.log("Apertura modal per impostazione risultati...");
            
            // Crea una modal temporanea per impostare i risultati
            const modalHTML = `
                <div id="modalRisultati" class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                    <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0;">üéØ Imposta Risultati Eventi</h2>
                            <button onclick="chiudiModalRisultati()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <p style="margin-bottom: 20px; color: #666;">
                            Imposta i risultati reali degli eventi per eseguire il backtest. 
                            Seleziona l'esito che si √® verificato realmente.
                        </p>
                        
                        <div class="results-container">
                            <table class="bookmaker-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;">#</th>
                                        <th style="width: 25%;">Evento</th>
                                        <th style="width: 15%;">Sport</th>
                                        <th style="width: 15%;">Data</th>
                                        <th style="width: 20%;">ValueBet Identificata</th>
                                        <th style="width: 20%;">Risultato Reale</th>
                                    </tr>
                                </thead>
                                <tbody id="tabellaImpostaRisultati">
                                    <!-- Eventi verranno inseriti qui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="salvaRisultatiMultipli()" 
                                    style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; margin-right: 10px;">
                                üíæ Salva Tutti i Risultati
                            </button>
                            <button onclick="chiudiModalRisultati()" 
                                    style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚ùå Annulla
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Aggiungi la modal al body
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            // Popola la tabella con gli eventi
            popolaTabellaRisultati();
        }

        function popolaTabellaRisultati() {
            const container = document.getElementById('tabellaImpostaRisultati');
            if (!container) return;
            
            // Filtra eventi con valuebet
            const eventiValuebet = databaseEventi.filter(evento => {
                try {
                    const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                    const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                    return risultatoAIQ.hasValue;
                } catch (e) {
                    return false;
                }
            });
            
            if (eventiValuebet.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 18px; margin-bottom: 10px;">üì≠</div>
                            Nessuna valuebet identificata nel database.<br>
                            <small>Prima di impostare i risultati, salva eventi con valuebet dalle altre tab.</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Genera HTML per la tabella
            const html = eventiValuebet.map((evento, index) => {
                const aiqStats = evento.aiqData ? evento.aiqData.stats : null;
                const risultatoAIQ = verificaValueBetAIQ(aiqStats, evento.tipoQuotes);
                
                // Opzioni per il dropdown in base al tipo di evento
                let opzioniRisultato = '';
                if (evento.tipoQuotes === '3_esiti') {
                    opzioniRisultato = `
                        <option value="NON_IMPOSTATO" ${evento.risultatoReale === 'NON_IMPOSTATO' ? 'selected' : ''}>Non impostato</option>
                        <option value="HOME" ${evento.risultatoReale === 'HOME' ? 'selected' : ''}>1 - Home Win</option>
                        <option value="DRAW" ${evento.risultatoReale === 'DRAW' ? 'selected' : ''}>X - Draw</option>
                        <option value="AWAY" ${evento.risultatoReale === 'AWAY' ? 'selected' : ''}>2 - Away Win</option>
                    `;
                } else if (evento.tipoQuotes === '2_esiti') {
                    opzioniRisultato = `
                        <option value="NON_IMPOSTATO" ${evento.risultatoReale === 'NON_IMPOSTATO' ? 'selected' : ''}>Non impostato</option>
                        <option value="YES" ${evento.risultatoReale === 'YES' ? 'selected' : ''}>S√¨ / Over</option>
                        <option value="NO" ${evento.risultatoReale === 'NO' ? 'selected' : ''}>No / Under</option>
                    `;
                } else {
                    opzioniRisultato = `
                        <option value="NON_IMPOSTATO" selected>Non impostato</option>
                    `;
                }
                
                return `
                    <tr data-event-id="${evento.id}">
                        <td style="text-align: center;">${index + 1}</td>
                        <td>
                            <strong>${evento.nome}</strong><br>
                            <small style="color: #666; font-size: 11px;">${evento.lega}</small>
                        </td>
                        <td>${evento.sport}</td>
                        <td>${evento.dataFormattata}</td>
                        <td style="text-align: center;">
                            <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                VALUE ${risultatoAIQ.outcome}
                                <small style="opacity: 0.8;">(${risultatoAIQ.forzaValue.toFixed(1)}%)</small>
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <select class="select-risultato" data-event-id="${evento.id}" 
                                style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; background: white; cursor: pointer; min-width: 150px;">
                                ${opzioniRisultato}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function salvaRisultatiMultipli() {
            const selects = document.querySelectorAll('.select-risultato');
            let modificati = 0;
            
            selects.forEach(select => {
                const eventId = select.getAttribute('data-event-id');
                const risultato = select.value;
                
                const eventoIndex = databaseEventi.findIndex(e => e.id === eventId);
                if (eventoIndex !== -1) {
                    databaseEventi[eventoIndex].risultatoReale = risultato;
                    modificati++;
                }
            });
            
            // Salva nel localStorage
            localStorage.setItem('databaseEventi', JSON.stringify(databaseEventi));
            
            // Chiudi la modal
            chiudiModalRisultati();
            
            // Aggiorna statistiche
            aggiornaStatisticheBacktest();
            
            showNotification(`‚úÖ ${modificati} risultati salvati`, 'success');
        }

        function chiudiModalRisultati() {
            const modal = document.getElementById('modalRisultati');
            if (modal) {
                modal.remove();
            }
        }

        // ==============================
        // FUNZIONI ESPORTAZIONE BACKTEST
        // ==============================

        function esportaBacktestCSV() {
            const scommesseContainer = document.getElementById('tabellaDettaglioBacktest');
            if (!scommesseContainer || scommesseContainer.children.length === 0) {
                showNotification('‚ùå Nessun dato da esportare', 'error');
                return;
            }
            
            let csvContent = "Backtest Scommesse - Esportato il: " + new Date().toLocaleString() + "\n\n";
            csvContent += "Numero;Evento;Data;Esito Value;Esito Reale;Quota;Stake;Risultato;Profitto\n";
            
            const rows = scommesseContainer.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    const numero = cells[0].textContent;
                    const evento = cells[1].textContent.replace(/\n/g, ' ').trim();
                    const data = cells[1].querySelector('small') ? cells[1].querySelector('small').textContent : '';
                    const esitoValue = cells[2].textContent.trim();
                    const quota = cells[3].textContent;
                    const stake = cells[4].textContent;
                    const risultato = cells[5].textContent.trim();
                    const profitto = cells[6].textContent;
                    
                    csvContent += `${numero};"${evento}";"${data}";${esitoValue};${quota};${stake};${risultato};${profitto}\n`;
                }
            });
            
            downloadFile(csvContent, 'backtest_scommesse.csv', 'text/csv');
            showNotification('üì• CSV esportato', 'success');
        }

        function esportaBacktestJSON() {
            showNotification('‚è≥ Funzione in sviluppo', 'info');
        }

        function esportaBacktestReport() {
            showNotification('‚è≥ Funzione in sviluppo', 'info');
        }

        // ==============================
        // INIZIALIZZAZIONE
        // ==============================
        window.onload = function() {
            // Carica database da localStorage (IMPORTANTE!)
            databaseEventi = JSON.parse(localStorage.getItem('databaseEventi') || '[]');
            console.log("Database eventi caricato:", databaseEventi.length, "eventi");
            
            // Aggiorna tutti i contatori
            refreshDatabaseEventi();
            
            // NON calcolare valori iniziali AIQ - campi vuoti
            // I calcolatori si popolano solo quando si fa il parsing
            
            // Parse automatico all'avvio - SOLO se ci sono dati nei textarea
            if (document.getElementById('inputData3').value.trim()) {
                parseData3Esiti();
            }
            
            if (document.getElementById('inputData2').value.trim()) {
                parseData2Esiti();
            }
            
            // Auto-parse quando si incolla
            document.getElementById('inputData3').addEventListener('paste', function() {
                setTimeout(parseData3Esiti, 100);
            });
            
            document.getElementById('inputData2').addEventListener('paste', function() {
                setTimeout(parseData2Esiti, 100);
            });
            
            // Aggiungi event listener per i nuovi textarea degli eventi
            document.getElementById('inputEvento3').addEventListener('paste', function() {
                setTimeout(parseEvento3, 100);
            });
            
            document.getElementById('inputEvento2').addEventListener('paste', function() {
                setTimeout(parseEvento2, 100);
            });

            // Shortcut Ctrl+Enter per parsare
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab.id === 'tab-3esiti') {
                        parseData3Esiti();
                    } else if (activeTab.id === 'tab-2esiti') {
                        parseData2Esiti();
                    } else if (activeTab.id === 'tab-eventi') {
                        // Non c'√® pi√π il parser nella tab eventi
                        showNotification('Usa i parser nelle altre tab per aggiungere eventi', 'info');
                    }
                }
            });

            // Inizializza database eventi - MOSTRA SEMPRE la tabella
            mostraTabellaEventi();
            
            // Inizializza ordinamento eventi
            aggiornaIndicatoriOrdinamentoEventi('data', 'desc');

            // CALCOLA STATISTICHE ALL'AVVIO
            calcolaStatisticheDatabase();

            // Aggiorna anche i filtri sport
            aggiornaFiltriSport();

            // Inizializza paginazione
            eventiFiltrati = [...databaseEventi];
            mostraTabellaEventi();

            // Inizializza configurazione AIQ
            caricaSoglieAIQ();

            // DEBUG: mostra il numero di eventi nella console
            console.log("Eventi nel database:", databaseEventi);

            // INIZIALIZZA INDICATORI SOGLIE AIQ
            console.log("Inizializzazione completata. Soglie AIQ:", soglieAIQ);
            setTimeout(() => {
                aggiornaIndicatoriSoglie();
                console.log("Indicatori soglie aggiornati");
            }, 500);   
            
                // Aggiorna statistiche backtest all'avvio
            setTimeout(() => {
                aggiornaStatisticheBacktest();
            }, 500);
        };
    </script>
</body>
</html>